<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="combined.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b></b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>combined.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		No overview generated for 'combined.js'<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ObjectList.Text.html">In2iGui.ObjectList.Text</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.DropDown.html">In2iGui.Formula.DropDown</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Layout.html">In2iGui.Layout</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Menu.html">In2iGui.Menu</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="n2i.URL.html">n2i.URL</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Selection.html">In2iGui.Selection</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ImageViewer.html">In2iGui.ImageViewer</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Selection.Items.html">In2iGui.Selection.Items</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.DatePicker.html">In2iGui.DatePicker</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Calendar.html">In2iGui.Calendar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Upload.Item.html">In2iGui.Upload.Item</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Editor.html">In2iGui.Editor</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="n2i.Preloader.html">n2i.Preloader</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Toolbar.SearchField.html">In2iGui.Toolbar.SearchField</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ObjectList.html">In2iGui.ObjectList</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.html">In2iGui.Formula</a></b></td>
    <td>This is a formula
  
</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Group.html">In2iGui.Formula.Group</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Location.html">In2iGui.Formula.Location</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.List.html">In2iGui.List</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Button.html">In2iGui.Button</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Dock.html">In2iGui.Dock</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Columns.html">In2iGui.Columns</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Articles.html">In2iGui.Articles</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Toolbar.html">In2iGui.Toolbar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.BoundPanel.html">In2iGui.BoundPanel</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.TextField.html">In2iGui.TextField</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Checkboxes.html">In2iGui.Formula.Checkboxes</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Checkbox.html">In2iGui.Formula.Checkbox</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.NumberValidator.html">In2iGui.NumberValidator</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Window.html">In2iGui.Window</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ObjectList.Object.html">In2iGui.ObjectList.Object</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Buttons.html">In2iGui.Buttons</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Number.html">In2iGui.Formula.Number</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Overflow.html">In2iGui.Overflow</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Text.html">In2iGui.Formula.Text</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Editor.Html.html">In2iGui.Editor.Html</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Overlay.html">In2iGui.Overlay</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.InfoView.html">In2iGui.InfoView</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Box.html">In2iGui.Box</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="Range.html">Range</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.DateTime.html">In2iGui.Formula.DateTime</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Picker.html">In2iGui.Picker</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ObjectList.Select.html">In2iGui.ObjectList.Select</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Wizard.html">In2iGui.Wizard</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.RevealingToolbar.html">In2iGui.RevealingToolbar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.html">In2iGui</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.SearchField.html">In2iGui.SearchField</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Tokens.html">In2iGui.Formula.Tokens</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Checkboxes.Items.html">In2iGui.Formula.Checkboxes.Items</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="n2i.Color.html">n2i.Color</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.StyleLength.html">In2iGui.Formula.StyleLength</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Fragment.html">In2iGui.Fragment</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Tabs.html">In2iGui.Tabs</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Gallery.html">In2iGui.Gallery</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Radiobuttons.html">In2iGui.Formula.Radiobuttons</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Toolbar.Icon.html">In2iGui.Toolbar.Icon</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.RichText.html">In2iGui.RichText</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ProgressBar.html">In2iGui.ProgressBar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Upload.html">In2iGui.Upload</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Alert.html">In2iGui.Alert</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ImagePicker.html">In2iGui.ImagePicker</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Editor.Header.html">In2iGui.Editor.Header</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Source.html">In2iGui.Source</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Tab.html">In2iGui.Tab</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Toolbar.Badge.html">In2iGui.Toolbar.Badge</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/*  Prototype JavaScript framework, version 1.6.1_rc2
 *  (c) 2005-2009 Sam Stephenson
 *
 *  Prototype is freely distributable under the terms of an MIT-style license.
 *  For details, see the Prototype web site: http://www.prototypejs.org/
 *
 *--------------------------------------------------------------------------*/</span>

var Prototype = {
  Version: <span class="literal">'1.6.1_rc2'</span>,

  Browser: {
    IE:     !!(window.attachEvent &amp;&amp;
      navigator.userAgent.indexOf(<span class="literal">'Opera'</span>) === -1),
    Opera:  navigator.userAgent.indexOf(<span class="literal">'Opera'</span>) &gt; -1,
    WebKit: navigator.userAgent.indexOf(<span class="literal">'AppleWebKit/'</span>) &gt; -1,
    Gecko:  navigator.userAgent.indexOf(<span class="literal">'Gecko'</span>) &gt; -1 &amp;&amp;
      navigator.userAgent.indexOf(<span class="literal">'KHTML'</span>) === -1,
    MobileSafari: !!navigator.userAgent.match(/Apple.*Mobile.*Safari/)
  },

  BrowserFeatures: {
    XPath: !!document.evaluate,
    SelectorsAPI: !!document.querySelector,
    ElementExtensions: (<span class="reserved">function</span>() {
      <span class="reserved">if</span> (window.HTMLElement &amp;&amp; window.HTMLElement.<span class="reserved">prototype</span>)
        <span class="reserved">return</span> true;
      <span class="reserved">if</span> (window.Element &amp;&amp; window.Element.<span class="reserved">prototype</span>)
        <span class="reserved">return</span> true;
    })(),
    SpecificElementExtensions: (<span class="reserved">function</span>() {
      <span class="reserved">if</span> (typeof window.HTMLDivElement !== <span class="literal">'undefined'</span>)
        <span class="reserved">return</span> true;

      var div = document.createElement(<span class="literal">'div'</span>);
      <span class="reserved">if</span> (div[<span class="literal">'__proto__'</span>] &amp;&amp; div[<span class="literal">'__proto__'</span>] !==
       document.createElement(<span class="literal">'form'</span>)[<span class="literal">'__proto__'</span>]) {
        <span class="reserved">return</span> true;
      }

      <span class="reserved">return</span> false;
    })()
  },

  ScriptFragment: <span class="literal">'&lt;script[^&gt;]*&gt;([\\S\\s]*?)&lt;\/script&gt;'</span>,
  JSONFilter: /^\/\*-secure-([\s\S]*)\*\/\s*$/,

  emptyFunction: <span class="reserved">function</span>() { },
  K: <span class="reserved">function</span>(x) { <span class="reserved">return</span> x }
};

<span class="reserved">if</span> (Prototype.Browser.MobileSafari)
  Prototype.BrowserFeatures.SpecificElementExtensions = false;


var Abstract = { };


var Try = {
  these: <span class="reserved">function</span>() {
    var returnValue;

    <span class="reserved">for</span> (var i = 0, length = arguments.length; i &lt; length; i++) {
      var lambda = arguments[i];
      try {
        returnValue = lambda();
        break;
      } catch (e) { }
    }

    <span class="reserved">return</span> returnValue;
  }
};

<span class="comment">/* Based on Alex Arnell's inheritance implementation. */</span>

var Class = (<span class="reserved">function</span>() {
  <span class="reserved">function</span> create() {
    var parent = null, properties = $A(arguments);
    <span class="reserved">if</span> (Object.isFunction(properties[0]))
      parent = properties.shift();

    <span class="reserved">function</span> klass() {
      <span class="reserved">this</span>.initialize.apply(<span class="reserved">this</span>, arguments);
    }

    Object.extend(klass, Class.Methods);
    klass.superclass = parent;
    klass.subclasses = [];

    <span class="reserved">if</span> (parent) {
      var subclass = <span class="reserved">function</span>() {};
      subclass.<span class="reserved">prototype</span> = parent.<span class="reserved">prototype</span>;
      klass.<span class="reserved">prototype</span> = new subclass;
      parent.subclasses.push(klass);
    }

    <span class="reserved">for</span> (var i = 0; i &lt; properties.length; i++)
      klass.addMethods(properties[i]);

    <span class="reserved">if</span> (!klass.<span class="reserved">prototype</span>.initialize)
      klass.<span class="reserved">prototype</span>.initialize = Prototype.emptyFunction;

    klass.<span class="reserved">prototype</span>.constructor = klass;
    <span class="reserved">return</span> klass;
  }

  <span class="reserved">function</span> addMethods(source) {
    var ancestor   = <span class="reserved">this</span>.superclass &amp;&amp; <span class="reserved">this</span>.superclass.<span class="reserved">prototype</span>;
    var properties = Object.keys(source);

    <span class="reserved">if</span> (!Object.keys({ toString: true }).length) {
      <span class="reserved">if</span> (source.toString != Object.<span class="reserved">prototype</span>.toString)
        properties.push(<span class="literal">"toString"</span>);
      <span class="reserved">if</span> (source.valueOf != Object.<span class="reserved">prototype</span>.valueOf)
        properties.push(<span class="literal">"valueOf"</span>);
    }

    <span class="reserved">for</span> (var i = 0, length = properties.length; i &lt; length; i++) {
      var property = properties[i], value = source[property];
      <span class="reserved">if</span> (ancestor &amp;&amp; Object.isFunction(value) &amp;&amp;
          value.argumentNames().first() == <span class="literal">"$super"</span>) {
        var method = value;
        value = (<span class="reserved">function</span>(m) {
          <span class="reserved">return</span> <span class="reserved">function</span>() { <span class="reserved">return</span> ancestor[m].apply(<span class="reserved">this</span>, arguments); };
        })(property).wrap(method);

        value.valueOf = method.valueOf.bind(method);
        value.toString = method.toString.bind(method);
      }
      <span class="reserved">this</span>.<span class="reserved">prototype</span>[property] = value;
    }

    <span class="reserved">return</span> <span class="reserved">this</span>;
  }

  <span class="reserved">return</span> {
    create: create,
    Methods: {
      addMethods: addMethods
    }
  };
})();
(<span class="reserved">function</span>() {

  <span class="reserved">function</span> getClass(object) {
    <span class="reserved">return</span> Object.<span class="reserved">prototype</span>.toString.call(object)
     .match(/^\[object\s(.*)\]$/)[1];
  }

  <span class="reserved">function</span> extend(destination, source) {
    <span class="reserved">for</span> (var property in source)
      destination[property] = source[property];
    <span class="reserved">return</span> destination;
  }

  <span class="reserved">function</span> inspect(object) {
    try {
      <span class="reserved">if</span> (isUndefined(object)) <span class="reserved">return</span> <span class="literal">'undefined'</span>;
      <span class="reserved">if</span> (object === null) <span class="reserved">return</span> <span class="literal">'null'</span>;
      <span class="reserved">return</span> object.inspect ? object.inspect() : String(object);
    } catch (e) {
      <span class="reserved">if</span> (e instanceof RangeError) <span class="reserved">return</span> <span class="literal">'...'</span>;
      throw e;
    }
  }

  <span class="reserved">function</span> toJSON(object) {
    var type = typeof object;
    switch (type) {
      case <span class="literal">'undefined'</span>:
      case <span class="literal">'function'</span>:
      case <span class="literal">'unknown'</span>: <span class="reserved">return</span>;
      case <span class="literal">'boolean'</span>: <span class="reserved">return</span> object.toString();
    }

    <span class="reserved">if</span> (object === null) <span class="reserved">return</span> <span class="literal">'null'</span>;
    <span class="reserved">if</span> (object.toJSON) <span class="reserved">return</span> object.toJSON();
    <span class="reserved">if</span> (isElement(object)) <span class="reserved">return</span>;

    var results = [];
    <span class="reserved">for</span> (var property in object) {
      var value = toJSON(object[property]);
      <span class="reserved">if</span> (!isUndefined(value))
        results.push(property.toJSON() + <span class="literal">': '</span> + value);
    }

    <span class="reserved">return</span> <span class="literal">'{'</span> + results.join(<span class="literal">', '</span>) + <span class="literal">'}'</span>;
  }

  <span class="reserved">function</span> toQueryString(object) {
    <span class="reserved">return</span> $H(object).toQueryString();
  }

  <span class="reserved">function</span> toHTML(object) {
    <span class="reserved">return</span> object &amp;&amp; object.toHTML ? object.toHTML() : String.interpret(object);
  }

  <span class="reserved">function</span> keys(object) {
    var results = [];
    <span class="reserved">for</span> (var property in object)
      results.push(property);
    <span class="reserved">return</span> results;
  }

  <span class="reserved">function</span> values(object) {
    var results = [];
    <span class="reserved">for</span> (var property in object)
      results.push(object[property]);
    <span class="reserved">return</span> results;
  }

  <span class="reserved">function</span> clone(object) {
    <span class="reserved">return</span> extend({ }, object);
  }

  <span class="reserved">function</span> isElement(object) {
    <span class="reserved">return</span> !!(object &amp;&amp; object.nodeType == 1);
  }

  <span class="reserved">function</span> isArray(object) {
    <span class="reserved">return</span> getClass(object) === <span class="literal">"Array"</span>;
  }


  <span class="reserved">function</span> isHash(object) {
    <span class="reserved">return</span> object instanceof Hash;
  }

  <span class="reserved">function</span> isFunction(object) {
    <span class="reserved">return</span> typeof object === <span class="literal">"function"</span>;
  }

  <span class="reserved">function</span> isString(object) {
    <span class="reserved">return</span> getClass(object) === <span class="literal">"String"</span>;
  }

  <span class="reserved">function</span> isNumber(object) {
    <span class="reserved">return</span> getClass(object) === <span class="literal">"Number"</span>;
  }

  <span class="reserved">function</span> isUndefined(object) {
    <span class="reserved">return</span> typeof object === <span class="literal">"undefined"</span>;
  }

  extend(Object, {
    extend:        extend,
    inspect:       inspect,
    toJSON:        toJSON,
    toQueryString: toQueryString,
    toHTML:        toHTML,
    keys:          keys,
    values:        values,
    clone:         clone,
    isElement:     isElement,
    isArray:       isArray,
    isHash:        isHash,
    isFunction:    isFunction,
    isString:      isString,
    isNumber:      isNumber,
    isUndefined:   isUndefined
  });
})();
Object.extend(Function.<span class="reserved">prototype</span>, (<span class="reserved">function</span>() {
  var slice = Array.<span class="reserved">prototype</span>.slice;

  <span class="reserved">function</span> update(array, args) {
    var arrayLength = array.length, length = args.length;
    <span class="reserved">while</span> (length--) array[arrayLength + length] = args[length];
    <span class="reserved">return</span> array;
  }

  <span class="reserved">function</span> merge(array, args) {
    array = slice.call(array, 0);
    <span class="reserved">return</span> update(array, args);
  }

  <span class="reserved">function</span> argumentNames() {
    var names = <span class="reserved">this</span>.toString().match(/^[\s\(]*<span class="reserved">function</span>[^(]*\(([^)]*)\)/)[1]
      .replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\<span class="comment">//g, '')</span>
      .replace(/\s+/g, <span class="literal">''</span>).split(<span class="literal">','</span>);
    <span class="reserved">return</span> names.length == 1 &amp;&amp; !names[0] ? [] : names;
  }

  <span class="reserved">function</span> bind(context) {
    <span class="reserved">if</span> (arguments.length &lt; 2 &amp;&amp; Object.isUndefined(arguments[0])) <span class="reserved">return</span> <span class="reserved">this</span>;
    var __method = <span class="reserved">this</span>, args = slice.call(arguments, 1);
    <span class="reserved">return</span> <span class="reserved">function</span>() {
      var a = merge(args, arguments);
      <span class="reserved">return</span> __method.apply(context, a);
    }
  }

  <span class="reserved">function</span> bindAsEventListener(context) {
    var __method = <span class="reserved">this</span>, args = slice.call(arguments, 1);
    <span class="reserved">return</span> <span class="reserved">function</span>(event) {
      var a = update([event || window.event], args);
      <span class="reserved">return</span> __method.apply(context, a);
    }
  }

  <span class="reserved">function</span> curry() {
    <span class="reserved">if</span> (!arguments.length) <span class="reserved">return</span> <span class="reserved">this</span>;
    var __method = <span class="reserved">this</span>, args = slice.call(arguments, 0);
    <span class="reserved">return</span> <span class="reserved">function</span>() {
      var a = merge(args, arguments);
      <span class="reserved">return</span> __method.apply(<span class="reserved">this</span>, a);
    }
  }

  <span class="reserved">function</span> delay(timeout) {
    var __method = <span class="reserved">this</span>, args = slice.call(arguments, 1);
    timeout = timeout * 1000
    <span class="reserved">return</span> window.setTimeout(<span class="reserved">function</span>() {
      <span class="reserved">return</span> __method.apply(__method, args);
    }, timeout);
  }

  <span class="reserved">function</span> defer() {
    var args = update([0.01], arguments);
    <span class="reserved">return</span> <span class="reserved">this</span>.delay.apply(<span class="reserved">this</span>, args);
  }

  <span class="reserved">function</span> wrap(wrapper) {
    var __method = <span class="reserved">this</span>;
    <span class="reserved">return</span> <span class="reserved">function</span>() {
      var a = update([__method.bind(<span class="reserved">this</span>)], arguments);
      <span class="reserved">return</span> wrapper.apply(<span class="reserved">this</span>, a);
    }
  }

  <span class="reserved">function</span> methodize() {
    <span class="reserved">if</span> (<span class="reserved">this</span>._methodized) <span class="reserved">return</span> <span class="reserved">this</span>._methodized;
    var __method = <span class="reserved">this</span>;
    <span class="reserved">return</span> <span class="reserved">this</span>._methodized = <span class="reserved">function</span>() {
      var a = update([<span class="reserved">this</span>], arguments);
      <span class="reserved">return</span> __method.apply(null, a);
    };
  }

  <span class="reserved">return</span> {
    argumentNames:       argumentNames,
    bind:                bind,
    bindAsEventListener: bindAsEventListener,
    curry:               curry,
    delay:               delay,
    defer:               defer,
    wrap:                wrap,
    methodize:           methodize
  }
})());


Date.<span class="reserved">prototype</span>.toJSON = <span class="reserved">function</span>() {
  <span class="reserved">return</span> <span class="literal">'"'</span> + <span class="reserved">this</span>.getUTCFullYear() + <span class="literal">'-'</span> +
    (<span class="reserved">this</span>.getUTCMonth() + 1).toPaddedString(2) + <span class="literal">'-'</span> +
    <span class="reserved">this</span>.getUTCDate().toPaddedString(2) + <span class="literal">'T'</span> +
    <span class="reserved">this</span>.getUTCHours().toPaddedString(2) + <span class="literal">':'</span> +
    <span class="reserved">this</span>.getUTCMinutes().toPaddedString(2) + <span class="literal">':'</span> +
    <span class="reserved">this</span>.getUTCSeconds().toPaddedString(2) + <span class="literal">'Z"'</span>;
};


RegExp.<span class="reserved">prototype</span>.match = RegExp.<span class="reserved">prototype</span>.test;

RegExp.escape = <span class="reserved">function</span>(str) {
  <span class="reserved">return</span> String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g, <span class="literal">'\\$1'</span>);
};
var PeriodicalExecuter = Class.create({
  initialize: <span class="reserved">function</span>(callback, frequency) {
    <span class="reserved">this</span>.callback = callback;
    <span class="reserved">this</span>.frequency = frequency;
    <span class="reserved">this</span>.currentlyExecuting = false;

    <span class="reserved">this</span>.registerCallback();
  },

  registerCallback: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.timer = setInterval(<span class="reserved">this</span>.onTimerEvent.bind(<span class="reserved">this</span>), <span class="reserved">this</span>.frequency * 1000);
  },

  execute: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.callback(<span class="reserved">this</span>);
  },

  stop: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (!<span class="reserved">this</span>.timer) <span class="reserved">return</span>;
    clearInterval(<span class="reserved">this</span>.timer);
    <span class="reserved">this</span>.timer = null;
  },

  onTimerEvent: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (!<span class="reserved">this</span>.currentlyExecuting) {
      try {
        <span class="reserved">this</span>.currentlyExecuting = true;
        <span class="reserved">this</span>.execute();
      } catch(e) {
        <span class="comment">/* empty catch for clients that don't support try/finally */</span>
      }
      finally {
        <span class="reserved">this</span>.currentlyExecuting = false;
      }
    }
  }
});
Object.extend(String, {
  interpret: <span class="reserved">function</span>(value) {
    <span class="reserved">return</span> value == null ? <span class="literal">''</span> : String(value);
  },
  specialChar: {
    <span class="literal">'\b'</span>: <span class="literal">'\\b'</span>,
    <span class="literal">'\t'</span>: <span class="literal">'\\t'</span>,
    <span class="literal">'\n'</span>: <span class="literal">'\\n'</span>,
    <span class="literal">'\f'</span>: <span class="literal">'\\f'</span>,
    <span class="literal">'\r'</span>: <span class="literal">'\\r'</span>,
    <span class="literal">'\\'</span>: <span class="literal">'\\\\'</span>
  }
});

Object.extend(String.<span class="reserved">prototype</span>, (<span class="reserved">function</span>() {

  <span class="reserved">function</span> prepareReplacement(replacement) {
    <span class="reserved">if</span> (Object.isFunction(replacement)) <span class="reserved">return</span> replacement;
    var template = new Template(replacement);
    <span class="reserved">return</span> <span class="reserved">function</span>(match) { <span class="reserved">return</span> template.evaluate(match) };
  }

  <span class="reserved">function</span> gsub(pattern, replacement) {
    var result = <span class="literal">''</span>, source = <span class="reserved">this</span>, match;
    replacement = prepareReplacement(replacement);

    <span class="reserved">if</span> (Object.isString(pattern))
      pattern = RegExp.escape(pattern);

    <span class="reserved">if</span> (!(pattern.length || pattern.source)) {
      replacement = replacement(<span class="literal">''</span>);
      <span class="reserved">return</span> replacement + source.split(<span class="literal">''</span>).join(replacement) + replacement;
    }

    <span class="reserved">while</span> (source.length &gt; 0) {
      <span class="reserved">if</span> (match = source.match(pattern)) {
        result += source.slice(0, match.index);
        result += String.interpret(replacement(match));
        source  = source.slice(match.index + match[0].length);
      } <span class="reserved">else</span> {
        result += source, source = <span class="literal">''</span>;
      }
    }
    <span class="reserved">return</span> result;
  }

  <span class="reserved">function</span> sub(pattern, replacement, count) {
    replacement = prepareReplacement(replacement);
    count = Object.isUndefined(count) ? 1 : count;

    <span class="reserved">return</span> <span class="reserved">this</span>.gsub(pattern, <span class="reserved">function</span>(match) {
      <span class="reserved">if</span> (--count &lt; 0) <span class="reserved">return</span> match[0];
      <span class="reserved">return</span> replacement(match);
    });
  }

  <span class="reserved">function</span> scan(pattern, iterator) {
    <span class="reserved">this</span>.gsub(pattern, iterator);
    <span class="reserved">return</span> String(<span class="reserved">this</span>);
  }

  <span class="reserved">function</span> truncate(length, truncation) {
    length = length || 30;
    truncation = Object.isUndefined(truncation) ? <span class="literal">'...'</span> : truncation;
    <span class="reserved">return</span> <span class="reserved">this</span>.length &gt; length ?
      <span class="reserved">this</span>.slice(0, length - truncation.length) + truncation : String(<span class="reserved">this</span>);
  }

  <span class="reserved">function</span> strip() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(/^\s+/, <span class="literal">''</span>).replace(/\s+$/, <span class="literal">''</span>);
  }

  <span class="reserved">function</span> stripTags() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(/&lt;\/?[^&gt;]+&gt;/gi, <span class="literal">''</span>);
  }

  <span class="reserved">function</span> stripScripts() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(new RegExp(Prototype.ScriptFragment, <span class="literal">'img'</span>), <span class="literal">''</span>);
  }

  <span class="reserved">function</span> extractScripts() {
    var matchAll = new RegExp(Prototype.ScriptFragment, <span class="literal">'img'</span>);
    var matchOne = new RegExp(Prototype.ScriptFragment, <span class="literal">'im'</span>);
    <span class="reserved">return</span> (<span class="reserved">this</span>.match(matchAll) || []).map(<span class="reserved">function</span>(scriptTag) {
      <span class="reserved">return</span> (scriptTag.match(matchOne) || [<span class="literal">''</span>, <span class="literal">''</span>])[1];
    });
  }

  <span class="reserved">function</span> evalScripts() {
    <span class="reserved">return</span> <span class="reserved">this</span>.extractScripts().map(<span class="reserved">function</span>(script) { <span class="reserved">return</span> eval(script) });
  }

  <span class="reserved">function</span> escapeHTML() {
    escapeHTML.text.data = <span class="reserved">this</span>;
    <span class="reserved">return</span> escapeHTML.div.innerHTML;
  }

  <span class="reserved">function</span> unescapeHTML() {
    var div = document.createElement(<span class="literal">'div'</span>);
    div.innerHTML = <span class="reserved">this</span>.stripTags();
    <span class="reserved">return</span> div.childNodes[0] ? (div.childNodes.length &gt; 1 ?
      $A(div.childNodes).inject(<span class="literal">''</span>, <span class="reserved">function</span>(memo, node) { <span class="reserved">return</span> memo+node.nodeValue }) :
      div.childNodes[0].nodeValue) : <span class="literal">''</span>;
  }

  <span class="reserved">function</span> toQueryParams(separator) {
    var match = <span class="reserved">this</span>.strip().match(/([^?#]*)(#.*)?$/);
    <span class="reserved">if</span> (!match) <span class="reserved">return</span> { };

    <span class="reserved">return</span> match[1].split(separator || <span class="literal">'&amp;'</span>).inject({ }, <span class="reserved">function</span>(hash, pair) {
      <span class="reserved">if</span> ((pair = pair.split(<span class="literal">'='</span>))[0]) {
        var key = decodeURIComponent(pair.shift());
        var value = pair.length &gt; 1 ? pair.join(<span class="literal">'='</span>) : pair[0];
        <span class="reserved">if</span> (value != undefined) value = decodeURIComponent(value);

        <span class="reserved">if</span> (key in hash) {
          <span class="reserved">if</span> (!Object.isArray(hash[key])) hash[key] = [hash[key]];
          hash[key].push(value);
        }
        <span class="reserved">else</span> hash[key] = value;
      }
      <span class="reserved">return</span> hash;
    });
  }

  <span class="reserved">function</span> toArray() {
    <span class="reserved">return</span> <span class="reserved">this</span>.split(<span class="literal">''</span>);
  }

  <span class="reserved">function</span> succ() {
    <span class="reserved">return</span> <span class="reserved">this</span>.slice(0, <span class="reserved">this</span>.length - 1) +
      String.fromCharCode(<span class="reserved">this</span>.charCodeAt(<span class="reserved">this</span>.length - 1) + 1);
  }

  <span class="reserved">function</span> times(count) {
    <span class="reserved">return</span> count &lt; 1 ? <span class="literal">''</span> : new Array(count + 1).join(<span class="reserved">this</span>);
  }

  <span class="reserved">function</span> camelize() {
    var parts = <span class="reserved">this</span>.split(<span class="literal">'-'</span>), len = parts.length;
    <span class="reserved">if</span> (len == 1) <span class="reserved">return</span> parts[0];

    var camelized = <span class="reserved">this</span>.charAt(0) == <span class="literal">'-'</span>
      ? parts[0].charAt(0).toUpperCase() + parts[0].substring(1)
      : parts[0];

    <span class="reserved">for</span> (var i = 1; i &lt; len; i++)
      camelized += parts[i].charAt(0).toUpperCase() + parts[i].substring(1);

    <span class="reserved">return</span> camelized;
  }

  <span class="reserved">function</span> capitalize() {
    <span class="reserved">return</span> <span class="reserved">this</span>.charAt(0).toUpperCase() + <span class="reserved">this</span>.substring(1).toLowerCase();
  }

  <span class="reserved">function</span> underscore() {
    <span class="reserved">return</span> <span class="reserved">this</span>.gsub(/::/, <span class="literal">'/'</span>).gsub(/([A-Z]+)([A-Z][a-z])/,<span class="literal">'#{1}_#{2}'</span>).gsub(/([a-z\d])([A-Z])/,<span class="literal">'#{1}_#{2}'</span>).gsub(/-/,<span class="literal">'_'</span>).toLowerCase();
  }

  <span class="reserved">function</span> dasherize() {
    <span class="reserved">return</span> <span class="reserved">this</span>.gsub(/_/,<span class="literal">'-'</span>);
  }

  <span class="reserved">function</span> inspect(useDoubleQuotes) {
    var escapedString = <span class="reserved">this</span>.gsub(/[\x00-\x1f\\]/, <span class="reserved">function</span>(match) {
      var character = String.specialChar[match[0]];
      <span class="reserved">return</span> character ? character : <span class="literal">'\\u00'</span> + match[0].charCodeAt().toPaddedString(2, 16);
    });
    <span class="reserved">if</span> (useDoubleQuotes) <span class="reserved">return</span> <span class="literal">'"'</span> + escapedString.replace(/<span class="literal">"/g, '\\"</span><span class="literal">') + '</span><span class="literal">"';
    return "</span><span class="literal">'" + escapedString.replace(/'</span>/g, <span class="literal">'\\\'</span><span class="literal">') + "'</span><span class="literal">";
  }

  function toJSON() {
    return this.inspect(true);
  }

  function unfilterJSON(filter) {
    return this.sub(filter || Prototype.JSONFilter, '#{1}');
  }

  function isJSON() {
    var str = this;
    if (str.blank()) return false;
    str = this.replace(/\\./g, '@').replace(/"</span>[^<span class="literal">"\\\n\r]*"</span>/g, <span class="literal">''</span>);
    <span class="reserved">return</span> (/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/).test(str);
  }

  <span class="reserved">function</span> evalJSON(sanitize) {
    var json = <span class="reserved">this</span>.unfilterJSON();
    try {
      <span class="reserved">if</span> (!sanitize || json.isJSON()) <span class="reserved">return</span> eval(<span class="literal">'('</span> + json + <span class="literal">')'</span>);
    } catch (e) { }
    throw new SyntaxError(<span class="literal">'Badly formed JSON string: '</span> + <span class="reserved">this</span>.inspect());
  }

  <span class="reserved">function</span> include(pattern) {
    <span class="reserved">return</span> <span class="reserved">this</span>.indexOf(pattern) &gt; -1;
  }

  <span class="reserved">function</span> startsWith(pattern) {
    <span class="reserved">return</span> <span class="reserved">this</span>.indexOf(pattern) === 0;
  }

  <span class="reserved">function</span> endsWith(pattern) {
    var d = <span class="reserved">this</span>.length - pattern.length;
    <span class="reserved">return</span> d &gt;= 0 &amp;&amp; <span class="reserved">this</span>.lastIndexOf(pattern) === d;
  }

  <span class="reserved">function</span> empty() {
    <span class="reserved">return</span> <span class="reserved">this</span> == <span class="literal">''</span>;
  }

  <span class="reserved">function</span> blank() {
    <span class="reserved">return</span> /^\s*$/.test(<span class="reserved">this</span>);
  }

  <span class="reserved">function</span> interpolate(object, pattern) {
    <span class="reserved">return</span> new Template(<span class="reserved">this</span>, pattern).evaluate(object);
  }

  <span class="reserved">return</span> {
    gsub:           gsub,
    sub:            sub,
    scan:           scan,
    truncate:       truncate,
    strip:          strip,
    stripTags:      stripTags,
    stripScripts:   stripScripts,
    extractScripts: extractScripts,
    evalScripts:    evalScripts,
    escapeHTML:     escapeHTML,
    unescapeHTML:   unescapeHTML,
    toQueryParams:  toQueryParams,
    parseQuery:     toQueryParams,
    toArray:        toArray,
    succ:           succ,
    times:          times,
    camelize:       camelize,
    capitalize:     capitalize,
    underscore:     underscore,
    dasherize:      dasherize,
    inspect:        inspect,
    toJSON:         toJSON,
    unfilterJSON:   unfilterJSON,
    isJSON:         isJSON,
    evalJSON:       evalJSON,
    include:        include,
    startsWith:     startsWith,
    endsWith:       endsWith,
    empty:          empty,
    blank:          blank,
    interpolate:    interpolate
  };
})());

Object.extend(String.<span class="reserved">prototype</span>.escapeHTML, {
  div:  document.createElement(<span class="literal">'div'</span>),
  text: document.createTextNode(<span class="literal">''</span>)
});

String.<span class="reserved">prototype</span>.escapeHTML.div.appendChild(String.<span class="reserved">prototype</span>.escapeHTML.text);

<span class="reserved">if</span> (<span class="literal">'&lt;\n&gt;'</span>.escapeHTML() !== <span class="literal">'&amp;lt;\n&amp;gt;'</span>) {
  String.<span class="reserved">prototype</span>.escapeHTML = <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(/&amp;/g,<span class="literal">'&amp;amp;'</span>).replace(/&lt;/g,<span class="literal">'&amp;lt;'</span>).replace(/&gt;/g,<span class="literal">'&amp;gt;'</span>);
  }
}

<span class="reserved">if</span> (<span class="literal">'&amp;lt;\n&amp;gt;'</span>.unescapeHTML() !== <span class="literal">'&lt;\n&gt;'</span>) {
  String.<span class="reserved">prototype</span>.unescapeHTML = <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.stripTags().replace(/&amp;lt;/g,<span class="literal">'&lt;'</span>).replace(/&amp;gt;/g,<span class="literal">'&gt;'</span>).replace(/&amp;amp;/g,<span class="literal">'&amp;'</span>);
  }
}
var Template = Class.create({
  initialize: <span class="reserved">function</span>(template, pattern) {
    <span class="reserved">this</span>.template = template.toString();
    <span class="reserved">this</span>.pattern = pattern || Template.Pattern;
  },

  evaluate: <span class="reserved">function</span>(object) {
    <span class="reserved">if</span> (Object.isFunction(object.toTemplateReplacements))
      object = object.toTemplateReplacements();

    <span class="reserved">return</span> <span class="reserved">this</span>.template.gsub(<span class="reserved">this</span>.pattern, <span class="reserved">function</span>(match) {
      <span class="reserved">if</span> (object == null) <span class="reserved">return</span> <span class="literal">''</span>;

      var before = match[1] || <span class="literal">''</span>;
      <span class="reserved">if</span> (before == <span class="literal">'\\'</span>) <span class="reserved">return</span> match[2];

      var ctx = object, expr = match[3];
      var pattern = /^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;
      match = pattern.exec(expr);
      <span class="reserved">if</span> (match == null) <span class="reserved">return</span> before;

      <span class="reserved">while</span> (match != null) {
        var comp = match[1].startsWith(<span class="literal">'['</span>) ? match[2].gsub(<span class="literal">'\\\\]'</span>, <span class="literal">']'</span>) : match[1];
        ctx = ctx[comp];
        <span class="reserved">if</span> (null == ctx || <span class="literal">''</span> == match[3]) break;
        expr = expr.substring(<span class="literal">'['</span> == match[3] ? match[1].length : match[0].length);
        match = pattern.exec(expr);
      }

      <span class="reserved">return</span> before + String.interpret(ctx);
    });
  }
});
Template.Pattern = /(^|.|\r|\n)(#\{(.*?)\})/;

var $break = { };

var Enumerable = (<span class="reserved">function</span>() {
  <span class="reserved">function</span> each(iterator, context) {
    var index = 0;
    try {
      <span class="reserved">this</span>._each(<span class="reserved">function</span>(value) {
        iterator.call(context, value, index++);
      });
    } catch (e) {
      <span class="reserved">if</span> (e != $break) throw e;
    }
    <span class="reserved">return</span> <span class="reserved">this</span>;
  }

  <span class="reserved">function</span> eachSlice(number, iterator, context) {
    var index = -number, slices = [], array = <span class="reserved">this</span>.toArray();
    <span class="reserved">if</span> (number &lt; 1) <span class="reserved">return</span> array;
    <span class="reserved">while</span> ((index += number) &lt; array.length)
      slices.push(array.slice(index, index+number));
    <span class="reserved">return</span> slices.collect(iterator, context);
  }

  <span class="reserved">function</span> all(iterator, context) {
    iterator = iterator || Prototype.K;
    var result = true;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      result = result &amp;&amp; !!iterator.call(context, value, index);
      <span class="reserved">if</span> (!result) throw $break;
    });
    <span class="reserved">return</span> result;
  }

  <span class="reserved">function</span> any(iterator, context) {
    iterator = iterator || Prototype.K;
    var result = false;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (result = !!iterator.call(context, value, index))
        throw $break;
    });
    <span class="reserved">return</span> result;
  }

  <span class="reserved">function</span> collect(iterator, context) {
    iterator = iterator || Prototype.K;
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      results.push(iterator.call(context, value, index));
    });
    <span class="reserved">return</span> results;
  }

  <span class="reserved">function</span> detect(iterator, context) {
    var result;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (iterator.call(context, value, index)) {
        result = value;
        throw $break;
      }
    });
    <span class="reserved">return</span> result;
  }

  <span class="reserved">function</span> findAll(iterator, context) {
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (iterator.call(context, value, index))
        results.push(value);
    });
    <span class="reserved">return</span> results;
  }

  <span class="reserved">function</span> grep(filter, iterator, context) {
    iterator = iterator || Prototype.K;
    var results = [];

    <span class="reserved">if</span> (Object.isString(filter))
      filter = new RegExp(RegExp.escape(filter));

    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (filter.match(value))
        results.push(iterator.call(context, value, index));
    });
    <span class="reserved">return</span> results;
  }

  <span class="reserved">function</span> include(object) {
    <span class="reserved">if</span> (Object.isFunction(<span class="reserved">this</span>.indexOf))
      <span class="reserved">if</span> (<span class="reserved">this</span>.indexOf(object) != -1) <span class="reserved">return</span> true;

    var found = false;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value) {
      <span class="reserved">if</span> (value == object) {
        found = true;
        throw $break;
      }
    });
    <span class="reserved">return</span> found;
  }

  <span class="reserved">function</span> inGroupsOf(number, fillWith) {
    fillWith = Object.isUndefined(fillWith) ? null : fillWith;
    <span class="reserved">return</span> <span class="reserved">this</span>.eachSlice(number, <span class="reserved">function</span>(slice) {
      <span class="reserved">while</span>(slice.length &lt; number) slice.push(fillWith);
      <span class="reserved">return</span> slice;
    });
  }

  <span class="reserved">function</span> inject(memo, iterator, context) {
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      memo = iterator.call(context, memo, value, index);
    });
    <span class="reserved">return</span> memo;
  }

  <span class="reserved">function</span> invoke(method) {
    var args = $A(arguments).slice(1);
    <span class="reserved">return</span> <span class="reserved">this</span>.map(<span class="reserved">function</span>(value) {
      <span class="reserved">return</span> value[method].apply(value, args);
    });
  }

  <span class="reserved">function</span> max(iterator, context) {
    iterator = iterator || Prototype.K;
    var result;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      value = iterator.call(context, value, index);
      <span class="reserved">if</span> (result == null || value &gt;= result)
        result = value;
    });
    <span class="reserved">return</span> result;
  }

  <span class="reserved">function</span> min(iterator, context) {
    iterator = iterator || Prototype.K;
    var result;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      value = iterator.call(context, value, index);
      <span class="reserved">if</span> (result == null || value &lt; result)
        result = value;
    });
    <span class="reserved">return</span> result;
  }

  <span class="reserved">function</span> partition(iterator, context) {
    iterator = iterator || Prototype.K;
    var trues = [], falses = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      (iterator.call(context, value, index) ?
        trues : falses).push(value);
    });
    <span class="reserved">return</span> [trues, falses];
  }

  <span class="reserved">function</span> pluck(property) {
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value) {
      results.push(value[property]);
    });
    <span class="reserved">return</span> results;
  }

  <span class="reserved">function</span> reject(iterator, context) {
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (!iterator.call(context, value, index))
        results.push(value);
    });
    <span class="reserved">return</span> results;
  }

  <span class="reserved">function</span> sortBy(iterator, context) {
    <span class="reserved">return</span> <span class="reserved">this</span>.map(<span class="reserved">function</span>(value, index) {
      <span class="reserved">return</span> {
        value: value,
        criteria: iterator.call(context, value, index)
      };
    }).sort(<span class="reserved">function</span>(left, right) {
      var a = left.criteria, b = right.criteria;
      <span class="reserved">return</span> a &lt; b ? -1 : a &gt; b ? 1 : 0;
    }).pluck(<span class="literal">'value'</span>);
  }

  <span class="reserved">function</span> toArray() {
    <span class="reserved">return</span> <span class="reserved">this</span>.map();
  }

  <span class="reserved">function</span> zip() {
    var iterator = Prototype.K, args = $A(arguments);
    <span class="reserved">if</span> (Object.isFunction(args.last()))
      iterator = args.pop();

    var collections = [<span class="reserved">this</span>].concat(args).map($A);
    <span class="reserved">return</span> <span class="reserved">this</span>.map(<span class="reserved">function</span>(value, index) {
      <span class="reserved">return</span> iterator(collections.pluck(index));
    });
  }

  <span class="reserved">function</span> size() {
    <span class="reserved">return</span> <span class="reserved">this</span>.toArray().length;
  }

  <span class="reserved">function</span> inspect() {
    <span class="reserved">return</span> <span class="literal">'#&lt;Enumerable:'</span> + <span class="reserved">this</span>.toArray().inspect() + <span class="literal">'&gt;'</span>;
  }









  <span class="reserved">return</span> {
    each:       each,
    eachSlice:  eachSlice,
    all:        all,
    every:      all,
    any:        any,
    some:       any,
    collect:    collect,
    map:        collect,
    detect:     detect,
    findAll:    findAll,
    select:     findAll,
    filter:     findAll,
    grep:       grep,
    include:    include,
    member:     include,
    inGroupsOf: inGroupsOf,
    inject:     inject,
    invoke:     invoke,
    max:        max,
    min:        min,
    partition:  partition,
    pluck:      pluck,
    reject:     reject,
    sortBy:     sortBy,
    toArray:    toArray,
    entries:    toArray,
    zip:        zip,
    size:       size,
    inspect:    inspect,
    find:       detect
  };
})();
<span class="reserved">function</span> $A(iterable) {
  <span class="reserved">if</span> (!iterable) <span class="reserved">return</span> [];
  <span class="reserved">if</span> (<span class="literal">'toArray'</span> in iterable) <span class="reserved">return</span> iterable.toArray();
  var length = iterable.length || 0, results = new Array(length);
  <span class="reserved">while</span> (length--) results[length] = iterable[length];
  <span class="reserved">return</span> results;
}

<span class="reserved">function</span> $w(string) {
  <span class="reserved">if</span> (!Object.isString(string)) <span class="reserved">return</span> [];
  string = string.strip();
  <span class="reserved">return</span> string ? string.split(/\s+/) : [];
}

Array.from = $A;


(<span class="reserved">function</span>() {
  var arrayProto = Array.<span class="reserved">prototype</span>,
      slice = arrayProto.slice,
      _each = arrayProto.forEach; <span class="comment">// use native browser JS 1.6 implementation if available</span>

  <span class="reserved">function</span> each(iterator) {
    <span class="reserved">for</span> (var i = 0, length = <span class="reserved">this</span>.length; i &lt; length; i++)
      iterator(<span class="reserved">this</span>[i]);
  }
  <span class="reserved">if</span> (!_each) _each = each;

  <span class="reserved">function</span> clear() {
    <span class="reserved">this</span>.length = 0;
    <span class="reserved">return</span> <span class="reserved">this</span>;
  }

  <span class="reserved">function</span> first() {
    <span class="reserved">return</span> <span class="reserved">this</span>[0];
  }

  <span class="reserved">function</span> last() {
    <span class="reserved">return</span> <span class="reserved">this</span>[<span class="reserved">this</span>.length - 1];
  }

  <span class="reserved">function</span> compact() {
    <span class="reserved">return</span> <span class="reserved">this</span>.select(<span class="reserved">function</span>(value) {
      <span class="reserved">return</span> value != null;
    });
  }

  <span class="reserved">function</span> flatten() {
    <span class="reserved">return</span> <span class="reserved">this</span>.inject([], <span class="reserved">function</span>(array, value) {
      <span class="reserved">if</span> (Object.isArray(value))
        <span class="reserved">return</span> array.concat(value.flatten());
      array.push(value);
      <span class="reserved">return</span> array;
    });
  }

  <span class="reserved">function</span> without() {
    var values = slice.call(arguments, 0);
    <span class="reserved">return</span> <span class="reserved">this</span>.select(<span class="reserved">function</span>(value) {
      <span class="reserved">return</span> !values.include(value);
    });
  }

  <span class="reserved">function</span> reverse(inline) {
    <span class="reserved">return</span> (inline !== false ? <span class="reserved">this</span> : <span class="reserved">this</span>.toArray())._reverse();
  }

  <span class="reserved">function</span> uniq(sorted) {
    <span class="reserved">return</span> <span class="reserved">this</span>.inject([], <span class="reserved">function</span>(array, value, index) {
      <span class="reserved">if</span> (0 == index || (sorted ? array.last() != value : !array.include(value)))
        array.push(value);
      <span class="reserved">return</span> array;
    });
  }

  <span class="reserved">function</span> intersect(array) {
    <span class="reserved">return</span> <span class="reserved">this</span>.uniq().findAll(<span class="reserved">function</span>(item) {
      <span class="reserved">return</span> array.detect(<span class="reserved">function</span>(value) { <span class="reserved">return</span> item === value });
    });
  }


  <span class="reserved">function</span> clone() {
    <span class="reserved">return</span> slice.call(<span class="reserved">this</span>, 0);
  }

  <span class="reserved">function</span> size() {
    <span class="reserved">return</span> <span class="reserved">this</span>.length;
  }

  <span class="reserved">function</span> inspect() {
    <span class="reserved">return</span> <span class="literal">'['</span> + <span class="reserved">this</span>.map(Object.inspect).join(<span class="literal">', '</span>) + <span class="literal">']'</span>;
  }

  <span class="reserved">function</span> toJSON() {
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(object) {
      var value = Object.toJSON(object);
      <span class="reserved">if</span> (!Object.isUndefined(value)) results.push(value);
    });
    <span class="reserved">return</span> <span class="literal">'['</span> + results.join(<span class="literal">', '</span>) + <span class="literal">']'</span>;
  }

  <span class="reserved">function</span> indexOf(item, i) {
    i || (i = 0);
    var length = <span class="reserved">this</span>.length;
    <span class="reserved">if</span> (i &lt; 0) i = length + i;
    <span class="reserved">for</span> (; i &lt; length; i++)
      <span class="reserved">if</span> (<span class="reserved">this</span>[i] === item) <span class="reserved">return</span> i;
    <span class="reserved">return</span> -1;
  }

  <span class="reserved">function</span> lastIndexOf(item, i) {
    i = isNaN(i) ? <span class="reserved">this</span>.length : (i &lt; 0 ? <span class="reserved">this</span>.length + i : i) + 1;
    var n = <span class="reserved">this</span>.slice(0, i).reverse().indexOf(item);
    <span class="reserved">return</span> (n &lt; 0) ? n : i - n - 1;
  }

  <span class="reserved">function</span> concat() {
    var array = slice.call(<span class="reserved">this</span>, 0), item;
    <span class="reserved">for</span> (var i = 0, length = arguments.length; i &lt; length; i++) {
      item = arguments[i];
      <span class="reserved">if</span> (Object.isArray(item) &amp;&amp; !(<span class="literal">'callee'</span> in item)) {
        <span class="reserved">for</span> (var j = 0, arrayLength = item.length; j &lt; arrayLength; j++)
          array.push(item[j]);
      } <span class="reserved">else</span> {
        array.push(item);
      }
    }
    <span class="reserved">return</span> array;
  }

  Object.extend(arrayProto, Enumerable);

  <span class="reserved">if</span> (!arrayProto._reverse)
    arrayProto._reverse = arrayProto.reverse;

  Object.extend(arrayProto, {
    _each:     _each,
    clear:     clear,
    first:     first,
    last:      last,
    compact:   compact,
    flatten:   flatten,
    without:   without,
    reverse:   reverse,
    uniq:      uniq,
    intersect: intersect,
    clone:     clone,
    toArray:   clone,
    size:      size,
    inspect:   inspect,
    toJSON:    toJSON
  });

  var CONCAT_ARGUMENTS_BUGGY = (<span class="reserved">function</span>() {
    <span class="reserved">return</span> [].concat(arguments)[0][0] !== 1;
  })(1,2)

  <span class="reserved">if</span> (CONCAT_ARGUMENTS_BUGGY) arrayProto.concat = concat;

  <span class="reserved">if</span> (!arrayProto.indexOf) arrayProto.indexOf = indexOf;
  <span class="reserved">if</span> (!arrayProto.lastIndexOf) arrayProto.lastIndexOf = lastIndexOf;
})();
<span class="reserved">function</span> $H(object) {
  <span class="reserved">return</span> new Hash(object);
};

var Hash = Class.create(Enumerable, (<span class="reserved">function</span>() {
  <span class="reserved">function</span> initialize(object) {
    <span class="reserved">this</span>._object = Object.isHash(object) ? object.toObject() : Object.clone(object);
  }

  <span class="reserved">function</span> _each(iterator) {
    <span class="reserved">for</span> (var key in <span class="reserved">this</span>._object) {
      var value = <span class="reserved">this</span>._object[key], pair = [key, value];
      pair.key = key;
      pair.value = value;
      iterator(pair);
    }
  }

  <span class="reserved">function</span> set(key, value) {
    <span class="reserved">return</span> <span class="reserved">this</span>._object[key] = value;
  }

  <span class="reserved">function</span> get(key) {
    <span class="reserved">if</span> (<span class="reserved">this</span>._object[key] !== Object.<span class="reserved">prototype</span>[key])
      <span class="reserved">return</span> <span class="reserved">this</span>._object[key];
  }

  <span class="reserved">function</span> unset(key) {
    var value = <span class="reserved">this</span>._object[key];
    delete <span class="reserved">this</span>._object[key];
    <span class="reserved">return</span> value;
  }

  <span class="reserved">function</span> toObject() {
    <span class="reserved">return</span> Object.clone(<span class="reserved">this</span>._object);
  }

  <span class="reserved">function</span> keys() {
    <span class="reserved">return</span> <span class="reserved">this</span>.pluck(<span class="literal">'key'</span>);
  }

  <span class="reserved">function</span> values() {
    <span class="reserved">return</span> <span class="reserved">this</span>.pluck(<span class="literal">'value'</span>);
  }

  <span class="reserved">function</span> index(value) {
    var match = <span class="reserved">this</span>.detect(<span class="reserved">function</span>(pair) {
      <span class="reserved">return</span> pair.value === value;
    });
    <span class="reserved">return</span> match &amp;&amp; match.key;
  }

  <span class="reserved">function</span> merge(object) {
    <span class="reserved">return</span> <span class="reserved">this</span>.clone().update(object);
  }

  <span class="reserved">function</span> update(object) {
    <span class="reserved">return</span> new Hash(object).inject(<span class="reserved">this</span>, <span class="reserved">function</span>(result, pair) {
      result.set(pair.key, pair.value);
      <span class="reserved">return</span> result;
    });
  }

  <span class="reserved">function</span> toQueryPair(key, value) {
    <span class="reserved">if</span> (Object.isUndefined(value)) <span class="reserved">return</span> key;
    <span class="reserved">return</span> key + <span class="literal">'='</span> + encodeURIComponent(String.interpret(value));
  }

  <span class="reserved">function</span> toQueryString() {
    <span class="reserved">return</span> <span class="reserved">this</span>.inject([], <span class="reserved">function</span>(results, pair) {
      var key = encodeURIComponent(pair.key), values = pair.value;

      <span class="reserved">if</span> (values &amp;&amp; typeof values == <span class="literal">'object'</span>) {
        <span class="reserved">if</span> (Object.isArray(values))
          <span class="reserved">return</span> results.concat(values.map(toQueryPair.curry(key)));
      } <span class="reserved">else</span> results.push(toQueryPair(key, values));
      <span class="reserved">return</span> results;
    }).join(<span class="literal">'&amp;'</span>);
  }

  <span class="reserved">function</span> inspect() {
    <span class="reserved">return</span> <span class="literal">'#&lt;Hash:{'</span> + <span class="reserved">this</span>.map(<span class="reserved">function</span>(pair) {
      <span class="reserved">return</span> pair.map(Object.inspect).join(<span class="literal">': '</span>);
    }).join(<span class="literal">', '</span>) + <span class="literal">'}&gt;'</span>;
  }

  <span class="reserved">function</span> toJSON() {
    <span class="reserved">return</span> Object.toJSON(<span class="reserved">this</span>.toObject());
  }

  <span class="reserved">function</span> clone() {
    <span class="reserved">return</span> new Hash(<span class="reserved">this</span>);
  }

  <span class="reserved">return</span> {
    initialize:             initialize,
    _each:                  _each,
    set:                    set,
    get:                    get,
    unset:                  unset,
    toObject:               toObject,
    toTemplateReplacements: toObject,
    keys:                   keys,
    values:                 values,
    index:                  index,
    merge:                  merge,
    update:                 update,
    toQueryString:          toQueryString,
    inspect:                inspect,
    toJSON:                 toJSON,
    clone:                  clone
  };
})());

Hash.from = $H;
Object.extend(Number.<span class="reserved">prototype</span>, (<span class="reserved">function</span>() {
  <span class="reserved">function</span> toColorPart() {
    <span class="reserved">return</span> <span class="reserved">this</span>.toPaddedString(2, 16);
  }

  <span class="reserved">function</span> succ() {
    <span class="reserved">return</span> <span class="reserved">this</span> + 1;
  }

  <span class="reserved">function</span> times(iterator, context) {
    $R(0, <span class="reserved">this</span>, true).each(iterator, context);
    <span class="reserved">return</span> <span class="reserved">this</span>;
  }

  <span class="reserved">function</span> toPaddedString(length, radix) {
    var string = <span class="reserved">this</span>.toString(radix || 10);
    <span class="reserved">return</span> <span class="literal">'0'</span>.times(length - string.length) + string;
  }

  <span class="reserved">function</span> toJSON() {
    <span class="reserved">return</span> isFinite(<span class="reserved">this</span>) ? <span class="reserved">this</span>.toString() : <span class="literal">'null'</span>;
  }

  <span class="reserved">function</span> abs() {
    <span class="reserved">return</span> Math.abs(<span class="reserved">this</span>);
  }

  <span class="reserved">function</span> round() {
    <span class="reserved">return</span> Math.round(<span class="reserved">this</span>);
  }

  <span class="reserved">function</span> ceil() {
    <span class="reserved">return</span> Math.ceil(<span class="reserved">this</span>);
  }

  <span class="reserved">function</span> floor() {
    <span class="reserved">return</span> Math.floor(<span class="reserved">this</span>);
  }

  <span class="reserved">return</span> {
    toColorPart:    toColorPart,
    succ:           succ,
    times:          times,
    toPaddedString: toPaddedString,
    toJSON:         toJSON,
    abs:            abs,
    round:          round,
    ceil:           ceil,
    floor:          floor
  };
})());

<span class="reserved">function</span> $R(start, end, exclusive) {
  <span class="reserved">return</span> new ObjectRange(start, end, exclusive);
}

var ObjectRange = Class.create(Enumerable, (<span class="reserved">function</span>() {
  <span class="reserved">function</span> initialize(start, end, exclusive) {
    <span class="reserved">this</span>.start = start;
    <span class="reserved">this</span>.end = end;
    <span class="reserved">this</span>.exclusive = exclusive;
  }

  <span class="reserved">function</span> _each(iterator) {
    var value = <span class="reserved">this</span>.start;
    <span class="reserved">while</span> (<span class="reserved">this</span>.include(value)) {
      iterator(value);
      value = value.succ();
    }
  }

  <span class="reserved">function</span> include(value) {
    <span class="reserved">if</span> (value &lt; <span class="reserved">this</span>.start)
      <span class="reserved">return</span> false;
    <span class="reserved">if</span> (<span class="reserved">this</span>.exclusive)
      <span class="reserved">return</span> value &lt; <span class="reserved">this</span>.end;
    <span class="reserved">return</span> value &lt;= <span class="reserved">this</span>.end;
  }

  <span class="reserved">return</span> {
    initialize: initialize,
    _each:      _each,
    include:    include
  };
})());



var Ajax = {
  getTransport: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Try.these(
      <span class="reserved">function</span>() {<span class="reserved">return</span> new XMLHttpRequest()},
      <span class="reserved">function</span>() {<span class="reserved">return</span> new ActiveXObject(<span class="literal">'Msxml2.XMLHTTP'</span>)},
      <span class="reserved">function</span>() {<span class="reserved">return</span> new ActiveXObject(<span class="literal">'Microsoft.XMLHTTP'</span>)}
    ) || false;
  },

  activeRequestCount: 0
};

Ajax.Responders = {
  responders: [],

  _each: <span class="reserved">function</span>(iterator) {
    <span class="reserved">this</span>.responders._each(iterator);
  },

  register: <span class="reserved">function</span>(responder) {
    <span class="reserved">if</span> (!<span class="reserved">this</span>.include(responder))
      <span class="reserved">this</span>.responders.push(responder);
  },

  unregister: <span class="reserved">function</span>(responder) {
    <span class="reserved">this</span>.responders = <span class="reserved">this</span>.responders.without(responder);
  },

  dispatch: <span class="reserved">function</span>(callback, request, transport, json) {
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(responder) {
      <span class="reserved">if</span> (Object.isFunction(responder[callback])) {
        try {
          responder[callback].apply(responder, [request, transport, json]);
        } catch (e) { }
      }
    });
  }
};

Object.extend(Ajax.Responders, Enumerable);

Ajax.Responders.register({
  onCreate:   <span class="reserved">function</span>() { Ajax.activeRequestCount++ },
  onComplete: <span class="reserved">function</span>() { Ajax.activeRequestCount-- }
});
Ajax.Base = Class.create({
  initialize: <span class="reserved">function</span>(options) {
    <span class="reserved">this</span>.options = {
      method:       <span class="literal">'post'</span>,
      asynchronous: true,
      contentType:  <span class="literal">'application/x-www-form-urlencoded'</span>,
      encoding:     <span class="literal">'UTF-8'</span>,
      parameters:   <span class="literal">''</span>,
      evalJSON:     true,
      evalJS:       true
    };
    Object.extend(<span class="reserved">this</span>.options, options || { });

    <span class="reserved">this</span>.options.method = <span class="reserved">this</span>.options.method.toLowerCase();

    <span class="reserved">if</span> (Object.isString(<span class="reserved">this</span>.options.parameters))
      <span class="reserved">this</span>.options.parameters = <span class="reserved">this</span>.options.parameters.toQueryParams();
    <span class="reserved">else</span> <span class="reserved">if</span> (Object.isHash(<span class="reserved">this</span>.options.parameters))
      <span class="reserved">this</span>.options.parameters = <span class="reserved">this</span>.options.parameters.toObject();
  }
});
Ajax.Request = Class.create(Ajax.Base, {
  _complete: false,

  initialize: <span class="reserved">function</span>($super, url, options) {
    $super(options);
    <span class="reserved">this</span>.transport = Ajax.getTransport();
    <span class="reserved">this</span>.request(url);
  },

  request: <span class="reserved">function</span>(url) {
    <span class="reserved">this</span>.url = url;
    <span class="reserved">this</span>.method = <span class="reserved">this</span>.options.method;
    var params = Object.clone(<span class="reserved">this</span>.options.parameters);

    <span class="reserved">if</span> (![<span class="literal">'get'</span>, <span class="literal">'post'</span>].include(<span class="reserved">this</span>.method)) {
      params[<span class="literal">'_method'</span>] = <span class="reserved">this</span>.method;
      <span class="reserved">this</span>.method = <span class="literal">'post'</span>;
    }

    <span class="reserved">this</span>.parameters = params;

    <span class="reserved">if</span> (params = Object.toQueryString(params)) {
      <span class="reserved">if</span> (<span class="reserved">this</span>.method == <span class="literal">'get'</span>)
        <span class="reserved">this</span>.url += (<span class="reserved">this</span>.url.include(<span class="literal">'?'</span>) ? <span class="literal">'&amp;'</span> : <span class="literal">'?'</span>) + params;
      <span class="reserved">else</span> <span class="reserved">if</span> (/Konqueror|Safari|KHTML/.test(navigator.userAgent))
        params += <span class="literal">'&amp;_='</span>;
    }

    try {
      var response = new Ajax.Response(<span class="reserved">this</span>);
      <span class="reserved">if</span> (<span class="reserved">this</span>.options.onCreate) <span class="reserved">this</span>.options.onCreate(response);
      Ajax.Responders.dispatch(<span class="literal">'onCreate'</span>, <span class="reserved">this</span>, response);

      <span class="reserved">this</span>.transport.open(<span class="reserved">this</span>.method.toUpperCase(), <span class="reserved">this</span>.url,
        <span class="reserved">this</span>.options.asynchronous);

      <span class="reserved">if</span> (<span class="reserved">this</span>.options.asynchronous) <span class="reserved">this</span>.respondToReadyState.bind(<span class="reserved">this</span>).defer(1);

      <span class="reserved">this</span>.transport.onreadystatechange = <span class="reserved">this</span>.onStateChange.bind(<span class="reserved">this</span>);
      <span class="reserved">this</span>.setRequestHeaders();

      <span class="reserved">this</span>.body = <span class="reserved">this</span>.method == <span class="literal">'post'</span> ? (<span class="reserved">this</span>.options.postBody || params) : null;
      <span class="reserved">this</span>.transport.send(<span class="reserved">this</span>.body);

      <span class="comment">/* Force Firefox to handle ready state 4 for synchronous requests */</span>
      <span class="reserved">if</span> (!<span class="reserved">this</span>.options.asynchronous &amp;&amp; <span class="reserved">this</span>.transport.overrideMimeType)
        <span class="reserved">this</span>.onStateChange();

    }
    catch (e) {
      <span class="reserved">this</span>.dispatchException(e);
    }
  },

  onStateChange: <span class="reserved">function</span>() {
    var readyState = <span class="reserved">this</span>.transport.readyState;
    <span class="reserved">if</span> (readyState &gt; 1 &amp;&amp; !((readyState == 4) &amp;&amp; <span class="reserved">this</span>._complete))
      <span class="reserved">this</span>.respondToReadyState(<span class="reserved">this</span>.transport.readyState);
  },

  setRequestHeaders: <span class="reserved">function</span>() {
    var headers = {
      <span class="literal">'X-Requested-With'</span>: <span class="literal">'XMLHttpRequest'</span>,
      <span class="literal">'X-Prototype-Version'</span>: Prototype.Version,
      <span class="literal">'Accept'</span>: <span class="literal">'text/javascript, text/html, application/xml, text/xml, */*'</span>
    };

    <span class="reserved">if</span> (<span class="reserved">this</span>.method == <span class="literal">'post'</span>) {
      headers[<span class="literal">'Content-type'</span>] = <span class="reserved">this</span>.options.contentType +
        (<span class="reserved">this</span>.options.encoding ? <span class="literal">'; charset='</span> + <span class="reserved">this</span>.options.encoding : <span class="literal">''</span>);

      <span class="comment">/* Force "Connection: close" for older Mozilla browsers to work
       * around a bug where XMLHttpRequest sends an incorrect
       * Content-length header. See Mozilla Bugzilla #246651.
       */</span>
      <span class="reserved">if</span> (<span class="reserved">this</span>.transport.overrideMimeType &amp;&amp;
          (navigator.userAgent.match(/Gecko\/(\d{4})/) || [0,2005])[1] &lt; 2005)
            headers[<span class="literal">'Connection'</span>] = <span class="literal">'close'</span>;
    }

    <span class="reserved">if</span> (typeof <span class="reserved">this</span>.options.requestHeaders == <span class="literal">'object'</span>) {
      var extras = <span class="reserved">this</span>.options.requestHeaders;

      <span class="reserved">if</span> (Object.isFunction(extras.push))
        <span class="reserved">for</span> (var i = 0, length = extras.length; i &lt; length; i += 2)
          headers[extras[i]] = extras[i+1];
      <span class="reserved">else</span>
        $H(extras).each(<span class="reserved">function</span>(pair) { headers[pair.key] = pair.value });
    }

    <span class="reserved">for</span> (var name in headers)
      <span class="reserved">this</span>.transport.setRequestHeader(name, headers[name]);
  },

  success: <span class="reserved">function</span>() {
    var status = <span class="reserved">this</span>.getStatus();
    <span class="reserved">return</span> !status || (status &gt;= 200 &amp;&amp; status &lt; 300);
  },

  getStatus: <span class="reserved">function</span>() {
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.transport.status || 0;
    } catch (e) { <span class="reserved">return</span> 0 }
  },

  respondToReadyState: <span class="reserved">function</span>(readyState) {
    var state = Ajax.Request.Events[readyState], response = new Ajax.Response(<span class="reserved">this</span>);

    <span class="reserved">if</span> (state == <span class="literal">'Complete'</span>) {
      try {
        <span class="reserved">this</span>._complete = true;
        (<span class="reserved">this</span>.options[<span class="literal">'on'</span> + response.status]
         || <span class="reserved">this</span>.options[<span class="literal">'on'</span> + (<span class="reserved">this</span>.success() ? <span class="literal">'Success'</span> : <span class="literal">'Failure'</span>)]
         || Prototype.emptyFunction)(response, response.headerJSON);
      } catch (e) {
        <span class="reserved">this</span>.dispatchException(e);
      }

      var contentType = response.getHeader(<span class="literal">'Content-type'</span>);
      <span class="reserved">if</span> (<span class="reserved">this</span>.options.evalJS == <span class="literal">'force'</span>
          || (<span class="reserved">this</span>.options.evalJS &amp;&amp; <span class="reserved">this</span>.isSameOrigin() &amp;&amp; contentType
          &amp;&amp; contentType.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i)))
        <span class="reserved">this</span>.evalResponse();
    }

    try {
      (<span class="reserved">this</span>.options[<span class="literal">'on'</span> + state] || Prototype.emptyFunction)(response, response.headerJSON);
      Ajax.Responders.dispatch(<span class="literal">'on'</span> + state, <span class="reserved">this</span>, response, response.headerJSON);
    } catch (e) {
      <span class="reserved">this</span>.dispatchException(e);
    }

    <span class="reserved">if</span> (state == <span class="literal">'Complete'</span>) {
      <span class="reserved">this</span>.transport.onreadystatechange = Prototype.emptyFunction;
    }
  },

  isSameOrigin: <span class="reserved">function</span>() {
    var m = <span class="reserved">this</span>.url.match(/^\s*https?:\/\/[^\/]*/);
    <span class="reserved">return</span> !m || (m[0] == <span class="literal">'#{protocol}//#{domain}#{port}'</span>.interpolate({
      protocol: location.protocol,
      domain: document.domain,
      port: location.port ? <span class="literal">':'</span> + location.port : <span class="literal">''</span>
    }));
  },

  getHeader: <span class="reserved">function</span>(name) {
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.transport.getResponseHeader(name) || null;
    } catch (e) { <span class="reserved">return</span> null; }
  },

  evalResponse: <span class="reserved">function</span>() {
    try {
      <span class="reserved">return</span> eval((<span class="reserved">this</span>.transport.responseText || <span class="literal">''</span>).unfilterJSON());
    } catch (e) {
      <span class="reserved">this</span>.dispatchException(e);
    }
  },

  dispatchException: <span class="reserved">function</span>(exception) {
    (<span class="reserved">this</span>.options.onException || Prototype.emptyFunction)(<span class="reserved">this</span>, exception);
    Ajax.Responders.dispatch(<span class="literal">'onException'</span>, <span class="reserved">this</span>, exception);
  }
});

Ajax.Request.Events =
  [<span class="literal">'Uninitialized'</span>, <span class="literal">'Loading'</span>, <span class="literal">'Loaded'</span>, <span class="literal">'Interactive'</span>, <span class="literal">'Complete'</span>];








Ajax.Response = Class.create({
  initialize: <span class="reserved">function</span>(request){
    <span class="reserved">this</span>.request = request;
    var transport  = <span class="reserved">this</span>.transport  = request.transport,
        readyState = <span class="reserved">this</span>.readyState = transport.readyState;

    <span class="reserved">if</span>((readyState &gt; 2 &amp;&amp; !Prototype.Browser.IE) || readyState == 4) {
      <span class="reserved">this</span>.status       = <span class="reserved">this</span>.getStatus();
      <span class="reserved">this</span>.statusText   = <span class="reserved">this</span>.getStatusText();
      <span class="reserved">this</span>.responseText = String.interpret(transport.responseText);
      <span class="reserved">this</span>.headerJSON   = <span class="reserved">this</span>._getHeaderJSON();
    }

    <span class="reserved">if</span>(readyState == 4) {
      var xml = transport.responseXML;
      <span class="reserved">this</span>.responseXML  = Object.isUndefined(xml) ? null : xml;
      <span class="reserved">this</span>.responseJSON = <span class="reserved">this</span>._getResponseJSON();
    }
  },

  status:      0,

  statusText: <span class="literal">''</span>,

  getStatus: Ajax.Request.<span class="reserved">prototype</span>.getStatus,

  getStatusText: <span class="reserved">function</span>() {
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.transport.statusText || <span class="literal">''</span>;
    } catch (e) { <span class="reserved">return</span> <span class="literal">''</span> }
  },

  getHeader: Ajax.Request.<span class="reserved">prototype</span>.getHeader,

  getAllHeaders: <span class="reserved">function</span>() {
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.getAllResponseHeaders();
    } catch (e) { <span class="reserved">return</span> null }
  },

  getResponseHeader: <span class="reserved">function</span>(name) {
    <span class="reserved">return</span> <span class="reserved">this</span>.transport.getResponseHeader(name);
  },

  getAllResponseHeaders: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.transport.getAllResponseHeaders();
  },

  _getHeaderJSON: <span class="reserved">function</span>() {
    var json = <span class="reserved">this</span>.getHeader(<span class="literal">'X-JSON'</span>);
    <span class="reserved">if</span> (!json) <span class="reserved">return</span> null;
    json = decodeURIComponent(escape(json));
    try {
      <span class="reserved">return</span> json.evalJSON(<span class="reserved">this</span>.request.options.sanitizeJSON ||
        !<span class="reserved">this</span>.request.isSameOrigin());
    } catch (e) {
      <span class="reserved">this</span>.request.dispatchException(e);
    }
  },

  _getResponseJSON: <span class="reserved">function</span>() {
    var options = <span class="reserved">this</span>.request.options;
    <span class="reserved">if</span> (!options.evalJSON || (options.evalJSON != <span class="literal">'force'</span> &amp;&amp;
      !(<span class="reserved">this</span>.getHeader(<span class="literal">'Content-type'</span>) || <span class="literal">''</span>).include(<span class="literal">'application/json'</span>)) ||
        <span class="reserved">this</span>.responseText.blank())
          <span class="reserved">return</span> null;
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.responseText.evalJSON(options.sanitizeJSON ||
        !<span class="reserved">this</span>.request.isSameOrigin());
    } catch (e) {
      <span class="reserved">this</span>.request.dispatchException(e);
    }
  }
});

Ajax.Updater = Class.create(Ajax.Request, {
  initialize: <span class="reserved">function</span>($super, container, url, options) {
    <span class="reserved">this</span>.container = {
      success: (container.success || container),
      failure: (container.failure || (container.success ? null : container))
    };

    options = Object.clone(options);
    var onComplete = options.onComplete;
    options.onComplete = (<span class="reserved">function</span>(response, json) {
      <span class="reserved">this</span>.updateContent(response.responseText);
      <span class="reserved">if</span> (Object.isFunction(onComplete)) onComplete(response, json);
    }).bind(<span class="reserved">this</span>);

    $super(url, options);
  },

  updateContent: <span class="reserved">function</span>(responseText) {
    var receiver = <span class="reserved">this</span>.container[<span class="reserved">this</span>.success() ? <span class="literal">'success'</span> : <span class="literal">'failure'</span>],
        options = <span class="reserved">this</span>.options;

    <span class="reserved">if</span> (!options.evalScripts) responseText = responseText.stripScripts();

    <span class="reserved">if</span> (receiver = $(receiver)) {
      <span class="reserved">if</span> (options.insertion) {
        <span class="reserved">if</span> (Object.isString(options.insertion)) {
          var insertion = { }; insertion[options.insertion] = responseText;
          receiver.insert(insertion);
        }
        <span class="reserved">else</span> options.insertion(receiver, responseText);
      }
      <span class="reserved">else</span> receiver.update(responseText);
    }
  }
});

Ajax.PeriodicalUpdater = Class.create(Ajax.Base, {
  initialize: <span class="reserved">function</span>($super, container, url, options) {
    $super(options);
    <span class="reserved">this</span>.onComplete = <span class="reserved">this</span>.options.onComplete;

    <span class="reserved">this</span>.frequency = (<span class="reserved">this</span>.options.frequency || 2);
    <span class="reserved">this</span>.decay = (<span class="reserved">this</span>.options.decay || 1);

    <span class="reserved">this</span>.updater = { };
    <span class="reserved">this</span>.container = container;
    <span class="reserved">this</span>.url = url;

    <span class="reserved">this</span>.start();
  },

  start: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.options.onComplete = <span class="reserved">this</span>.updateComplete.bind(<span class="reserved">this</span>);
    <span class="reserved">this</span>.onTimerEvent();
  },

  stop: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.updater.options.onComplete = undefined;
    clearTimeout(<span class="reserved">this</span>.timer);
    (<span class="reserved">this</span>.onComplete || Prototype.emptyFunction).apply(<span class="reserved">this</span>, arguments);
  },

  updateComplete: <span class="reserved">function</span>(response) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.options.decay) {
      <span class="reserved">this</span>.decay = (response.responseText == <span class="reserved">this</span>.lastText ?
        <span class="reserved">this</span>.decay * <span class="reserved">this</span>.options.decay : 1);

      <span class="reserved">this</span>.lastText = response.responseText;
    }
    <span class="reserved">this</span>.timer = <span class="reserved">this</span>.onTimerEvent.bind(<span class="reserved">this</span>).delay(<span class="reserved">this</span>.decay * <span class="reserved">this</span>.frequency);
  },

  onTimerEvent: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.updater = new Ajax.Updater(<span class="reserved">this</span>.container, <span class="reserved">this</span>.url, <span class="reserved">this</span>.options);
  }
});



<span class="reserved">function</span> $(element) {
  <span class="reserved">if</span> (arguments.length &gt; 1) {
    <span class="reserved">for</span> (var i = 0, elements = [], length = arguments.length; i &lt; length; i++)
      elements.push($(arguments[i]));
    <span class="reserved">return</span> elements;
  }
  <span class="reserved">if</span> (Object.isString(element))
    element = document.getElementById(element);
  <span class="reserved">return</span> Element.extend(element);
}

<span class="reserved">if</span> (Prototype.BrowserFeatures.XPath) {
  document._getElementsByXPath = <span class="reserved">function</span>(expression, parentElement) {
    var results = [];
    var query = document.evaluate(expression, $(parentElement) || document,
      null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
    <span class="reserved">for</span> (var i = 0, length = query.snapshotLength; i &lt; length; i++)
      results.push(Element.extend(query.snapshotItem(i)));
    <span class="reserved">return</span> results;
  };
}

<span class="comment">/*--------------------------------------------------------------------------*/</span>

<span class="reserved">if</span> (!window.Node) var Node = { };

<span class="reserved">if</span> (!Node.ELEMENT_NODE) {
  Object.extend(Node, {
    ELEMENT_NODE: 1,
    ATTRIBUTE_NODE: 2,
    TEXT_NODE: 3,
    CDATA_SECTION_NODE: 4,
    ENTITY_REFERENCE_NODE: 5,
    ENTITY_NODE: 6,
    PROCESSING_INSTRUCTION_NODE: 7,
    COMMENT_NODE: 8,
    DOCUMENT_NODE: 9,
    DOCUMENT_TYPE_NODE: 10,
    DOCUMENT_FRAGMENT_NODE: 11,
    NOTATION_NODE: 12
  });
}


(<span class="reserved">function</span>(global) {

  var SETATTRIBUTE_IGNORES_NAME = (<span class="reserved">function</span>(){
    var elForm = document.createElement(<span class="literal">"form"</span>);
    var elInput = document.createElement(<span class="literal">"input"</span>);
    var root = document.documentElement;
    elInput.setAttribute(<span class="literal">"name"</span>, <span class="literal">"test"</span>);
    elForm.appendChild(elInput);
    root.appendChild(elForm);
    var isBuggy = elForm.elements
      ? (typeof elForm.elements.test == <span class="literal">"undefined"</span>)
      : null;
    root.removeChild(elForm);
    elForm = elInput = null;
    <span class="reserved">return</span> isBuggy;
  })();

  var element = global.Element;
  global.Element = <span class="reserved">function</span>(tagName, attributes) {
    attributes = attributes || { };
    tagName = tagName.toLowerCase();
    var cache = Element.cache;
    <span class="reserved">if</span> (SETATTRIBUTE_IGNORES_NAME &amp;&amp; attributes.name) {
      tagName = <span class="literal">'&lt;'</span> + tagName + <span class="literal">' name="'</span> + attributes.name + <span class="literal">'"&gt;'</span>;
      delete attributes.name;
      <span class="reserved">return</span> Element.writeAttribute(document.createElement(tagName), attributes);
    }
    <span class="reserved">if</span> (!cache[tagName]) cache[tagName] = Element.extend(document.createElement(tagName));
    <span class="reserved">return</span> Element.writeAttribute(cache[tagName].cloneNode(false), attributes);
  };
  Object.extend(global.Element, element || { });
  <span class="reserved">if</span> (element) global.Element.<span class="reserved">prototype</span> = element.<span class="reserved">prototype</span>;
})(<span class="reserved">this</span>);

Element.cache = { };
Element.idCounter = 1;

Element.Methods = {
  visible: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).style.display != <span class="literal">'none'</span>;
  },

  toggle: <span class="reserved">function</span>(element) {
    element = $(element);
    Element[Element.visible(element) ? <span class="literal">'hide'</span> : <span class="literal">'show'</span>](element);
    <span class="reserved">return</span> element;
  },


  hide: <span class="reserved">function</span>(element) {
    element = $(element);
    element.style.display = <span class="literal">'none'</span>;
    <span class="reserved">return</span> element;
  },

  show: <span class="reserved">function</span>(element) {
    element = $(element);
    element.style.display = <span class="literal">''</span>;
    <span class="reserved">return</span> element;
  },

  remove: <span class="reserved">function</span>(element) {
    element = $(element);
    element.parentNode.removeChild(element);
    <span class="reserved">return</span> element;
  },

  update: (<span class="reserved">function</span>(){

    var SELECT_ELEMENT_INNERHTML_BUGGY = (<span class="reserved">function</span>(){
      var el = document.createElement(<span class="literal">"select"</span>),
          isBuggy = true;
      el.innerHTML = <span class="literal">"&lt;option value=\"</span>test\<span class="literal">"&gt;test&lt;/option&gt;"</span>;
      <span class="reserved">if</span> (el.options &amp;&amp; el.options[0]) {
        isBuggy = el.options[0].nodeName.toUpperCase() !== <span class="literal">"OPTION"</span>;
      }
      el = null;
      <span class="reserved">return</span> isBuggy;
    })();

    var TABLE_ELEMENT_INNERHTML_BUGGY = (<span class="reserved">function</span>(){
      try {
        var el = document.createElement(<span class="literal">"table"</span>);
        <span class="reserved">if</span> (el &amp;&amp; el.tBodies) {
          el.innerHTML = <span class="literal">"&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;test&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;"</span>;
          var isBuggy = typeof el.tBodies[0] == <span class="literal">"undefined"</span>;
          el = null;
          <span class="reserved">return</span> isBuggy;
        }
      } catch (e) {
        <span class="reserved">return</span> true;
      }
    })();

    var SCRIPT_ELEMENT_REJECTS_TEXTNODE_APPENDING = (<span class="reserved">function</span> () {
      var s = document.createElement(<span class="literal">"script"</span>),
          isBuggy = false;
      try {
        s.appendChild(document.createTextNode(<span class="literal">""</span>));
        isBuggy = !s.firstChild ||
          s.firstChild &amp;&amp; s.firstChild.nodeType !== 3;
      } catch (e) {
        isBuggy = true;
      }
      s = null;
      <span class="reserved">return</span> isBuggy;
    })();

    <span class="reserved">function</span> update(element, content) {
      element = $(element);

      <span class="reserved">if</span> (content &amp;&amp; content.toElement)
        content = content.toElement();

      <span class="reserved">if</span> (Object.isElement(content))
        <span class="reserved">return</span> element.update().insert(content);

      content = Object.toHTML(content);

      var tagName = element.tagName.toUpperCase();

      <span class="reserved">if</span> (tagName === <span class="literal">'SCRIPT'</span> &amp;&amp; SCRIPT_ELEMENT_REJECTS_TEXTNODE_APPENDING) {
        element.text = content;
        <span class="reserved">return</span> element;
      }

      <span class="reserved">if</span> (SELECT_ELEMENT_INNERHTML_BUGGY || TABLE_ELEMENT_INNERHTML_BUGGY) {
        <span class="reserved">if</span> (tagName in Element._insertionTranslations.tags) {
          $A(element.childNodes).each(<span class="reserved">function</span>(node) {
            element.removeChild(node);
          });
          Element._getContentFromAnonymousElement(tagName, content.stripScripts())
            .each(<span class="reserved">function</span>(node) {
              element.appendChild(node)
            });
        }
        <span class="reserved">else</span> {
          element.innerHTML = content.stripScripts();
        }
      }
      <span class="reserved">else</span> {
        element.innerHTML = content.stripScripts();
      }

      content.evalScripts.bind(content).defer();
      <span class="reserved">return</span> element;
    }

    <span class="reserved">return</span> update;
  })(),

  replace: <span class="reserved">function</span>(element, content) {
    element = $(element);
    <span class="reserved">if</span> (content &amp;&amp; content.toElement) content = content.toElement();
    <span class="reserved">else</span> <span class="reserved">if</span> (!Object.isElement(content)) {
      content = Object.toHTML(content);
      var range = element.ownerDocument.createRange();
      range.selectNode(element);
      content.evalScripts.bind(content).defer();
      content = range.createContextualFragment(content.stripScripts());
    }
    element.parentNode.replaceChild(content, element);
    <span class="reserved">return</span> element;
  },

  insert: <span class="reserved">function</span>(element, insertions) {
    element = $(element);

    <span class="reserved">if</span> (Object.isString(insertions) || Object.isNumber(insertions) ||
        Object.isElement(insertions) || (insertions &amp;&amp; (insertions.toElement || insertions.toHTML)))
          insertions = {bottom:insertions};

    var content, insert, tagName, childNodes;

    <span class="reserved">for</span> (var position in insertions) {
      content  = insertions[position];
      position = position.toLowerCase();
      insert = Element._insertionTranslations[position];

      <span class="reserved">if</span> (content &amp;&amp; content.toElement) content = content.toElement();
      <span class="reserved">if</span> (Object.isElement(content)) {
        insert(element, content);
        continue;
      }

      content = Object.toHTML(content);

      tagName = ((position == <span class="literal">'before'</span> || position == <span class="literal">'after'</span>)
        ? element.parentNode : element).tagName.toUpperCase();

      childNodes = Element._getContentFromAnonymousElement(tagName, content.stripScripts());

      <span class="reserved">if</span> (position == <span class="literal">'top'</span> || position == <span class="literal">'after'</span>) childNodes.reverse();
      childNodes.each(insert.curry(element));

      content.evalScripts.bind(content).defer();
    }

    <span class="reserved">return</span> element;
  },

  wrap: <span class="reserved">function</span>(element, wrapper, attributes) {
    element = $(element);
    <span class="reserved">if</span> (Object.isElement(wrapper))
      $(wrapper).writeAttribute(attributes || { });
    <span class="reserved">else</span> <span class="reserved">if</span> (Object.isString(wrapper)) wrapper = new Element(wrapper, attributes);
    <span class="reserved">else</span> wrapper = new Element(<span class="literal">'div'</span>, wrapper);
    <span class="reserved">if</span> (element.parentNode)
      element.parentNode.replaceChild(wrapper, element);
    wrapper.appendChild(element);
    <span class="reserved">return</span> wrapper;
  },

  inspect: <span class="reserved">function</span>(element) {
    element = $(element);
    var result = <span class="literal">'&lt;'</span> + element.tagName.toLowerCase();
    $H({<span class="literal">'id'</span>: <span class="literal">'id'</span>, <span class="literal">'className'</span>: <span class="literal">'class'</span>}).each(<span class="reserved">function</span>(pair) {
      var property = pair.first(), attribute = pair.last();
      var value = (element[property] || <span class="literal">''</span>).toString();
      <span class="reserved">if</span> (value) result += <span class="literal">' '</span> + attribute + <span class="literal">'='</span> + value.inspect(true);
    });
    <span class="reserved">return</span> result + <span class="literal">'&gt;'</span>;
  },

  recursivelyCollect: <span class="reserved">function</span>(element, property) {
    element = $(element);
    var elements = [];
    <span class="reserved">while</span> (element = element[property])
      <span class="reserved">if</span> (element.nodeType == 1)
        elements.push(Element.extend(element));
    <span class="reserved">return</span> elements;
  },

  ancestors: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).recursivelyCollect(<span class="literal">'parentNode'</span>);
  },

  descendants: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> Element.select(element, <span class="literal">"*"</span>);
  },

  firstDescendant: <span class="reserved">function</span>(element) {
    element = $(element).firstChild;
    <span class="reserved">while</span> (element &amp;&amp; element.nodeType != 1) element = element.nextSibling;
    <span class="reserved">return</span> $(element);
  },

  immediateDescendants: <span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (!(element = $(element).firstChild)) <span class="reserved">return</span> [];
    <span class="reserved">while</span> (element &amp;&amp; element.nodeType != 1) element = element.nextSibling;
    <span class="reserved">if</span> (element) <span class="reserved">return</span> [element].concat($(element).nextSiblings());
    <span class="reserved">return</span> [];
  },

  previousSiblings: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).recursivelyCollect(<span class="literal">'previousSibling'</span>);
  },

  nextSiblings: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).recursivelyCollect(<span class="literal">'nextSibling'</span>);
  },

  siblings: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">return</span> element.previousSiblings().reverse().concat(element.nextSiblings());
  },

  match: <span class="reserved">function</span>(element, selector) {
    <span class="reserved">if</span> (Object.isString(selector))
      selector = new Selector(selector);
    <span class="reserved">return</span> selector.match($(element));
  },

  up: <span class="reserved">function</span>(element, expression, index) {
    element = $(element);
    <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> $(element.parentNode);
    var ancestors = element.ancestors();
    <span class="reserved">return</span> Object.isNumber(expression) ? ancestors[expression] :
      Selector.findElement(ancestors, expression, index);
  },

  down: <span class="reserved">function</span>(element, expression, index) {
    element = $(element);
    <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> element.firstDescendant();
    <span class="reserved">return</span> Object.isNumber(expression) ? element.descendants()[expression] :
      Element.select(element, expression)[index || 0];
  },

  previous: <span class="reserved">function</span>(element, expression, index) {
    element = $(element);
    <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> $(Selector.handlers.previousElementSibling(element));
    var previousSiblings = element.previousSiblings();
    <span class="reserved">return</span> Object.isNumber(expression) ? previousSiblings[expression] :
      Selector.findElement(previousSiblings, expression, index);
  },

  next: <span class="reserved">function</span>(element, expression, index) {
    element = $(element);
    <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> $(Selector.handlers.nextElementSibling(element));
    var nextSiblings = element.nextSiblings();
    <span class="reserved">return</span> Object.isNumber(expression) ? nextSiblings[expression] :
      Selector.findElement(nextSiblings, expression, index);
  },


  select: <span class="reserved">function</span>() {
    var args = $A(arguments), element = $(args.shift());
    <span class="reserved">return</span> Selector.findChildElements(element, args);
  },

  adjacent: <span class="reserved">function</span>() {
    var args = $A(arguments), element = $(args.shift());
    <span class="reserved">return</span> Selector.findChildElements(element.parentNode, args).without(element);
  },

  identify: <span class="reserved">function</span>(element) {
    element = $(element);
    var id = element.readAttribute(<span class="literal">'id'</span>);
    <span class="reserved">if</span> (id) <span class="reserved">return</span> id;
    do { id = <span class="literal">'anonymous_element_'</span> + Element.idCounter++ } <span class="reserved">while</span> ($(id));
    element.writeAttribute(<span class="literal">'id'</span>, id);
    <span class="reserved">return</span> id;
  },

  readAttribute: (<span class="reserved">function</span>(){

    var iframeGetAttributeThrowsError = (<span class="reserved">function</span>(){
      var el = document.createElement(<span class="literal">'iframe'</span>),
          isBuggy = false;

      document.documentElement.appendChild(el);
      try {
        el.getAttribute(<span class="literal">'type'</span>, 2);
      } catch(e) {
        isBuggy = true;
      }
      document.documentElement.removeChild(el);
      el = null;
      <span class="reserved">return</span> isBuggy;
    })();

    <span class="reserved">return</span> <span class="reserved">function</span>(element, name) {
      element = $(element);
      <span class="reserved">if</span> (iframeGetAttributeThrowsError &amp;&amp;
          name === <span class="literal">'type'</span> &amp;&amp;
          element.tagName.toUpperCase() == <span class="literal">'IFRAME'</span>) {
        <span class="reserved">return</span> element.getAttribute(<span class="literal">'type'</span>);
      }
      <span class="reserved">if</span> (Prototype.Browser.IE) {
        var t = Element._attributeTranslations.read;
        <span class="reserved">if</span> (t.values[name]) <span class="reserved">return</span> t.values[name](element, name);
        <span class="reserved">if</span> (t.names[name]) name = t.names[name];
        <span class="reserved">if</span> (name.include(<span class="literal">':'</span>)) {
          <span class="reserved">return</span> (!element.attributes || !element.attributes[name]) ? null :
           element.attributes[name].value;
        }
      }
      <span class="reserved">return</span> element.getAttribute(name);
    }
  })(),

  writeAttribute: <span class="reserved">function</span>(element, name, value) {
    element = $(element);
    var attributes = { }, t = Element._attributeTranslations.write;

    <span class="reserved">if</span> (typeof name == <span class="literal">'object'</span>) attributes = name;
    <span class="reserved">else</span> attributes[name] = Object.isUndefined(value) ? true : value;

    <span class="reserved">for</span> (var attr in attributes) {
      name = t.names[attr] || attr;
      value = attributes[attr];
      <span class="reserved">if</span> (t.values[attr]) name = t.values[attr](element, value);
      <span class="reserved">if</span> (value === false || value === null)
        element.removeAttribute(name);
      <span class="reserved">else</span> <span class="reserved">if</span> (value === true)
        element.setAttribute(name, name);
      <span class="reserved">else</span> element.setAttribute(name, value);
    }
    <span class="reserved">return</span> element;
  },

  getHeight: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).getDimensions().height;
  },

  getWidth: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).getDimensions().width;
  },

  classNames: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> new Element.ClassNames(element);
  },

  hasClassName: <span class="reserved">function</span>(element, className) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    var elementClassName = element.className;
    <span class="reserved">return</span> (elementClassName.length &gt; 0 &amp;&amp; (elementClassName == className ||
      new RegExp(<span class="literal">"(^|\\s)"</span> + className + <span class="literal">"(\\s|$)"</span>).test(elementClassName)));
  },

  addClassName: <span class="reserved">function</span>(element, className) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    <span class="reserved">if</span> (!element.hasClassName(className))
      element.className += (element.className ? <span class="literal">' '</span> : <span class="literal">''</span>) + className;
    <span class="reserved">return</span> element;
  },

  removeClassName: <span class="reserved">function</span>(element, className) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    element.className = element.className.replace(
      new RegExp(<span class="literal">"(^|\\s+)"</span> + className + <span class="literal">"(\\s+|$)"</span>), <span class="literal">' '</span>).strip();
    <span class="reserved">return</span> element;
  },

  toggleClassName: <span class="reserved">function</span>(element, className) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    <span class="reserved">return</span> element[element.hasClassName(className) ?
      <span class="literal">'removeClassName'</span> : <span class="literal">'addClassName'</span>](className);
  },

  cleanWhitespace: <span class="reserved">function</span>(element) {
    element = $(element);
    var node = element.firstChild;
    <span class="reserved">while</span> (node) {
      var nextNode = node.nextSibling;
      <span class="reserved">if</span> (node.nodeType == 3 &amp;&amp; !/\S/.test(node.nodeValue))
        element.removeChild(node);
      node = nextNode;
    }
    <span class="reserved">return</span> element;
  },

  empty: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).innerHTML.blank();
  },

  descendantOf: <span class="reserved">function</span>(element, ancestor) {
    element = $(element), ancestor = $(ancestor);

    <span class="reserved">if</span> (element.compareDocumentPosition)
      <span class="reserved">return</span> (element.compareDocumentPosition(ancestor) &amp; 8) === 8;

    <span class="reserved">if</span> (ancestor.contains)
      <span class="reserved">return</span> ancestor.contains(element) &amp;&amp; ancestor !== element;

    <span class="reserved">while</span> (element = element.parentNode)
      <span class="reserved">if</span> (element == ancestor) <span class="reserved">return</span> true;

    <span class="reserved">return</span> false;
  },

  scrollTo: <span class="reserved">function</span>(element) {
    element = $(element);
    var pos = element.cumulativeOffset();
    window.scrollTo(pos[0], pos[1]);
    <span class="reserved">return</span> element;
  },

  getStyle: <span class="reserved">function</span>(element, style) {
    element = $(element);
    style = style == <span class="literal">'float'</span> ? <span class="literal">'cssFloat'</span> : style.camelize();
    var value = element.style[style];
    <span class="reserved">if</span> (!value || value == <span class="literal">'auto'</span>) {
      var css = document.defaultView.getComputedStyle(element, null);
      value = css ? css[style] : null;
    }
    <span class="reserved">if</span> (style == <span class="literal">'opacity'</span>) <span class="reserved">return</span> value ? parseFloat(value) : 1.0;
    <span class="reserved">return</span> value == <span class="literal">'auto'</span> ? null : value;
  },

  getOpacity: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).getStyle(<span class="literal">'opacity'</span>);
  },

  setStyle: <span class="reserved">function</span>(element, styles) {
    element = $(element);
    var elementStyle = element.style, match;
    <span class="reserved">if</span> (Object.isString(styles)) {
      element.style.cssText += <span class="literal">';'</span> + styles;
      <span class="reserved">return</span> styles.include(<span class="literal">'opacity'</span>) ?
        element.setOpacity(styles.match(/opacity:\s*(\d?\.?\d*)/)[1]) : element;
    }
    <span class="reserved">for</span> (var property in styles)
      <span class="reserved">if</span> (property == <span class="literal">'opacity'</span>) element.setOpacity(styles[property]);
      <span class="reserved">else</span>
        elementStyle[(property == <span class="literal">'float'</span> || property == <span class="literal">'cssFloat'</span>) ?
          (Object.isUndefined(elementStyle.styleFloat) ? <span class="literal">'cssFloat'</span> : <span class="literal">'styleFloat'</span>) :
            property] = styles[property];

    <span class="reserved">return</span> element;
  },

  setOpacity: <span class="reserved">function</span>(element, value) {
    element = $(element);
    element.style.opacity = (value == 1 || value === <span class="literal">''</span>) ? <span class="literal">''</span> :
      (value &lt; 0.00001) ? 0 : value;
    <span class="reserved">return</span> element;
  },

  getDimensions: <span class="reserved">function</span>(element) {
    element = $(element);
    var display = element.getStyle(<span class="literal">'display'</span>);
    <span class="reserved">if</span> (display != <span class="literal">'none'</span> &amp;&amp; display != null) <span class="comment">// Safari bug</span>
      <span class="reserved">return</span> {width: element.offsetWidth, height: element.offsetHeight};

    var els = element.style;
    var originalVisibility = els.visibility;
    var originalPosition = els.position;
    var originalDisplay = els.display;
    els.visibility = <span class="literal">'hidden'</span>;
    <span class="reserved">if</span> (originalPosition != <span class="literal">'fixed'</span>) <span class="comment">// Switching fixed to absolute causes issues in Safari</span>
      els.position = <span class="literal">'absolute'</span>;
    els.display = <span class="literal">'block'</span>;
    var originalWidth = element.clientWidth;
    var originalHeight = element.clientHeight;
    els.display = originalDisplay;
    els.position = originalPosition;
    els.visibility = originalVisibility;
    <span class="reserved">return</span> {width: originalWidth, height: originalHeight};
  },

  makePositioned: <span class="reserved">function</span>(element) {
    element = $(element);
    var pos = Element.getStyle(element, <span class="literal">'position'</span>);
    <span class="reserved">if</span> (pos == <span class="literal">'static'</span> || !pos) {
      element._madePositioned = true;
      element.style.position = <span class="literal">'relative'</span>;
      <span class="reserved">if</span> (Prototype.Browser.Opera) {
        element.style.top = 0;
        element.style.left = 0;
      }
    }
    <span class="reserved">return</span> element;
  },

  undoPositioned: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (element._madePositioned) {
      element._madePositioned = undefined;
      element.style.position =
        element.style.top =
        element.style.left =
        element.style.bottom =
        element.style.right = <span class="literal">''</span>;
    }
    <span class="reserved">return</span> element;
  },

  makeClipping: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (element._overflow) <span class="reserved">return</span> element;
    element._overflow = Element.getStyle(element, <span class="literal">'overflow'</span>) || <span class="literal">'auto'</span>;
    <span class="reserved">if</span> (element._overflow !== <span class="literal">'hidden'</span>)
      element.style.overflow = <span class="literal">'hidden'</span>;
    <span class="reserved">return</span> element;
  },

  undoClipping: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (!element._overflow) <span class="reserved">return</span> element;
    element.style.overflow = element._overflow == <span class="literal">'auto'</span> ? <span class="literal">''</span> : element._overflow;
    element._overflow = null;
    <span class="reserved">return</span> element;
  },

  cumulativeOffset: <span class="reserved">function</span>(element) {
    var valueT = 0, valueL = 0;
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;
      element = element.offsetParent;
    } <span class="reserved">while</span> (element);
    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  },

  positionedOffset: <span class="reserved">function</span>(element) {
    var valueT = 0, valueL = 0;
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;
      element = element.offsetParent;
      <span class="reserved">if</span> (element) {
        <span class="reserved">if</span> (element.tagName.toUpperCase() == <span class="literal">'BODY'</span>) break;
        var p = Element.getStyle(element, <span class="literal">'position'</span>);
        <span class="reserved">if</span> (p !== <span class="literal">'static'</span>) break;
      }
    } <span class="reserved">while</span> (element);
    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  },

  absolutize: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (element.getStyle(<span class="literal">'position'</span>) == <span class="literal">'absolute'</span>) <span class="reserved">return</span> element;

    var offsets = element.positionedOffset();
    var top     = offsets[1];
    var left    = offsets[0];
    var width   = element.clientWidth;
    var height  = element.clientHeight;

    element._originalLeft   = left - parseFloat(element.style.left  || 0);
    element._originalTop    = top  - parseFloat(element.style.top || 0);
    element._originalWidth  = element.style.width;
    element._originalHeight = element.style.height;

    element.style.position = <span class="literal">'absolute'</span>;
    element.style.top    = top + <span class="literal">'px'</span>;
    element.style.left   = left + <span class="literal">'px'</span>;
    element.style.width  = width + <span class="literal">'px'</span>;
    element.style.height = height + <span class="literal">'px'</span>;
    <span class="reserved">return</span> element;
  },

  relativize: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (element.getStyle(<span class="literal">'position'</span>) == <span class="literal">'relative'</span>) <span class="reserved">return</span> element;

    element.style.position = <span class="literal">'relative'</span>;
    var top  = parseFloat(element.style.top  || 0) - (element._originalTop || 0);
    var left = parseFloat(element.style.left || 0) - (element._originalLeft || 0);

    element.style.top    = top + <span class="literal">'px'</span>;
    element.style.left   = left + <span class="literal">'px'</span>;
    element.style.height = element._originalHeight;
    element.style.width  = element._originalWidth;
    <span class="reserved">return</span> element;
  },

  cumulativeScrollOffset: <span class="reserved">function</span>(element) {
    var valueT = 0, valueL = 0;
    do {
      valueT += element.scrollTop  || 0;
      valueL += element.scrollLeft || 0;
      element = element.parentNode;
    } <span class="reserved">while</span> (element);
    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  },

  getOffsetParent: <span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (element.offsetParent) <span class="reserved">return</span> $(element.offsetParent);
    <span class="reserved">if</span> (element == document.body) <span class="reserved">return</span> $(element);

    <span class="reserved">while</span> ((element = element.parentNode) &amp;&amp; element != document.body)
      <span class="reserved">if</span> (Element.getStyle(element, <span class="literal">'position'</span>) != <span class="literal">'static'</span>)
        <span class="reserved">return</span> $(element);

    <span class="reserved">return</span> $(document.body);
  },

  viewportOffset: <span class="reserved">function</span>(forElement) {
    var valueT = 0, valueL = 0;

    var element = forElement;
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;

      <span class="reserved">if</span> (element.offsetParent == document.body &amp;&amp;
        Element.getStyle(element, <span class="literal">'position'</span>) == <span class="literal">'absolute'</span>) break;

    } <span class="reserved">while</span> (element = element.offsetParent);

    element = forElement;
    do {
      <span class="reserved">if</span> (!Prototype.Browser.Opera || (element.tagName &amp;&amp; (element.tagName.toUpperCase() == <span class="literal">'BODY'</span>))) {
        valueT -= element.scrollTop  || 0;
        valueL -= element.scrollLeft || 0;
      }
    } <span class="reserved">while</span> (element = element.parentNode);

    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  },

  clonePosition: <span class="reserved">function</span>(element, source) {
    var options = Object.extend({
      setLeft:    true,
      setTop:     true,
      setWidth:   true,
      setHeight:  true,
      offsetTop:  0,
      offsetLeft: 0
    }, arguments[2] || { });

    source = $(source);
    var p = source.viewportOffset();

    element = $(element);
    var delta = [0, 0];
    var parent = null;
    <span class="reserved">if</span> (Element.getStyle(element, <span class="literal">'position'</span>) == <span class="literal">'absolute'</span>) {
      parent = element.getOffsetParent();
      delta = parent.viewportOffset();
    }

    <span class="reserved">if</span> (parent == document.body) {
      delta[0] -= document.body.offsetLeft;
      delta[1] -= document.body.offsetTop;
    }

    <span class="reserved">if</span> (options.setLeft)   element.style.left  = (p[0] - delta[0] + options.offsetLeft) + <span class="literal">'px'</span>;
    <span class="reserved">if</span> (options.setTop)    element.style.top   = (p[1] - delta[1] + options.offsetTop) + <span class="literal">'px'</span>;
    <span class="reserved">if</span> (options.setWidth)  element.style.width = source.offsetWidth + <span class="literal">'px'</span>;
    <span class="reserved">if</span> (options.setHeight) element.style.height = source.offsetHeight + <span class="literal">'px'</span>;
    <span class="reserved">return</span> element;
  }
};

Object.extend(Element.Methods, {
  getElementsBySelector: Element.Methods.select,

  childElements: Element.Methods.immediateDescendants
});

Element._attributeTranslations = {
  write: {
    names: {
      className: <span class="literal">'class'</span>,
      htmlFor:   <span class="literal">'for'</span>
    },
    values: { }
  }
};

<span class="reserved">if</span> (Prototype.Browser.Opera) {
  Element.Methods.getStyle = Element.Methods.getStyle.wrap(
    <span class="reserved">function</span>(proceed, element, style) {
      switch (style) {
        case <span class="literal">'left'</span>: case <span class="literal">'top'</span>: case <span class="literal">'right'</span>: case <span class="literal">'bottom'</span>:
          <span class="reserved">if</span> (proceed(element, <span class="literal">'position'</span>) === <span class="literal">'static'</span>) <span class="reserved">return</span> null;
        case <span class="literal">'height'</span>: case <span class="literal">'width'</span>:
          <span class="reserved">if</span> (!Element.visible(element)) <span class="reserved">return</span> null;

          var dim = parseInt(proceed(element, style), 10);

          <span class="reserved">if</span> (dim !== element[<span class="literal">'offset'</span> + style.capitalize()])
            <span class="reserved">return</span> dim + <span class="literal">'px'</span>;

          var properties;
          <span class="reserved">if</span> (style === <span class="literal">'height'</span>) {
            properties = [<span class="literal">'border-top-width'</span>, <span class="literal">'padding-top'</span>,
             <span class="literal">'padding-bottom'</span>, <span class="literal">'border-bottom-width'</span>];
          }
          <span class="reserved">else</span> {
            properties = [<span class="literal">'border-left-width'</span>, <span class="literal">'padding-left'</span>,
             <span class="literal">'padding-right'</span>, <span class="literal">'border-right-width'</span>];
          }
          <span class="reserved">return</span> properties.inject(dim, <span class="reserved">function</span>(memo, property) {
            var val = proceed(element, property);
            <span class="reserved">return</span> val === null ? memo : memo - parseInt(val, 10);
          }) + <span class="literal">'px'</span>;
        default: <span class="reserved">return</span> proceed(element, style);
      }
    }
  );

  Element.Methods.readAttribute = Element.Methods.readAttribute.wrap(
    <span class="reserved">function</span>(proceed, element, attribute) {
      <span class="reserved">if</span> (attribute === <span class="literal">'title'</span>) <span class="reserved">return</span> element.title;
      <span class="reserved">return</span> proceed(element, attribute);
    }
  );
}

<span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.IE) {
  Element.Methods.getOffsetParent = Element.Methods.getOffsetParent.wrap(
    <span class="reserved">function</span>(proceed, element) {
      element = $(element);
      try { element.offsetParent }
      catch(e) { <span class="reserved">return</span> $(document.body) }
      var position = element.getStyle(<span class="literal">'position'</span>);
      <span class="reserved">if</span> (position !== <span class="literal">'static'</span>) <span class="reserved">return</span> proceed(element);
      element.setStyle({ position: <span class="literal">'relative'</span> });
      var value = proceed(element);
      element.setStyle({ position: position });
      <span class="reserved">return</span> value;
    }
  );

  $w(<span class="literal">'positionedOffset viewportOffset'</span>).each(<span class="reserved">function</span>(method) {
    Element.Methods[method] = Element.Methods[method].wrap(
      <span class="reserved">function</span>(proceed, element) {
        element = $(element);
        try { element.offsetParent }
        catch(e) { <span class="reserved">return</span> Element._returnOffset(0,0) }
        var position = element.getStyle(<span class="literal">'position'</span>);
        <span class="reserved">if</span> (position !== <span class="literal">'static'</span>) <span class="reserved">return</span> proceed(element);
        var offsetParent = element.getOffsetParent();
        <span class="reserved">if</span> (offsetParent &amp;&amp; offsetParent.getStyle(<span class="literal">'position'</span>) === <span class="literal">'fixed'</span>)
          offsetParent.setStyle({ zoom: 1 });
        element.setStyle({ position: <span class="literal">'relative'</span> });
        var value = proceed(element);
        element.setStyle({ position: position });
        <span class="reserved">return</span> value;
      }
    );
  });

  Element.Methods.cumulativeOffset = Element.Methods.cumulativeOffset.wrap(
    <span class="reserved">function</span>(proceed, element) {
      try { element.offsetParent }
      catch(e) { <span class="reserved">return</span> Element._returnOffset(0,0) }
      <span class="reserved">return</span> proceed(element);
    }
  );

  Element.Methods.getStyle = <span class="reserved">function</span>(element, style) {
    element = $(element);
    style = (style == <span class="literal">'float'</span> || style == <span class="literal">'cssFloat'</span>) ? <span class="literal">'styleFloat'</span> : style.camelize();
    var value = element.style[style];
    <span class="reserved">if</span> (!value &amp;&amp; element.currentStyle) value = element.currentStyle[style];

    <span class="reserved">if</span> (style == <span class="literal">'opacity'</span>) {
      <span class="reserved">if</span> (value = (element.getStyle(<span class="literal">'filter'</span>) || <span class="literal">''</span>).match(/alpha\(opacity=(.*)\)/))
        <span class="reserved">if</span> (value[1]) <span class="reserved">return</span> parseFloat(value[1]) / 100;
      <span class="reserved">return</span> 1.0;
    }

    <span class="reserved">if</span> (value == <span class="literal">'auto'</span>) {
      <span class="reserved">if</span> ((style == <span class="literal">'width'</span> || style == <span class="literal">'height'</span>) &amp;&amp; (element.getStyle(<span class="literal">'display'</span>) != <span class="literal">'none'</span>))
        <span class="reserved">return</span> element[<span class="literal">'offset'</span> + style.capitalize()] + <span class="literal">'px'</span>;
      <span class="reserved">return</span> null;
    }
    <span class="reserved">return</span> value;
  };

  Element.Methods.setOpacity = <span class="reserved">function</span>(element, value) {
    <span class="reserved">function</span> stripAlpha(filter){
      <span class="reserved">return</span> filter.replace(/alpha\([^\)]*\)/gi,<span class="literal">''</span>);
    }
    element = $(element);
    var currentStyle = element.currentStyle;
    <span class="reserved">if</span> ((currentStyle &amp;&amp; !currentStyle.hasLayout) ||
      (!currentStyle &amp;&amp; element.style.zoom == <span class="literal">'normal'</span>))
        element.style.zoom = 1;

    var filter = element.getStyle(<span class="literal">'filter'</span>), style = element.style;
    <span class="reserved">if</span> (value == 1 || value === <span class="literal">''</span>) {
      (filter = stripAlpha(filter)) ?
        style.filter = filter : style.removeAttribute(<span class="literal">'filter'</span>);
      <span class="reserved">return</span> element;
    } <span class="reserved">else</span> <span class="reserved">if</span> (value &lt; 0.00001) value = 0;
    style.filter = stripAlpha(filter) +
      <span class="literal">'alpha(opacity='</span> + (value * 100) + <span class="literal">')'</span>;
    <span class="reserved">return</span> element;
  };

  Element._attributeTranslations = (<span class="reserved">function</span>(){

    var classProp = <span class="literal">'className'</span>;
    var forProp = <span class="literal">'for'</span>;

    var el = document.createElement(<span class="literal">'div'</span>);

    el.setAttribute(classProp, <span class="literal">'x'</span>);

    <span class="reserved">if</span> (el.className !== <span class="literal">'x'</span>) {
      el.setAttribute(<span class="literal">'class'</span>, <span class="literal">'x'</span>);
      <span class="reserved">if</span> (el.className === <span class="literal">'x'</span>) {
        classProp = <span class="literal">'class'</span>;
      }
    }
    el = null;

    el = document.createElement(<span class="literal">'label'</span>);
    el.setAttribute(forProp, <span class="literal">'x'</span>);
    <span class="reserved">if</span> (el.htmlFor !== <span class="literal">'x'</span>) {
      el.setAttribute(<span class="literal">'htmlFor'</span>, <span class="literal">'x'</span>);
      <span class="reserved">if</span> (el.htmlFor === <span class="literal">'x'</span>) {
        forProp = <span class="literal">'htmlFor'</span>;
      }
    }
    el = null;

    <span class="reserved">return</span> {
      read: {
        names: {
          <span class="literal">'class'</span>:      classProp,
          <span class="literal">'className'</span>:  classProp,
          <span class="literal">'for'</span>:        forProp,
          <span class="literal">'htmlFor'</span>:    forProp
        },
        values: {
          _getAttr: <span class="reserved">function</span>(element, attribute) {
            <span class="reserved">return</span> element.getAttribute(attribute, 2);
          },
          _getAttrNode: <span class="reserved">function</span>(element, attribute) {
            var node = element.getAttributeNode(attribute);
            <span class="reserved">return</span> node ? node.value : <span class="literal">""</span>;
          },
          _getEv: (<span class="reserved">function</span>(){

            var el = document.createElement(<span class="literal">'div'</span>);
            el.onclick = Prototype.emptyFunction;
            var value = el.getAttribute(<span class="literal">'onclick'</span>);
            var f;

            <span class="reserved">if</span> (String(value).indexOf(<span class="literal">'{'</span>) &gt; -1) {
              f = <span class="reserved">function</span>(element, attribute) {
                attribute = element.getAttribute(attribute);
                <span class="reserved">if</span> (!attribute) <span class="reserved">return</span> null;
                attribute = attribute.toString();
                attribute = attribute.split(<span class="literal">'{'</span>)[1];
                attribute = attribute.split(<span class="literal">'}'</span>)[0];
                <span class="reserved">return</span> attribute.strip();
              }
            }
            <span class="reserved">else</span> <span class="reserved">if</span> (value === <span class="literal">''</span>) {
              f = <span class="reserved">function</span>(element, attribute) {
                attribute = element.getAttribute(attribute);
                <span class="reserved">if</span> (!attribute) <span class="reserved">return</span> null;
                <span class="reserved">return</span> attribute.strip();
              }
            }
            el = null;
            <span class="reserved">return</span> f;
          })(),
          _flag: <span class="reserved">function</span>(element, attribute) {
            <span class="reserved">return</span> $(element).hasAttribute(attribute) ? attribute : null;
          },
          style: <span class="reserved">function</span>(element) {
            <span class="reserved">return</span> element.style.cssText.toLowerCase();
          },
          title: <span class="reserved">function</span>(element) {
            <span class="reserved">return</span> element.title;
          }
        }
      }
    }
  })();

  Element._attributeTranslations.write = {
    names: Object.extend({
      cellpadding: <span class="literal">'cellPadding'</span>,
      cellspacing: <span class="literal">'cellSpacing'</span>
    }, Element._attributeTranslations.read.names),
    values: {
      checked: <span class="reserved">function</span>(element, value) {
        element.checked = !!value;
      },

      style: <span class="reserved">function</span>(element, value) {
        element.style.cssText = value ? value : <span class="literal">''</span>;
      }
    }
  };

  Element._attributeTranslations.has = {};

  $w(<span class="literal">'colSpan rowSpan vAlign dateTime accessKey tabIndex '</span> +
      <span class="literal">'encType maxLength readOnly longDesc frameBorder'</span>).each(<span class="reserved">function</span>(attr) {
    Element._attributeTranslations.write.names[attr.toLowerCase()] = attr;
    Element._attributeTranslations.has[attr.toLowerCase()] = attr;
  });

  (<span class="reserved">function</span>(v) {
    Object.extend(v, {
      href:        v._getAttr,
      src:         v._getAttr,
      type:        v._getAttr,
      action:      v._getAttrNode,
      disabled:    v._flag,
      checked:     v._flag,
      readonly:    v._flag,
      multiple:    v._flag,
      onload:      v._getEv,
      onunload:    v._getEv,
      onclick:     v._getEv,
      ondblclick:  v._getEv,
      onmousedown: v._getEv,
      onmouseup:   v._getEv,
      onmouseover: v._getEv,
      onmousemove: v._getEv,
      onmouseout:  v._getEv,
      onfocus:     v._getEv,
      onblur:      v._getEv,
      onkeypress:  v._getEv,
      onkeydown:   v._getEv,
      onkeyup:     v._getEv,
      onsubmit:    v._getEv,
      onreset:     v._getEv,
      onselect:    v._getEv,
      onchange:    v._getEv
    });
  })(Element._attributeTranslations.read.values);

  <span class="reserved">if</span> (Prototype.BrowserFeatures.ElementExtensions) {
    (<span class="reserved">function</span>() {
      <span class="reserved">function</span> _descendants(element) {
        var nodes = element.getElementsByTagName(<span class="literal">'*'</span>), results = [];
        <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
          <span class="reserved">if</span> (node.tagName !== <span class="literal">"!"</span>) <span class="comment">// Filter out comment nodes.</span>
            results.push(node);
        <span class="reserved">return</span> results;
      }

      Element.Methods.down = <span class="reserved">function</span>(element, expression, index) {
        element = $(element);
        <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> element.firstDescendant();
        <span class="reserved">return</span> Object.isNumber(expression) ? _descendants(element)[expression] :
          Element.select(element, expression)[index || 0];
      }
    })();
  }

}

<span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.Gecko &amp;&amp; /rv:1\.8\.0/.test(navigator.userAgent)) {
  Element.Methods.setOpacity = <span class="reserved">function</span>(element, value) {
    element = $(element);
    element.style.opacity = (value == 1) ? 0.999999 :
      (value === <span class="literal">''</span>) ? <span class="literal">''</span> : (value &lt; 0.00001) ? 0 : value;
    <span class="reserved">return</span> element;
  };
}

<span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.WebKit) {
  Element.Methods.setOpacity = <span class="reserved">function</span>(element, value) {
    element = $(element);
    element.style.opacity = (value == 1 || value === <span class="literal">''</span>) ? <span class="literal">''</span> :
      (value &lt; 0.00001) ? 0 : value;

    <span class="reserved">if</span> (value == 1)
      <span class="reserved">if</span>(element.tagName.toUpperCase() == <span class="literal">'IMG'</span> &amp;&amp; element.width) {
        element.width++; element.width--;
      } <span class="reserved">else</span> try {
        var n = document.createTextNode(<span class="literal">' '</span>);
        element.appendChild(n);
        element.removeChild(n);
      } catch (e) { }

    <span class="reserved">return</span> element;
  };

  Element.Methods.cumulativeOffset = <span class="reserved">function</span>(element) {
    var valueT = 0, valueL = 0;
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;
      <span class="reserved">if</span> (element.offsetParent == document.body)
        <span class="reserved">if</span> (Element.getStyle(element, <span class="literal">'position'</span>) == <span class="literal">'absolute'</span>) break;

      element = element.offsetParent;
    } <span class="reserved">while</span> (element);

    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  };
}

<span class="reserved">if</span> (<span class="literal">'outerHTML'</span> in document.documentElement) {
  Element.Methods.replace = <span class="reserved">function</span>(element, content) {
    element = $(element);

    <span class="reserved">if</span> (content &amp;&amp; content.toElement) content = content.toElement();
    <span class="reserved">if</span> (Object.isElement(content)) {
      element.parentNode.replaceChild(content, element);
      <span class="reserved">return</span> element;
    }

    content = Object.toHTML(content);
    var parent = element.parentNode, tagName = parent.tagName.toUpperCase();

    <span class="reserved">if</span> (Element._insertionTranslations.tags[tagName]) {
      var nextSibling = element.next();
      var fragments = Element._getContentFromAnonymousElement(tagName, content.stripScripts());
      parent.removeChild(element);
      <span class="reserved">if</span> (nextSibling)
        fragments.each(<span class="reserved">function</span>(node) { parent.insertBefore(node, nextSibling) });
      <span class="reserved">else</span>
        fragments.each(<span class="reserved">function</span>(node) { parent.appendChild(node) });
    }
    <span class="reserved">else</span> element.outerHTML = content.stripScripts();

    content.evalScripts.bind(content).defer();
    <span class="reserved">return</span> element;
  };
}

Element._returnOffset = <span class="reserved">function</span>(l, t) {
  var result = [l, t];
  result.left = l;
  result.top = t;
  <span class="reserved">return</span> result;
};

Element._getContentFromAnonymousElement = <span class="reserved">function</span>(tagName, html) {
  var div = new Element(<span class="literal">'div'</span>), t = Element._insertionTranslations.tags[tagName];
  <span class="reserved">if</span> (t) {
    div.innerHTML = t[0] + html + t[1];
    t[2].times(<span class="reserved">function</span>() { div = div.firstChild });
  } <span class="reserved">else</span> div.innerHTML = html;
  <span class="reserved">return</span> $A(div.childNodes);
};

Element._insertionTranslations = {
  before: <span class="reserved">function</span>(element, node) {
    element.parentNode.insertBefore(node, element);
  },
  top: <span class="reserved">function</span>(element, node) {
    element.insertBefore(node, element.firstChild);
  },
  bottom: <span class="reserved">function</span>(element, node) {
    element.appendChild(node);
  },
  after: <span class="reserved">function</span>(element, node) {
    element.parentNode.insertBefore(node, element.nextSibling);
  },
  tags: {
    TABLE:  [<span class="literal">'&lt;table&gt;'</span>,                <span class="literal">'&lt;/table&gt;'</span>,                   1],
    TBODY:  [<span class="literal">'&lt;table&gt;&lt;tbody&gt;'</span>,         <span class="literal">'&lt;/tbody&gt;&lt;/table&gt;'</span>,           2],
    TR:     [<span class="literal">'&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;'</span>,     <span class="literal">'&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'</span>,      3],
    TD:     [<span class="literal">'&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;'</span>, <span class="literal">'&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'</span>, 4],
    SELECT: [<span class="literal">'&lt;select&gt;'</span>,               <span class="literal">'&lt;/select&gt;'</span>,                  1]
  }
};

(<span class="reserved">function</span>() {
  Object.extend(<span class="reserved">this</span>.tags, {
    THEAD: <span class="reserved">this</span>.tags.TBODY,
    TFOOT: <span class="reserved">this</span>.tags.TBODY,
    TH:    <span class="reserved">this</span>.tags.TD
  });
}).call(Element._insertionTranslations);

Element.Methods.Simulated = {
  hasAttribute: <span class="reserved">function</span>(element, attribute) {
    attribute = Element._attributeTranslations.has[attribute] || attribute;
    var node = $(element).getAttributeNode(attribute);
    <span class="reserved">return</span> !!(node &amp;&amp; node.specified);
  }
};

Element.Methods.ByTag = { };

Object.extend(Element, Element.Methods);

(<span class="reserved">function</span>(div) {

  <span class="reserved">if</span> (!Prototype.BrowserFeatures.ElementExtensions &amp;&amp; div[<span class="literal">'__proto__'</span>]) {
    window.HTMLElement = { };
    window.HTMLElement.<span class="reserved">prototype</span> = div[<span class="literal">'__proto__'</span>];
    Prototype.BrowserFeatures.ElementExtensions = true;
  }

  div = null;

})(document.createElement(<span class="literal">'div'</span>))

Element.extend = (<span class="reserved">function</span>() {

  <span class="reserved">function</span> checkDeficiency(tagName) {
    <span class="reserved">if</span> (typeof window.Element != <span class="literal">'undefined'</span>) {
      var proto = window.Element.<span class="reserved">prototype</span>;
      <span class="reserved">if</span> (proto) {
        var id = <span class="literal">'_'</span> + (Math.random()+<span class="literal">''</span>).slice(2);
        var el = document.createElement(tagName);
        proto[id] = <span class="literal">'x'</span>;
        var isBuggy = (el[id] !== <span class="literal">'x'</span>);
        delete proto[id];
        el = null;
        <span class="reserved">return</span> isBuggy;
      }
    }
    <span class="reserved">return</span> false;
  }

  <span class="reserved">function</span> extendElementWith(element, methods) {
    <span class="reserved">for</span> (var property in methods) {
      var value = methods[property];
      <span class="reserved">if</span> (Object.isFunction(value) &amp;&amp; !(property in element))
        element[property] = value.methodize();
    }
  }

  var HTMLOBJECTELEMENT_PROTOTYPE_BUGGY = checkDeficiency(<span class="literal">'object'</span>);
  var HTMLAPPLETELEMENT_PROTOTYPE_BUGGY = checkDeficiency(<span class="literal">'applet'</span>);

  <span class="reserved">if</span> (Prototype.BrowserFeatures.SpecificElementExtensions) {
    <span class="reserved">if</span> (HTMLOBJECTELEMENT_PROTOTYPE_BUGGY &amp;&amp;
        HTMLAPPLETELEMENT_PROTOTYPE_BUGGY) {
      <span class="reserved">return</span> <span class="reserved">function</span>(element) {
        <span class="reserved">if</span> (element &amp;&amp; element.tagName) {
          var tagName = element.tagName.toUpperCase();
          <span class="reserved">if</span> (tagName === <span class="literal">'OBJECT'</span> || tagName === <span class="literal">'APPLET'</span>) {
            extendElementWith(element, Element.Methods);
            <span class="reserved">if</span> (tagName === <span class="literal">'OBJECT'</span>) {
              extendElementWith(element, Element.Methods.ByTag.OBJECT)
            }
            <span class="reserved">else</span> <span class="reserved">if</span> (tagName === <span class="literal">'APPLET'</span>) {
              extendElementWith(element, Element.Methods.ByTag.APPLET)
            }
          }
        }
        <span class="reserved">return</span> element;
      }
    }
    <span class="reserved">return</span> Prototype.K;
  }

  var Methods = { }, ByTag = Element.Methods.ByTag;

  var extend = Object.extend(<span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (!element || typeof element._extendedByPrototype != <span class="literal">'undefined'</span> ||
        element.nodeType != 1 || element == window) <span class="reserved">return</span> element;

    var methods = Object.clone(Methods),
        tagName = element.tagName.toUpperCase();

    <span class="reserved">if</span> (ByTag[tagName]) Object.extend(methods, ByTag[tagName]);

    extendElementWith(element, methods);

    element._extendedByPrototype = Prototype.emptyFunction;
    <span class="reserved">return</span> element;

  }, {
    refresh: <span class="reserved">function</span>() {
      <span class="reserved">if</span> (!Prototype.BrowserFeatures.ElementExtensions) {
        Object.extend(Methods, Element.Methods);
        Object.extend(Methods, Element.Methods.Simulated);
      }
    }
  });

  extend.refresh();
  <span class="reserved">return</span> extend;
})();

Element.hasAttribute = <span class="reserved">function</span>(element, attribute) {
  <span class="reserved">if</span> (element.hasAttribute) <span class="reserved">return</span> element.hasAttribute(attribute);
  <span class="reserved">return</span> Element.Methods.Simulated.hasAttribute(element, attribute);
};

Element.addMethods = <span class="reserved">function</span>(methods) {
  var F = Prototype.BrowserFeatures, T = Element.Methods.ByTag;

  <span class="reserved">if</span> (!methods) {
    Object.extend(Form, Form.Methods);
    Object.extend(Form.Element, Form.Element.Methods);
    Object.extend(Element.Methods.ByTag, {
      <span class="literal">"FORM"</span>:     Object.clone(Form.Methods),
      <span class="literal">"INPUT"</span>:    Object.clone(Form.Element.Methods),
      <span class="literal">"SELECT"</span>:   Object.clone(Form.Element.Methods),
      <span class="literal">"TEXTAREA"</span>: Object.clone(Form.Element.Methods)
    });
  }

  <span class="reserved">if</span> (arguments.length == 2) {
    var tagName = methods;
    methods = arguments[1];
  }

  <span class="reserved">if</span> (!tagName) Object.extend(Element.Methods, methods || { });
  <span class="reserved">else</span> {
    <span class="reserved">if</span> (Object.isArray(tagName)) tagName.each(extend);
    <span class="reserved">else</span> extend(tagName);
  }

  <span class="reserved">function</span> extend(tagName) {
    tagName = tagName.toUpperCase();
    <span class="reserved">if</span> (!Element.Methods.ByTag[tagName])
      Element.Methods.ByTag[tagName] = { };
    Object.extend(Element.Methods.ByTag[tagName], methods);
  }

  <span class="reserved">function</span> copy(methods, destination, onlyIfAbsent) {
    onlyIfAbsent = onlyIfAbsent || false;
    <span class="reserved">for</span> (var property in methods) {
      var value = methods[property];
      <span class="reserved">if</span> (!Object.isFunction(value)) continue;
      <span class="reserved">if</span> (!onlyIfAbsent || !(property in destination))
        destination[property] = value.methodize();
    }
  }

  <span class="reserved">function</span> findDOMClass(tagName) {
    var klass;
    var trans = {
      <span class="literal">"OPTGROUP"</span>: <span class="literal">"OptGroup"</span>, <span class="literal">"TEXTAREA"</span>: <span class="literal">"TextArea"</span>, <span class="literal">"P"</span>: <span class="literal">"Paragraph"</span>,
      <span class="literal">"FIELDSET"</span>: <span class="literal">"FieldSet"</span>, <span class="literal">"UL"</span>: <span class="literal">"UList"</span>, <span class="literal">"OL"</span>: <span class="literal">"OList"</span>, <span class="literal">"DL"</span>: <span class="literal">"DList"</span>,
      <span class="literal">"DIR"</span>: <span class="literal">"Directory"</span>, <span class="literal">"H1"</span>: <span class="literal">"Heading"</span>, <span class="literal">"H2"</span>: <span class="literal">"Heading"</span>, <span class="literal">"H3"</span>: <span class="literal">"Heading"</span>,
      <span class="literal">"H4"</span>: <span class="literal">"Heading"</span>, <span class="literal">"H5"</span>: <span class="literal">"Heading"</span>, <span class="literal">"H6"</span>: <span class="literal">"Heading"</span>, <span class="literal">"Q"</span>: <span class="literal">"Quote"</span>,
      <span class="literal">"INS"</span>: <span class="literal">"Mod"</span>, <span class="literal">"DEL"</span>: <span class="literal">"Mod"</span>, <span class="literal">"A"</span>: <span class="literal">"Anchor"</span>, <span class="literal">"IMG"</span>: <span class="literal">"Image"</span>, <span class="literal">"CAPTION"</span>:
      <span class="literal">"TableCaption"</span>, <span class="literal">"COL"</span>: <span class="literal">"TableCol"</span>, <span class="literal">"COLGROUP"</span>: <span class="literal">"TableCol"</span>, <span class="literal">"THEAD"</span>:
      <span class="literal">"TableSection"</span>, <span class="literal">"TFOOT"</span>: <span class="literal">"TableSection"</span>, <span class="literal">"TBODY"</span>: <span class="literal">"TableSection"</span>, <span class="literal">"TR"</span>:
      <span class="literal">"TableRow"</span>, <span class="literal">"TH"</span>: <span class="literal">"TableCell"</span>, <span class="literal">"TD"</span>: <span class="literal">"TableCell"</span>, <span class="literal">"FRAMESET"</span>:
      <span class="literal">"FrameSet"</span>, <span class="literal">"IFRAME"</span>: <span class="literal">"IFrame"</span>
    };
    <span class="reserved">if</span> (trans[tagName]) klass = <span class="literal">'HTML'</span> + trans[tagName] + <span class="literal">'Element'</span>;
    <span class="reserved">if</span> (window[klass]) <span class="reserved">return</span> window[klass];
    klass = <span class="literal">'HTML'</span> + tagName + <span class="literal">'Element'</span>;
    <span class="reserved">if</span> (window[klass]) <span class="reserved">return</span> window[klass];
    klass = <span class="literal">'HTML'</span> + tagName.capitalize() + <span class="literal">'Element'</span>;
    <span class="reserved">if</span> (window[klass]) <span class="reserved">return</span> window[klass];

    var element = document.createElement(tagName);
    var proto = element[<span class="literal">'__proto__'</span>] || element.constructor.<span class="reserved">prototype</span>;
    element = null;
    <span class="reserved">return</span> proto;
  }

  var elementPrototype = window.HTMLElement ? HTMLElement.<span class="reserved">prototype</span> :
   Element.<span class="reserved">prototype</span>;

  <span class="reserved">if</span> (F.ElementExtensions) {
    copy(Element.Methods, elementPrototype);
    copy(Element.Methods.Simulated, elementPrototype, true);
  }

  <span class="reserved">if</span> (F.SpecificElementExtensions) {
    <span class="reserved">for</span> (var tag in Element.Methods.ByTag) {
      var klass = findDOMClass(tag);
      <span class="reserved">if</span> (Object.isUndefined(klass)) continue;
      copy(T[tag], klass.<span class="reserved">prototype</span>);
    }
  }

  Object.extend(Element, Element.Methods);
  delete Element.ByTag;

  <span class="reserved">if</span> (Element.extend.refresh) Element.extend.refresh();
  Element.cache = { };
};


document.viewport = {

  getDimensions: <span class="reserved">function</span>() {
    <span class="reserved">return</span> { width: <span class="reserved">this</span>.getWidth(), height: <span class="reserved">this</span>.getHeight() };
  },

  getScrollOffsets: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Element._returnOffset(
      window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft,
      window.pageYOffset || document.documentElement.scrollTop  || document.body.scrollTop);
  }
};

(<span class="reserved">function</span>(viewport) {
  var B = Prototype.Browser, doc = document, element, property = {};

  <span class="reserved">function</span> getRootElement() {
    <span class="reserved">if</span> (B.WebKit &amp;&amp; !doc.evaluate)
      <span class="reserved">return</span> document;

    <span class="reserved">if</span> (B.Opera &amp;&amp; window.parseFloat(window.opera.version()) &lt; 9.5)
      <span class="reserved">return</span> document.body;

    <span class="reserved">return</span> document.documentElement;
  }

  <span class="reserved">function</span> define(D) {
    <span class="reserved">if</span> (!element) element = getRootElement();

    property[D] = <span class="literal">'client'</span> + D;

    viewport[<span class="literal">'get'</span> + D] = <span class="reserved">function</span>() { <span class="reserved">return</span> element[property[D]] };
    <span class="reserved">return</span> viewport[<span class="literal">'get'</span> + D]();
  }

  viewport.getWidth  = define.curry(<span class="literal">'Width'</span>);

  viewport.getHeight = define.curry(<span class="literal">'Height'</span>);
})(document.viewport);


Element.Storage = {
  UID: 1
};

Element.addMethods({
  getStorage: <span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;

    var uid;
    <span class="reserved">if</span> (element === window) {
      uid = 0;
    } <span class="reserved">else</span> {
      <span class="reserved">if</span> (typeof element._prototypeUID === <span class="literal">"undefined"</span>)
        element._prototypeUID = [Element.Storage.UID++];
      uid = element._prototypeUID[0];
    }

    <span class="reserved">if</span> (!Element.Storage[uid])
      Element.Storage[uid] = $H();

    <span class="reserved">return</span> Element.Storage[uid];
  },

  store: <span class="reserved">function</span>(element, key, value) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;

    <span class="reserved">if</span> (arguments.length === 2) {
      element.getStorage().update(key);
    } <span class="reserved">else</span> {
      element.getStorage().set(key, value);
    }

    <span class="reserved">return</span> element;
  },

  retrieve: <span class="reserved">function</span>(element, key, defaultValue) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    var hash = Element.getStorage(element), value = hash.get(key);

    <span class="reserved">if</span> (Object.isUndefined(value)) {
      hash.set(key, defaultValue);
      value = defaultValue;
    }

    <span class="reserved">return</span> value;
  },

  clone: <span class="reserved">function</span>(element, deep) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    var clone = element.cloneNode(deep);
    clone._prototypeUID = void 0;
    <span class="reserved">if</span> (deep) {
      var descendants = Element.select(clone, <span class="literal">'*'</span>),
          i = descendants.length;
      <span class="reserved">while</span> (i--) {
        descendants[i]._prototypeUID = void 0;
      }
    }
    <span class="reserved">return</span> Element.extend(clone);
  }
});
<span class="comment">/* Portions of the Selector class are derived from Jack Slocum's DomQuery,
 * part of YUI-Ext version 0.40, distributed under the terms of an MIT-style
 * license.  Please see http://www.yui-ext.com/ for more information. */</span>

var Selector = Class.create({
  initialize: <span class="reserved">function</span>(expression) {
    <span class="reserved">this</span>.expression = expression.strip();

    <span class="reserved">if</span> (<span class="reserved">this</span>.shouldUseSelectorsAPI()) {
      <span class="reserved">this</span>.mode = <span class="literal">'selectorsAPI'</span>;
    } <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.shouldUseXPath()) {
      <span class="reserved">this</span>.mode = <span class="literal">'xpath'</span>;
      <span class="reserved">this</span>.compileXPathMatcher();
    } <span class="reserved">else</span> {
      <span class="reserved">this</span>.mode = <span class="literal">"normal"</span>;
      <span class="reserved">this</span>.compileMatcher();
    }

  },

  shouldUseXPath: (<span class="reserved">function</span>() {

    var IS_DESCENDANT_SELECTOR_BUGGY = (<span class="reserved">function</span>(){
      var isBuggy = false;
      <span class="reserved">if</span> (document.evaluate &amp;&amp; window.XPathResult) {
        var el = document.createElement(<span class="literal">'div'</span>);
        el.innerHTML = <span class="literal">'&lt;ul&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;'</span>;

        var xpath = <span class="literal">".//*[local-name()='ul' or local-name()='UL']"</span> +
          <span class="literal">"//*[local-name()='li' or local-name()='LI']"</span>;

        var result = document.evaluate(xpath, el, null,
          XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);

        isBuggy = (result.snapshotLength !== 2);
        el = null;
      }
      <span class="reserved">return</span> isBuggy;
    })();

    <span class="reserved">return</span> <span class="reserved">function</span>() {
      <span class="reserved">if</span> (!Prototype.BrowserFeatures.XPath) <span class="reserved">return</span> false;

      var e = <span class="reserved">this</span>.expression;

      <span class="reserved">if</span> (Prototype.Browser.WebKit &amp;&amp;
       (e.include(<span class="literal">"-of-type"</span>) || e.include(<span class="literal">":empty"</span>)))
        <span class="reserved">return</span> false;

      <span class="reserved">if</span> ((/(\[[\w-]*?:|:checked)/).test(e))
        <span class="reserved">return</span> false;

      <span class="reserved">if</span> (IS_DESCENDANT_SELECTOR_BUGGY) <span class="reserved">return</span> false;

      <span class="reserved">return</span> true;
    }

  })(),

  shouldUseSelectorsAPI: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (!Prototype.BrowserFeatures.SelectorsAPI) <span class="reserved">return</span> false;

    <span class="reserved">if</span> (Selector.CASE_INSENSITIVE_CLASS_NAMES) <span class="reserved">return</span> false;

    <span class="reserved">if</span> (!Selector._div) Selector._div = new Element(<span class="literal">'div'</span>);

    try {
      Selector._div.querySelector(<span class="reserved">this</span>.expression);
    } catch(e) {
      <span class="reserved">return</span> false;
    }

    <span class="reserved">return</span> true;
  },

  compileMatcher: <span class="reserved">function</span>() {
    var e = <span class="reserved">this</span>.expression, ps = Selector.patterns, h = Selector.handlers,
        c = Selector.criteria, le, p, m, len = ps.length, name;

    <span class="reserved">if</span> (Selector._cache[e]) {
      <span class="reserved">this</span>.matcher = Selector._cache[e];
      <span class="reserved">return</span>;
    }

    <span class="reserved">this</span>.matcher = [<span class="literal">"this.matcher = function(root) {"</span>,
                    <span class="literal">"var r = root, h = Selector.handlers, c = false, n;"</span>];

    <span class="reserved">while</span> (e &amp;&amp; le != e &amp;&amp; (/\S/).test(e)) {
      le = e;
      <span class="reserved">for</span> (var i = 0; i&lt;len; i++) {
        p = ps[i].re;
        name = ps[i].name;
        <span class="reserved">if</span> (m = e.match(p)) {
          <span class="reserved">this</span>.matcher.push(Object.isFunction(c[name]) ? c[name](m) :
            new Template(c[name]).evaluate(m));
          e = e.replace(m[0], <span class="literal">''</span>);
          break;
        }
      }
    }

    <span class="reserved">this</span>.matcher.push(<span class="literal">"return h.unique(n);\n}"</span>);
    eval(<span class="reserved">this</span>.matcher.join(<span class="literal">'\n'</span>));
    Selector._cache[<span class="reserved">this</span>.expression] = <span class="reserved">this</span>.matcher;
  },

  compileXPathMatcher: <span class="reserved">function</span>() {
    var e = <span class="reserved">this</span>.expression, ps = Selector.patterns,
        x = Selector.xpath, le, m, len = ps.length, name;

    <span class="reserved">if</span> (Selector._cache[e]) {
      <span class="reserved">this</span>.xpath = Selector._cache[e]; <span class="reserved">return</span>;
    }

    <span class="reserved">this</span>.matcher = [<span class="literal">'.//*'</span>];
    <span class="reserved">while</span> (e &amp;&amp; le != e &amp;&amp; (/\S/).test(e)) {
      le = e;
      <span class="reserved">for</span> (var i = 0; i&lt;len; i++) {
        name = ps[i].name;
        <span class="reserved">if</span> (m = e.match(ps[i].re)) {
          <span class="reserved">this</span>.matcher.push(Object.isFunction(x[name]) ? x[name](m) :
            new Template(x[name]).evaluate(m));
          e = e.replace(m[0], <span class="literal">''</span>);
          break;
        }
      }
    }

    <span class="reserved">this</span>.xpath = <span class="reserved">this</span>.matcher.join(<span class="literal">''</span>);
    Selector._cache[<span class="reserved">this</span>.expression] = <span class="reserved">this</span>.xpath;
  },

  findElements: <span class="reserved">function</span>(root) {
    root = root || document;
    var e = <span class="reserved">this</span>.expression, results;

    switch (<span class="reserved">this</span>.mode) {
      case <span class="literal">'selectorsAPI'</span>:
        <span class="reserved">if</span> (root !== document) {
          var oldId = root.id, id = $(root).identify();
          id = id.replace(/[\.:]/g, <span class="literal">"\\$0"</span>);
          e = <span class="literal">"#"</span> + id + <span class="literal">" "</span> + e;
        }

        results = $A(root.querySelectorAll(e)).map(Element.extend);
        root.id = oldId;

        <span class="reserved">return</span> results;
      case <span class="literal">'xpath'</span>:
        <span class="reserved">return</span> document._getElementsByXPath(<span class="reserved">this</span>.xpath, root);
      default:
       <span class="reserved">return</span> <span class="reserved">this</span>.matcher(root);
    }
  },

  match: <span class="reserved">function</span>(element) {
    <span class="reserved">this</span>.tokens = [];

    var e = <span class="reserved">this</span>.expression, ps = Selector.patterns, as = Selector.assertions;
    var le, p, m, len = ps.length, name;

    <span class="reserved">while</span> (e &amp;&amp; le !== e &amp;&amp; (/\S/).test(e)) {
      le = e;
      <span class="reserved">for</span> (var i = 0; i&lt;len; i++) {
        p = ps[i].re;
        name = ps[i].name;
        <span class="reserved">if</span> (m = e.match(p)) {
          <span class="reserved">if</span> (as[name]) {
            <span class="reserved">this</span>.tokens.push([name, Object.clone(m)]);
            e = e.replace(m[0], <span class="literal">''</span>);
          } <span class="reserved">else</span> {
            <span class="reserved">return</span> <span class="reserved">this</span>.findElements(document).include(element);
          }
        }
      }
    }

    var match = true, name, matches;
    <span class="reserved">for</span> (var i = 0, token; token = <span class="reserved">this</span>.tokens[i]; i++) {
      name = token[0], matches = token[1];
      <span class="reserved">if</span> (!Selector.assertions[name](element, matches)) {
        match = false; break;
      }
    }

    <span class="reserved">return</span> match;
  },

  toString: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.expression;
  },

  inspect: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="literal">"#&lt;Selector:"</span> + <span class="reserved">this</span>.expression.inspect() + <span class="literal">"&gt;"</span>;
  }
});

<span class="reserved">if</span> (Prototype.BrowserFeatures.SelectorsAPI &amp;&amp;
 document.compatMode === <span class="literal">'BackCompat'</span>) {
  Selector.CASE_INSENSITIVE_CLASS_NAMES = (<span class="reserved">function</span>(){
    var div = document.createElement(<span class="literal">'div'</span>),
     span = document.createElement(<span class="literal">'span'</span>);

    div.id = <span class="literal">"prototype_test_id"</span>;
    span.className = <span class="literal">'Test'</span>;
    div.appendChild(span);
    var isIgnored = (div.querySelector(<span class="literal">'#prototype_test_id .test'</span>) !== null);
    div = span = null;
    <span class="reserved">return</span> isIgnored;
  })();
}

Object.extend(Selector, {
  _cache: { },

  xpath: {
    descendant:   <span class="literal">"//*"</span>,
    child:        <span class="literal">"/*"</span>,
    adjacent:     <span class="literal">"/following-sibling::*[1]"</span>,
    laterSibling: <span class="literal">'/following-sibling::*'</span>,
    tagName:      <span class="reserved">function</span>(m) {
      <span class="reserved">if</span> (m[1] == <span class="literal">'*'</span>) <span class="reserved">return</span> <span class="literal">''</span>;
      <span class="reserved">return</span> <span class="literal">"[local-name()='"</span> + m[1].toLowerCase() +
             <span class="literal">"' or local-name()='"</span> + m[1].toUpperCase() + <span class="literal">"']"</span>;
    },
    className:    <span class="literal">"[contains(concat(' ', @class, ' '), ' #{1} ')]"</span>,
    id:           <span class="literal">"[@id='#{1}']"</span>,
    attrPresence: <span class="reserved">function</span>(m) {
      m[1] = m[1].toLowerCase();
      <span class="reserved">return</span> new Template(<span class="literal">"[@#{1}]"</span>).evaluate(m);
    },
    attr: <span class="reserved">function</span>(m) {
      m[1] = m[1].toLowerCase();
      m[3] = m[5] || m[6];
      <span class="reserved">return</span> new Template(Selector.xpath.operators[m[2]]).evaluate(m);
    },
    pseudo: <span class="reserved">function</span>(m) {
      var h = Selector.xpath.pseudos[m[1]];
      <span class="reserved">if</span> (!h) <span class="reserved">return</span> <span class="literal">''</span>;
      <span class="reserved">if</span> (Object.isFunction(h)) <span class="reserved">return</span> h(m);
      <span class="reserved">return</span> new Template(Selector.xpath.pseudos[m[1]]).evaluate(m);
    },
    operators: {
      <span class="literal">'='</span>:  <span class="literal">"[@#{1}='#{3}']"</span>,
      <span class="literal">'!='</span>: <span class="literal">"[@#{1}!='#{3}']"</span>,
      <span class="literal">'^='</span>: <span class="literal">"[starts-with(@#{1}, '#{3}')]"</span>,
      <span class="literal">'$='</span>: <span class="literal">"[substring(@#{1}, (string-length(@#{1}) - string-length('#{3}') + 1))='#{3}']"</span>,
      <span class="literal">'*='</span>: <span class="literal">"[contains(@#{1}, '#{3}')]"</span>,
      <span class="literal">'~='</span>: <span class="literal">"[contains(concat(' ', @#{1}, ' '), ' #{3} ')]"</span>,
      <span class="literal">'|='</span>: <span class="literal">"[contains(concat('-', @#{1}, '-'), '-#{3}-')]"</span>
    },
    pseudos: {
      <span class="literal">'first-child'</span>: <span class="literal">'[not(preceding-sibling::*)]'</span>,
      <span class="literal">'last-child'</span>:  <span class="literal">'[not(following-sibling::*)]'</span>,
      <span class="literal">'only-child'</span>:  <span class="literal">'[not(preceding-sibling::* or following-sibling::*)]'</span>,
      <span class="literal">'empty'</span>:       <span class="literal">"[count(*) = 0 and (count(text()) = 0)]"</span>,
      <span class="literal">'checked'</span>:     <span class="literal">"[@checked]"</span>,
      <span class="literal">'disabled'</span>:    <span class="literal">"[(@disabled) and (@type!='hidden')]"</span>,
      <span class="literal">'enabled'</span>:     <span class="literal">"[not(@disabled) and (@type!='hidden')]"</span>,
      <span class="literal">'not'</span>: <span class="reserved">function</span>(m) {
        var e = m[6], p = Selector.patterns,
            x = Selector.xpath, le, v, len = p.length, name;

        var exclusion = [];
        <span class="reserved">while</span> (e &amp;&amp; le != e &amp;&amp; (/\S/).test(e)) {
          le = e;
          <span class="reserved">for</span> (var i = 0; i&lt;len; i++) {
            name = p[i].name
            <span class="reserved">if</span> (m = e.match(p[i].re)) {
              v = Object.isFunction(x[name]) ? x[name](m) : new Template(x[name]).evaluate(m);
              exclusion.push(<span class="literal">"("</span> + v.substring(1, v.length - 1) + <span class="literal">")"</span>);
              e = e.replace(m[0], <span class="literal">''</span>);
              break;
            }
          }
        }
        <span class="reserved">return</span> <span class="literal">"[not("</span> + exclusion.join(<span class="literal">" and "</span>) + <span class="literal">")]"</span>;
      },
      <span class="literal">'nth-child'</span>:      <span class="reserved">function</span>(m) {
        <span class="reserved">return</span> Selector.xpath.pseudos.nth(<span class="literal">"(count(./preceding-sibling::*) + 1) "</span>, m);
      },
      <span class="literal">'nth-last-child'</span>: <span class="reserved">function</span>(m) {
        <span class="reserved">return</span> Selector.xpath.pseudos.nth(<span class="literal">"(count(./following-sibling::*) + 1) "</span>, m);
      },
      <span class="literal">'nth-of-type'</span>:    <span class="reserved">function</span>(m) {
        <span class="reserved">return</span> Selector.xpath.pseudos.nth(<span class="literal">"position() "</span>, m);
      },
      <span class="literal">'nth-last-of-type'</span>: <span class="reserved">function</span>(m) {
        <span class="reserved">return</span> Selector.xpath.pseudos.nth(<span class="literal">"(last() + 1 - position()) "</span>, m);
      },
      <span class="literal">'first-of-type'</span>:  <span class="reserved">function</span>(m) {
        m[6] = <span class="literal">"1"</span>; <span class="reserved">return</span> Selector.xpath.pseudos[<span class="literal">'nth-of-type'</span>](m);
      },
      <span class="literal">'last-of-type'</span>:   <span class="reserved">function</span>(m) {
        m[6] = <span class="literal">"1"</span>; <span class="reserved">return</span> Selector.xpath.pseudos[<span class="literal">'nth-last-of-type'</span>](m);
      },
      <span class="literal">'only-of-type'</span>:   <span class="reserved">function</span>(m) {
        var p = Selector.xpath.pseudos; <span class="reserved">return</span> p[<span class="literal">'first-of-type'</span>](m) + p[<span class="literal">'last-of-type'</span>](m);
      },
      nth: <span class="reserved">function</span>(fragment, m) {
        var mm, formula = m[6], predicate;
        <span class="reserved">if</span> (formula == <span class="literal">'even'</span>) formula = <span class="literal">'2n+0'</span>;
        <span class="reserved">if</span> (formula == <span class="literal">'odd'</span>)  formula = <span class="literal">'2n+1'</span>;
        <span class="reserved">if</span> (mm = formula.match(/^(\d+)$/)) <span class="comment">// digit only</span>
          <span class="reserved">return</span> <span class="literal">'['</span> + fragment + <span class="literal">"= "</span> + mm[1] + <span class="literal">']'</span>;
        <span class="reserved">if</span> (mm = formula.match(/^(-?\d*)?n(([+-])(\d+))?/)) { <span class="comment">// an+b</span>
          <span class="reserved">if</span> (mm[1] == <span class="literal">"-"</span>) mm[1] = -1;
          var a = mm[1] ? Number(mm[1]) : 1;
          var b = mm[2] ? Number(mm[2]) : 0;
          predicate = <span class="literal">"[((#{fragment} - #{b}) mod #{a} = 0) and "</span> +
          <span class="literal">"((#{fragment} - #{b}) div #{a} &gt;= 0)]"</span>;
          <span class="reserved">return</span> new Template(predicate).evaluate({
            fragment: fragment, a: a, b: b });
        }
      }
    }
  },

  criteria: {
    tagName:      <span class="literal">'n = h.tagName(n, r, "#{1}", c);      c = false;'</span>,
    className:    <span class="literal">'n = h.className(n, r, "#{1}", c);    c = false;'</span>,
    id:           <span class="literal">'n = h.id(n, r, "#{1}", c);           c = false;'</span>,
    attrPresence: <span class="literal">'n = h.attrPresence(n, r, "#{1}", c); c = false;'</span>,
    attr: <span class="reserved">function</span>(m) {
      m[3] = (m[5] || m[6]);
      <span class="reserved">return</span> new Template(<span class="literal">'n = h.attr(n, r, "#{1}", "#{3}", "#{2}", c); c = false;'</span>).evaluate(m);
    },
    pseudo: <span class="reserved">function</span>(m) {
      <span class="reserved">if</span> (m[6]) m[6] = m[6].replace(/<span class="literal">"/g, '\\"</span><span class="literal">');
      return new Template('</span>n = h.pseudo(n, <span class="literal">"#{1}"</span>, <span class="literal">"#{6}"</span>, r, c); c = false;<span class="literal">').evaluate(m);
    },
    descendant:   '</span>c = <span class="literal">"descendant"</span>;<span class="literal">',
    child:        '</span>c = <span class="literal">"child"</span>;<span class="literal">',
    adjacent:     '</span>c = <span class="literal">"adjacent"</span>;<span class="literal">',
    laterSibling: '</span>c = <span class="literal">"laterSibling"</span>;<span class="literal">'
  },

  patterns: [
    { name: '</span>laterSibling<span class="literal">', re: /^\s*~\s*/ },
    { name: '</span>child<span class="literal">',        re: /^\s*&gt;\s*/ },
    { name: '</span>adjacent<span class="literal">',     re: /^\s*\+\s*/ },
    { name: '</span>descendant<span class="literal">',   re: /^\s/ },

    { name: '</span>tagName<span class="literal">',      re: /^\s*(\*|[\w\-]+)(\b|$)?/ },
    { name: '</span>id<span class="literal">',           re: /^#([\w\-\*]+)(\b|$)/ },
    { name: '</span>className<span class="literal">',    re: /^\.([\w\-\*]+)(\b|$)/ },
    { name: '</span>pseudo<span class="literal">',       re: /^:((first|last|nth|nth-last|only)(-child|-of-type)|empty|checked|(en|dis)abled|not)(\((.*?)\))?(\b|$|(?=\s|[:+~&gt;]))/ },
    { name: '</span>attrPresence<span class="literal">', re: /^\[((?:[\w-]+:)?[\w-]+)\]/ },
    { name: '</span>attr<span class="literal">',         re: /\[((?:[\w-]*:)?[\w-]+)\s*(?:([!^$*~|]?=)\s*((['</span><span class="literal">"])([^\4]*?)\4|([^'"</span>][^\]]*?)))?\]/ }
  ],

  assertions: {
    tagName: <span class="reserved">function</span>(element, matches) {
      <span class="reserved">return</span> matches[1].toUpperCase() == element.tagName.toUpperCase();
    },

    className: <span class="reserved">function</span>(element, matches) {
      <span class="reserved">return</span> Element.hasClassName(element, matches[1]);
    },

    id: <span class="reserved">function</span>(element, matches) {
      <span class="reserved">return</span> element.id === matches[1];
    },

    attrPresence: <span class="reserved">function</span>(element, matches) {
      <span class="reserved">return</span> Element.hasAttribute(element, matches[1]);
    },

    attr: <span class="reserved">function</span>(element, matches) {
      var nodeValue = Element.readAttribute(element, matches[1]);
      <span class="reserved">return</span> nodeValue &amp;&amp; Selector.operators[matches[2]](nodeValue, matches[5] || matches[6]);
    }
  },

  handlers: {
    concat: <span class="reserved">function</span>(a, b) {
      <span class="reserved">for</span> (var i = 0, node; node = b[i]; i++)
        a.push(node);
      <span class="reserved">return</span> a;
    },

    mark: <span class="reserved">function</span>(nodes) {
      var _true = Prototype.emptyFunction;
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
        node._countedByPrototype = _true;
      <span class="reserved">return</span> nodes;
    },

    unmark: <span class="reserved">function</span>(nodes) {
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
        node._countedByPrototype = undefined;
      <span class="reserved">return</span> nodes;
    },

    index: <span class="reserved">function</span>(parentNode, reverse, ofType) {
      parentNode._countedByPrototype = Prototype.emptyFunction;
      <span class="reserved">if</span> (reverse) {
        <span class="reserved">for</span> (var nodes = parentNode.childNodes, i = nodes.length - 1, j = 1; i &gt;= 0; i--) {
          var node = nodes[i];
          <span class="reserved">if</span> (node.nodeType == 1 &amp;&amp; (!ofType || node._countedByPrototype)) node.nodeIndex = j++;
        }
      } <span class="reserved">else</span> {
        <span class="reserved">for</span> (var i = 0, j = 1, nodes = parentNode.childNodes; node = nodes[i]; i++)
          <span class="reserved">if</span> (node.nodeType == 1 &amp;&amp; (!ofType || node._countedByPrototype)) node.nodeIndex = j++;
      }
    },

    unique: <span class="reserved">function</span>(nodes) {
      <span class="reserved">if</span> (nodes.length == 0) <span class="reserved">return</span> nodes;
      var results = [], n;
      <span class="reserved">for</span> (var i = 0, l = nodes.length; i &lt; l; i++)
        <span class="reserved">if</span> (typeof (n = nodes[i])._countedByPrototype == <span class="literal">'undefined'</span>) {
          n._countedByPrototype = Prototype.emptyFunction;
          results.push(Element.extend(n));
        }
      <span class="reserved">return</span> Selector.handlers.unmark(results);
    },

    descendant: <span class="reserved">function</span>(nodes) {
      var h = Selector.handlers;
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        h.concat(results, node.getElementsByTagName(<span class="literal">'*'</span>));
      <span class="reserved">return</span> results;
    },

    child: <span class="reserved">function</span>(nodes) {
      var h = Selector.handlers;
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        <span class="reserved">for</span> (var j = 0, child; child = node.childNodes[j]; j++)
          <span class="reserved">if</span> (child.nodeType == 1 &amp;&amp; child.tagName != <span class="literal">'!'</span>) results.push(child);
      }
      <span class="reserved">return</span> results;
    },

    adjacent: <span class="reserved">function</span>(nodes) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        var next = <span class="reserved">this</span>.nextElementSibling(node);
        <span class="reserved">if</span> (next) results.push(next);
      }
      <span class="reserved">return</span> results;
    },

    laterSibling: <span class="reserved">function</span>(nodes) {
      var h = Selector.handlers;
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        h.concat(results, Element.nextSiblings(node));
      <span class="reserved">return</span> results;
    },

    nextElementSibling: <span class="reserved">function</span>(node) {
      <span class="reserved">while</span> (node = node.nextSibling)
        <span class="reserved">if</span> (node.nodeType == 1) <span class="reserved">return</span> node;
      <span class="reserved">return</span> null;
    },

    previousElementSibling: <span class="reserved">function</span>(node) {
      <span class="reserved">while</span> (node = node.previousSibling)
        <span class="reserved">if</span> (node.nodeType == 1) <span class="reserved">return</span> node;
      <span class="reserved">return</span> null;
    },

    tagName: <span class="reserved">function</span>(nodes, root, tagName, combinator) {
      var uTagName = tagName.toUpperCase();
      var results = [], h = Selector.handlers;
      <span class="reserved">if</span> (nodes) {
        <span class="reserved">if</span> (combinator) {
          <span class="reserved">if</span> (combinator == <span class="literal">"descendant"</span>) {
            <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
              h.concat(results, node.getElementsByTagName(tagName));
            <span class="reserved">return</span> results;
          } <span class="reserved">else</span> nodes = <span class="reserved">this</span>[combinator](nodes);
          <span class="reserved">if</span> (tagName == <span class="literal">"*"</span>) <span class="reserved">return</span> nodes;
        }
        <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
          <span class="reserved">if</span> (node.tagName.toUpperCase() === uTagName) results.push(node);
        <span class="reserved">return</span> results;
      } <span class="reserved">else</span> <span class="reserved">return</span> root.getElementsByTagName(tagName);
    },

    id: <span class="reserved">function</span>(nodes, root, id, combinator) {
      var targetNode = $(id), h = Selector.handlers;

      <span class="reserved">if</span> (root == document) {
        <span class="reserved">if</span> (!targetNode) <span class="reserved">return</span> [];
        <span class="reserved">if</span> (!nodes) <span class="reserved">return</span> [targetNode];
      } <span class="reserved">else</span> {
        <span class="reserved">if</span> (!root.sourceIndex || root.sourceIndex &lt; 1) {
          var nodes = root.getElementsByTagName(<span class="literal">'*'</span>);
          <span class="reserved">for</span> (var j = 0, node; node = nodes[j]; j++) {
            <span class="reserved">if</span> (node.id === id) <span class="reserved">return</span> [node];
          }
        }
      }

      <span class="reserved">if</span> (nodes) {
        <span class="reserved">if</span> (combinator) {
          <span class="reserved">if</span> (combinator == <span class="literal">'child'</span>) {
            <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
              <span class="reserved">if</span> (targetNode.parentNode == node) <span class="reserved">return</span> [targetNode];
          } <span class="reserved">else</span> <span class="reserved">if</span> (combinator == <span class="literal">'descendant'</span>) {
            <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
              <span class="reserved">if</span> (Element.descendantOf(targetNode, node)) <span class="reserved">return</span> [targetNode];
          } <span class="reserved">else</span> <span class="reserved">if</span> (combinator == <span class="literal">'adjacent'</span>) {
            <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
              <span class="reserved">if</span> (Selector.handlers.previousElementSibling(targetNode) == node)
                <span class="reserved">return</span> [targetNode];
          } <span class="reserved">else</span> nodes = h[combinator](nodes);
        }
        <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
          <span class="reserved">if</span> (node == targetNode) <span class="reserved">return</span> [targetNode];
        <span class="reserved">return</span> [];
      }
      <span class="reserved">return</span> (targetNode &amp;&amp; Element.descendantOf(targetNode, root)) ? [targetNode] : [];
    },

    className: <span class="reserved">function</span>(nodes, root, className, combinator) {
      <span class="reserved">if</span> (nodes &amp;&amp; combinator) nodes = <span class="reserved">this</span>[combinator](nodes);
      <span class="reserved">return</span> Selector.handlers.byClassName(nodes, root, className);
    },

    byClassName: <span class="reserved">function</span>(nodes, root, className) {
      <span class="reserved">if</span> (!nodes) nodes = Selector.handlers.descendant([root]);
      var needle = <span class="literal">' '</span> + className + <span class="literal">' '</span>;
      <span class="reserved">for</span> (var i = 0, results = [], node, nodeClassName; node = nodes[i]; i++) {
        nodeClassName = node.className;
        <span class="reserved">if</span> (nodeClassName.length == 0) continue;
        <span class="reserved">if</span> (nodeClassName == className || (<span class="literal">' '</span> + nodeClassName + <span class="literal">' '</span>).include(needle))
          results.push(node);
      }
      <span class="reserved">return</span> results;
    },

    attrPresence: <span class="reserved">function</span>(nodes, root, attr, combinator) {
      <span class="reserved">if</span> (!nodes) nodes = root.getElementsByTagName(<span class="literal">"*"</span>);
      <span class="reserved">if</span> (nodes &amp;&amp; combinator) nodes = <span class="reserved">this</span>[combinator](nodes);
      var results = [];
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
        <span class="reserved">if</span> (Element.hasAttribute(node, attr)) results.push(node);
      <span class="reserved">return</span> results;
    },

    attr: <span class="reserved">function</span>(nodes, root, attr, value, operator, combinator) {
      <span class="reserved">if</span> (!nodes) nodes = root.getElementsByTagName(<span class="literal">"*"</span>);
      <span class="reserved">if</span> (nodes &amp;&amp; combinator) nodes = <span class="reserved">this</span>[combinator](nodes);
      var handler = Selector.operators[operator], results = [];
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++) {
        var nodeValue = Element.readAttribute(node, attr);
        <span class="reserved">if</span> (nodeValue === null) continue;
        <span class="reserved">if</span> (handler(nodeValue, value)) results.push(node);
      }
      <span class="reserved">return</span> results;
    },

    pseudo: <span class="reserved">function</span>(nodes, name, value, root, combinator) {
      <span class="reserved">if</span> (nodes &amp;&amp; combinator) nodes = <span class="reserved">this</span>[combinator](nodes);
      <span class="reserved">if</span> (!nodes) nodes = root.getElementsByTagName(<span class="literal">"*"</span>);
      <span class="reserved">return</span> Selector.pseudos[name](nodes, value, root);
    }
  },

  pseudos: {
    <span class="literal">'first-child'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        <span class="reserved">if</span> (Selector.handlers.previousElementSibling(node)) continue;
          results.push(node);
      }
      <span class="reserved">return</span> results;
    },
    <span class="literal">'last-child'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        <span class="reserved">if</span> (Selector.handlers.nextElementSibling(node)) continue;
          results.push(node);
      }
      <span class="reserved">return</span> results;
    },
    <span class="literal">'only-child'</span>: <span class="reserved">function</span>(nodes, value, root) {
      var h = Selector.handlers;
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (!h.previousElementSibling(node) &amp;&amp; !h.nextElementSibling(node))
          results.push(node);
      <span class="reserved">return</span> results;
    },
    <span class="literal">'nth-child'</span>:        <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, formula, root);
    },
    <span class="literal">'nth-last-child'</span>:   <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, formula, root, true);
    },
    <span class="literal">'nth-of-type'</span>:      <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, formula, root, false, true);
    },
    <span class="literal">'nth-last-of-type'</span>: <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, formula, root, true, true);
    },
    <span class="literal">'first-of-type'</span>:    <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, <span class="literal">"1"</span>, root, false, true);
    },
    <span class="literal">'last-of-type'</span>:     <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, <span class="literal">"1"</span>, root, true, true);
    },
    <span class="literal">'only-of-type'</span>:     <span class="reserved">function</span>(nodes, formula, root) {
      var p = Selector.pseudos;
      <span class="reserved">return</span> p[<span class="literal">'last-of-type'</span>](p[<span class="literal">'first-of-type'</span>](nodes, formula, root), formula, root);
    },

    getIndices: <span class="reserved">function</span>(a, b, total) {
      <span class="reserved">if</span> (a == 0) <span class="reserved">return</span> b &gt; 0 ? [b] : [];
      <span class="reserved">return</span> $R(1, total).inject([], <span class="reserved">function</span>(memo, i) {
        <span class="reserved">if</span> (0 == (i - b) % a &amp;&amp; (i - b) / a &gt;= 0) memo.push(i);
        <span class="reserved">return</span> memo;
      });
    },

    nth: <span class="reserved">function</span>(nodes, formula, root, reverse, ofType) {
      <span class="reserved">if</span> (nodes.length == 0) <span class="reserved">return</span> [];
      <span class="reserved">if</span> (formula == <span class="literal">'even'</span>) formula = <span class="literal">'2n+0'</span>;
      <span class="reserved">if</span> (formula == <span class="literal">'odd'</span>)  formula = <span class="literal">'2n+1'</span>;
      var h = Selector.handlers, results = [], indexed = [], m;
      h.mark(nodes);
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++) {
        <span class="reserved">if</span> (!node.parentNode._countedByPrototype) {
          h.index(node.parentNode, reverse, ofType);
          indexed.push(node.parentNode);
        }
      }
      <span class="reserved">if</span> (formula.match(/^\d+$/)) { <span class="comment">// just a number</span>
        formula = Number(formula);
        <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
          <span class="reserved">if</span> (node.nodeIndex == formula) results.push(node);
      } <span class="reserved">else</span> <span class="reserved">if</span> (m = formula.match(/^(-?\d*)?n(([+-])(\d+))?/)) { <span class="comment">// an+b</span>
        <span class="reserved">if</span> (m[1] == <span class="literal">"-"</span>) m[1] = -1;
        var a = m[1] ? Number(m[1]) : 1;
        var b = m[2] ? Number(m[2]) : 0;
        var indices = Selector.pseudos.getIndices(a, b, nodes.length);
        <span class="reserved">for</span> (var i = 0, node, l = indices.length; node = nodes[i]; i++) {
          <span class="reserved">for</span> (var j = 0; j &lt; l; j++)
            <span class="reserved">if</span> (node.nodeIndex == indices[j]) results.push(node);
        }
      }
      h.unmark(nodes);
      h.unmark(indexed);
      <span class="reserved">return</span> results;
    },

    <span class="literal">'empty'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        <span class="reserved">if</span> (node.tagName == <span class="literal">'!'</span> || node.firstChild) continue;
        results.push(node);
      }
      <span class="reserved">return</span> results;
    },

    <span class="literal">'not'</span>: <span class="reserved">function</span>(nodes, selector, root) {
      var h = Selector.handlers, selectorType, m;
      var exclusions = new Selector(selector).findElements(root);
      h.mark(exclusions);
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (!node._countedByPrototype) results.push(node);
      h.unmark(exclusions);
      <span class="reserved">return</span> results;
    },

    <span class="literal">'enabled'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (!node.disabled &amp;&amp; (!node.type || node.type !== <span class="literal">'hidden'</span>))
          results.push(node);
      <span class="reserved">return</span> results;
    },

    <span class="literal">'disabled'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (node.disabled) results.push(node);
      <span class="reserved">return</span> results;
    },

    <span class="literal">'checked'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (node.checked) results.push(node);
      <span class="reserved">return</span> results;
    }
  },

  operators: {
    <span class="literal">'='</span>:  <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv == v; },
    <span class="literal">'!='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv != v; },
    <span class="literal">'^='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv == v || nv &amp;&amp; nv.startsWith(v); },
    <span class="literal">'$='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv == v || nv &amp;&amp; nv.endsWith(v); },
    <span class="literal">'*='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv == v || nv &amp;&amp; nv.include(v); },
    <span class="literal">'~='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> (<span class="literal">' '</span> + nv + <span class="literal">' '</span>).include(<span class="literal">' '</span> + v + <span class="literal">' '</span>); },
    <span class="literal">'|='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> (<span class="literal">'-'</span> + (nv || <span class="literal">""</span>).toUpperCase() +
     <span class="literal">'-'</span>).include(<span class="literal">'-'</span> + (v || <span class="literal">""</span>).toUpperCase() + <span class="literal">'-'</span>); }
  },

  split: <span class="reserved">function</span>(expression) {
    var expressions = [];
    expression.scan(/(([\w#:.~&gt;+()\s-]+|\*|\[.*?\])+)\s*(,|$)/, <span class="reserved">function</span>(m) {
      expressions.push(m[1].strip());
    });
    <span class="reserved">return</span> expressions;
  },

  matchElements: <span class="reserved">function</span>(elements, expression) {
    var matches = $$(expression), h = Selector.handlers;
    h.mark(matches);
    <span class="reserved">for</span> (var i = 0, results = [], element; element = elements[i]; i++)
      <span class="reserved">if</span> (element._countedByPrototype) results.push(element);
    h.unmark(matches);
    <span class="reserved">return</span> results;
  },

  findElement: <span class="reserved">function</span>(elements, expression, index) {
    <span class="reserved">if</span> (Object.isNumber(expression)) {
      index = expression; expression = false;
    }
    <span class="reserved">return</span> Selector.matchElements(elements, expression || <span class="literal">'*'</span>)[index || 0];
  },

  findChildElements: <span class="reserved">function</span>(element, expressions) {
    expressions = Selector.split(expressions.join(<span class="literal">','</span>));
    var results = [], h = Selector.handlers;
    <span class="reserved">for</span> (var i = 0, l = expressions.length, selector; i &lt; l; i++) {
      selector = new Selector(expressions[i].strip());
      h.concat(results, selector.findElements(element));
    }
    <span class="reserved">return</span> (l &gt; 1) ? h.unique(results) : results;
  }
});

<span class="reserved">if</span> (Prototype.Browser.IE) {
  Object.extend(Selector.handlers, {
    concat: <span class="reserved">function</span>(a, b) {
      <span class="reserved">for</span> (var i = 0, node; node = b[i]; i++)
        <span class="reserved">if</span> (node.tagName !== <span class="literal">"!"</span>) a.push(node);
      <span class="reserved">return</span> a;
    },

    unmark: <span class="reserved">function</span>(nodes) {
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
        node.removeAttribute(<span class="literal">'_countedByPrototype'</span>);
      <span class="reserved">return</span> nodes;
    }
  });
}

<span class="reserved">function</span> $$() {
  <span class="reserved">return</span> Selector.findChildElements(document, $A(arguments));
}

var Form = {
  reset: <span class="reserved">function</span>(form) {
    form = $(form);
    form.reset();
    <span class="reserved">return</span> form;
  },

  serializeElements: <span class="reserved">function</span>(elements, options) {
    <span class="reserved">if</span> (typeof options != <span class="literal">'object'</span>) options = { hash: !!options };
    <span class="reserved">else</span> <span class="reserved">if</span> (Object.isUndefined(options.hash)) options.hash = true;
    var key, value, submitted = false, submit = options.submit;

    var data = elements.inject({ }, <span class="reserved">function</span>(result, element) {
      <span class="reserved">if</span> (!element.disabled &amp;&amp; element.name) {
        key = element.name; value = $(element).getValue();
        <span class="reserved">if</span> (value != null &amp;&amp; element.type != <span class="literal">'file'</span> &amp;&amp; (element.type != <span class="literal">'submit'</span> || (!submitted &amp;&amp;
            submit !== false &amp;&amp; (!submit || key == submit) &amp;&amp; (submitted = true)))) {
          <span class="reserved">if</span> (key in result) {
            <span class="reserved">if</span> (!Object.isArray(result[key])) result[key] = [result[key]];
            result[key].push(value);
          }
          <span class="reserved">else</span> result[key] = value;
        }
      }
      <span class="reserved">return</span> result;
    });

    <span class="reserved">return</span> options.hash ? data : Object.toQueryString(data);
  }
};

Form.Methods = {
  serialize: <span class="reserved">function</span>(form, options) {
    <span class="reserved">return</span> Form.serializeElements(Form.getElements(form), options);
  },

  getElements: <span class="reserved">function</span>(form) {
    var elements = $(form).getElementsByTagName(<span class="literal">'*'</span>),
        element,
        arr = [ ],
        serializers = Form.Element.Serializers;
    <span class="reserved">for</span> (var i = 0; element = elements[i]; i++) {
      arr.push(element);
    }
    <span class="reserved">return</span> arr.inject([], <span class="reserved">function</span>(elements, child) {
      <span class="reserved">if</span> (serializers[child.tagName.toLowerCase()])
        elements.push(Element.extend(child));
      <span class="reserved">return</span> elements;
    })
  },

  getInputs: <span class="reserved">function</span>(form, typeName, name) {
    form = $(form);
    var inputs = form.getElementsByTagName(<span class="literal">'input'</span>);

    <span class="reserved">if</span> (!typeName &amp;&amp; !name) <span class="reserved">return</span> $A(inputs).map(Element.extend);

    <span class="reserved">for</span> (var i = 0, matchingInputs = [], length = inputs.length; i &lt; length; i++) {
      var input = inputs[i];
      <span class="reserved">if</span> ((typeName &amp;&amp; input.type != typeName) || (name &amp;&amp; input.name != name))
        continue;
      matchingInputs.push(Element.extend(input));
    }

    <span class="reserved">return</span> matchingInputs;
  },

  disable: <span class="reserved">function</span>(form) {
    form = $(form);
    Form.getElements(form).invoke(<span class="literal">'disable'</span>);
    <span class="reserved">return</span> form;
  },

  enable: <span class="reserved">function</span>(form) {
    form = $(form);
    Form.getElements(form).invoke(<span class="literal">'enable'</span>);
    <span class="reserved">return</span> form;
  },

  findFirstElement: <span class="reserved">function</span>(form) {
    var elements = $(form).getElements().findAll(<span class="reserved">function</span>(element) {
      <span class="reserved">return</span> <span class="literal">'hidden'</span> != element.type &amp;&amp; !element.disabled;
    });
    var firstByIndex = elements.findAll(<span class="reserved">function</span>(element) {
      <span class="reserved">return</span> element.hasAttribute(<span class="literal">'tabIndex'</span>) &amp;&amp; element.tabIndex &gt;= 0;
    }).sortBy(<span class="reserved">function</span>(element) { <span class="reserved">return</span> element.tabIndex }).first();

    <span class="reserved">return</span> firstByIndex ? firstByIndex : elements.find(<span class="reserved">function</span>(element) {
      <span class="reserved">return</span> [<span class="literal">'input'</span>, <span class="literal">'select'</span>, <span class="literal">'textarea'</span>].include(element.tagName.toLowerCase());
    });
  },

  focusFirstElement: <span class="reserved">function</span>(form) {
    form = $(form);
    form.findFirstElement().activate();
    <span class="reserved">return</span> form;
  },

  request: <span class="reserved">function</span>(form, options) {
    form = $(form), options = Object.clone(options || { });

    var params = options.parameters, action = form.readAttribute(<span class="literal">'action'</span>) || <span class="literal">''</span>;
    <span class="reserved">if</span> (action.blank()) action = window.location.href;
    options.parameters = form.serialize(true);

    <span class="reserved">if</span> (params) {
      <span class="reserved">if</span> (Object.isString(params)) params = params.toQueryParams();
      Object.extend(options.parameters, params);
    }

    <span class="reserved">if</span> (form.hasAttribute(<span class="literal">'method'</span>) &amp;&amp; !options.method)
      options.method = form.method;

    <span class="reserved">return</span> new Ajax.Request(action, options);
  }
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>


Form.Element = {
  focus: <span class="reserved">function</span>(element) {
    $(element).focus();
    <span class="reserved">return</span> element;
  },

  select: <span class="reserved">function</span>(element) {
    $(element).select();
    <span class="reserved">return</span> element;
  }
};

Form.Element.Methods = {

  serialize: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (!element.disabled &amp;&amp; element.name) {
      var value = element.getValue();
      <span class="reserved">if</span> (value != undefined) {
        var pair = { };
        pair[element.name] = value;
        <span class="reserved">return</span> Object.toQueryString(pair);
      }
    }
    <span class="reserved">return</span> <span class="literal">''</span>;
  },

  getValue: <span class="reserved">function</span>(element) {
    element = $(element);
    var method = element.tagName.toLowerCase();
    <span class="reserved">return</span> Form.Element.Serializers[method](element);
  },

  setValue: <span class="reserved">function</span>(element, value) {
    element = $(element);
    var method = element.tagName.toLowerCase();
    Form.Element.Serializers[method](element, value);
    <span class="reserved">return</span> element;
  },

  clear: <span class="reserved">function</span>(element) {
    $(element).value = <span class="literal">''</span>;
    <span class="reserved">return</span> element;
  },

  present: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).value != <span class="literal">''</span>;
  },

  activate: <span class="reserved">function</span>(element) {
    element = $(element);
    try {
      element.focus();
      <span class="reserved">if</span> (element.select &amp;&amp; (element.tagName.toLowerCase() != <span class="literal">'input'</span> ||
          ![<span class="literal">'button'</span>, <span class="literal">'reset'</span>, <span class="literal">'submit'</span>].include(element.type)))
        element.select();
    } catch (e) { }
    <span class="reserved">return</span> element;
  },

  disable: <span class="reserved">function</span>(element) {
    element = $(element);
    element.disabled = true;
    <span class="reserved">return</span> element;
  },

  enable: <span class="reserved">function</span>(element) {
    element = $(element);
    element.disabled = false;
    <span class="reserved">return</span> element;
  }
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>

var Field = Form.Element;

var $F = Form.Element.Methods.getValue;

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Form.Element.Serializers = {
  input: <span class="reserved">function</span>(element, value) {
    switch (element.type.toLowerCase()) {
      case <span class="literal">'checkbox'</span>:
      case <span class="literal">'radio'</span>:
        <span class="reserved">return</span> Form.Element.Serializers.inputSelector(element, value);
      default:
        <span class="reserved">return</span> Form.Element.Serializers.textarea(element, value);
    }
  },

  inputSelector: <span class="reserved">function</span>(element, value) {
    <span class="reserved">if</span> (Object.isUndefined(value)) <span class="reserved">return</span> element.checked ? element.value : null;
    <span class="reserved">else</span> element.checked = !!value;
  },

  textarea: <span class="reserved">function</span>(element, value) {
    <span class="reserved">if</span> (Object.isUndefined(value)) <span class="reserved">return</span> element.value;
    <span class="reserved">else</span> element.value = value;
  },

  select: <span class="reserved">function</span>(element, value) {
    <span class="reserved">if</span> (Object.isUndefined(value))
      <span class="reserved">return</span> <span class="reserved">this</span>[element.type == <span class="literal">'select-one'</span> ?
        <span class="literal">'selectOne'</span> : <span class="literal">'selectMany'</span>](element);
    <span class="reserved">else</span> {
      var opt, currentValue, single = !Object.isArray(value);
      <span class="reserved">for</span> (var i = 0, length = element.length; i &lt; length; i++) {
        opt = element.options[i];
        currentValue = <span class="reserved">this</span>.optionValue(opt);
        <span class="reserved">if</span> (single) {
          <span class="reserved">if</span> (currentValue == value) {
            opt.selected = true;
            <span class="reserved">return</span>;
          }
        }
        <span class="reserved">else</span> opt.selected = value.include(currentValue);
      }
    }
  },

  selectOne: <span class="reserved">function</span>(element) {
    var index = element.selectedIndex;
    <span class="reserved">return</span> index &gt;= 0 ? <span class="reserved">this</span>.optionValue(element.options[index]) : null;
  },

  selectMany: <span class="reserved">function</span>(element) {
    var values, length = element.length;
    <span class="reserved">if</span> (!length) <span class="reserved">return</span> null;

    <span class="reserved">for</span> (var i = 0, values = []; i &lt; length; i++) {
      var opt = element.options[i];
      <span class="reserved">if</span> (opt.selected) values.push(<span class="reserved">this</span>.optionValue(opt));
    }
    <span class="reserved">return</span> values;
  },

  optionValue: <span class="reserved">function</span>(opt) {
    <span class="reserved">return</span> Element.extend(opt).hasAttribute(<span class="literal">'value'</span>) ? opt.value : opt.text;
  }
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>


Abstract.TimedObserver = Class.create(PeriodicalExecuter, {
  initialize: <span class="reserved">function</span>($super, element, frequency, callback) {
    $super(callback, frequency);
    <span class="reserved">this</span>.element   = $(element);
    <span class="reserved">this</span>.lastValue = <span class="reserved">this</span>.getValue();
  },

  execute: <span class="reserved">function</span>() {
    var value = <span class="reserved">this</span>.getValue();
    <span class="reserved">if</span> (Object.isString(<span class="reserved">this</span>.lastValue) &amp;&amp; Object.isString(value) ?
        <span class="reserved">this</span>.lastValue != value : String(<span class="reserved">this</span>.lastValue) != String(value)) {
      <span class="reserved">this</span>.callback(<span class="reserved">this</span>.element, value);
      <span class="reserved">this</span>.lastValue = value;
    }
  }
});

Form.Element.Observer = Class.create(Abstract.TimedObserver, {
  getValue: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Form.Element.getValue(<span class="reserved">this</span>.element);
  }
});

Form.Observer = Class.create(Abstract.TimedObserver, {
  getValue: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Form.serialize(<span class="reserved">this</span>.element);
  }
});

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Abstract.EventObserver = Class.create({
  initialize: <span class="reserved">function</span>(element, callback) {
    <span class="reserved">this</span>.element  = $(element);
    <span class="reserved">this</span>.callback = callback;

    <span class="reserved">this</span>.lastValue = <span class="reserved">this</span>.getValue();
    <span class="reserved">if</span> (<span class="reserved">this</span>.element.tagName.toLowerCase() == <span class="literal">'form'</span>)
      <span class="reserved">this</span>.registerFormCallbacks();
    <span class="reserved">else</span>
      <span class="reserved">this</span>.registerCallback(<span class="reserved">this</span>.element);
  },

  onElementEvent: <span class="reserved">function</span>() {
    var value = <span class="reserved">this</span>.getValue();
    <span class="reserved">if</span> (<span class="reserved">this</span>.lastValue != value) {
      <span class="reserved">this</span>.callback(<span class="reserved">this</span>.element, value);
      <span class="reserved">this</span>.lastValue = value;
    }
  },

  registerFormCallbacks: <span class="reserved">function</span>() {
    Form.getElements(<span class="reserved">this</span>.element).each(<span class="reserved">this</span>.registerCallback, <span class="reserved">this</span>);
  },

  registerCallback: <span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (element.type) {
      switch (element.type.toLowerCase()) {
        case <span class="literal">'checkbox'</span>:
        case <span class="literal">'radio'</span>:
          Event.observe(element, <span class="literal">'click'</span>, <span class="reserved">this</span>.onElementEvent.bind(<span class="reserved">this</span>));
          break;
        default:
          Event.observe(element, <span class="literal">'change'</span>, <span class="reserved">this</span>.onElementEvent.bind(<span class="reserved">this</span>));
          break;
      }
    }
  }
});

Form.Element.EventObserver = Class.create(Abstract.EventObserver, {
  getValue: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Form.Element.getValue(<span class="reserved">this</span>.element);
  }
});

Form.EventObserver = Class.create(Abstract.EventObserver, {
  getValue: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Form.serialize(<span class="reserved">this</span>.element);
  }
});
(<span class="reserved">function</span>() {

  var Event = {
    KEY_BACKSPACE: 8,
    KEY_TAB:       9,
    KEY_RETURN:   13,
    KEY_ESC:      27,
    KEY_LEFT:     37,
    KEY_UP:       38,
    KEY_RIGHT:    39,
    KEY_DOWN:     40,
    KEY_DELETE:   46,
    KEY_HOME:     36,
    KEY_END:      35,
    KEY_PAGEUP:   33,
    KEY_PAGEDOWN: 34,
    KEY_INSERT:   45,

    cache: {}
  };

  var _isButton;
  <span class="reserved">if</span> (Prototype.Browser.IE) {
    var buttonMap = { 0: 1, 1: 4, 2: 2 };
    _isButton = <span class="reserved">function</span>(event, code) {
      <span class="reserved">return</span> event.button === buttonMap[code];
    };
  } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.WebKit) {
    _isButton = <span class="reserved">function</span>(event, code) {
      switch (code) {
        case 0: <span class="reserved">return</span> event.which == 1 &amp;&amp; !event.metaKey;
        case 1: <span class="reserved">return</span> event.which == 1 &amp;&amp; event.metaKey;
        default: <span class="reserved">return</span> false;
      }
    };
  } <span class="reserved">else</span> {
    _isButton = <span class="reserved">function</span>(event, code) {
      <span class="reserved">return</span> event.which ? (event.which === code + 1) : (event.button === code);
    };
  }

  <span class="reserved">function</span> isLeftClick(event)   { <span class="reserved">return</span> _isButton(event, 0) }

  <span class="reserved">function</span> isMiddleClick(event) { <span class="reserved">return</span> _isButton(event, 1) }

  <span class="reserved">function</span> isRightClick(event)  { <span class="reserved">return</span> _isButton(event, 2) }

  <span class="reserved">function</span> element(event) {
    event = Event.extend(event);

    var node = event.target, type = event.type,
     currentTarget = event.currentTarget;

    <span class="reserved">if</span> (currentTarget &amp;&amp; currentTarget.tagName) {
      <span class="reserved">if</span> (type === <span class="literal">'load'</span> || type === <span class="literal">'error'</span> ||
        (type === <span class="literal">'click'</span> &amp;&amp; currentTarget.tagName.toLowerCase() === <span class="literal">'input'</span>
          &amp;&amp; currentTarget.type === <span class="literal">'radio'</span>))
            node = currentTarget;
    }

    <span class="reserved">if</span> (node.nodeType == Node.TEXT_NODE)
      node = node.parentNode;

    <span class="reserved">return</span> Element.extend(node);
  }

  <span class="reserved">function</span> findElement(event, expression) {
    var element = Event.element(event);
    <span class="reserved">if</span> (!expression) <span class="reserved">return</span> element;
    var elements = [element].concat(element.ancestors());
    <span class="reserved">return</span> Selector.findElement(elements, expression, 0);
  }

  <span class="reserved">function</span> pointer(event) {
    <span class="reserved">return</span> { x: pointerX(event), y: pointerY(event) };
  }

  <span class="reserved">function</span> pointerX(event) {
    var docElement = document.documentElement,
     body = document.body || { scrollLeft: 0 };

    <span class="reserved">return</span> event.pageX || (event.clientX +
      (docElement.scrollLeft || body.scrollLeft) -
      (docElement.clientLeft || 0));
  }

  <span class="reserved">function</span> pointerY(event) {
    var docElement = document.documentElement,
     body = document.body || { scrollTop: 0 };

    <span class="reserved">return</span>  event.pageY || (event.clientY +
       (docElement.scrollTop || body.scrollTop) -
       (docElement.clientTop || 0));
  }


  <span class="reserved">function</span> stop(event) {
    Event.extend(event);
    event.preventDefault();
    event.stopPropagation();

    event.stopped = true;
  }

  Event.Methods = {
    isLeftClick: isLeftClick,
    isMiddleClick: isMiddleClick,
    isRightClick: isRightClick,

    element: element,
    findElement: findElement,

    pointer: pointer,
    pointerX: pointerX,
    pointerY: pointerY,

    stop: stop
  };


  var methods = Object.keys(Event.Methods).inject({ }, <span class="reserved">function</span>(m, name) {
    m[name] = Event.Methods[name].methodize();
    <span class="reserved">return</span> m;
  });

  <span class="reserved">if</span> (Prototype.Browser.IE) {
    <span class="reserved">function</span> _relatedTarget(event) {
      var element;
      switch (event.type) {
        case <span class="literal">'mouseover'</span>: element = event.fromElement; break;
        case <span class="literal">'mouseout'</span>:  element = event.toElement;   break;
        default: <span class="reserved">return</span> null;
      }
      <span class="reserved">return</span> Element.extend(element);
    }

    Object.extend(methods, {
      stopPropagation: <span class="reserved">function</span>() { <span class="reserved">this</span>.cancelBubble = true },
      preventDefault:  <span class="reserved">function</span>() { <span class="reserved">this</span>.returnValue = false },
      inspect: <span class="reserved">function</span>() { <span class="reserved">return</span> <span class="literal">'[object Event]'</span> }
    });

    Event.extend = <span class="reserved">function</span>(event, element) {
      <span class="reserved">if</span> (!event) <span class="reserved">return</span> false;
      <span class="reserved">if</span> (event._extendedByPrototype) <span class="reserved">return</span> event;

      event._extendedByPrototype = Prototype.emptyFunction;
      var pointer = Event.pointer(event);

      Object.extend(event, {
        target: event.srcElement || element,
        relatedTarget: _relatedTarget(event),
        pageX:  pointer.x,
        pageY:  pointer.y
      });

      <span class="reserved">return</span> Object.extend(event, methods);
    };
  } <span class="reserved">else</span> {
    Event.<span class="reserved">prototype</span> = window.Event.<span class="reserved">prototype</span> || document.createEvent(<span class="literal">'HTMLEvents'</span>).__proto__;
    Object.extend(Event.<span class="reserved">prototype</span>, methods);
    Event.extend = Prototype.K;
  }

  <span class="reserved">function</span> _createResponder(element, eventName, handler) {
    var registry = Element.retrieve(element, <span class="literal">'prototype_event_registry'</span>);

    <span class="reserved">if</span> (Object.isUndefined(registry)) {
      CACHE.push(element);
      registry = Element.retrieve(element, <span class="literal">'prototype_event_registry'</span>, $H());
    }

    var respondersForEvent = registry.get(eventName);
    <span class="reserved">if</span> (Object.isUndefined()) {
      respondersForEvent = [];
      registry.set(eventName, respondersForEvent);
    }

    <span class="reserved">if</span> (respondersForEvent.pluck(<span class="literal">'handler'</span>).include(handler)) <span class="reserved">return</span> false;

    var responder;
    <span class="reserved">if</span> (eventName.include(<span class="literal">":"</span>)) {
      responder = <span class="reserved">function</span>(event) {
        <span class="reserved">if</span> (Object.isUndefined(event.eventName))
          <span class="reserved">return</span> false;

        <span class="reserved">if</span> (event.eventName !== eventName)
          <span class="reserved">return</span> false;

        Event.extend(event, element);
        handler.call(element, event);
      };
    } <span class="reserved">else</span> {
      <span class="reserved">if</span> (!Prototype.Browser.IE &amp;&amp;
       (eventName === <span class="literal">"mouseenter"</span> || eventName === <span class="literal">"mouseleave"</span>)) {
        <span class="reserved">if</span> (eventName === <span class="literal">"mouseenter"</span> || eventName === <span class="literal">"mouseleave"</span>) {
          responder = <span class="reserved">function</span>(event) {
            Event.extend(event, element);

            var parent = event.relatedTarget;
            <span class="reserved">while</span> (parent &amp;&amp; parent !== element) {
              try { parent = parent.parentNode; }
              catch(e) { parent = element; }
            }

            <span class="reserved">if</span> (parent === element) <span class="reserved">return</span>;

            handler.call(element, event);
          };
        }
      } <span class="reserved">else</span> {
        responder = <span class="reserved">function</span>(event) {
          Event.extend(event, element);
          handler.call(element, event);
        };
      }
    }

    responder.handler = handler;
    respondersForEvent.push(responder);
    <span class="reserved">return</span> responder;
  }

  <span class="reserved">function</span> _destroyCache() {
    <span class="reserved">for</span> (var i = 0, length = CACHE.length; i &lt; length; i++) {
      Event.stopObserving(CACHE[i]);
      CACHE[i] = null;
    }
  }

  var CACHE = [];

  <span class="reserved">if</span> (Prototype.Browser.IE)
    window.attachEvent(<span class="literal">'onunload'</span>, _destroyCache);

  <span class="reserved">if</span> (Prototype.Browser.WebKit)
    window.addEventListener(<span class="literal">'unload'</span>, Prototype.emptyFunction, false);


  var _getDOMEventName = Prototype.K;

  <span class="reserved">if</span> (!Prototype.Browser.IE) {
    _getDOMEventName = <span class="reserved">function</span>(eventName) {
      var translations = { mouseenter: <span class="literal">"mouseover"</span>, mouseleave: <span class="literal">"mouseout"</span> };
      <span class="reserved">return</span> eventName in translations ? translations[eventName] : eventName;
    };
  }

  <span class="reserved">function</span> observe(element, eventName, handler) {
    element = $(element);

    var responder = _createResponder(element, eventName, handler);

    <span class="reserved">if</span> (!responder) <span class="reserved">return</span> element;

    <span class="reserved">if</span> (eventName.include(<span class="literal">':'</span>)) {
      <span class="reserved">if</span> (element.addEventListener)
        element.addEventListener(<span class="literal">"dataavailable"</span>, responder, false);
      <span class="reserved">else</span> {
        element.attachEvent(<span class="literal">"ondataavailable"</span>, responder);
        element.attachEvent(<span class="literal">"onfilterchange"</span>, responder);
      }
    } <span class="reserved">else</span> {
      var actualEventName = _getDOMEventName(eventName);

      <span class="reserved">if</span> (element.addEventListener)
        element.addEventListener(actualEventName, responder, false);
      <span class="reserved">else</span>
        element.attachEvent(<span class="literal">"on"</span> + actualEventName, responder);
    }

    <span class="reserved">return</span> element;
  }

  <span class="reserved">function</span> stopObserving(element, eventName, handler) {
    element = $(element);

    var registry = Element.retrieve(element, <span class="literal">'prototype_event_registry'</span>);

    <span class="reserved">if</span> (Object.isUndefined(registry)) <span class="reserved">return</span> element;

    <span class="reserved">if</span> (eventName &amp;&amp; !handler) {
      var responders = registry.get(eventName);

      <span class="reserved">if</span> (Object.isUndefined(responders)) <span class="reserved">return</span> element;

      responders.each( <span class="reserved">function</span>(r) {
        Element.stopObserving(element, eventName, r.handler);
      });
      <span class="reserved">return</span> element;
    } <span class="reserved">else</span> <span class="reserved">if</span> (!eventName) {
      registry.each( <span class="reserved">function</span>(pair) {
        var eventName = pair.key, responders = pair.value;

        responders.each( <span class="reserved">function</span>(r) {
          Element.stopObserving(element, eventName, r.handler);
        });
      });
      <span class="reserved">return</span> element;
    }

    var responders = registry.get(eventName);

    <span class="reserved">if</span> (!responders) <span class="reserved">return</span>;

    var responder = responders.find( <span class="reserved">function</span>(r) { <span class="reserved">return</span> r.handler === handler; });
    <span class="reserved">if</span> (!responder) <span class="reserved">return</span> element;

    var actualEventName = _getDOMEventName(eventName);

    <span class="reserved">if</span> (eventName.include(<span class="literal">':'</span>)) {
      <span class="reserved">if</span> (element.removeEventListener)
        element.removeEventListener(<span class="literal">"dataavailable"</span>, responder, false);
      <span class="reserved">else</span> {
        element.detachEvent(<span class="literal">"ondataavailable"</span>, responder);
        element.detachEvent(<span class="literal">"onfilterchange"</span>,  responder);
      }
    } <span class="reserved">else</span> {
      <span class="reserved">if</span> (element.removeEventListener)
        element.removeEventListener(actualEventName, responder, false);
      <span class="reserved">else</span>
        element.detachEvent(<span class="literal">'on'</span> + actualEventName, responder);
    }

    registry.set(eventName, responders.without(responder));

    <span class="reserved">return</span> element;
  }

  <span class="reserved">function</span> fire(element, eventName, memo, bubble) {
    element = $(element);

    <span class="reserved">if</span> (Object.isUndefined(bubble))
      bubble = true;

    <span class="reserved">if</span> (element == document &amp;&amp; document.createEvent &amp;&amp; !element.dispatchEvent)
      element = document.documentElement;

    var event;
    <span class="reserved">if</span> (document.createEvent) {
      event = document.createEvent(<span class="literal">'HTMLEvents'</span>);
      event.initEvent(<span class="literal">'dataavailable'</span>, true, true);
    } <span class="reserved">else</span> {
      event = document.createEventObject();
      event.eventType = bubble ? <span class="literal">'ondataavailable'</span> : <span class="literal">'onfilterchange'</span>;
    }

    event.eventName = eventName;
    event.memo = memo || { };

    <span class="reserved">if</span> (document.createEvent)
      element.dispatchEvent(event);
    <span class="reserved">else</span>
      element.fireEvent(event.eventType, event);

    <span class="reserved">return</span> Event.extend(event);
  }


  Object.extend(Event, Event.Methods);

  Object.extend(Event, {
    fire:          fire,
    observe:       observe,
    stopObserving: stopObserving
  });

  Element.addMethods({
    fire:          fire,

    observe:       observe,

    stopObserving: stopObserving
  });

  Object.extend(document, {
    fire:          fire.methodize(),

    observe:       observe.methodize(),

    stopObserving: stopObserving.methodize(),

    loaded:        false
  });

  <span class="reserved">if</span> (window.Event) Object.extend(window.Event, Event);
  <span class="reserved">else</span> window.Event = Event;
})();

(<span class="reserved">function</span>() {
  <span class="comment">/* Support for the DOMContentLoaded event is based on work by Dan Webb,
     Matthias Miller, Dean Edwards, John Resig, and Diego Perini. */</span>

  var timer;

  <span class="reserved">function</span> fireContentLoadedEvent() {
    <span class="reserved">if</span> (document.loaded) <span class="reserved">return</span>;
    <span class="reserved">if</span> (timer) window.clearTimeout(timer);
    document.loaded = true;
    document.fire(<span class="literal">'dom:loaded'</span>);
  }

  <span class="reserved">function</span> checkReadyState() {
    <span class="reserved">if</span> (document.readyState === <span class="literal">'complete'</span>) {
      document.stopObserving(<span class="literal">'readystatechange'</span>, checkReadyState);
      fireContentLoadedEvent();
    }
  }

  <span class="reserved">function</span> pollDoScroll() {
    try { document.documentElement.doScroll(<span class="literal">'left'</span>); }
    catch(e) {
      timer = pollDoScroll.defer();
      <span class="reserved">return</span>;
    }
    fireContentLoadedEvent();
  }

  <span class="reserved">if</span> (document.addEventListener) {
    document.addEventListener(<span class="literal">'DOMContentLoaded'</span>, fireContentLoadedEvent, false);
  } <span class="reserved">else</span> {
    document.observe(<span class="literal">'readystatechange'</span>, checkReadyState);
    <span class="reserved">if</span> (window == top)
      timer = pollDoScroll.defer();
  }

  Event.observe(window, <span class="literal">'load'</span>, fireContentLoadedEvent);
})();

Element.addMethods();

<span class="comment">/*------------------------------- DEPRECATED -------------------------------*/</span>

Hash.toQueryString = Object.toQueryString;

var Toggle = { display: Element.toggle };

Element.Methods.childOf = Element.Methods.descendantOf;

var Insertion = {
  Before: <span class="reserved">function</span>(element, content) {
    <span class="reserved">return</span> Element.insert(element, {before:content});
  },

  Top: <span class="reserved">function</span>(element, content) {
    <span class="reserved">return</span> Element.insert(element, {top:content});
  },

  Bottom: <span class="reserved">function</span>(element, content) {
    <span class="reserved">return</span> Element.insert(element, {bottom:content});
  },

  After: <span class="reserved">function</span>(element, content) {
    <span class="reserved">return</span> Element.insert(element, {after:content});
  }
};

var $continue = new Error(<span class="literal">'"throw $continue" is deprecated, use "return" instead'</span>);

var Position = {
  includeScrollOffsets: false,

  prepare: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.deltaX =  window.pageXOffset
                || document.documentElement.scrollLeft
                || document.body.scrollLeft
                || 0;
    <span class="reserved">this</span>.deltaY =  window.pageYOffset
                || document.documentElement.scrollTop
                || document.body.scrollTop
                || 0;
  },

  within: <span class="reserved">function</span>(element, x, y) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.includeScrollOffsets)
      <span class="reserved">return</span> <span class="reserved">this</span>.withinIncludingScrolloffsets(element, x, y);
    <span class="reserved">this</span>.xcomp = x;
    <span class="reserved">this</span>.ycomp = y;
    <span class="reserved">this</span>.offset = Element.cumulativeOffset(element);

    <span class="reserved">return</span> (y &gt;= <span class="reserved">this</span>.offset[1] &amp;&amp;
            y &lt;  <span class="reserved">this</span>.offset[1] + element.offsetHeight &amp;&amp;
            x &gt;= <span class="reserved">this</span>.offset[0] &amp;&amp;
            x &lt;  <span class="reserved">this</span>.offset[0] + element.offsetWidth);
  },

  withinIncludingScrolloffsets: <span class="reserved">function</span>(element, x, y) {
    var offsetcache = Element.cumulativeScrollOffset(element);

    <span class="reserved">this</span>.xcomp = x + offsetcache[0] - <span class="reserved">this</span>.deltaX;
    <span class="reserved">this</span>.ycomp = y + offsetcache[1] - <span class="reserved">this</span>.deltaY;
    <span class="reserved">this</span>.offset = Element.cumulativeOffset(element);

    <span class="reserved">return</span> (<span class="reserved">this</span>.ycomp &gt;= <span class="reserved">this</span>.offset[1] &amp;&amp;
            <span class="reserved">this</span>.ycomp &lt;  <span class="reserved">this</span>.offset[1] + element.offsetHeight &amp;&amp;
            <span class="reserved">this</span>.xcomp &gt;= <span class="reserved">this</span>.offset[0] &amp;&amp;
            <span class="reserved">this</span>.xcomp &lt;  <span class="reserved">this</span>.offset[0] + element.offsetWidth);
  },

  overlap: <span class="reserved">function</span>(mode, element) {
    <span class="reserved">if</span> (!mode) <span class="reserved">return</span> 0;
    <span class="reserved">if</span> (mode == <span class="literal">'vertical'</span>)
      <span class="reserved">return</span> ((<span class="reserved">this</span>.offset[1] + element.offsetHeight) - <span class="reserved">this</span>.ycomp) /
        element.offsetHeight;
    <span class="reserved">if</span> (mode == <span class="literal">'horizontal'</span>)
      <span class="reserved">return</span> ((<span class="reserved">this</span>.offset[0] + element.offsetWidth) - <span class="reserved">this</span>.xcomp) /
        element.offsetWidth;
  },


  cumulativeOffset: Element.Methods.cumulativeOffset,

  positionedOffset: Element.Methods.positionedOffset,

  absolutize: <span class="reserved">function</span>(element) {
    Position.prepare();
    <span class="reserved">return</span> Element.absolutize(element);
  },

  relativize: <span class="reserved">function</span>(element) {
    Position.prepare();
    <span class="reserved">return</span> Element.relativize(element);
  },

  realOffset: Element.Methods.cumulativeScrollOffset,

  offsetParent: Element.Methods.getOffsetParent,

  page: Element.Methods.viewportOffset,

  clone: <span class="reserved">function</span>(source, target, options) {
    options = options || { };
    <span class="reserved">return</span> Element.clonePosition(target, source, options);
  }
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>

<span class="reserved">if</span> (!document.getElementsByClassName) document.getElementsByClassName = <span class="reserved">function</span>(instanceMethods){
  <span class="reserved">function</span> iter(name) {
    <span class="reserved">return</span> name.blank() ? null : <span class="literal">"[contains(concat(' ', @class, ' '), ' "</span> + name + <span class="literal">" ')]"</span>;
  }

  instanceMethods.getElementsByClassName = Prototype.BrowserFeatures.XPath ?
  <span class="reserved">function</span>(element, className) {
    className = className.toString().strip();
    var cond = /\s/.test(className) ? $w(className).map(iter).join(<span class="literal">''</span>) : iter(className);
    <span class="reserved">return</span> cond ? document._getElementsByXPath(<span class="literal">'.//*'</span> + cond, element) : [];
  } : <span class="reserved">function</span>(element, className) {
    className = className.toString().strip();
    var elements = [], classNames = (/\s/.test(className) ? $w(className) : null);
    <span class="reserved">if</span> (!classNames &amp;&amp; !className) <span class="reserved">return</span> elements;

    var nodes = $(element).getElementsByTagName(<span class="literal">'*'</span>);
    className = <span class="literal">' '</span> + className + <span class="literal">' '</span>;

    <span class="reserved">for</span> (var i = 0, child, cn; child = nodes[i]; i++) {
      <span class="reserved">if</span> (child.className &amp;&amp; (cn = <span class="literal">' '</span> + child.className + <span class="literal">' '</span>) &amp;&amp; (cn.include(className) ||
          (classNames &amp;&amp; classNames.all(<span class="reserved">function</span>(name) {
            <span class="reserved">return</span> !name.toString().blank() &amp;&amp; cn.include(<span class="literal">' '</span> + name + <span class="literal">' '</span>);
          }))))
        elements.push(Element.extend(child));
    }
    <span class="reserved">return</span> elements;
  };

  <span class="reserved">return</span> <span class="reserved">function</span>(className, parentElement) {
    <span class="reserved">return</span> $(parentElement || document.body).getElementsByClassName(className);
  };
}(Element.Methods);

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Element.ClassNames = Class.create();
Element.ClassNames.<span class="reserved">prototype</span> = {
  initialize: <span class="reserved">function</span>(element) {
    <span class="reserved">this</span>.element = $(element);
  },

  _each: <span class="reserved">function</span>(iterator) {
    <span class="reserved">this</span>.element.className.split(/\s+/).select(<span class="reserved">function</span>(name) {
      <span class="reserved">return</span> name.length &gt; 0;
    })._each(iterator);
  },

  set: <span class="reserved">function</span>(className) {
    <span class="reserved">this</span>.element.className = className;
  },

  add: <span class="reserved">function</span>(classNameToAdd) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.include(classNameToAdd)) <span class="reserved">return</span>;
    <span class="reserved">this</span>.set($A(<span class="reserved">this</span>).concat(classNameToAdd).join(<span class="literal">' '</span>));
  },

  remove: <span class="reserved">function</span>(classNameToRemove) {
    <span class="reserved">if</span> (!<span class="reserved">this</span>.include(classNameToRemove)) <span class="reserved">return</span>;
    <span class="reserved">this</span>.set($A(<span class="reserved">this</span>).without(classNameToRemove).join(<span class="literal">' '</span>));
  },

  toString: <span class="reserved">function</span>() {
    <span class="reserved">return</span> $A(<span class="reserved">this</span>).join(<span class="literal">' '</span>);
  }
};

Object.extend(Element.ClassNames.<span class="reserved">prototype</span>, Enumerable);

<span class="comment">/*--------------------------------------------------------------------------*/</span>
<span class="comment">/** <span class="attrib">@namespace</span> */</span>
var n2i = {
	<span class="comment">/** <span class="attrib">@namespace</span> */</span>
	browser : {}
}

n2i.browser.opera = /opera/i.test(navigator.userAgent);
n2i.browser.msie = !n2i.browser.opera &amp;&amp; /MSIE/.test(navigator.userAgent);
n2i.browser.msie6 = navigator.userAgent.indexOf(<span class="literal">'MSIE 6'</span>)!==-1;
n2i.browser.msie7 = navigator.userAgent.indexOf(<span class="literal">'MSIE 7'</span>)!==-1;
n2i.browser.msie8 = navigator.userAgent.indexOf(<span class="literal">'MSIE 8'</span>)!==-1;
n2i.browser.webkit = navigator.userAgent.indexOf(<span class="literal">'WebKit'</span>)!==-1;
n2i.browser.safari = navigator.userAgent.indexOf(<span class="literal">'Safari'</span>)!==-1;
n2i.browser.webkitVersion = null;
n2i.browser.gecko = !n2i.browser.webkit &amp;&amp; navigator.userAgent.indexOf(<span class="literal">'Gecko'</span>)!=-1;

(<span class="reserved">function</span>() {
	var result = /Safari\/([\d.]+)/.exec(navigator.userAgent);
	<span class="reserved">if</span> (result) {
		n2i.browser.webkitVersion=parseFloat(result[1]);
	}
})()

n2i.ELEMENT_NODE=1;
n2i.ATTRIBUTE_NODE=2;
n2i.TEXT_NODE=3;

<span class="comment">/** Log something */</span>
n2i.log = <span class="reserved">function</span>(obj) {
	try {
		console.log(obj);
	} catch (ignore) {};
}

<span class="comment">/** Make a string camelized */</span>
n2i.camelize = <span class="reserved">function</span>(str) {
    var oStringList = str.split(<span class="literal">'-'</span>);
    <span class="reserved">if</span> (oStringList.length == 1) <span class="reserved">return</span> oStringList[0];

    var camelizedString = str.indexOf(<span class="literal">'-'</span>) == 0
      ? oStringList[0].charAt(0).toUpperCase() + oStringList[0].substring(1)
      : oStringList[0];

    <span class="reserved">for</span> (var i = 1, len = oStringList.length; i &lt; len; i++) {
      var s = oStringList[i];
      camelizedString += s.charAt(0).toUpperCase() + s.substring(1);
    }

    <span class="reserved">return</span> camelizedString;
}

<span class="comment">/** Override the properties on the first argument with properties from the last object */</span>
n2i.override = <span class="reserved">function</span>(original,subject) {
	<span class="reserved">if</span> (subject) {
		<span class="reserved">for</span> (prop in subject) {
			original[prop] = subject[prop];
		}
	}
	<span class="reserved">return</span> original;
}

<span class="comment">/** Trim whitespace including unicode chars */</span>
n2i.trim = <span class="reserved">function</span>(str) {
	<span class="reserved">if</span> (!str) <span class="reserved">return</span> str;
	<span class="reserved">return</span> str.replace(/^[\s\x0b\xa0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000]+|[\s\x0b\xa0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000]+$/g, <span class="literal">''</span>);
}

<span class="comment">/** Escape the html in a string */</span>
n2i.escapeHTML = <span class="reserved">function</span>(str) {
    var div = document.createElement(<span class="literal">'div'</span>);
    div.appendChild(document.createTextNode(str));
    <span class="reserved">return</span> div.innerHTML;
}

<span class="comment">/** Checks if a string has characters */</span>
n2i.isEmpty = n2i.isBlank = <span class="reserved">function</span>(str) {
	<span class="reserved">if</span> (str===null || typeof(str)===<span class="literal">'undefined'</span>) <span class="reserved">return</span> true;
	<span class="reserved">return</span> typeof(str)==<span class="literal">'string'</span> &amp;&amp; n2i.trim(str).length==0;
}

n2i.isDefined = <span class="reserved">function</span>(obj) {
	<span class="reserved">return</span> obj!==null &amp;&amp; typeof(obj)!==<span class="literal">'undefined'</span>;
}

n2i.inArray = <span class="reserved">function</span>(arr,value) {
	<span class="reserved">for</span> (var i=0; i &lt; arr.length; i++) {
		<span class="reserved">if</span> (arr[i]==value) <span class="reserved">return</span> true;
	};
	<span class="reserved">return</span> false;
}


n2i.flipInArray = <span class="reserved">function</span>(arr,value) {
	<span class="reserved">if</span> (n2i.inArray(arr,value)) {
		n2i.removeFromArray(arr,value);
	} <span class="reserved">else</span> {
		arr.push(value);
	}
}

n2i.removeFromArray = <span class="reserved">function</span>(arr,value) {
	<span class="reserved">for</span> (var i = arr.length - 1; i &gt;= 0; i--){
		<span class="reserved">if</span> (arr[i]==value) {
			arr.splice(i,1);
		}
	};
}

n2i.addToArray = <span class="reserved">function</span>(arr,value) {
	<span class="reserved">if</span> (value.constructor==Array) {
		<span class="reserved">for</span> (var i=0; i &lt; value.length; i++) {
			<span class="reserved">if</span> (!n2i.inArray(arr,value[i])) {
				arr.push(value);
			}
		};
	} <span class="reserved">else</span> {
		<span class="reserved">if</span> (!n2i.inArray(arr,value)) {
			arr.push(value);
		}
	}
}

n2i.scrollTo = <span class="reserved">function</span>(element) {
	element = $(element);
	<span class="reserved">if</span> (element) {
		var pos = element.cumulativeOffset();
		window.scrollTo(pos.left, pos.top-50);
	}
}

<span class="comment">////////////////////// DOM ////////////////////</span>

<span class="comment">/** <span class="attrib">@namespace</span> */</span>
n2i.dom = {
	isElement : <span class="reserved">function</span>(n,name) {
		<span class="reserved">return</span> n.nodeType==n2i.ELEMENT_NODE &amp;&amp; (name===undefined ? true : n.nodeName==name);
	},
	isDefinedText : <span class="reserved">function</span>(node) {
		<span class="reserved">return</span> node.nodeType==n2i.TEXT_NODE &amp;&amp; node.nodeValue.length&gt;0;
	},
	addText : <span class="reserved">function</span>(node,text) {
		node.appendChild(document.createTextNode(text));
	},
	getNodeText : <span class="reserved">function</span>(node) {
		var txt = <span class="literal">''</span>;
		var c = node.childNodes;
		<span class="reserved">for</span> (var i=0; i &lt; c.length; i++) {
			<span class="reserved">if</span> (c[i].nodeType==n2i.TEXT_NODE &amp;&amp; c[i].nodeValue!=null) {
				txt+=c[i].nodeValue;
			}
		};
		<span class="reserved">return</span> txt;
	}
}

<span class="comment">///////////////////// Style ///////////////////</span>

n2i.getStyle = <span class="reserved">function</span>(element, style) {
	element = $(element);
	var cameled = n2i.camelize(style);
	var value = element.style[cameled];
	<span class="reserved">if</span> (!value) {
		<span class="reserved">if</span> (document.defaultView &amp;&amp; document.defaultView.getComputedStyle) {
			var css = document.defaultView.getComputedStyle(element, null);
			value = css ? css.getPropertyValue(style) : null;
		} <span class="reserved">else</span> <span class="reserved">if</span> (element.currentStyle) {
			value = element.currentStyle[cameled];
		}
	}
	<span class="reserved">if</span> (window.opera &amp;&amp; [<span class="literal">'left'</span>, <span class="literal">'top'</span>, <span class="literal">'right'</span>, <span class="literal">'bottom'</span>].include(style)) {
		<span class="reserved">if</span> (n2i.getStyle(element, <span class="literal">'position'</span>) == <span class="literal">'static'</span>) value = <span class="literal">'auto'</span>;
	}
	<span class="reserved">return</span> value == <span class="literal">'auto'</span> ? null : value;
}

n2i.setOpacity = <span class="reserved">function</span>(element,opacity) {
	<span class="reserved">if</span> (n2i.browser.msie) {
		<span class="reserved">if</span> (opacity==1) {
			element.style[<span class="literal">'filter'</span>]=null;
		} <span class="reserved">else</span> {
			element.style[<span class="literal">'filter'</span>]=<span class="literal">'alpha(opacity='</span>+(opacity*100)+<span class="literal">')'</span>;
		}
	} <span class="reserved">else</span> {
		element.style[<span class="literal">'opacity'</span>]=opacity;
	}
}

n2i.copyStyle = <span class="reserved">function</span>(source,target,styles) {
	styles.each(<span class="reserved">function</span>(s) {
		var r = source.getStyle(s);
		<span class="reserved">if</span> (r) target.style[s] = source.getStyle(s);
	});
}

<span class="comment">///////////////////// Events ////////////////////</span>

n2i.isReturnKey = <span class="reserved">function</span>(e) {
	<span class="reserved">return</span> e.keyCode==13;
}
n2i.isRightKey = <span class="reserved">function</span>(e) {
	<span class="reserved">return</span> e.keyCode==39;
}
n2i.isLeftKey = <span class="reserved">function</span>(e) {
	<span class="reserved">return</span> e.keyCode==37;
}
n2i.isEscapeKey = <span class="reserved">function</span>(e) {
	<span class="reserved">return</span> e.keyCode==27;
}
n2i.isSpaceKey = <span class="reserved">function</span>(e) {
	<span class="reserved">return</span> e.keyCode==32;
}

<span class="comment">//////////////////// Frames ////////////////////</span>

n2i.getFrameDocument = <span class="reserved">function</span>(frame) {
    <span class="reserved">if</span> (frame.contentDocument) {
        <span class="reserved">return</span> frame.contentDocument;
    } <span class="reserved">else</span> <span class="reserved">if</span> (frame.contentWindow) {
        <span class="reserved">return</span> frame.contentWindow.document;
    } <span class="reserved">else</span> <span class="reserved">if</span> (frame.document) {
        <span class="reserved">return</span> frame.document;
    }
}

<span class="comment">/////////////////// Position /////////////////////</span>

n2i.getScrollTop = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (self.pageYOffset) {
		<span class="reserved">return</span> self.pageYOffset;
	} <span class="reserved">else</span> <span class="reserved">if</span> (document.documentElement &amp;&amp; document.documentElement.scrollTop) {
		<span class="reserved">return</span> document.documentElement.scrollTop;
	} <span class="reserved">else</span> <span class="reserved">if</span> (document.body) {
		<span class="reserved">return</span> document.body.scrollTop;
	}
}

n2i.getScrollLeft = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (self.pageYOffset) {
		<span class="reserved">return</span> self.pageXOffset;
	} <span class="reserved">else</span> <span class="reserved">if</span> (document.documentElement &amp;&amp; document.documentElement.scrollTop) {
		<span class="reserved">return</span> document.documentElement.scrollLeft;
	} <span class="reserved">else</span> <span class="reserved">if</span> (document.body) {
		<span class="reserved">return</span> document.body.scrollLeft;
	}
}

n2i.getInnerHeight = <span class="reserved">function</span>() {
	var y;
	<span class="reserved">if</span> (self.innerHeight) {
		<span class="reserved">return</span> self.innerHeight;
	} <span class="reserved">else</span> <span class="reserved">if</span> (document.documentElement &amp;&amp; document.documentElement.clientHeight) {
		<span class="reserved">return</span> document.documentElement.clientHeight;
	} <span class="reserved">else</span> <span class="reserved">if</span> (document.body) {
		<span class="reserved">return</span> document.body.clientHeight;
	}
}

n2i.getDocumentWidth = n2i.getInnerWidth = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (self.innerHeight) {
		<span class="reserved">return</span> self.innerWidth;
	} <span class="reserved">else</span> <span class="reserved">if</span> (document.documentElement &amp;&amp; document.documentElement.clientHeight) {
		<span class="reserved">return</span> document.documentElement.clientWidth;
	} <span class="reserved">else</span> <span class="reserved">if</span> (document.body) {
		<span class="reserved">return</span> document.body.clientWidth;
	}
}

n2i.getDocumentHeight = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (n2i.browser.msie6) {
		<span class="comment">// In IE6 check the children too</span>
		var max = Math.max(document.body.clientHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight);
		$(document.body).childElements().each(<span class="reserved">function</span>(node) {
			max = Math.max(max,node.getHeight());
		});
		<span class="reserved">return</span> max;
	}
	<span class="reserved">if</span> (window.scrollMaxY &amp;&amp; window.innerHeight) {
		<span class="reserved">return</span> window.scrollMaxY+window.innerHeight;
	} <span class="reserved">else</span> {
		<span class="reserved">return</span> Math.max(document.body.clientHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight);
	}
}

<span class="comment">//////////////////////////// Preloader /////////////////////////</span>

<span class="comment">/** <span class="attrib">@constructor</span> */</span>
n2i.Preloader = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = options || {};
	<span class="reserved">this</span>.delegate = {};
	<span class="reserved">this</span>.images = [];
	<span class="reserved">this</span>.loaded = 0;
}

n2i.Preloader.<span class="reserved">prototype</span> = {
	addImages : <span class="reserved">function</span>(imageOrImages) {
		<span class="reserved">if</span> (typeof(imageOrImages)==<span class="literal">'object'</span>) {
			<span class="reserved">for</span> (var i=0; i &lt; imageOrImages.length; i++) {
				<span class="reserved">this</span>.images.push(imageOrImages[i]);
			};
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.images.push(imageOrImages);
		}
	},
	setDelegate : <span class="reserved">function</span>(d) {
		<span class="reserved">this</span>.delegate = d;
	},
	load : <span class="reserved">function</span>(startIndex) {
		startIndex = startIndex || 0;
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.obs = [];
		<span class="reserved">for</span> (var i=startIndex; i &lt; <span class="reserved">this</span>.images.length+startIndex; i++) {
			var index=i;
			<span class="reserved">if</span> (index&gt;=<span class="reserved">this</span>.images.length) {
				index = index-<span class="reserved">this</span>.images.length;
			}
			var img = new Image();
			img.n2iPreloaderIndex = index;
			img.onload = <span class="reserved">function</span>() {self.imageChanged(<span class="reserved">this</span>.n2iPreloaderIndex,<span class="literal">'imageDidLoad'</span>)};
			img.onerror = <span class="reserved">function</span>() {self.imageChanged(<span class="reserved">this</span>.n2iPreloaderIndex,<span class="literal">'imageDidGiveError'</span>)};
			img.onabort = <span class="reserved">function</span>() {self.imageChanged(<span class="reserved">this</span>.n2iPreloaderIndex,<span class="literal">'imageDidAbort'</span>)};
			img.src = (<span class="reserved">this</span>.options.context ? <span class="reserved">this</span>.options.context : <span class="literal">''</span>)+<span class="reserved">this</span>.images[index];
			<span class="reserved">this</span>.obs.push(img);
		};
	},
	imageChanged : <span class="reserved">function</span>(index,method) {
		<span class="reserved">this</span>.loaded++;
		<span class="reserved">if</span> (<span class="reserved">this</span>.delegate[method]) {
			<span class="reserved">this</span>.delegate[method](<span class="reserved">this</span>.loaded,<span class="reserved">this</span>.images.length,index);
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.loaded==<span class="reserved">this</span>.images.length &amp;&amp; <span class="reserved">this</span>.delegate.allImagesDidLoad) {
			<span class="reserved">this</span>.delegate.allImagesDidLoad();
		}
	}
}

<span class="comment">/* <span class="attrib">@namespace</span> */</span>
n2i.cookie = {
	set : <span class="reserved">function</span>(name,value,days) {
		<span class="reserved">if</span> (days) {
			var date = new Date();
			date.setTime(date.getTime()+(days*24*60*60*1000));
			var expires = <span class="literal">"; expires="</span>+date.toGMTString();
		}
		<span class="reserved">else</span> var expires = <span class="literal">""</span>;
		document.cookie = name+<span class="literal">"="</span>+value+expires+<span class="literal">"; path=/"</span>;
	},
	get : <span class="reserved">function</span>(name) {
		var nameEQ = name + <span class="literal">"="</span>;
		var ca = document.cookie.split(<span class="literal">';'</span>);
		<span class="reserved">for</span>(var i=0;i &lt; ca.length;i++) {
			var c = ca[i];
			<span class="reserved">while</span> (c.charAt(0)==<span class="literal">' '</span>) c = c.substring(1,c.length);
			<span class="reserved">if</span> (c.indexOf(nameEQ) == 0) <span class="reserved">return</span> c.substring(nameEQ.length,c.length);
		}
		<span class="reserved">return</span> null;
	},
	clear : <span class="reserved">function</span>(name) {
		<span class="reserved">this</span>.set(name,<span class="literal">""</span>,-1);
	}
}

<span class="comment">///////////////////////// URL/Location /////////////////////</span>

n2i.URL = <span class="reserved">function</span>(url) {
	<span class="reserved">this</span>.url = url || <span class="literal">''</span>;
}

n2i.URL.<span class="reserved">prototype</span> = {
	addParameter : <span class="reserved">function</span>(key,value) {
		<span class="reserved">this</span>.url+=<span class="reserved">this</span>.url.indexOf(<span class="literal">'?'</span>)!=-1 ? <span class="literal">'&amp;'</span> : <span class="literal">'?'</span>;
		<span class="reserved">this</span>.url+=key+<span class="literal">'='</span>+(n2i.isDefined(value) ? value : <span class="literal">''</span>);
	},
	toString : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.url;
	}
}

<span class="comment">/* <span class="attrib">@namespace</span> */</span>
n2i.location = {
	getParameter : <span class="reserved">function</span>(name) {
		var parms = n2i.location.getParameters();
		<span class="reserved">for</span> (var i=0; i &lt; parms.length; i++) {
			<span class="reserved">if</span> (parms[i].name==name) {
				<span class="reserved">return</span> parms[i].value;
			}
		};
		<span class="reserved">return</span> null;
	},
	setParameter : <span class="reserved">function</span>(name,value) {
		var parms = n2i.location.getParameters();
		var found = false;
		<span class="reserved">for</span> (var i=0; i &lt; parms.length; i++) {
			<span class="reserved">if</span> (parms[i].name==name) {
				parms[i].value=value;
				found=true;
				break;
			}
		};
		<span class="reserved">if</span> (!found) {
			parms.push({name:name,value:value});
		}
		n2i.location.setParameters(parms);
	},
	hasHash : <span class="reserved">function</span>(name) {
		var h = document.location.hash;
		<span class="reserved">if</span> (h!==<span class="literal">''</span>) {
			<span class="reserved">return</span> h==<span class="literal">'#'</span>+name;
		}
		<span class="reserved">return</span> false;
	},
	getHashParameter : <span class="reserved">function</span>(name) {
		var h = document.location.hash;
		<span class="reserved">if</span> (h!==<span class="literal">''</span>) {
			var i = h.indexOf(name+<span class="literal">'='</span>);
			<span class="reserved">if</span> (i!==-1) {
				var remaining = h.substring(i+name.length+1);
				<span class="reserved">if</span> (remaining.indexOf(<span class="literal">'&amp;'</span>)!==-1) {
					<span class="reserved">return</span> remaining.substring(0,remaining.indexOf(<span class="literal">'&amp;'</span>));
				}
				<span class="reserved">return</span> remaining;
			}
		}
		<span class="reserved">return</span> null;
	},
	clearHash : <span class="reserved">function</span>() {
		document.location.hash=<span class="literal">'#'</span>;
	},
	setParameters : <span class="reserved">function</span>(parms) {
		var query = <span class="literal">''</span>;
		<span class="reserved">for</span> (var i=0; i &lt; parms.length; i++) {
			query+= i==0 ? <span class="literal">'?'</span> : <span class="literal">'&amp;'</span>;
			query+=parms[i].name+<span class="literal">'='</span>+parms[i].value;
		};
		document.location.search=query;
	},
	getBoolean : <span class="reserved">function</span>(name) {
		var value = n2i.location.getParameter(name);
		<span class="reserved">return</span> (value==<span class="literal">'true'</span> || value==<span class="literal">'1'</span>);
	},
	getParameters : <span class="reserved">function</span>() {
		var items = document.location.search.substring(1).split(<span class="literal">'&amp;'</span>);
		var parsed = [];
		<span class="reserved">for</span>( var i = 0; i &lt; items.length; i++) {
			var item = items[i].split(<span class="literal">'='</span>);
			var name = unescape(item[0]).replace(/^\s*|\s*$/g,<span class="literal">""</span>);
			var value = unescape(item[1]).replace(/^\s*|\s*$/g,<span class="literal">""</span>);
			<span class="reserved">if</span> (name) {
				parsed.push({name:name,value:value});
			}
		};
		<span class="reserved">return</span> parsed;
	}	
};

<span class="comment">/////////////////////////// Animation ///////////////////////////</span>


n2i.ani = n2i.animate = <span class="reserved">function</span>(element,style,value,duration,delegate) {
	n2i.animation.get(element).animate(null,value,style,duration,delegate);
}

<span class="comment">/** <span class="attrib">@namespace</span> */</span>
n2i.animation = {
	objects : {},
	running : false,
	latestId : 0,
	get : <span class="reserved">function</span>(element) {
		element = $(element);
		<span class="reserved">if</span> (!element.n2iAnimationId) element.n2iAnimationId = <span class="reserved">this</span>.latestId++;
		<span class="reserved">if</span> (!<span class="reserved">this</span>.objects[element.n2iAnimationId]) {
			<span class="reserved">this</span>.objects[element.n2iAnimationId] = new n2i.animation.Item(element);
		}
		<span class="reserved">return</span> <span class="reserved">this</span>.objects[element.n2iAnimationId];
	},
	start : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.running) {
			n2i.animation.render();
		}
	}
};

n2i.animation.render = <span class="reserved">function</span>(element) {
	<span class="reserved">this</span>.running = true;
	var next = false;
	var stamp = new Date().getTime();
	<span class="reserved">for</span> (id in <span class="reserved">this</span>.objects) {
		var obj = <span class="reserved">this</span>.objects[id];
		<span class="reserved">if</span> (obj.work) {
			<span class="reserved">for</span> (var i=0; i &lt; obj.work.length; i++) {
				var work = obj.work[i];
				<span class="reserved">if</span> (work.finished) continue;
				var place = (stamp-work.start)/(work.end-work.start);
				<span class="reserved">if</span> (place&lt;0) {
					next=true;
					continue;
				}
				<span class="reserved">else</span> <span class="reserved">if</span> (isNaN(place)) place = 1;
				<span class="reserved">else</span> <span class="reserved">if</span> (place&gt;1) place=1;
				<span class="reserved">else</span> <span class="reserved">if</span> (place&lt;1) next=true;
				var v = place;
				<span class="reserved">if</span> (work.delegate &amp;&amp; work.delegate.ease) {
					v = work.delegate.ease(v);
				}
				var value = null;
				<span class="reserved">if</span> (!work.css) {
					obj.element[work.property] = Math.round(work.from+(work.to-work.from)*v);
				} <span class="reserved">else</span> <span class="reserved">if</span> (work.to.red!=null) {
					var red = Math.round(work.from.red+(work.to.red-work.from.red)*v);
					var green = Math.round(work.from.green+(work.to.green-work.from.green)*v);
					var blue = Math.round(work.from.blue+(work.to.blue-work.from.blue)*v);
					value = <span class="literal">'rgb('</span>+red+<span class="literal">','</span>+green+<span class="literal">','</span>+blue+<span class="literal">')'</span>;
					obj.element.style[work.property]=value;
				} <span class="reserved">else</span> <span class="reserved">if</span> (n2i.browser.msie &amp;&amp; work.property==<span class="literal">'opacity'</span>) {
					var opacity = (work.from+(work.to-work.from)*v);
					<span class="reserved">if</span> (opacity==1) {
						obj.element.style.removeAttribute(<span class="literal">'filter'</span>);
					} <span class="reserved">else</span> {
						obj.element.style[<span class="literal">'filter'</span>]=<span class="literal">'alpha(opacity='</span>+(opacity*100)+<span class="literal">')'</span>;
					}
				} <span class="reserved">else</span> {
					value = new String(work.from+(work.to-work.from)*v)+(work.unit!=null ? work.unit : <span class="literal">''</span>);
					obj.element.style[work.property]=value;
				}
				<span class="reserved">if</span> (place==1) {
					work.finished = true;
					<span class="reserved">if</span> (work.delegate &amp;&amp; work.delegate.onComplete) {
						window.setTimeout(work.delegate.onComplete);
					} <span class="reserved">else</span> <span class="reserved">if</span> (work.delegate &amp;&amp; work.delegate.hideOnComplete) {
						obj.element.style.display=<span class="literal">'none'</span>;
					}
				}
			};
		}
	}
	<span class="reserved">if</span> (next) {
		window.setTimeout(<span class="reserved">function</span>() {
			n2i.animation.render();
		},0);
	} <span class="reserved">else</span> {
		<span class="reserved">this</span>.running = false;
	}
	<span class="comment">//window.status = this.running;</span>
}

n2i.animation.parseStyle = <span class="reserved">function</span>(value) {
	var parsed = {type:null,value:null,unit:null};
	var match;
	<span class="reserved">if</span> (!n2i.isDefined(value)) {
		<span class="reserved">return</span> parsed;
	} <span class="reserved">else</span> <span class="reserved">if</span> (!isNaN(value)) {
		parsed.value=parseFloat(value);
	} <span class="reserved">else</span> <span class="reserved">if</span> (match=value.match(/([\-]?[0-9\.]+)(px|pt|%)/)) {
		parsed.type = <span class="literal">'length'</span>;
		parsed.value = parseFloat(match[1]);
		parsed.unit = match[2];
	} <span class="reserved">else</span> <span class="reserved">if</span> (match=value.match(/rgb\(([0-9]+),[ ]?([0-9]+),[ ]?([0-9]+)\)/)) {
		parsed.type = <span class="literal">'color'</span>;
		parsed.value = {
			red:parseInt(match[1]),
			green:parseInt(match[2]),
			blue:parseInt(match[3])
		};
	} <span class="reserved">else</span> {
		var color = new n2i.Color(value);
		<span class="reserved">if</span> (color.ok) {
			parsed.value = {
				red:color.r,
				green:color.g,
				blue:color.b
			};
		}
	}
	<span class="reserved">return</span> parsed;
}

<span class="comment">///////////////////////////// Item ///////////////////////////////</span>

n2i.animation.Item = <span class="reserved">function</span>(element) {
	<span class="reserved">this</span>.element = element;
	<span class="reserved">this</span>.work = [];
}

n2i.animation.Item.<span class="reserved">prototype</span>.animate = <span class="reserved">function</span>(from,to,property,duration,delegate) {
	var css = true;
	<span class="reserved">if</span> (property==<span class="literal">'scrollLeft'</span> || property==<span class="literal">'scrollTop'</span>) {
		css = false;
	}
	
	var work = <span class="reserved">this</span>.getWork(css ? n2i.camelize(property) : property);
	work.delegate = delegate;
	work.finished = false;
	work.css = css;
	<span class="reserved">if</span> (from!=null) {
		work.from = from;
	} <span class="reserved">else</span> <span class="reserved">if</span> (work.css &amp;&amp; n2i.browser.msie &amp;&amp; property==<span class="literal">'opacity'</span>) {
		work.from = <span class="reserved">this</span>.getIEOpacity(<span class="reserved">this</span>.element);
	} <span class="reserved">else</span> <span class="reserved">if</span> (work.css) {
		var style = n2i.getStyle(<span class="reserved">this</span>.element,property);
		var parsedStyle = n2i.animation.parseStyle(style);
		work.from = parsedStyle.value;
	} <span class="reserved">else</span> {
		work.from = <span class="reserved">this</span>.element[property];
	}
	<span class="reserved">if</span> (work.css) {
		var parsed = n2i.animation.parseStyle(to);
		work.to = parsed.value;
		work.unit = parsed.unit;
	} <span class="reserved">else</span> {
		work.to = to;
		work.unit = null;
	}
	work.start = new Date().getTime();
	<span class="reserved">if</span> (delegate &amp;&amp; delegate.delay) work.start+=delegate.delay;
	work.end = work.start+duration;
	n2i.animation.start();
}

n2i.animation.Item.<span class="reserved">prototype</span>.getIEOpacity = <span class="reserved">function</span>(element) {
	var filter = n2i.getStyle(element,<span class="literal">'filter'</span>).toLowerCase();
	var match;
	<span class="reserved">if</span> (match = filter.match(/opacity=([0-9]+)/)) {
		<span class="reserved">return</span> parseFloat(match[1])/100;
	} <span class="reserved">else</span> {
		<span class="reserved">return</span> 1;
	}
}

n2i.animation.Item.<span class="reserved">prototype</span>.getWork = <span class="reserved">function</span>(property) {
	<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.work.length; i++) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.work[i].property==property) {
			<span class="reserved">return</span> <span class="reserved">this</span>.work[i];
		}
	};
	var work = {property:property};
	<span class="reserved">this</span>.work[<span class="reserved">this</span>.work.length] = work;
	<span class="reserved">return</span> work;
}

<span class="comment">/////////////////////////////// Loop ///////////////////////////////////</span>

n2i.animation.Loop = <span class="reserved">function</span>(recipe) {
	<span class="reserved">this</span>.recipe = recipe;
	<span class="reserved">this</span>.position = -1;
	<span class="reserved">this</span>.running = false;
}

n2i.animation.Loop.<span class="reserved">prototype</span>.next = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.position++;
	<span class="reserved">if</span> (<span class="reserved">this</span>.position&gt;=<span class="reserved">this</span>.recipe.length) {
		<span class="reserved">this</span>.position = 0;
	}
	var item = <span class="reserved">this</span>.recipe[<span class="reserved">this</span>.position];
	<span class="reserved">if</span> (typeof(item)==<span class="literal">'function'</span>) {
		item();
	} <span class="reserved">else</span> <span class="reserved">if</span> (item.element) {
		n2i.ani(item.element,item.property,item.value,item.duration,{ease:item.ease});
	}
	var self = <span class="reserved">this</span>;
	var time = item.duration || 0;
	window.setTimeout(<span class="reserved">function</span>() {self.next()},time);
}

n2i.animation.Loop.<span class="reserved">prototype</span>.start = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.running=true;
	<span class="reserved">this</span>.next();
}

<span class="comment">/**
	<span class="attrib">@constructor</span>
*/</span>
n2i.Color = <span class="reserved">function</span>(color_string) {
    <span class="reserved">this</span>.ok = false;

    <span class="comment">// strip any leading #</span>
    <span class="reserved">if</span> (color_string.charAt(0) == <span class="literal">'#'</span>) { <span class="comment">// remove # if any</span>
        color_string = color_string.substr(1,6);
    }

    color_string = color_string.replace(/ /g,<span class="literal">''</span>);
    color_string = color_string.toLowerCase();

    <span class="comment">// before getting into regexps, try simple matches</span>
    <span class="comment">// and overwrite the input</span>
    var simple_colors = {
        aliceblue: <span class="literal">'f0f8ff'</span>,
        antiquewhite: <span class="literal">'faebd7'</span>,
        aqua: <span class="literal">'00ffff'</span>,
        aquamarine: <span class="literal">'7fffd4'</span>,
        azure: <span class="literal">'f0ffff'</span>,
        beige: <span class="literal">'f5f5dc'</span>,
        bisque: <span class="literal">'ffe4c4'</span>,
        black: <span class="literal">'000000'</span>,
        blanchedalmond: <span class="literal">'ffebcd'</span>,
        blue: <span class="literal">'0000ff'</span>,
        blueviolet: <span class="literal">'8a2be2'</span>,
        brown: <span class="literal">'a52a2a'</span>,
        burlywood: <span class="literal">'deb887'</span>,
        cadetblue: <span class="literal">'5f9ea0'</span>,
        chartreuse: <span class="literal">'7fff00'</span>,
        chocolate: <span class="literal">'d2691e'</span>,
        coral: <span class="literal">'ff7f50'</span>,
        cornflowerblue: <span class="literal">'6495ed'</span>,
        cornsilk: <span class="literal">'fff8dc'</span>,
        crimson: <span class="literal">'dc143c'</span>,
        cyan: <span class="literal">'00ffff'</span>,
        darkblue: <span class="literal">'00008b'</span>,
        darkcyan: <span class="literal">'008b8b'</span>,
        darkgoldenrod: <span class="literal">'b8860b'</span>,
        darkgray: <span class="literal">'a9a9a9'</span>,
        darkgreen: <span class="literal">'006400'</span>,
        darkkhaki: <span class="literal">'bdb76b'</span>,
        darkmagenta: <span class="literal">'8b008b'</span>,
        darkolivegreen: <span class="literal">'556b2f'</span>,
        darkorange: <span class="literal">'ff8c00'</span>,
        darkorchid: <span class="literal">'9932cc'</span>,
        darkred: <span class="literal">'8b0000'</span>,
        darksalmon: <span class="literal">'e9967a'</span>,
        darkseagreen: <span class="literal">'8fbc8f'</span>,
        darkslateblue: <span class="literal">'483d8b'</span>,
        darkslategray: <span class="literal">'2f4f4f'</span>,
        darkturquoise: <span class="literal">'00ced1'</span>,
        darkviolet: <span class="literal">'9400d3'</span>,
        deeppink: <span class="literal">'ff1493'</span>,
        deepskyblue: <span class="literal">'00bfff'</span>,
        dimgray: <span class="literal">'696969'</span>,
        dodgerblue: <span class="literal">'1e90ff'</span>,
        feldspar: <span class="literal">'d19275'</span>,
        firebrick: <span class="literal">'b22222'</span>,
        floralwhite: <span class="literal">'fffaf0'</span>,
        forestgreen: <span class="literal">'228b22'</span>,
        fuchsia: <span class="literal">'ff00ff'</span>,
        gainsboro: <span class="literal">'dcdcdc'</span>,
        ghostwhite: <span class="literal">'f8f8ff'</span>,
        gold: <span class="literal">'ffd700'</span>,
        goldenrod: <span class="literal">'daa520'</span>,
        gray: <span class="literal">'808080'</span>,
        green: <span class="literal">'008000'</span>,
        greenyellow: <span class="literal">'adff2f'</span>,
        honeydew: <span class="literal">'f0fff0'</span>,
        hotpink: <span class="literal">'ff69b4'</span>,
        indianred : <span class="literal">'cd5c5c'</span>,
        indigo : <span class="literal">'4b0082'</span>,
        ivory: <span class="literal">'fffff0'</span>,
        khaki: <span class="literal">'f0e68c'</span>,
        lavender: <span class="literal">'e6e6fa'</span>,
        lavenderblush: <span class="literal">'fff0f5'</span>,
        lawngreen: <span class="literal">'7cfc00'</span>,
        lemonchiffon: <span class="literal">'fffacd'</span>,
        lightblue: <span class="literal">'add8e6'</span>,
        lightcoral: <span class="literal">'f08080'</span>,
        lightcyan: <span class="literal">'e0ffff'</span>,
        lightgoldenrodyellow: <span class="literal">'fafad2'</span>,
        lightgrey: <span class="literal">'d3d3d3'</span>,
        lightgreen: <span class="literal">'90ee90'</span>,
        lightpink: <span class="literal">'ffb6c1'</span>,
        lightsalmon: <span class="literal">'ffa07a'</span>,
        lightseagreen: <span class="literal">'20b2aa'</span>,
        lightskyblue: <span class="literal">'87cefa'</span>,
        lightslateblue: <span class="literal">'8470ff'</span>,
        lightslategray: <span class="literal">'778899'</span>,
        lightsteelblue: <span class="literal">'b0c4de'</span>,
        lightyellow: <span class="literal">'ffffe0'</span>,
        lime: <span class="literal">'00ff00'</span>,
        limegreen: <span class="literal">'32cd32'</span>,
        linen: <span class="literal">'faf0e6'</span>,
        magenta: <span class="literal">'ff00ff'</span>,
        maroon: <span class="literal">'800000'</span>,
        mediumaquamarine: <span class="literal">'66cdaa'</span>,
        mediumblue: <span class="literal">'0000cd'</span>,
        mediumorchid: <span class="literal">'ba55d3'</span>,
        mediumpurple: <span class="literal">'9370d8'</span>,
        mediumseagreen: <span class="literal">'3cb371'</span>,
        mediumslateblue: <span class="literal">'7b68ee'</span>,
        mediumspringgreen: <span class="literal">'00fa9a'</span>,
        mediumturquoise: <span class="literal">'48d1cc'</span>,
        mediumvioletred: <span class="literal">'c71585'</span>,
        midnightblue: <span class="literal">'191970'</span>,
        mintcream: <span class="literal">'f5fffa'</span>,
        mistyrose: <span class="literal">'ffe4e1'</span>,
        moccasin: <span class="literal">'ffe4b5'</span>,
        navajowhite: <span class="literal">'ffdead'</span>,
        navy: <span class="literal">'000080'</span>,
        oldlace: <span class="literal">'fdf5e6'</span>,
        olive: <span class="literal">'808000'</span>,
        olivedrab: <span class="literal">'6b8e23'</span>,
        orange: <span class="literal">'ffa500'</span>,
        orangered: <span class="literal">'ff4500'</span>,
        orchid: <span class="literal">'da70d6'</span>,
        palegoldenrod: <span class="literal">'eee8aa'</span>,
        palegreen: <span class="literal">'98fb98'</span>,
        paleturquoise: <span class="literal">'afeeee'</span>,
        palevioletred: <span class="literal">'d87093'</span>,
        papayawhip: <span class="literal">'ffefd5'</span>,
        peachpuff: <span class="literal">'ffdab9'</span>,
        peru: <span class="literal">'cd853f'</span>,
        pink: <span class="literal">'ffc0cb'</span>,
        plum: <span class="literal">'dda0dd'</span>,
        powderblue: <span class="literal">'b0e0e6'</span>,
        purple: <span class="literal">'800080'</span>,
        red: <span class="literal">'ff0000'</span>,
        rosybrown: <span class="literal">'bc8f8f'</span>,
        royalblue: <span class="literal">'4169e1'</span>,
        saddlebrown: <span class="literal">'8b4513'</span>,
        salmon: <span class="literal">'fa8072'</span>,
        sandybrown: <span class="literal">'f4a460'</span>,
        seagreen: <span class="literal">'2e8b57'</span>,
        seashell: <span class="literal">'fff5ee'</span>,
        sienna: <span class="literal">'a0522d'</span>,
        silver: <span class="literal">'c0c0c0'</span>,
        skyblue: <span class="literal">'87ceeb'</span>,
        slateblue: <span class="literal">'6a5acd'</span>,
        slategray: <span class="literal">'708090'</span>,
        snow: <span class="literal">'fffafa'</span>,
        springgreen: <span class="literal">'00ff7f'</span>,
        steelblue: <span class="literal">'4682b4'</span>,
        tan: <span class="literal">'d2b48c'</span>,
        teal: <span class="literal">'008080'</span>,
        thistle: <span class="literal">'d8bfd8'</span>,
        tomato: <span class="literal">'ff6347'</span>,
        turquoise: <span class="literal">'40e0d0'</span>,
        violet: <span class="literal">'ee82ee'</span>,
        violetred: <span class="literal">'d02090'</span>,
        wheat: <span class="literal">'f5deb3'</span>,
        white: <span class="literal">'ffffff'</span>,
        whitesmoke: <span class="literal">'f5f5f5'</span>,
        yellow: <span class="literal">'ffff00'</span>,
        yellowgreen: <span class="literal">'9acd32'</span>
    };
    <span class="reserved">for</span> (var key in simple_colors) {
        <span class="reserved">if</span> (color_string == key) {
            color_string = simple_colors[key];
        }
    }
    <span class="comment">// emd of simple type-in colors</span>

    <span class="comment">// array of color definition objects</span>
    var color_defs = [
        {
            re: /^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,
            example: [<span class="literal">'rgb(123, 234, 45)'</span>, <span class="literal">'rgb(255,234,245)'</span>],
            process: <span class="reserved">function</span> (bits){
                <span class="reserved">return</span> [
                    parseInt(bits[1]),
                    parseInt(bits[2]),
                    parseInt(bits[3])
                ];
            }
        },
        {
            re: /^(\w{2})(\w{2})(\w{2})$/,
            example: [<span class="literal">'#00ff00'</span>, <span class="literal">'336699'</span>],
            process: <span class="reserved">function</span> (bits){
                <span class="reserved">return</span> [
                    parseInt(bits[1], 16),
                    parseInt(bits[2], 16),
                    parseInt(bits[3], 16)
                ];
            }
        },
        {
            re: /^(\w{1})(\w{1})(\w{1})$/,
            example: [<span class="literal">'#fb0'</span>, <span class="literal">'f0f'</span>],
            process: <span class="reserved">function</span> (bits){
                <span class="reserved">return</span> [
                    parseInt(bits[1] + bits[1], 16),
                    parseInt(bits[2] + bits[2], 16),
                    parseInt(bits[3] + bits[3], 16)
                ];
            }
        }
    ];

    <span class="comment">// search through the definitions to find a match</span>
    <span class="reserved">for</span> (var i = 0; i &lt; color_defs.length; i++) {
        var re = color_defs[i].re;
        var processor = color_defs[i].process;
        var bits = re.exec(color_string);
        <span class="reserved">if</span> (bits) {
            channels = processor(bits);
            <span class="reserved">this</span>.r = channels[0];
            <span class="reserved">this</span>.g = channels[1];
            <span class="reserved">this</span>.b = channels[2];
            <span class="reserved">this</span>.ok = true;
        }

    }

    <span class="comment">// validate/cleanup values</span>
    <span class="reserved">this</span>.r = (<span class="reserved">this</span>.r &lt; 0 || isNaN(<span class="reserved">this</span>.r)) ? 0 : ((<span class="reserved">this</span>.r &gt; 255) ? 255 : <span class="reserved">this</span>.r);
    <span class="reserved">this</span>.g = (<span class="reserved">this</span>.g &lt; 0 || isNaN(<span class="reserved">this</span>.g)) ? 0 : ((<span class="reserved">this</span>.g &gt; 255) ? 255 : <span class="reserved">this</span>.g);
    <span class="reserved">this</span>.b = (<span class="reserved">this</span>.b &lt; 0 || isNaN(<span class="reserved">this</span>.b)) ? 0 : ((<span class="reserved">this</span>.b &gt; 255) ? 255 : <span class="reserved">this</span>.b);

    <span class="comment">// some getters</span>
    <span class="reserved">this</span>.toRGB = <span class="reserved">function</span> () {
        <span class="reserved">return</span> <span class="literal">'rgb('</span> + <span class="reserved">this</span>.r + <span class="literal">', '</span> + <span class="reserved">this</span>.g + <span class="literal">', '</span> + <span class="reserved">this</span>.b + <span class="literal">')'</span>;
    }
    <span class="reserved">this</span>.toHex = <span class="reserved">function</span> () {
        var r = <span class="reserved">this</span>.r.toString(16);
        var g = <span class="reserved">this</span>.g.toString(16);
        var b = <span class="reserved">this</span>.b.toString(16);
        <span class="reserved">if</span> (r.length == 1) r = <span class="literal">'0'</span> + r;
        <span class="reserved">if</span> (g.length == 1) g = <span class="literal">'0'</span> + g;
        <span class="reserved">if</span> (b.length == 1) b = <span class="literal">'0'</span> + b;
        <span class="reserved">return</span> <span class="literal">'#'</span> + r + g + b;
    }

}


<span class="comment">/** <span class="attrib">@namespace</span> */</span>
n2i.ease = {
	slowFastSlow : <span class="reserved">function</span>(val) {
		var a = 1.6;
		var b = 1.4;
		<span class="reserved">return</span> -1*Math.pow(Math.cos((Math.PI/2)*Math.pow(val,a)),Math.pow(Math.PI,b))+1;
	},
	fastSlow : <span class="reserved">function</span>(val) {
		var a = .5;
		var b = .7
		<span class="reserved">return</span> -1*Math.pow(Math.cos((Math.PI/2)*Math.pow(val,a)),Math.pow(Math.PI,b))+1;
	},
	elastic : <span class="reserved">function</span>(t) {
		<span class="reserved">return</span> 1 - n2i.ease.elastic2(1-t);
	},

	elastic2 : <span class="reserved">function</span> (t, a, p) {
		<span class="reserved">if</span> (t&lt;=0 || t&gt;=1) <span class="reserved">return</span> t;
		<span class="reserved">if</span> (!p) p=0.45;
		var s;
		<span class="reserved">if</span> (!a || a &lt; 1) {
			a=1;
			s=p/4;
		} <span class="reserved">else</span> {
			s = p/(2*Math.PI) * Math.asin (1/a);
		}
		<span class="reserved">return</span> -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t-s)*(2*Math.PI)/p ));
	},
	bounce : <span class="reserved">function</span>(t) {
		<span class="reserved">if</span> (t &lt; (1/2.75)) {
			<span class="reserved">return</span> 7.5625*t*t;
		} <span class="reserved">else</span> <span class="reserved">if</span> (t &lt; (2/2.75)) {
			<span class="reserved">return</span> (7.5625*(t-=(1.5/2.75))*t + .75);
		} <span class="reserved">else</span> <span class="reserved">if</span> (t &lt; (2.5/2.75)) {
			<span class="reserved">return</span> (7.5625*(t-=(2.25/2.75))*t + .9375);
		} <span class="reserved">else</span> {
			<span class="reserved">return</span> (7.5625*(t-=(2.625/2.75))*t + .984375);
		}
	},
	
	linear: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: A linear easing function</span>
		<span class="reserved">return</span> n;
	},

	quadIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n, 2);
	},

	quadOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> n * (n-2) * -1;
	},

	quadInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n=n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(n, 2) / 2; }
		<span class="reserved">return</span> -1 * ((--n)*(n-2) - 1) / 2;
	},

	cubicIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n, 3);
	},

	cubicOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n-1, 3) + 1;
	},

	cubicInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n=n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(n, 3) / 2; }
		n-=2;
		<span class="reserved">return</span> (Math.pow(n, 3) + 2) / 2;
	},

	quartIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n, 4);
	},

	quartOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> -1 * (Math.pow(n-1, 4) - 1);
	},

	quartInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n=n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(n, 4) / 2; }
		n-=2;
		<span class="reserved">return</span> -1/2 * (Math.pow(n, 4) - 2);
	},

	quintIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n, 5);
	},

	quintOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n-1, 5) + 1;
	},

	quintInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n=n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(n, 5) / 2; };
		n-=2;
		<span class="reserved">return</span> (Math.pow(n, 5) + 2) / 2;
	},

	sineIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> -1 * Math.cos(n * (Math.PI/2)) + 1;
	},

	sineOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.sin(n * (Math.PI/2));
	},

	sineInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> -1 * (Math.cos(Math.PI*n) - 1) / 2;
	},

	expoIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> (n==0) ? 0 : Math.pow(2, 10 * (n - 1));
	},

	expoOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> (n==1) ? 1 : (-1 * Math.pow(2, -10 * n) + 1);
	},

	expoInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">if</span>(n==0){ <span class="reserved">return</span> 0; }
		<span class="reserved">if</span>(n==1){ <span class="reserved">return</span> 1; }
		n = n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(2, 10 * (n-1)) / 2; }
		--n;
		<span class="reserved">return</span> (-1 * Math.pow(2, -10 * n) + 2) / 2;
	},

	circIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> -1 * (Math.sqrt(1 - Math.pow(n, 2)) - 1);
	},

	circOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n = n-1;
		<span class="reserved">return</span> Math.sqrt(1 - Math.pow(n, 2));
	},

	circInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n = n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> -1/2 * (Math.sqrt(1 - Math.pow(n, 2)) - 1); }
		n-=2;
		<span class="reserved">return</span> 1/2 * (Math.sqrt(1 - Math.pow(n, 2)) + 1);
	},

	backIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		var s = 1.70158;
		<span class="reserved">return</span> Math.pow(n, 2) * ((s+1)*n - s);
	},

	backOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: an easing function that pops past the range briefly, and </span>
		<span class="comment">// 	slowly comes back. </span>
		n = n - 1;
		var s = 1.70158;
		<span class="reserved">return</span> Math.pow(n, 2) * ((s + 1) * n + s) + 1;
	},

	backInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		var s = 1.70158 * 1.525;
		n = n*2;
		<span class="reserved">if</span>(n &lt; 1){ <span class="reserved">return</span> (Math.pow(n, 2)*((s+1)*n - s))/2; }
		n-=2;
		<span class="reserved">return</span> (Math.pow(n, 2)*((s+1)*n + s) + 2)/2;
	},

	elasticIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">if</span>(n==0){ <span class="reserved">return</span> 0; }
		<span class="reserved">if</span>(n==1){ <span class="reserved">return</span> 1; }
		var p = .3;
		var s = p/4;
		n = n - 1;
		<span class="reserved">return</span> -1 * Math.pow(2,10*n) * Math.sin((n-s)*(2*Math.PI)/p);
	},

	elasticOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that elasticly snaps around the target value, near the end of the Animation</span>
		<span class="reserved">if</span>(n==0) <span class="reserved">return</span> 0;
		<span class="reserved">if</span>(n==1) <span class="reserved">return</span> 1;
		var p = .3;
		var s = p/4;
		<span class="reserved">return</span> Math.pow(2,-10*n) * Math.sin((n-s)*(2*Math.PI)/p) + 1;
	},

	elasticInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that elasticly snaps around the value, near the beginning and end of the Animation		</span>
		<span class="reserved">if</span>(n==0) <span class="reserved">return</span> 0;
		n = n*2;
		<span class="reserved">if</span>(n==2) <span class="reserved">return</span> 1;
		var p = .3*1.5;
		var s = p/4;
		<span class="reserved">if</span>(n&lt;1){
			n-=1;
			<span class="reserved">return</span> -.5*(Math.pow(2,10*n) * Math.sin((n-s)*(2*Math.PI)/p));
		}
		n-=1;
		<span class="reserved">return</span> .5*(Math.pow(2,-10*n) * Math.sin((n-s)*(2*Math.PI)/p)) + 1;
	},

	bounceIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that "bounces" near the beginning of an Animation</span>
		<span class="reserved">return</span> (1 - n2i.ease.bounceOut(1-n)); <span class="comment">// Decimal</span>
	},

	bounceOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that "bounces" near the end of an Animation</span>
		var s=7.5625;
		var p=2.75;
		var l; 
		<span class="reserved">if</span>(n &lt; (1 / p)){
			l = s*Math.pow(n, 2);
		}<span class="reserved">else</span> <span class="reserved">if</span>(n &lt; (2 / p)){
			n -= (1.5 / p);
			l = s * Math.pow(n, 2) + .75;
		}<span class="reserved">else</span> <span class="reserved">if</span>(n &lt; (2.5 / p)){
			n -= (2.25 / p);
			l = s * Math.pow(n, 2) + .9375;
		}<span class="reserved">else</span>{
			n -= (2.625 / p);
			l = s * Math.pow(n, 2) + .984375;
		}
		<span class="reserved">return</span> l;
	},

	bounceInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that "bounces" at the beginning and end of the Animation</span>
		<span class="reserved">if</span>(n&lt;0.5){ <span class="reserved">return</span> n2i.ease.bounceIn(n*2) / 2; }
		<span class="reserved">return</span> (n2i.ease.bounceOut(n*2-1) / 2) + 0.5; <span class="comment">// Decimal</span>
	}
};var WysiHat = {};

WysiHat.Editor = {
  <span class="comment">/**
   *  WysiHat.Editor.attach(textarea)
   *  - textarea (String | Element): an id or DOM node of the textarea that
   *  you want to convert to rich text.
   *
   *  Creates a new editor for the textarea.
   **/</span>
  attach: <span class="reserved">function</span>(textarea) {
    textarea = $(textarea);
    textarea.hide();

    <span class="reserved">return</span> WysiHat.iFrame.create(textarea, <span class="reserved">function</span>(editArea) {
      var document = editArea.getDocument();
      var window = editArea.getWindow();

      editArea.load();

      Event.observe(window, <span class="literal">'focus'</span>, <span class="reserved">function</span>(event) { editArea.focus(); });
      Event.observe(window, <span class="literal">'blur'</span>, <span class="reserved">function</span>(event) { editArea.blur(); });


      Event.observe(document, <span class="literal">'mouseup'</span>, <span class="reserved">function</span>(event) {
        editArea.fire(<span class="literal">"wysihat:mouseup"</span>);
      });

      Event.observe(document, <span class="literal">'mousemove'</span>, <span class="reserved">function</span>(event) {
        editArea.fire(<span class="literal">"wysihat:mousemove"</span>);
      });

      Event.observe(document, <span class="literal">'keypress'</span>, <span class="reserved">function</span>(event) {
        editArea.fire(<span class="literal">"wysihat:change"</span>);
        editArea.fire(<span class="literal">"wysihat:keypress"</span>);
      });

      Event.observe(document, <span class="literal">'keyup'</span>, <span class="reserved">function</span>(event) {
        editArea.fire(<span class="literal">"wysihat:change"</span>);
        editArea.fire(<span class="literal">"wysihat:keyup"</span>);
      });

      Event.observe(document, <span class="literal">'keydown'</span>, <span class="reserved">function</span>(event) {
        <span class="reserved">if</span> (event.keyCode == 86)
          editArea.fire(<span class="literal">"wysihat:paste"</span>);
      });

      Event.observe(window, <span class="literal">'paste'</span>, <span class="reserved">function</span>(event) {
        editArea.fire(<span class="literal">"wysihat:paste"</span>);
      });


      editArea.observe(<span class="literal">"wysihat:change"</span>, <span class="reserved">function</span>(event) {
        event.target.save();
      });
      <span class="comment">//editArea.focus(); HACK!</span>
    });
  }
};

<span class="comment">/**
 * mixin WysiHat.Commands
 *
 *  Methods will be mixed into the editor element. Most of these
 *  methods will be used to bind to button clicks or key presses.
 *
 *  var editor = WysiHat.Editor.attach(textarea);
 *  $('bold_button').observe('click', function(event) {
 *    editor.boldSelection();
 *    Event.stop(event);
 *  });
 *
 *  In this example, it is important to stop the click event so you don't
 *  lose your current selection.
 **/</span>
WysiHat.Commands = {
  <span class="comment">/**
   * WysiHat.Commands#boldSelection() -&gt; undefined
   *  Bolds the current selection.
   **/</span>
  boldSelection: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.execCommand(<span class="literal">'bold'</span>, false, null);
  },

  <span class="comment">/**
   * WysiHat.Commands#underlineSelection() -&gt; undefined
   *  Underlines the current selection.
   **/</span>
  underlineSelection: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.execCommand(<span class="literal">'underline'</span>, false, null);
  },

  <span class="comment">/**
   * WysiHat.Commands#italicSelection() -&gt; undefined
   *  Italicizes the current selection.
   **/</span>
  italicSelection: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.execCommand(<span class="literal">'italic'</span>, false, null);
  },

  <span class="comment">/**
   * WysiHat.Commands#italicSelection() -&gt; undefined
   *  Strikethroughs the current selection.
   **/</span>
  strikethroughSelection: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.execCommand(<span class="literal">'strikethrough'</span>, false, null);
  },

  <span class="comment">/**
   * WysiHat.Commands#italicSelection() -&gt; undefined
   *  Blockquotes the current selection.
   **/</span>
  blockquoteSelection: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.execCommand(<span class="literal">'blockquote'</span>, false, null);
  },

  <span class="comment">/**
   * WysiHat.Commands#colorSelection(color) -&gt; undefined
   *  - color (String): a color name or hexadecimal value
   *  Sets the foreground color of the current selection.
   **/</span>
  colorSelection: <span class="reserved">function</span>(color) {
    <span class="reserved">this</span>.execCommand(<span class="literal">'forecolor'</span>, false, color);
  },

  <span class="comment">/**
   * WysiHat.Commands#linkSelection(url) -&gt; undefined
   *  - url (String): value for href
   *  Wraps the current selection in a link.
   **/</span>
  linkSelection: <span class="reserved">function</span>(url) {
    <span class="reserved">this</span>.execCommand(<span class="literal">'createLink'</span>, false, url);
  },

  <span class="comment">/**
   * WysiHat.Commands#insertOrderedList() -&gt; undefined
   *  Formats current selection as an ordered list. If the selection is empty
   *  a new list is inserted.
   **/</span>
  insertOrderedList: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.execCommand(<span class="literal">'insertorderedlist'</span>, false, null);
  },

  <span class="comment">/**
   * WysiHat.Commands#insertUnorderedList() -&gt; undefined
   *  Formats current selection as an unordered list. If the selection is empty
   *  a new list is inserted.
   **/</span>
  insertUnorderedList: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.execCommand(<span class="literal">'insertunorderedlist'</span>, false, null);
  },

  <span class="comment">/**
   * WysiHat.Commands#insertImage(url) -&gt; undefined
   *  - url (String): value for src
   *  Insert an image at the insertion point with the given url.
   **/</span>
  insertImage: <span class="reserved">function</span>(url) {
    <span class="reserved">this</span>.execCommand(<span class="literal">'insertImage'</span>, false, url);
  },

  <span class="comment">/**
   * WysiHat.Commands#insertHTML(html) -&gt; undefined
   *  - html (String): HTML or plain text
   *  Insert HTML at the insertion point.
   **/</span>
  insertHTML: <span class="reserved">function</span>(html) {
    <span class="reserved">if</span> (Prototype.Browser.IE) {
      var range = <span class="reserved">this</span>._selection.getRange();
      range.pasteHTML(html);
      range.collapse(false);
      range.select();
    } <span class="reserved">else</span> {
      <span class="reserved">this</span>.execCommand(<span class="literal">'insertHTML'</span>, false, html);
    }
  },

  <span class="comment">/**
   * WysiHat.Commands#execCommand(command[, ui = false][, value = null]) -&gt; undefined
   *  - command (String): Command to execute
   *  - ui (Boolean): Boolean flag for showing UI. Currenty this not
   *  implemented by any browser. Just use false.
   *  - value (String): Value to pass to command
   *  A simple delegation method to the documents execCommand method.
   **/</span>
  execCommand: <span class="reserved">function</span>(command, ui, value) {
    var document = <span class="reserved">this</span>.getDocument();
    document.execCommand(command, ui, value);
  },

  queryStateCommands: $A([<span class="literal">'bold'</span>, <span class="literal">'italic'</span>, <span class="literal">'underline'</span>, <span class="literal">'strikethrough'</span>]),

  <span class="comment">/**
   * WysiHat.Commands#queryCommandState(state) -&gt; Boolean
   *  - state (String): bold, italic, underline, etc
   *  Determines whether the current selection has the given state.
   *  queryCommandState('bold') would return true if the selected text
   *  is bold.
   *
   * You can extend this behavior by adding a custom method to the editor
   * element, queryCustom(). However this API is not final.
   * queryCommandState('link') would call queryLink().
   **/</span>
  queryCommandState: <span class="reserved">function</span>(state) {
    var document = <span class="reserved">this</span>.getDocument();

    <span class="reserved">if</span> (<span class="reserved">this</span>.queryStateCommands.include(state))
      <span class="reserved">return</span> document.queryCommandState(state);
    <span class="reserved">else</span> <span class="reserved">if</span> ((f = <span class="reserved">this</span>[<span class="literal">'query'</span> + state.capitalize()]))
      <span class="reserved">return</span> f.bind(<span class="reserved">this</span>).call();
    <span class="reserved">else</span>
      <span class="reserved">return</span> false;
  }
};
<span class="comment">/**
 * mixin WysiHat.Persistence
 *
 *  Methods will be mixed into the editor element. These methods deal with
 *  extracting and filtering content going in and out of the editor.
 */</span>
WysiHat.Persistence = (<span class="reserved">function</span>() {
  <span class="comment">/**
   * WysiHat.Persistence#outputFilter(text) -&gt; String
   *  - text (String): HTML string
   *
   *  Use to filter content coming out of the editor. By default it calls
   *  text.format_html_output. This method has been extract so you can override
   *  it and provide your own custom output filter.
   */</span>
  <span class="reserved">function</span> outputFilter(text) {
    <span class="reserved">return</span> text.format_html_output();
  }

  <span class="comment">/**
   * WysiHat.Persistence#inputFilter(text) -&gt; String
   *  - text (String): HTML string
   *
   *  Use to filter content going into the editor. By default it calls
   *  text.format_html_input. This method has been extract so you can override
   *  it and provide your own custom input filter.
   */</span>
  <span class="reserved">function</span> inputFilter(text) {
    <span class="reserved">return</span> text.format_html_input();
  }

  <span class="comment">/**
   * WysiHat.Persistence#content() -&gt; String
   *  Returns the editors HTML contents. The contents are first passed
   *  through outputFilter.
   *
   *  You can replace the generic outputFilter with your own function. The
   *  default behavior is to use String#format_html_output.
   *
   *  editor.outputFilter = function(text) {
   *    return MyUtils.format_and_santize(text);
   *  };
   **/</span>
  <span class="reserved">function</span> content() {
    <span class="reserved">return</span> <span class="reserved">this</span>.outputFilter(<span class="reserved">this</span>.rawContent());
  }

  <span class="comment">/**
   * WysiHat.Persistence#setContent(text) -&gt; undefined
   *  - text (String): HTML string
   *
   *  Replaces editor's entire contents with the given HTML. The contents are
   *  first passed through inputFilter.
   *
   *  You can replace the generic inputFilter with your own function. The
   *  default behavior is to use String#format_html_input.
   *
   *  editor.inputFilter = function(text) {
   *    return MyUtils.format_and_santize(text);
   *  };
   **/</span>
  <span class="reserved">function</span> setContent(text) {
    <span class="reserved">this</span>.setRawContent(<span class="reserved">this</span>.inputFilter(text));
  }

  <span class="comment">/**
   * WysiHat.Persistence#save() -&gt; undefined
   *  Saves editors contents back out to the textarea.
   **/</span>
  <span class="reserved">function</span> save() {
    <span class="reserved">this</span>.textarea.value = <span class="reserved">this</span>.content();
  }

  <span class="comment">/**
   * WysiHat.Persistence#load() -&gt; undefined
   *  Loads textarea contents into editor.
   **/</span>
   <span class="reserved">function</span> load() {
     <span class="reserved">this</span>.setContent(<span class="reserved">this</span>.textarea.value);
  }

  <span class="comment">/**
   * WysiHat.Persistence#reload() -&gt; undefined
   *  Saves current contents and loads contents into editor.
   **/</span>
  <span class="reserved">function</span> reload() {
    <span class="reserved">this</span>.selection.setBookmark();
    <span class="reserved">this</span>.save();
    <span class="reserved">this</span>.load();
    <span class="reserved">this</span>.selection.moveToBookmark();
  }

  <span class="reserved">return</span> {
    outputFilter: outputFilter,
    inputFilter:  inputFilter,
    content:      content,
    setContent:   setContent,
    save:         save,
    load:         load,
    reload:       reload
  };
})();
<span class="comment">/**
 * mixin WysiHat.Window
 *
 *  Methods will be mixed into the editor element. These methods handle window
 *  events such as focus and blur events on the editor.
 */</span>
WysiHat.Window = (<span class="reserved">function</span>() {
  <span class="comment">/**
   * WysiHat.Window#getDocument() -&gt; Document
   *  Cross browser method to return the iFrame's document.
   *  You should not need to access this directly, and this API is not final.
   */</span>
  <span class="reserved">function</span> getDocument() {
    <span class="reserved">return</span> <span class="reserved">this</span>.contentDocument || <span class="reserved">this</span>.contentWindow.document;
  }

  <span class="comment">/**
   * WysiHat.Window#getWindow() -&gt; Window
   *  Cross browser method to return the iFrame's window.
   *  You should not need to access this directly, and this API is not final.
   */</span>
  <span class="reserved">function</span> getWindow() {
    <span class="reserved">if</span> (<span class="reserved">this</span>.contentWindow.document)
      <span class="reserved">return</span> <span class="reserved">this</span>.contentWindow;
    <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.contentDocument)
      <span class="reserved">return</span> <span class="reserved">this</span>.contentDocument.defaultView;
    <span class="reserved">else</span>
      <span class="reserved">return</span> null;
  }

  <span class="comment">/**
   * WysiHat.Window#focus() -&gt; undefined
   *  binds observers to mouseup, mousemove, keypress, and keyup on focus
   **/</span>
  <span class="reserved">function</span> focus() {
    <span class="reserved">this</span>.getWindow().focus();

    <span class="reserved">if</span> (<span class="reserved">this</span>.hasFocus)
      <span class="reserved">return</span>;

    <span class="reserved">this</span>.hasFocus = true;
  }

  <span class="comment">/**
   * WysiHat.Window#blur() -&gt; undefined
   *  removes observers to mouseup, mousemove, keypress, and keyup on blur
   **/</span>
  <span class="reserved">function</span> blur() {
    <span class="reserved">this</span>.hasFocus = false;
  }

  <span class="reserved">return</span> {
    getDocument: getDocument,
    getWindow: getWindow,
    focus: focus,
    blur: blur
  };
})();

WysiHat.iFrame = {
  create: <span class="reserved">function</span>(textarea, callback) {
    var editArea = new Element(<span class="literal">'iframe'</span>, { <span class="literal">'id'</span>: textarea.id + <span class="literal">'_editor'</span>, <span class="literal">'class'</span>: <span class="literal">'editor'</span>, allowtransparency:<span class="literal">'true'</span> });

    Object.extend(editArea, WysiHat.Commands);
    Object.extend(editArea, WysiHat.Persistence);
    Object.extend(editArea, WysiHat.Window);
    Object.extend(editArea, WysiHat.iFrame.Methods);

    editArea.attach(textarea, callback);

    textarea.insert({before: editArea});

    <span class="reserved">return</span> editArea;
  }
};

WysiHat.iFrame.Methods = {
  attach: <span class="reserved">function</span>(element, callback) {
    <span class="reserved">this</span>.textarea = element;

    <span class="reserved">this</span>.observe(<span class="literal">'load'</span>, <span class="reserved">function</span>() {
      <span class="reserved">function</span> setDocumentStyles(document, styles) {
        <span class="reserved">if</span> (Prototype.Browser.IE) {
          var style = document.createStyleSheet();
          style.addRule(<span class="literal">"body"</span>, <span class="literal">"border: 0"</span>);
          style.addRule(<span class="literal">"p"</span>, <span class="literal">"margin: 0"</span>);

          $H(styles).each(<span class="reserved">function</span>(pair) {
            var value = pair.first().underscore().dasherize() + <span class="literal">": "</span> + pair.last();
            style.addRule(<span class="literal">"body"</span>, value);
          });
        } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.Opera) {
          var style = Element(<span class="literal">'style'</span>).update(<span class="literal">"p { margin: 0; }"</span>);
          var head = document.getElementsByTagName(<span class="literal">'head'</span>)[0];
          head.appendChild(style);
        } <span class="reserved">else</span> {
          Element.setStyle(document.body, styles);
        }
      }

      try {
        var document = <span class="reserved">this</span>.getDocument();
      } catch(e) { <span class="reserved">return</span>; } <span class="comment">// No iframe, just stop</span>

      <span class="reserved">this</span>.selection = new WysiHat.Selection(<span class="reserved">this</span>);

      <span class="reserved">if</span> (<span class="reserved">this</span>.ready &amp;&amp; document.designMode == <span class="literal">'on'</span>)
        <span class="reserved">return</span>;

      setDocumentStyles(document, WysiHat.Editor.styles || {});

      document.designMode = <span class="literal">'on'</span>;
      callback(<span class="reserved">this</span>);
      <span class="reserved">this</span>.ready = true;
	<span class="reserved">if</span> (document.body) {
      <span class="reserved">this</span>.fire(<span class="literal">"wysihat:loaded"</span>); <span class="comment">// HACK</span>
}
    });
  },

  rawContent: <span class="reserved">function</span>() {
    var document = <span class="reserved">this</span>.getDocument();
    <span class="reserved">return</span> document.body.innerHTML;
  },

  setRawContent: <span class="reserved">function</span>(text) {
    var document = <span class="reserved">this</span>.getDocument();
    <span class="reserved">if</span> (document.body)
      document.body.innerHTML = text;
  }
};

Object.extend(String.<span class="reserved">prototype</span>, (<span class="reserved">function</span>() {
  <span class="comment">/**
   * String#format_html_output() -&gt; String
   *
   *  Cleanup browser's HTML mess!
   *
   *  There is no standard formatting among the major browsers for the rich
   *  text output. Safari wraps its line breaks with "div" tags, Firefox puts
   *  "br" tags at the end of the line, and other such as Internet Explorer
   *  wrap lines in "p" tags.
   *
   *  The output is a standarizes these inconsistencies and produces a clean
   *  result. A single return creates a line break "br" and double returns
   *  create a new paragraph. This is similar to how Textile and Markdown
   *  handle whitespace.
   *
   *  Raw browser content =&gt; String#format_html_output =&gt; Textarea
   **/</span>
  <span class="reserved">function</span> format_html_output() {
    var text = String(<span class="reserved">this</span>);
    text = text.tidy_xhtml();

    <span class="reserved">if</span> (Prototype.Browser.WebKit) {
      text = text.replace(/(&lt;div&gt;)+/g, <span class="literal">"\n"</span>);
      text = text.replace(/(&lt;\/div&gt;)+/g, <span class="literal">""</span>);

      text = text.replace(/&lt;p&gt;\s*&lt;\/p&gt;/g, <span class="literal">""</span>);

      text = text.replace(/&lt;br \/&gt;(\n)*/g, <span class="literal">"\n"</span>);
    } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.Gecko) {
      text = text.replace(/&lt;p&gt;/g, <span class="literal">""</span>);
      text = text.replace(/&lt;\/p&gt;(\n)?/g, <span class="literal">"\n"</span>);

      text = text.replace(/&lt;br \/&gt;(\n)*/g, <span class="literal">"\n"</span>);
    } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.IE || Prototype.Browser.Opera) {
      text = text.replace(/&lt;p&gt;(&amp;nbsp;|&amp;#160;|\s)&lt;\/p&gt;/g, <span class="literal">"&lt;p&gt;&lt;/p&gt;"</span>);

      text = text.replace(/&lt;br \/&gt;/g, <span class="literal">""</span>);

      text = text.replace(/&lt;p&gt;/g, <span class="literal">''</span>);

      text = text.replace(/&amp;nbsp;/g, <span class="literal">''</span>);

      text = text.replace(/&lt;\/p&gt;(\n)?/g, <span class="literal">"\n"</span>);

      text = text.gsub(/^&lt;p&gt;/, <span class="literal">''</span>);
      text = text.gsub(/&lt;\/p&gt;$/, <span class="literal">''</span>);
    }

    text = text.gsub(/&lt;b&gt;/, <span class="literal">"&lt;strong&gt;"</span>);
    text = text.gsub(/&lt;\/b&gt;/, <span class="literal">"&lt;/strong&gt;"</span>);

    text = text.gsub(/&lt;i&gt;/, <span class="literal">"&lt;em&gt;"</span>);
    text = text.gsub(/&lt;\/i&gt;/, <span class="literal">"&lt;/em&gt;"</span>);

    text = text.replace(/\n\n+/g, <span class="literal">"&lt;/p&gt;\n\n&lt;p&gt;"</span>);

    text = text.gsub(/(([^\n])(\n))(?=([^\n]))/, <span class="literal">"#{2}&lt;br /&gt;\n"</span>);

    text = <span class="literal">'&lt;p&gt;'</span> + text + <span class="literal">'&lt;/p&gt;'</span>;

    text = text.replace(/&lt;p&gt;\s*/g, <span class="literal">"&lt;p&gt;"</span>);
    text = text.replace(/\s*&lt;\/p&gt;/g, <span class="literal">"&lt;/p&gt;"</span>);

    var element = Element(<span class="literal">"body"</span>);
    element.innerHTML = text;

    <span class="reserved">if</span> (Prototype.Browser.WebKit || Prototype.Browser.Gecko) {
      var replaced;
      do {
        replaced = false;
        element.select(<span class="literal">'span'</span>).each(<span class="reserved">function</span>(span) {
          <span class="reserved">if</span> (span.hasClassName(<span class="literal">'Apple-style-span'</span>)) {
            span.removeClassName(<span class="literal">'Apple-style-span'</span>);
            <span class="reserved">if</span> (span.className == <span class="literal">''</span>)
              span.removeAttribute(<span class="literal">'class'</span>);
            replaced = true;
          } <span class="reserved">else</span> <span class="reserved">if</span> (span.getStyle(<span class="literal">'fontWeight'</span>) == <span class="literal">'bold'</span>) {
            span.setStyle({fontWeight: <span class="literal">''</span>});
            <span class="reserved">if</span> (span.style.length == 0)
              span.removeAttribute(<span class="literal">'style'</span>);
            span.update(<span class="literal">'&lt;strong&gt;'</span> + span.innerHTML + <span class="literal">'&lt;/strong&gt;'</span>);
            replaced = true;
          } <span class="reserved">else</span> <span class="reserved">if</span> (span.getStyle(<span class="literal">'fontStyle'</span>) == <span class="literal">'italic'</span>) {
            span.setStyle({fontStyle: <span class="literal">''</span>});
            <span class="reserved">if</span> (span.style.length == 0)
              span.removeAttribute(<span class="literal">'style'</span>);
            span.update(<span class="literal">'&lt;em&gt;'</span> + span.innerHTML + <span class="literal">'&lt;/em&gt;'</span>);
            replaced = true;
          } <span class="reserved">else</span> <span class="reserved">if</span> (span.getStyle(<span class="literal">'textDecoration'</span>) == <span class="literal">'underline'</span>) {
            span.setStyle({textDecoration: <span class="literal">''</span>});
            <span class="reserved">if</span> (span.style.length == 0)
              span.removeAttribute(<span class="literal">'style'</span>);
            span.update(<span class="literal">'&lt;u&gt;'</span> + span.innerHTML + <span class="literal">'&lt;/u&gt;'</span>);
            replaced = true;
          } <span class="reserved">else</span> <span class="reserved">if</span> (span.attributes.length == 0) {
            span.replace(span.innerHTML);
            replaced = true;
          }
        });
      } <span class="reserved">while</span> (replaced);

    }

    <span class="reserved">for</span> (var i = 0; i &lt; element.descendants().length; i++) {
      var node = element.descendants()[i];
      <span class="reserved">if</span> (node.innerHTML.blank() &amp;&amp; node.nodeName != <span class="literal">'BR'</span> &amp;&amp; node.id != <span class="literal">'bookmark'</span>)
        node.remove();
    }

    text = element.innerHTML;
    text = text.tidy_xhtml();

    text = text.replace(/&lt;br \/&gt;(\n)*/g, <span class="literal">"&lt;br /&gt;\n"</span>);
    text = text.replace(/&lt;\/p&gt;\n&lt;p&gt;/g, <span class="literal">"&lt;/p&gt;\n\n&lt;p&gt;"</span>);

    text = text.replace(/&lt;p&gt;\s*&lt;\/p&gt;/g, <span class="literal">""</span>);

    text = text.replace(/\s*$/g, <span class="literal">""</span>);

    <span class="reserved">return</span> text;
  }

  <span class="comment">/**
   * String#format_html_input() -&gt; String
   *
   *  Prepares sane HTML for editing.
   *
   *  This function preforms the reserve function of String#format_html_output. Each
   *  browser has difficulty editing mix formatting conventions. This restores
   *  most of the original browser specific formatting tags and some other
   *  styling conventions.
   *
   *  Textarea =&gt; String#format_html_input =&gt; Raw content
  **/</span>
  <span class="reserved">function</span> format_html_input() {
    var text = String(<span class="reserved">this</span>);

    var element = Element(<span class="literal">"body"</span>);
    element.innerHTML = text;

    <span class="reserved">if</span> (Prototype.Browser.Gecko || Prototype.Browser.WebKit) {
      element.select(<span class="literal">'strong'</span>).each(<span class="reserved">function</span>(element) {
        element.replace(<span class="literal">'&lt;span style="font-weight: bold;"&gt;'</span> + element.innerHTML + <span class="literal">'&lt;/span&gt;'</span>);
      });
      element.select(<span class="literal">'em'</span>).each(<span class="reserved">function</span>(element) {
        element.replace(<span class="literal">'&lt;span style="font-style: italic;"&gt;'</span> + element.innerHTML + <span class="literal">'&lt;/span&gt;'</span>);
      });
      element.select(<span class="literal">'u'</span>).each(<span class="reserved">function</span>(element) {
        element.replace(<span class="literal">'&lt;span style="text-decoration: underline;"&gt;'</span> + element.innerHTML + <span class="literal">'&lt;/span&gt;'</span>);
      });
    }

    <span class="reserved">if</span> (Prototype.Browser.WebKit)
      element.select(<span class="literal">'span'</span>).each(<span class="reserved">function</span>(span) {
        <span class="reserved">if</span> (span.getStyle(<span class="literal">'fontWeight'</span>) == <span class="literal">'bold'</span>)
          span.addClassName(<span class="literal">'Apple-style-span'</span>);

        <span class="reserved">if</span> (span.getStyle(<span class="literal">'fontStyle'</span>) == <span class="literal">'italic'</span>)
          span.addClassName(<span class="literal">'Apple-style-span'</span>);

        <span class="reserved">if</span> (span.getStyle(<span class="literal">'textDecoration'</span>) == <span class="literal">'underline'</span>)
          span.addClassName(<span class="literal">'Apple-style-span'</span>);
      });

    text = element.innerHTML;
    text = text.tidy_xhtml();

    text = text.replace(/&lt;\/p&gt;(\n)*&lt;p&gt;/g, <span class="literal">"\n\n"</span>);

    text = text.replace(/(\n)?&lt;br( \/)?&gt;(\n)?/g, <span class="literal">"\n"</span>);

    text = text.replace(/^&lt;p&gt;/g, <span class="literal">''</span>);
    text = text.replace(/&lt;\/p&gt;$/g, <span class="literal">''</span>);

    <span class="reserved">if</span> (Prototype.Browser.Gecko) {
      text = text.replace(/\n/g, <span class="literal">"&lt;br&gt;"</span>);
      text = text + <span class="literal">'&lt;br&gt;'</span>;
    } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.WebKit) {
      text = text.replace(/\n/g, <span class="literal">"&lt;/div&gt;&lt;div&gt;"</span>);
      text = <span class="literal">'&lt;div&gt;'</span> + text + <span class="literal">'&lt;/div&gt;'</span>;
      text = text.replace(/&lt;div&gt;&lt;\/div&gt;/g, <span class="literal">"&lt;div&gt;&lt;br&gt;&lt;/div&gt;"</span>);
    } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.IE || Prototype.Browser.Opera) {
      text = text.replace(/\n/g, <span class="literal">"&lt;/p&gt;\n&lt;p&gt;"</span>);
      text = <span class="literal">'&lt;p&gt;'</span> + text + <span class="literal">'&lt;/p&gt;'</span>;
      text = text.replace(/&lt;p&gt;&lt;\/p&gt;/g, <span class="literal">"&lt;p&gt;&amp;nbsp;&lt;/p&gt;"</span>);
      text = text.replace(/(&lt;p&gt;&amp;nbsp;&lt;\/p&gt;)+$/g, <span class="literal">""</span>);
    }

    <span class="reserved">return</span> text;
  }

  <span class="comment">/**
   * String#tidy_xhtml() -&gt; String
   *
   *  Normalizes and tidies text into XHTML content.
   *   * Strips out browser line breaks, '\r'
   *   * Downcases tag names
   *   * Closes line break tags
   **/</span>
  <span class="reserved">function</span> tidy_xhtml() {
    var text = String(<span class="reserved">this</span>);

    text = text.gsub(/\r\n?/, <span class="literal">"\n"</span>);

    text = text.gsub(/&lt;([A-Z]+)([^&gt;]*)&gt;/, <span class="reserved">function</span>(match) {
      <span class="reserved">return</span> <span class="literal">'&lt;'</span> + match[1].toLowerCase() + match[2] + <span class="literal">'&gt;'</span>;
    });

    text = text.gsub(/&lt;\/([A-Z]+)&gt;/, <span class="reserved">function</span>(match) {
      <span class="reserved">return</span> <span class="literal">'&lt;/'</span> + match[1].toLowerCase() + <span class="literal">'&gt;'</span>;
    });

    text = text.replace(/&lt;br&gt;/g, <span class="literal">"&lt;br /&gt;"</span>);

    <span class="reserved">return</span> text;
  }

  <span class="reserved">return</span> {
    format_html_output: format_html_output,
    format_html_input:  format_html_input,
    tidy_xhtml:         tidy_xhtml
  };
})());
Object.extend(String.<span class="reserved">prototype</span>, {
  <span class="comment">/**
   * String#sanitize([options]) -&gt; String
   * - options (Hash): Whitelist options
   *
   *  Sanitizes HTML tags and attributes. Options accepts an array of
   *  allowed tags and attributes.
   #
   *  "&lt;a href='#'&gt;Example&lt;/a&gt;".sanitize({tags: ['a'], attributes: ['href']})
   **/</span>
  sanitize: <span class="reserved">function</span>(options) {
    <span class="reserved">return</span> Element(<span class="literal">"div"</span>).update(<span class="reserved">this</span>).sanitize(options).innerHTML.tidy_xhtml();
  }
});

Element.addMethods({
  <span class="comment">/**
   * Element#sanitize([options]) -&gt; Element
   * - options (Hash): Whitelist options
   *
   *  Sanitizes element tags and attributes. Options accepts an array of
   *  allowed tags and attributes.
   #
   *  This method is called by String#sanitize().
   **/</span>
  sanitize: <span class="reserved">function</span>(element, options) {
    element = $(element);
    options = $H(options);
    var allowed_tags = $A(options.get(<span class="literal">'tags'</span>) || []);
    var allowed_attributes = $A(options.get(<span class="literal">'attributes'</span>) || []);
    var sanitized = Element(element.nodeName);

    $A(element.childNodes).each(<span class="reserved">function</span>(child) {
      <span class="reserved">if</span> (child.nodeType == 1) {
        var children = $(child).sanitize(options).childNodes;

        <span class="reserved">if</span> (allowed_tags.include(child.nodeName.toLowerCase())) {
          var new_child = Element(child.nodeName);
          allowed_attributes.each(<span class="reserved">function</span>(attribute) {
            <span class="reserved">if</span> ((value = child.readAttribute(attribute)))
              new_child.writeAttribute(attribute, value);
          });
          sanitized.appendChild(new_child);

          $A(children).each(<span class="reserved">function</span>(grandchild) { new_child.appendChild(grandchild); });
        } <span class="reserved">else</span> {
          $A(children).each(<span class="reserved">function</span>(grandchild) { sanitized.appendChild(grandchild); });
        }
      } <span class="reserved">else</span> <span class="reserved">if</span> (child.nodeType == 3) {
        sanitized.appendChild(child);
      }
    });
    <span class="reserved">return</span> sanitized;
  }
});

<span class="comment">/**
 * class Range
 *
 *  *Under construction*
 *
 *  An attempt to implement the W3C Range in IE.
 *
 **/</span>
<span class="reserved">if</span> (Prototype.Browser.IE) {
  <span class="reserved">function</span> Range(ownerDocument) {
    <span class="reserved">this</span>.ownerDocument = ownerDocument;

    <span class="reserved">this</span>.startContainer = <span class="reserved">this</span>.ownerDocument.documentElement;
    <span class="reserved">this</span>.startOffset    = 0;
    <span class="reserved">this</span>.endContainer   = <span class="reserved">this</span>.ownerDocument.documentElement;
    <span class="reserved">this</span>.endOffset      = 0;

    <span class="reserved">this</span>.collapsed = true;
    <span class="reserved">this</span>.commonAncestorContainer = null;

    <span class="reserved">this</span>.START_TO_START = 0;
    <span class="reserved">this</span>.START_TO_END   = 1;
    <span class="reserved">this</span>.END_TO_END     = 2;
    <span class="reserved">this</span>.END_TO_START   = 3;
  }

  document.createRange = <span class="reserved">function</span>() {
    <span class="reserved">return</span> new Range(<span class="reserved">this</span>);
  };

  Object.extend(Range.<span class="reserved">prototype</span>, {
    setStart: <span class="reserved">function</span>(parent, offset) {},
    setEnd: <span class="reserved">function</span>(parent, offset) {},
    setStartBefore: <span class="reserved">function</span>(node) {},
    setStartAfter: <span class="reserved">function</span>(node) {},
    setEndBefore: <span class="reserved">function</span>(node) {},
    setEndAfter: <span class="reserved">function</span>(node) {},

    collapse: <span class="reserved">function</span>(toStart) {},

    selectNode: <span class="reserved">function</span>(n) {},
    selectNodeContents: <span class="reserved">function</span>(n) {},

    compareBoundaryPoints: <span class="reserved">function</span>(how, sourceRange) {},

    deleteContents: <span class="reserved">function</span>() {},
    extractContents: <span class="reserved">function</span>() {},
    cloneContents: <span class="reserved">function</span>() {},

    insertNode: <span class="reserved">function</span>(n) {
      var range = <span class="reserved">this</span>.ownerDocument.selection.createRange();
      var parent = <span class="reserved">this</span>.ownerDocument.createElement(<span class="literal">'div'</span>);
      parent.appendChild(n);
      range.collapse();
      range.pasteHTML(parent.innerHTML);
    },
    surroundContents: <span class="reserved">function</span>(newParent) {
      var range = <span class="reserved">this</span>.ownerDocument.selection.createRange();
      var parent = <span class="reserved">this</span>.document.createElement(<span class="literal">'div'</span>);
      parent.appendChild(newParent);
      node.innerHTML += range.htmlText;
      range.pasteHTML(parent.innerHTML);
    },

    cloneRange: <span class="reserved">function</span>() {},
    toString: <span class="reserved">function</span>() {},
    detach: <span class="reserved">function</span>() {}
  });
}
<span class="comment">/**
 * class WysiHat.Selection
 **/</span>
WysiHat.Selection = Class.create((<span class="reserved">function</span>() {
  <span class="comment">/**
   *  new WysiHat.Selection(editor)
   *  - editor (WysiHat.Editor): the editor object that you want to bind to
   **/</span>
  <span class="reserved">function</span> initialize(editor) {
    <span class="reserved">this</span>.window = editor.getWindow();
    <span class="reserved">this</span>.document = editor.getDocument();
  }

  <span class="comment">/**
   * WysiHat.Selection#getSelection() -&gt; Selection
   *  Get selected text.
   **/</span>
  <span class="reserved">function</span> getSelection() {
    <span class="reserved">return</span> <span class="reserved">this</span>.window.getSelection ? <span class="reserved">this</span>.window.getSelection() : <span class="reserved">this</span>.document.selection;
  }

  <span class="comment">/**
   * WysiHat.Selection#getRange() -&gt; Range
   *  Get range for selected text.
   **/</span>
  <span class="reserved">function</span> getRange() {
    var selection = <span class="reserved">this</span>.getSelection();

    try {
      var range;
      <span class="reserved">if</span> (selection.getRangeAt)
        range = selection.getRangeAt(0);
      <span class="reserved">else</span>
        range = selection.createRange();
    } catch(e) { <span class="reserved">return</span> null; }

    <span class="reserved">if</span> (Prototype.Browser.WebKit) {
      range.setStart(selection.baseNode, selection.baseOffset);
      range.setEnd(selection.extentNode, selection.extentOffset);
    }

    <span class="reserved">return</span> range;
  }

  <span class="comment">/**
   * WysiHat.Selection#selectNode(node) -&gt; undefined
   * - node (Element): Element or node to select
   **/</span>
  <span class="reserved">function</span> selectNode(node) {
    var selection = <span class="reserved">this</span>.getSelection();

    <span class="reserved">if</span> (Prototype.Browser.IE) {
      var range = createRangeFromElement(<span class="reserved">this</span>.document, node);
      range.select();
    } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.WebKit) {
      selection.setBaseAndExtent(node, 0, node, node.innerText.length);
    } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.Opera) {
      range = <span class="reserved">this</span>.document.createRange();
      range.selectNode(node);
      selection.removeAllRanges();
      selection.addRange(range);
    } <span class="reserved">else</span> {
      var range = createRangeFromElement(<span class="reserved">this</span>.document, node);
      selection.removeAllRanges();
      selection.addRange(range);
    }
  }

  <span class="comment">/**
   * WysiHat.Selection#getNode() -&gt; Element
   *  Returns selected node.
   **/</span>
  <span class="reserved">function</span> getNode() {
    var nodes = null, candidates = [], children, el;
    var range = <span class="reserved">this</span>.getRange();

    <span class="reserved">if</span> (!range)
      <span class="reserved">return</span> null;

    var parent;
    <span class="reserved">if</span> (range.parentElement)
      parent = range.parentElement();
    <span class="reserved">else</span>
      parent = range.commonAncestorContainer;

    <span class="reserved">if</span> (parent) {
      <span class="reserved">while</span> (parent.nodeType != 1) parent = parent.parentNode;
      <span class="reserved">if</span> (parent.nodeName.toLowerCase() != <span class="literal">"body"</span>) {
        el = parent;
        do {
          el = el.parentNode;
          candidates[candidates.length] = el;
        } <span class="reserved">while</span> (el.nodeName.toLowerCase() != <span class="literal">"body"</span>);
      }
      children = parent.all || parent.getElementsByTagName(<span class="literal">"*"</span>);
      <span class="reserved">for</span> (var j = 0; j &lt; children.length; j++)
        candidates[candidates.length] = children[j];
      nodes = [parent];
      <span class="reserved">for</span> (var ii = 0, r2; ii &lt; candidates.length; ii++) {
        r2 = createRangeFromElement(<span class="reserved">this</span>.document, candidates[ii]);
        <span class="reserved">if</span> (r2 &amp;&amp; compareRanges(range, r2))
          nodes[nodes.length] = candidates[ii];
      }
    }

    <span class="reserved">return</span> nodes.first();
  }

  <span class="reserved">function</span> createRangeFromElement(document, node) {
    <span class="reserved">if</span> (document.body.createTextRange) {
      var range = document.body.createTextRange();
      range.moveToElementText(node);
    } <span class="reserved">else</span> <span class="reserved">if</span> (document.createRange) {
      var range = document.createRange();
      range.selectNodeContents(node);
    }
    <span class="reserved">return</span> range;
  }

  <span class="reserved">function</span> compareRanges(r1, r2) {
    <span class="reserved">if</span> (r1.compareEndPoints) {
      <span class="reserved">return</span> !(
        r2.compareEndPoints(<span class="literal">'StartToStart'</span>, r1) == 1 &amp;&amp;
        r2.compareEndPoints(<span class="literal">'EndToEnd'</span>, r1) == 1 &amp;&amp;
        r2.compareEndPoints(<span class="literal">'StartToEnd'</span>, r1) == 1 &amp;&amp;
        r2.compareEndPoints(<span class="literal">'EndToStart'</span>, r1) == 1
        ||
        r2.compareEndPoints(<span class="literal">'StartToStart'</span>, r1) == -1 &amp;&amp;
        r2.compareEndPoints(<span class="literal">'EndToEnd'</span>, r1) == -1 &amp;&amp;
        r2.compareEndPoints(<span class="literal">'StartToEnd'</span>, r1) == -1 &amp;&amp;
        r2.compareEndPoints(<span class="literal">'EndToStart'</span>, r1) == -1
      );
    } <span class="reserved">else</span> <span class="reserved">if</span> (r1.compareBoundaryPoints) {
      <span class="reserved">return</span> !(
        r2.compareBoundaryPoints(0, r1) == 1 &amp;&amp;
        r2.compareBoundaryPoints(2, r1) == 1 &amp;&amp;
        r2.compareBoundaryPoints(1, r1) == 1 &amp;&amp;
        r2.compareBoundaryPoints(3, r1) == 1
        ||
        r2.compareBoundaryPoints(0, r1) == -1 &amp;&amp;
        r2.compareBoundaryPoints(2, r1) == -1 &amp;&amp;
        r2.compareBoundaryPoints(1, r1) == -1 &amp;&amp;
        r2.compareBoundaryPoints(3, r1) == -1
      );
    }

    <span class="reserved">return</span> null;
  };

  <span class="reserved">function</span> setBookmark() {
    var bookmark = <span class="reserved">this</span>.document.getElementById(<span class="literal">'bookmark'</span>);
    <span class="reserved">if</span> (bookmark)
      bookmark.parentNode.removeChild(bookmark);

    bookmark = <span class="reserved">this</span>.document.createElement(<span class="literal">'span'</span>);
    bookmark.id = <span class="literal">'bookmark'</span>;
    bookmark.innerHTML = <span class="literal">'&amp;nbsp;'</span>;

    var range;
    <span class="reserved">if</span> (Prototype.Browser.IE)
      range = new Range(<span class="reserved">this</span>.document);
    <span class="reserved">else</span>
      range = <span class="reserved">this</span>.getRange();
    range.insertNode(bookmark);
  }

  <span class="reserved">function</span> moveToBookmark() {
    var bookmark = <span class="reserved">this</span>.document.getElementById(<span class="literal">'bookmark'</span>);
    <span class="reserved">if</span> (!bookmark)
      <span class="reserved">return</span>;

    <span class="reserved">if</span> (Prototype.Browser.IE) {
      var range = <span class="reserved">this</span>.getRange();
      range.moveToElementText(bookmark);
      range.collapse();
      range.select();
    } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.WebKit) {
      var selection = <span class="reserved">this</span>.getSelection();
      selection.setBaseAndExtent(bookmark, 0, bookmark, 0);
    } <span class="reserved">else</span> {
      var range = <span class="reserved">this</span>.getRange();
      range.setStartBefore(bookmark);
    }

    bookmark.parentNode.removeChild(bookmark);
  }

  <span class="reserved">return</span> {
    initialize:     initialize,
    getSelection:   getSelection,
    getRange:       getRange,
    getNode:        getNode,
    selectNode:     selectNode,
    setBookmark:    setBookmark,
    moveToBookmark: moveToBookmark
  };
})());

<span class="comment">/**
 * class WysiHat.Toolbar
 **/</span>
WysiHat.Toolbar = Class.create((<span class="reserved">function</span>() {
  <span class="comment">/**
   * new WysiHat.Toolbar(editor)
   *  - editor (WysiHat.Editor): the editor object that you want to attach to
   *
   *  Creates a toolbar element above the editor. The WysiHat.Toolbar object
   *  has many helper methods to easily add buttons to the toolbar.
   *
   *  This toolbar class is not required for the Editor object to function.
   *  It is merely a set of helper methods to get you started and to build
   *  on top of.
   **/</span>
  <span class="reserved">function</span> initialize(editArea) {
    <span class="reserved">this</span>.editArea = editArea;

    <span class="reserved">this</span>.hasMouseDown = false;
    <span class="reserved">this</span>.element = new Element(<span class="literal">'div'</span>, { <span class="literal">'class'</span>: <span class="literal">'editor_toolbar'</span> });

    var toolbar = <span class="reserved">this</span>;
    <span class="reserved">this</span>.element.observe(<span class="literal">'mousedown'</span>, <span class="reserved">function</span>(event) { toolbar.mouseDown(event); });
    <span class="reserved">this</span>.element.observe(<span class="literal">'mouseup'</span>, <span class="reserved">function</span>(event) { toolbar.mouseUp(event); });

    <span class="reserved">this</span>.editArea.insert({before: <span class="reserved">this</span>.element});
  }

  <span class="comment">/**
   * WysiHat.Toolbar#addButtonSet(set) -&gt; undefined
   *  - set (Array): The set array contains nested arrays that hold the
   *  button options, and handler.
   *
   *  Adds a button set to the toolbar.
   *
   *  WysiHat.Toolbar.ButtonSets.Basic is a built in button set,
   *  that looks like:
   *  [
   *    [{ name: 'bold', label: "Bold" }, function(editor) {
   *      editor.boldSelection();
   *    }],
   *    [{ name: 'underline', label: "Underline" }, function(editor) {
   *      editor.underlineSelection();
   *    }],
   *    [{ name: 'italic', label: "Italic" }, function(editor) {
   *      editor.italicSelection();
   *    }]
   *  ]
   **/</span>
  <span class="reserved">function</span> addButtonSet(set) {
    var toolbar = <span class="reserved">this</span>;
    $A(set).each(<span class="reserved">function</span>(button) {
      var options = button.first();
      var handler = button.last();
      toolbar.addButton(options, handler);
    });
  }

  <span class="comment">/**
   * WysiHat.Toolbar#addButton(options, handler) -&gt; undefined
   *  - options (Hash): Required options hash
   *  - handler (Function): Function to bind to the button
   *
   *  The options hash accepts two required keys, name and label. The label
   *  value is used as the link's inner text. The name value is set to the
   *  link's class and is used to check the button state.
   *
   *  toolbar.addButton({
   *    name: 'bold', label: "Bold" }, function(editor) {
   *      editor.boldSelection();
   *  });
   *
   *  Would create a link,
   *  "&lt;a href='#' class='button bold'&gt;&lt;span&gt;Bold&lt;/span&gt;&lt;/a&gt;"
   **/</span>
  <span class="reserved">function</span> addButton(options, handler) {
    options = $H(options);
    var button = Element(<span class="literal">'a'</span>, { <span class="literal">'class'</span>: <span class="literal">'button'</span>, <span class="literal">'href'</span>: <span class="literal">'#'</span> }).update(<span class="literal">'&lt;span&gt;'</span> + options.get(<span class="literal">'label'</span>) + <span class="literal">'&lt;/span&gt;'</span>);
    button.addClassName(options.get(<span class="literal">'name'</span>));

    <span class="reserved">this</span>.observeButtonClick(button, handler);
    <span class="reserved">this</span>.observeStateChanges(button, options.get(<span class="literal">'name'</span>));
    <span class="reserved">this</span>.element.appendChild(button);
  }

  <span class="comment">/**
   * WysiHat.Toolbar#observeButtonClick(element, handler) -&gt; undefined
   *  - element (String | Element): Element to bind handler to
   *  - handler (Function): Function to bind to the element
   *  fires wysihat:change
   *
   *  In addition to binding the given handler to the element, this observe
   *  function also sets up a few more events. When the elements onclick is
   *  fired, the toolbars hasMouseDown property will be set to true and
   *  back to false on exit.
   **/</span>
  <span class="reserved">function</span> observeButtonClick(element, handler) {
    var toolbar = <span class="reserved">this</span>;
    $(element).observe(<span class="literal">'click'</span>, <span class="reserved">function</span>(event) {
      toolbar.hasMouseDown = true;
      handler(toolbar.editArea);
      toolbar.editArea.fire(<span class="literal">"wysihat:change"</span>);
      Event.stop(event);
      toolbar.hasMouseDown = false;
    });
  }

  <span class="comment">/**
   * WysiHat.Toolbar#observeStateChanges(element, command) -&gt; undefined
   *  - element (String | Element): Element to receive changes
   *  - command (String): Name of editor command to observe
   *
   *  Adds the class "selected" to the given Element when the selected text
   *  matches the command.
   *
   *  toolbar.observeStateChanges(buttonElement, 'bold')
   *  would add the class "selected" to the buttonElement when the editor's
   *  selected text was bold.
   **/</span>
  <span class="reserved">function</span> observeStateChanges(element, command) {
    <span class="reserved">this</span>.editArea.observe(<span class="literal">"wysihat:mousemove"</span>, <span class="reserved">function</span>(event) {
      <span class="reserved">if</span> (event.target.queryCommandState(command))
        element.addClassName(<span class="literal">'selected'</span>);
      <span class="reserved">else</span>
        element.removeClassName(<span class="literal">'selected'</span>);
    });
  }

  <span class="comment">/**
   * WysiHat.Toolbar#mouseDown(event) -&gt; undefined
   *  - event (Event)
   *  This function is triggered when the user clicks their mouse down on
   *  the toolbar element. For now, it only updates the hasMouseDown property
   *  to true.
   **/</span>
  <span class="reserved">function</span> mouseDown(event) {
    <span class="reserved">this</span>.hasMouseDown = true;
  }

  <span class="comment">/**
   * WysiHat.Toolbar#mouseDown(event) -&gt; undefined
   *  - event (Event)
   *  This function is triggered when the user releases their mouse from
   *  the toolbar element. It resets the hasMouseDown property back to false
   *  and refocuses on the editing window.
   **/</span>
  <span class="reserved">function</span> mouseUp(event) {
    <span class="reserved">this</span>.editArea.focus();
    <span class="reserved">this</span>.hasMouseDown = false;
  }

  <span class="reserved">return</span> {
    initialize:          initialize,
    addButtonSet:        addButtonSet,
    addButton:           addButton,
    observeButtonClick:  observeButtonClick,
    observeStateChanges: observeStateChanges,
    mouseDown:           mouseDown,
    mouseUp:             mouseUp
  };
})());

WysiHat.Toolbar.ButtonSets = {};

<span class="comment">/**
 * WysiHat.Toolbar.ButtonSets.Basic = $A([
 *    [{ name: 'bold', label: "Bold" }, function(editor) {
 *      editor.boldSelection();
 *    }],
 *
 *    [{ name: 'underline', label: "Underline" }, function(editor) {
 *      editor.underlineSelection();
 *    }],
 *
 *    [{ name: 'italic', label: "Italic" }, function(editor) {
 *      editor.italicSelection();
 *    }]
 *  ])
 *
 *  A basic set of buttons: bold, underline, and italic. This set is
 *  compatible with WysiHat.Toolbar, and can be added to the toolbar with:
 *  toolbar.addButtonSet(WysiHat.Toolbar.ButtonSets.Basic);
 **/</span>
WysiHat.Toolbar.ButtonSets.Basic = $A([
  [{ name: <span class="literal">'bold'</span>, label: <span class="literal">"Bold"</span> }, <span class="reserved">function</span>(editor) {
    editor.boldSelection();
  }],

  [{ name: <span class="literal">'underline'</span>, label: <span class="literal">"Underline"</span> }, <span class="reserved">function</span>(editor) {
    editor.underlineSelection();
  }],

  [{ name: <span class="literal">'italic'</span>, label: <span class="literal">"Italic"</span> }, <span class="reserved">function</span>(editor) {
    editor.italicSelection();
  }]
]);

<span class="comment">/*	SWFObject v2.0 &lt;http://code.google.com/p/swfobject/&gt;
	Copyright (c) 2007 Geoff Stearns, Michael Williams, and Bobby van der Sluis
	This software is released under the MIT License &lt;http://www.opensource.org/licenses/mit-license.php&gt;
*/</span>
var swfobject=<span class="reserved">function</span>(){var Z=<span class="literal">"undefined"</span>,P=<span class="literal">"object"</span>,B=<span class="literal">"Shockwave Flash"</span>,h=<span class="literal">"ShockwaveFlash.ShockwaveFlash"</span>,W=<span class="literal">"application/x-shockwave-flash"</span>,K=<span class="literal">"SWFObjectExprInst"</span>,G=window,g=document,N=navigator,f=[],H=[],Q=null,L=null,T=null,S=false,C=false;var a=<span class="reserved">function</span>(){var l=typeof g.getElementById!=Z&amp;&amp;typeof g.getElementsByTagName!=Z&amp;&amp;typeof g.createElement!=Z&amp;&amp;typeof g.appendChild!=Z&amp;&amp;typeof g.replaceChild!=Z&amp;&amp;typeof g.removeChild!=Z&amp;&amp;typeof g.cloneNode!=Z,t=[0,0,0],n=null;<span class="reserved">if</span>(typeof N.plugins!=Z&amp;&amp;typeof N.plugins[B]==P){n=N.plugins[B].description;<span class="reserved">if</span>(n){n=n.replace(/^.*\s+(\S+\s+\S+$)/,<span class="literal">"$1"</span>);t[0]=parseInt(n.replace(/^(.*)\..*$/,<span class="literal">"$1"</span>),10);t[1]=parseInt(n.replace(/^.*\.(.*)\s.*$/,<span class="literal">"$1"</span>),10);t[2]=/r/.test(n)?parseInt(n.replace(/^.*r(.*)$/,<span class="literal">"$1"</span>),10):0}}<span class="reserved">else</span>{<span class="reserved">if</span>(typeof G.ActiveXObject!=Z){var o=null,s=false;try{o=new ActiveXObject(h+<span class="literal">".7"</span>)}catch(k){try{o=new ActiveXObject(h+<span class="literal">".6"</span>);t=[6,0,21];o.AllowScriptAccess=<span class="literal">"always"</span>}catch(k){<span class="reserved">if</span>(t[0]==6){s=true}}<span class="reserved">if</span>(!s){try{o=new ActiveXObject(h)}catch(k){}}}<span class="reserved">if</span>(!s&amp;&amp;o){try{n=o.GetVariable(<span class="literal">"$version"</span>);<span class="reserved">if</span>(n){n=n.split(<span class="literal">" "</span>)[1].split(<span class="literal">","</span>);t=[parseInt(n[0],10),parseInt(n[1],10),parseInt(n[2],10)]}}catch(k){}}}}var v=N.userAgent.toLowerCase(),j=N.platform.toLowerCase(),r=/webkit/.test(v)?parseFloat(v.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,<span class="literal">"$1"</span>)):false,i=false,q=j?/win/.test(j):/win/.test(v),m=j?/mac/.test(j):/mac/.test(v);<span class="comment">/*<span class="attrib">@cc_on</span> i=true;<span class="attrib">@if</span>(<span class="attrib">@_win32</span>)q=true;<span class="attrib">@elif</span>(<span class="attrib">@_mac</span>)m=true;<span class="attrib">@end</span>@*/</span><span class="reserved">return</span>{w3cdom:l,pv:t,webkit:r,ie:i,win:q,mac:m}}();var e=<span class="reserved">function</span>(){<span class="reserved">if</span>(!a.w3cdom){<span class="reserved">return</span> }J(I);<span class="reserved">if</span>(a.ie&amp;&amp;a.win){try{g.write(<span class="literal">"&lt;script id=__ie_ondomload defer=true src=//:&gt;&lt;\/script&gt;"</span>);var i=c(<span class="literal">"__ie_ondomload"</span>);<span class="reserved">if</span>(i){i.onreadystatechange=<span class="reserved">function</span>(){<span class="reserved">if</span>(<span class="reserved">this</span>.readyState==<span class="literal">"complete"</span>){<span class="reserved">this</span>.parentNode.removeChild(<span class="reserved">this</span>);V()}}}}catch(j){}}<span class="reserved">if</span>(a.webkit&amp;&amp;typeof g.readyState!=Z){Q=setInterval(<span class="reserved">function</span>(){<span class="reserved">if</span>(/loaded|complete/.test(g.readyState)){V()}},10)}<span class="reserved">if</span>(typeof g.addEventListener!=Z){g.addEventListener(<span class="literal">"DOMContentLoaded"</span>,V,null)}M(V)}();<span class="reserved">function</span> V(){<span class="reserved">if</span>(S){<span class="reserved">return</span> }<span class="reserved">if</span>(a.ie&amp;&amp;a.win){var m=Y(<span class="literal">"span"</span>);try{var l=g.getElementsByTagName(<span class="literal">"body"</span>)[0].appendChild(m);l.parentNode.removeChild(l)}catch(n){<span class="reserved">return</span> }}S=true;<span class="reserved">if</span>(Q){clearInterval(Q);Q=null}var j=f.length;<span class="reserved">for</span>(var k=0;k&lt;j;k++){f[k]()}}<span class="reserved">function</span> J(i){<span class="reserved">if</span>(S){i()}<span class="reserved">else</span>{f[f.length]=i}}<span class="reserved">function</span> M(j){<span class="reserved">if</span>(typeof G.addEventListener!=Z){G.addEventListener(<span class="literal">"load"</span>,j,false)}<span class="reserved">else</span>{<span class="reserved">if</span>(typeof g.addEventListener!=Z){g.addEventListener(<span class="literal">"load"</span>,j,false)}<span class="reserved">else</span>{<span class="reserved">if</span>(typeof G.attachEvent!=Z){G.attachEvent(<span class="literal">"onload"</span>,j)}<span class="reserved">else</span>{<span class="reserved">if</span>(typeof G.onload==<span class="literal">"function"</span>){var i=G.onload;G.onload=<span class="reserved">function</span>(){i();j()}}<span class="reserved">else</span>{G.onload=j}}}}}<span class="reserved">function</span> I(){var l=H.length;<span class="reserved">for</span>(var j=0;j&lt;l;j++){var m=H[j].id;<span class="reserved">if</span>(a.pv[0]&gt;0){var k=c(m);<span class="reserved">if</span>(k){H[j].width=k.getAttribute(<span class="literal">"width"</span>)?k.getAttribute(<span class="literal">"width"</span>):<span class="literal">"0"</span>;H[j].height=k.getAttribute(<span class="literal">"height"</span>)?k.getAttribute(<span class="literal">"height"</span>):<span class="literal">"0"</span>;<span class="reserved">if</span>(O(H[j].swfVersion)){<span class="reserved">if</span>(a.webkit&amp;&amp;a.webkit&lt;312){U(k)}X(m,true)}<span class="reserved">else</span>{<span class="reserved">if</span>(H[j].expressInstall&amp;&amp;!C&amp;&amp;O(<span class="literal">"6.0.65"</span>)&amp;&amp;(a.win||a.mac)){D(H[j])}<span class="reserved">else</span>{d(k)}}}}<span class="reserved">else</span>{X(m,true)}}}<span class="reserved">function</span> U(m){var k=m.getElementsByTagName(P)[0];<span class="reserved">if</span>(k){var p=Y(<span class="literal">"embed"</span>),r=k.attributes;<span class="reserved">if</span>(r){var o=r.length;<span class="reserved">for</span>(var n=0;n&lt;o;n++){<span class="reserved">if</span>(r[n].nodeName.toLowerCase()==<span class="literal">"data"</span>){p.setAttribute(<span class="literal">"src"</span>,r[n].nodeValue)}<span class="reserved">else</span>{p.setAttribute(r[n].nodeName,r[n].nodeValue)}}}var q=k.childNodes;<span class="reserved">if</span>(q){var s=q.length;<span class="reserved">for</span>(var l=0;l&lt;s;l++){<span class="reserved">if</span>(q[l].nodeType==1&amp;&amp;q[l].nodeName.toLowerCase()==<span class="literal">"param"</span>){p.setAttribute(q[l].getAttribute(<span class="literal">"name"</span>),q[l].getAttribute(<span class="literal">"value"</span>))}}}m.parentNode.replaceChild(p,m)}}<span class="reserved">function</span> F(i){<span class="reserved">if</span>(a.ie&amp;&amp;a.win&amp;&amp;O(<span class="literal">"8.0.0"</span>)){G.attachEvent(<span class="literal">"onunload"</span>,<span class="reserved">function</span>(){var k=c(i);<span class="reserved">if</span>(k){<span class="reserved">for</span>(var j in k){<span class="reserved">if</span>(typeof k[j]==<span class="literal">"function"</span>){k[j]=<span class="reserved">function</span>(){}}}k.parentNode.removeChild(k)}})}}<span class="reserved">function</span> D(j){C=true;var o=c(j.id);<span class="reserved">if</span>(o){<span class="reserved">if</span>(j.altContentId){var l=c(j.altContentId);<span class="reserved">if</span>(l){L=l;T=j.altContentId}}<span class="reserved">else</span>{L=b(o)}<span class="reserved">if</span>(!(/%$/.test(j.width))&amp;&amp;parseInt(j.width,10)&lt;310){j.width=<span class="literal">"310"</span>}<span class="reserved">if</span>(!(/%$/.test(j.height))&amp;&amp;parseInt(j.height,10)&lt;137){j.height=<span class="literal">"137"</span>}g.title=g.title.slice(0,47)+<span class="literal">" - Flash Player Installation"</span>;var n=a.ie&amp;&amp;a.win?<span class="literal">"ActiveX"</span>:<span class="literal">"PlugIn"</span>,k=g.title,m=<span class="literal">"MMredirectURL="</span>+G.location+<span class="literal">"&amp;MMplayerType="</span>+n+<span class="literal">"&amp;MMdoctitle="</span>+k,p=j.id;<span class="reserved">if</span>(a.ie&amp;&amp;a.win&amp;&amp;o.readyState!=4){var i=Y(<span class="literal">"div"</span>);p+=<span class="literal">"SWFObjectNew"</span>;i.setAttribute(<span class="literal">"id"</span>,p);o.parentNode.insertBefore(i,o);o.style.display=<span class="literal">"none"</span>;G.attachEvent(<span class="literal">"onload"</span>,<span class="reserved">function</span>(){o.parentNode.removeChild(o)})}R({data:j.expressInstall,id:K,width:j.width,height:j.height},{flashvars:m},p)}}<span class="reserved">function</span> d(j){<span class="reserved">if</span>(a.ie&amp;&amp;a.win&amp;&amp;j.readyState!=4){var i=Y(<span class="literal">"div"</span>);j.parentNode.insertBefore(i,j);i.parentNode.replaceChild(b(j),i);j.style.display=<span class="literal">"none"</span>;G.attachEvent(<span class="literal">"onload"</span>,<span class="reserved">function</span>(){j.parentNode.removeChild(j)})}<span class="reserved">else</span>{j.parentNode.replaceChild(b(j),j)}}<span class="reserved">function</span> b(n){var m=Y(<span class="literal">"div"</span>);<span class="reserved">if</span>(a.win&amp;&amp;a.ie){m.innerHTML=n.innerHTML}<span class="reserved">else</span>{var k=n.getElementsByTagName(P)[0];<span class="reserved">if</span>(k){var o=k.childNodes;<span class="reserved">if</span>(o){var j=o.length;<span class="reserved">for</span>(var l=0;l&lt;j;l++){<span class="reserved">if</span>(!(o[l].nodeType==1&amp;&amp;o[l].nodeName.toLowerCase()==<span class="literal">"param"</span>)&amp;&amp;!(o[l].nodeType==8)){m.appendChild(o[l].cloneNode(true))}}}}}<span class="reserved">return</span> m}<span class="reserved">function</span> R(AE,AC,q){var p,t=c(q);<span class="reserved">if</span>(typeof AE.id==Z){AE.id=q}<span class="reserved">if</span>(a.ie&amp;&amp;a.win){var AD=<span class="literal">""</span>;<span class="reserved">for</span>(var z in AE){<span class="reserved">if</span>(AE[z]!=Object.<span class="reserved">prototype</span>[z]){<span class="reserved">if</span>(z==<span class="literal">"data"</span>){AC.movie=AE[z]}<span class="reserved">else</span>{<span class="reserved">if</span>(z.toLowerCase()==<span class="literal">"styleclass"</span>){AD+=<span class="literal">' class="'</span>+AE[z]+<span class="literal">'"'</span>}<span class="reserved">else</span>{<span class="reserved">if</span>(z!=<span class="literal">"classid"</span>){AD+=<span class="literal">" "</span>+z+<span class="literal">'="'</span>+AE[z]+<span class="literal">'"'</span>}}}}}var AB=<span class="literal">""</span>;<span class="reserved">for</span>(var y in AC){<span class="reserved">if</span>(AC[y]!=Object.<span class="reserved">prototype</span>[y]){AB+=<span class="literal">'&lt;param name="'</span>+y+<span class="literal">'" value="'</span>+AC[y]+<span class="literal">'" /&gt;'</span>}}t.outerHTML=<span class="literal">'&lt;object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'</span>+AD+<span class="literal">"&gt;"</span>+AB+<span class="literal">"&lt;/object&gt;"</span>;F(AE.id);p=c(AE.id)}<span class="reserved">else</span>{<span class="reserved">if</span>(a.webkit&amp;&amp;a.webkit&lt;312){var AA=Y(<span class="literal">"embed"</span>);AA.setAttribute(<span class="literal">"type"</span>,W);<span class="reserved">for</span>(var x in AE){<span class="reserved">if</span>(AE[x]!=Object.<span class="reserved">prototype</span>[x]){<span class="reserved">if</span>(x==<span class="literal">"data"</span>){AA.setAttribute(<span class="literal">"src"</span>,AE[x])}<span class="reserved">else</span>{<span class="reserved">if</span>(x.toLowerCase()==<span class="literal">"styleclass"</span>){AA.setAttribute(<span class="literal">"class"</span>,AE[x])}<span class="reserved">else</span>{<span class="reserved">if</span>(x!=<span class="literal">"classid"</span>){AA.setAttribute(x,AE[x])}}}}}<span class="reserved">for</span>(var w in AC){<span class="reserved">if</span>(AC[w]!=Object.<span class="reserved">prototype</span>[w]){<span class="reserved">if</span>(w!=<span class="literal">"movie"</span>){AA.setAttribute(w,AC[w])}}}t.parentNode.replaceChild(AA,t);p=AA}<span class="reserved">else</span>{var s=Y(P);s.setAttribute(<span class="literal">"type"</span>,W);<span class="reserved">for</span>(var v in AE){<span class="reserved">if</span>(AE[v]!=Object.<span class="reserved">prototype</span>[v]){<span class="reserved">if</span>(v.toLowerCase()==<span class="literal">"styleclass"</span>){s.setAttribute(<span class="literal">"class"</span>,AE[v])}<span class="reserved">else</span>{<span class="reserved">if</span>(v!=<span class="literal">"classid"</span>){s.setAttribute(v,AE[v])}}}}<span class="reserved">for</span>(var u in AC){<span class="reserved">if</span>(AC[u]!=Object.<span class="reserved">prototype</span>[u]&amp;&amp;u!=<span class="literal">"movie"</span>){E(s,u,AC[u])}}t.parentNode.replaceChild(s,t);p=s}}<span class="reserved">return</span> p}<span class="reserved">function</span> E(k,i,j){var l=Y(<span class="literal">"param"</span>);l.setAttribute(<span class="literal">"name"</span>,i);l.setAttribute(<span class="literal">"value"</span>,j);k.appendChild(l)}<span class="reserved">function</span> c(i){<span class="reserved">return</span> g.getElementById(i)}<span class="reserved">function</span> Y(i){<span class="reserved">return</span> g.createElement(i)}<span class="reserved">function</span> O(k){var j=a.pv,i=k.split(<span class="literal">"."</span>);i[0]=parseInt(i[0],10);i[1]=parseInt(i[1],10);i[2]=parseInt(i[2],10);<span class="reserved">return</span>(j[0]&gt;i[0]||(j[0]==i[0]&amp;&amp;j[1]&gt;i[1])||(j[0]==i[0]&amp;&amp;j[1]==i[1]&amp;&amp;j[2]&gt;=i[2]))?true:false}<span class="reserved">function</span> A(m,j){<span class="reserved">if</span>(a.ie&amp;&amp;a.mac){<span class="reserved">return</span> }var l=g.getElementsByTagName(<span class="literal">"head"</span>)[0],k=Y(<span class="literal">"style"</span>);k.setAttribute(<span class="literal">"type"</span>,<span class="literal">"text/css"</span>);k.setAttribute(<span class="literal">"media"</span>,<span class="literal">"screen"</span>);<span class="reserved">if</span>(!(a.ie&amp;&amp;a.win)&amp;&amp;typeof g.createTextNode!=Z){k.appendChild(g.createTextNode(m+<span class="literal">" {"</span>+j+<span class="literal">"}"</span>))}l.appendChild(k);<span class="reserved">if</span>(a.ie&amp;&amp;a.win&amp;&amp;typeof g.styleSheets!=Z&amp;&amp;g.styleSheets.length&gt;0){var i=g.styleSheets[g.styleSheets.length-1];<span class="reserved">if</span>(typeof i.addRule==P){i.addRule(m,j)}}}<span class="reserved">function</span> X(k,i){var j=i?<span class="literal">"visible"</span>:<span class="literal">"hidden"</span>;<span class="reserved">if</span>(S){c(k).style.visibility=j}<span class="reserved">else</span>{A(<span class="literal">"#"</span>+k,<span class="literal">"visibility:"</span>+j)}}<span class="reserved">return</span>{registerObject:<span class="reserved">function</span>(l,i,k){<span class="reserved">if</span>(!a.w3cdom||!l||!i){<span class="reserved">return</span> }var j={};j.id=l;j.swfVersion=i;j.expressInstall=k?k:false;H[H.length]=j;X(l,false)},getObjectById:<span class="reserved">function</span>(l){var i=null;<span class="reserved">if</span>(a.w3cdom&amp;&amp;S){var j=c(l);<span class="reserved">if</span>(j){var k=j.getElementsByTagName(P)[0];<span class="reserved">if</span>(!k||(k&amp;&amp;typeof j.SetVariable!=Z)){i=j}<span class="reserved">else</span>{<span class="reserved">if</span>(typeof k.SetVariable!=Z){i=k}}}}<span class="reserved">return</span> i},embedSWF:<span class="reserved">function</span>(n,u,r,t,j,m,k,p,s){<span class="reserved">if</span>(!a.w3cdom||!n||!u||!r||!t||!j){<span class="reserved">return</span> }r+=<span class="literal">""</span>;t+=<span class="literal">""</span>;<span class="reserved">if</span>(O(j)){X(u,false);var q=(typeof s==P)?s:{};q.data=n;q.width=r;q.height=t;var o=(typeof p==P)?p:{};<span class="reserved">if</span>(typeof k==P){<span class="reserved">for</span>(var l in k){<span class="reserved">if</span>(k[l]!=Object.<span class="reserved">prototype</span>[l]){<span class="reserved">if</span>(typeof o.flashvars!=Z){o.flashvars+=<span class="literal">"&amp;"</span>+l+<span class="literal">"="</span>+k[l]}<span class="reserved">else</span>{o.flashvars=l+<span class="literal">"="</span>+k[l]}}}}J(<span class="reserved">function</span>(){R(q,o,u);<span class="reserved">if</span>(q.id==u){X(u,true)}})}<span class="reserved">else</span>{<span class="reserved">if</span>(m&amp;&amp;!C&amp;&amp;O(<span class="literal">"6.0.65"</span>)&amp;&amp;(a.win||a.mac)){X(u,false);J(<span class="reserved">function</span>(){var i={};i.id=i.altContentId=u;i.width=r;i.height=t;i.expressInstall=m;D(i)})}}},getFlashPlayerVersion:<span class="reserved">function</span>(){<span class="reserved">return</span>{major:a.pv[0],minor:a.pv[1],release:a.pv[2]}},hasFlashPlayerVersion:O,createSWF:<span class="reserved">function</span>(k,j,i){<span class="reserved">if</span>(a.w3cdom&amp;&amp;S){<span class="reserved">return</span> R(k,j,i)}<span class="reserved">else</span>{<span class="reserved">return</span> undefined}},createCSS:<span class="reserved">function</span>(j,i){<span class="reserved">if</span>(a.w3cdom){A(j,i)}},addDomLoadEvent:J,addLoadEvent:M,getQueryParamValue:<span class="reserved">function</span>(m){var l=g.location.search||g.location.hash;<span class="reserved">if</span>(m==null){<span class="reserved">return</span> l}<span class="reserved">if</span>(l){var k=l.substring(1).split(<span class="literal">"&amp;"</span>);<span class="reserved">for</span>(var j=0;j&lt;k.length;j++){<span class="reserved">if</span>(k[j].substring(0,k[j].indexOf(<span class="literal">"="</span>))==m){<span class="reserved">return</span> k[j].substring((k[j].indexOf(<span class="literal">"="</span>)+1))}}}<span class="reserved">return</span><span class="literal">""</span>},expressInstallCallback:<span class="reserved">function</span>(){<span class="reserved">if</span>(C&amp;&amp;L){var i=c(K);<span class="reserved">if</span>(i){i.parentNode.replaceChild(L,i);<span class="reserved">if</span>(T){X(T,true);<span class="reserved">if</span>(a.ie&amp;&amp;a.win){L.style.display=<span class="literal">"block"</span>}}L=null;T=null;C=false}}}}}();<span class="comment">/**
 * SWFUpload: http://www.swfupload.org, http://swfupload.googlecode.com
 *
 * mmSWFUpload 1.0: Flash upload dialog - http://profandesign.se/swfupload/,  http://www.vinterwebb.se/
 *
 * SWFUpload is (c) 2006-2007 Lars Huring, Olov Nilzn and Mammon Media and is released under the MIT License:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * SWFUpload 2 is (c) 2007-2008 Jake Roberts and is released under the MIT License:
 * http://www.opensource.org/licenses/mit-license.php
 *
 */</span>


<span class="comment">/* ******************* */</span>
<span class="comment">/* Constructor &amp; Init  */</span>
<span class="comment">/* ******************* */</span>

var SWFUpload = <span class="reserved">function</span> (settings) {
	<span class="reserved">this</span>.initSWFUpload(settings);
};

SWFUpload.<span class="reserved">prototype</span>.initSWFUpload = <span class="reserved">function</span> (settings) {
	try {
		<span class="reserved">this</span>.customSettings = {};	<span class="comment">// A container where developers can place their own settings associated with this instance.</span>
		<span class="reserved">this</span>.settings = settings;
		<span class="reserved">this</span>.eventQueue = [];
		<span class="reserved">this</span>.movieName = <span class="literal">"SWFUpload_"</span> + SWFUpload.movieCount++;
		<span class="reserved">this</span>.movieElement = null;

		<span class="comment">// Setup global control tracking</span>
		SWFUpload.instances[<span class="reserved">this</span>.movieName] = <span class="reserved">this</span>;

		<span class="comment">// Load the settings.  Load the Flash movie.</span>
		<span class="reserved">this</span>.initSettings();
		<span class="reserved">this</span>.loadFlash();
		<span class="reserved">this</span>.displayDebugInfo();
	} catch (ex) {
		delete SWFUpload.instances[<span class="reserved">this</span>.movieName];
		throw ex;
	}
};

<span class="comment">/* *************** */</span>
<span class="comment">/* Static Members  */</span>
<span class="comment">/* *************** */</span>
SWFUpload.instances = {};
SWFUpload.movieCount = 0;
SWFUpload.version = <span class="literal">"2.2.0 Alpha"</span>;
SWFUpload.QUEUE_ERROR = {
	QUEUE_LIMIT_EXCEEDED	  		: -100,
	FILE_EXCEEDS_SIZE_LIMIT  		: -110,
	ZERO_BYTE_FILE			  		: -120,
	INVALID_FILETYPE		  		: -130
};
SWFUpload.UPLOAD_ERROR = {
	HTTP_ERROR				  		: -200,
	MISSING_UPLOAD_URL	      		: -210,
	IO_ERROR				  		: -220,
	SECURITY_ERROR			  		: -230,
	UPLOAD_LIMIT_EXCEEDED	  		: -240,
	UPLOAD_FAILED			  		: -250,
	SPECIFIED_FILE_ID_NOT_FOUND		: -260,
	FILE_VALIDATION_FAILED	  		: -270,
	FILE_CANCELLED			  		: -280,
	UPLOAD_STOPPED					: -290
};
SWFUpload.FILE_STATUS = {
	QUEUED		 : -1,
	IN_PROGRESS	 : -2,
	ERROR		 : -3,
	COMPLETE	 : -4,
	CANCELLED	 : -5
};
SWFUpload.BUTTON_ACTION = {
	SELECT_FILE  : -100,
	SELECT_FILES : -110,
	START_UPLOAD : -120
};

<span class="comment">/* ******************** */</span>
<span class="comment">/* Instance Members  */</span>
<span class="comment">/* ******************** */</span>

<span class="comment">// Private: initSettings ensures that all the</span>
<span class="comment">// settings are set, getting a default value if one was not assigned.</span>
SWFUpload.<span class="reserved">prototype</span>.initSettings = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.ensureDefault = <span class="reserved">function</span> (settingName, defaultValue) {
		<span class="reserved">this</span>.settings[settingName] = (<span class="reserved">this</span>.settings[settingName] == undefined) ? defaultValue : <span class="reserved">this</span>.settings[settingName];
	};
	
	<span class="comment">// Upload backend settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_url"</span>, <span class="literal">""</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_post_name"</span>, <span class="literal">"Filedata"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"post_params"</span>, {});
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"use_query_string"</span>, false);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"requeue_on_error"</span>, false);
	
	<span class="comment">// File Settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_types"</span>, <span class="literal">"*.*"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_types_description"</span>, <span class="literal">"All Files"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_size_limit"</span>, 0);	<span class="comment">// Default zero means "unlimited"</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_upload_limit"</span>, 0);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_queue_limit"</span>, 0);

	<span class="comment">// Flash Settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"flash_url"</span>, <span class="literal">"swfupload.swf"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"prevent_swf_caching"</span>, true);
	
	<span class="comment">// Button Settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_image_url"</span>, <span class="literal">""</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_width"</span>, 1);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_height"</span>, 1);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_text"</span>, <span class="literal">""</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_text_style"</span>, <span class="literal">"color: #000000; font-size: 16pt;"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_text_top_padding"</span>, 0);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_text_left_padding"</span>, 0);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_action"</span>, SWFUpload.BUTTON_ACTION.SELECT_FILES);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_disabled"</span>, false);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"button_placeholder_id"</span>, null);
	
	<span class="comment">// Debug Settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"debug"</span>, false);
	<span class="reserved">this</span>.settings.debug_enabled = <span class="reserved">this</span>.settings.debug;	<span class="comment">// Here to maintain v2 API</span>
	
	<span class="comment">// Event Handlers</span>
	<span class="reserved">this</span>.settings.return_upload_start_handler = <span class="reserved">this</span>.returnUploadStart;
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"swfupload_loaded_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_dialog_start_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_queued_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_queue_error_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_dialog_complete_handler"</span>, null);
	
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_start_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_progress_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_error_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_success_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_complete_handler"</span>, null);
	
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"debug_handler"</span>, <span class="reserved">function</span>(msg) {n2i.log(msg)});

	<span class="reserved">this</span>.ensureDefault(<span class="literal">"custom_settings"</span>, {});

	<span class="comment">// Other settings</span>
	<span class="reserved">this</span>.customSettings = <span class="reserved">this</span>.settings.custom_settings;
	
	<span class="comment">// Update the flash url if needed</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.settings.prevent_swf_caching) {
		<span class="reserved">this</span>.settings.flash_url = <span class="reserved">this</span>.settings.flash_url + <span class="literal">"?swfuploadrnd="</span> + Math.floor(Math.random() * 999999999);
	}
	
	delete <span class="reserved">this</span>.ensureDefault;
};

SWFUpload.<span class="reserved">prototype</span>.loadFlash = <span class="reserved">function</span> () {
	<span class="reserved">if</span> (<span class="reserved">this</span>.settings.button_placeholder_id !== <span class="literal">""</span>) {
		<span class="reserved">this</span>.replaceWithFlash();
	} <span class="reserved">else</span> {
		<span class="reserved">this</span>.appendFlash();
	}
};

<span class="comment">// Private: appendFlash gets the HTML tag for the Flash</span>
<span class="comment">// It then appends the flash to the body</span>
SWFUpload.<span class="reserved">prototype</span>.appendFlash = <span class="reserved">function</span> () {
	var targetElement, container;

	<span class="comment">// Make sure an element with the ID we are going to use doesn't already exist</span>
	<span class="reserved">if</span> (document.getElementById(<span class="reserved">this</span>.movieName) !== null) {
		throw <span class="literal">"ID "</span> + <span class="reserved">this</span>.movieName + <span class="literal">" is already in use. The Flash Object could not be added"</span>;
	}

	<span class="comment">// Get the body tag where we will be adding the flash movie</span>
	targetElement = document.getElementsByTagName(<span class="literal">"body"</span>)[0];

	<span class="reserved">if</span> (targetElement == undefined) {
		throw <span class="literal">"Could not find the 'body' element."</span>;
	}

	<span class="comment">// Append the container and load the flash</span>
	container = document.createElement(<span class="literal">"div"</span>);
	container.style.width = <span class="literal">"1px"</span>;
	container.style.height = <span class="literal">"1px"</span>;
	container.style.overflow = <span class="literal">"hidden"</span>;

	targetElement.appendChild(container);
	container.innerHTML = <span class="reserved">this</span>.getFlashHTML();	<span class="comment">// Using innerHTML is non-standard but the only sensible way to dynamically add Flash in IE (and maybe other browsers)</span>
};

<span class="comment">// Private: replaceWithFlash replaces the button_placeholder element with the flash movie.</span>
SWFUpload.<span class="reserved">prototype</span>.replaceWithFlash = <span class="reserved">function</span> () {
	var targetElement, tempParent;

	<span class="comment">// Make sure an element with the ID we are going to use doesn't already exist</span>
	<span class="reserved">if</span> (document.getElementById(<span class="reserved">this</span>.movieName) !== null) {
		throw <span class="literal">"ID "</span> + <span class="reserved">this</span>.movieName + <span class="literal">" is already in use. The Flash Object could not be added"</span>;
	}
	<span class="comment">// Get the element where we will be placing the flash movie</span>
	targetElement = <span class="reserved">this</span>.settings.button_placeholder || document.getElementById(<span class="reserved">this</span>.settings.button_placeholder_id);

	<span class="reserved">if</span> (targetElement == undefined) {
		throw <span class="literal">"Could not find the placeholder element."</span>;
	}

	<span class="comment">// Append the container and load the flash</span>
	tempParent = document.createElement(<span class="literal">"div"</span>);
	tempParent.innerHTML = <span class="reserved">this</span>.getFlashHTML();	<span class="comment">// Using innerHTML is non-standard but the only sensible way to dynamically add Flash in IE (and maybe other browsers)</span>
	targetElement.parentNode.replaceChild(tempParent.firstChild, targetElement);
};

<span class="comment">// Private: getFlashHTML generates the object tag needed to embed the flash in to the document</span>
SWFUpload.<span class="reserved">prototype</span>.getFlashHTML = <span class="reserved">function</span> () {
	var transparent = <span class="reserved">this</span>.settings.button_image_url === <span class="literal">""</span> ? true : false;
	
	<span class="comment">// Flash Satay object syntax: http://www.alistapart.com/articles/flashsatay</span>
	<span class="reserved">return</span> [<span class="literal">'&lt;object id="'</span>, <span class="reserved">this</span>.movieName, <span class="literal">'" type="application/x-shockwave-flash" data="'</span>, <span class="reserved">this</span>.settings.flash_url, <span class="literal">'" width="'</span>, <span class="reserved">this</span>.settings.button_width, <span class="literal">'" height="'</span>, <span class="reserved">this</span>.settings.button_height, <span class="literal">'" class="swfupload"&gt;'</span>,
				<span class="literal">'&lt;param name="wmode" value="'</span>, transparent ? <span class="literal">"transparent"</span> : <span class="literal">"window"</span>, <span class="literal">'" /&gt;'</span>,
				<span class="literal">'&lt;param name="movie" value="'</span>, <span class="reserved">this</span>.settings.flash_url, <span class="literal">'" /&gt;'</span>,
				<span class="literal">'&lt;param name="quality" value="high" /&gt;'</span>,
				<span class="literal">'&lt;param name="menu" value="false" /&gt;'</span>,
				<span class="literal">'&lt;param name="allowScriptAccess" value="always" /&gt;'</span>,
				<span class="literal">'&lt;param name="flashvars" value="'</span> + <span class="reserved">this</span>.getFlashVars() + <span class="literal">'" /&gt;'</span>,
				<span class="literal">'&lt;/object&gt;'</span>].join(<span class="literal">""</span>);
};

<span class="comment">// Private: getFlashVars builds the parameter string that will be passed</span>
<span class="comment">// to flash in the flashvars param.</span>
SWFUpload.<span class="reserved">prototype</span>.getFlashVars = <span class="reserved">function</span> () {
	<span class="comment">// Build a string from the post param object</span>
	var paramString = <span class="reserved">this</span>.buildParamString();

	<span class="comment">// Build the parameter string</span>
	<span class="reserved">return</span> [<span class="literal">"movieName="</span>, encodeURIComponent(<span class="reserved">this</span>.movieName),
			<span class="literal">"&amp;amp;uploadURL="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.upload_url),
			<span class="literal">"&amp;amp;useQueryString="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.use_query_string),
			<span class="literal">"&amp;amp;requeueOnError="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.requeue_on_error),
			<span class="literal">"&amp;amp;params="</span>, encodeURIComponent(paramString),
			<span class="literal">"&amp;amp;filePostName="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_post_name),
			<span class="literal">"&amp;amp;fileTypes="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_types),
			<span class="literal">"&amp;amp;fileTypesDescription="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_types_description),
			<span class="literal">"&amp;amp;fileSizeLimit="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_size_limit),
			<span class="literal">"&amp;amp;fileUploadLimit="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_upload_limit),
			<span class="literal">"&amp;amp;fileQueueLimit="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_queue_limit),
			<span class="literal">"&amp;amp;debugEnabled="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.debug_enabled),
			<span class="literal">"&amp;amp;buttonImageURL="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_image_url),
			<span class="literal">"&amp;amp;buttonWidth="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_width),
			<span class="literal">"&amp;amp;buttonHeight="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_height),
			<span class="literal">"&amp;amp;buttonText="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_text),
			<span class="literal">"&amp;amp;buttonTextTopPadding="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_text_top_padding),
			<span class="literal">"&amp;amp;buttonTextLeftPadding="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_text_left_padding),
			<span class="literal">"&amp;amp;buttonTextStyle="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_text_style),
			<span class="literal">"&amp;amp;buttonAction="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_action),
			<span class="literal">"&amp;amp;buttonDisabled="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.button_disabled)
		].join(<span class="literal">""</span>);
};

<span class="comment">// Public: getMovieElement retrieves the DOM reference to the Flash element added by SWFUpload</span>
<span class="comment">// The element is cached after the first lookup</span>
SWFUpload.<span class="reserved">prototype</span>.getMovieElement = <span class="reserved">function</span> () {
	<span class="reserved">if</span> (<span class="reserved">this</span>.movieElement == undefined) {
		<span class="reserved">this</span>.movieElement = document.getElementById(<span class="reserved">this</span>.movieName);
	}

	<span class="reserved">if</span> (<span class="reserved">this</span>.movieElement === null) {
		throw <span class="literal">"Could not find Flash element"</span>;
	}
	
	<span class="reserved">return</span> <span class="reserved">this</span>.movieElement;
};

<span class="comment">// Private: buildParamString takes the name/value pairs in the post_params setting object</span>
<span class="comment">// and joins them up in to a string formatted "name=value&amp;amp;name=value"</span>
SWFUpload.<span class="reserved">prototype</span>.buildParamString = <span class="reserved">function</span> () {
	var postParams = <span class="reserved">this</span>.settings.post_params; 
	var paramStringPairs = [];

	<span class="reserved">if</span> (typeof(postParams) === <span class="literal">"object"</span>) {
		<span class="reserved">for</span> (var name in postParams) {
			<span class="reserved">if</span> (postParams.hasOwnProperty(name)) {
				paramStringPairs.push(encodeURIComponent(name.toString()) + <span class="literal">"="</span> + encodeURIComponent(postParams[name].toString()));
			}
		}
	}

	<span class="reserved">return</span> paramStringPairs.join(<span class="literal">"&amp;amp;"</span>);
};

<span class="comment">// Public: Used to remove a SWFUpload instance from the page. This method strives to remove</span>
<span class="comment">// all references to the SWF, and other objects so memory is properly freed.</span>
<span class="comment">// Returns true if everything was destroyed. Returns a false if a failure occurs leaving SWFUpload in an inconsistant state.</span>
SWFUpload.<span class="reserved">prototype</span>.destroy = <span class="reserved">function</span> () {
	try {
		<span class="comment">// Make sure Flash is done before we try to remove it</span>
		<span class="reserved">this</span>.stopUpload();
		
		<span class="comment">// Remove the SWFUpload DOM nodes</span>
		var movieElement = null;
		try {
			movieElement = <span class="reserved">this</span>.getMovieElement();
		} catch (ex) {
		}
		
		<span class="reserved">if</span> (movieElement != undefined &amp;&amp; movieElement.parentNode != undefined &amp;&amp; typeof movieElement.parentNode.removeChild === <span class="literal">"function"</span>) {
			var container = movieElement.parentNode;
			<span class="reserved">if</span> (container != undefined) {
				container.removeChild(movieElement);
				<span class="reserved">if</span> (container.parentNode != undefined &amp;&amp; typeof container.parentNode.removeChild === <span class="literal">"function"</span>) {
					container.parentNode.removeChild(container);
				}
			}
		}
		
		<span class="comment">// Destroy references</span>
		SWFUpload.instances[<span class="reserved">this</span>.movieName] = null;
		delete SWFUpload.instances[<span class="reserved">this</span>.movieName];

		delete <span class="reserved">this</span>.movieElement;
		delete <span class="reserved">this</span>.settings;
		delete <span class="reserved">this</span>.customSettings;
		delete <span class="reserved">this</span>.eventQueue;
		delete <span class="reserved">this</span>.movieName;
		
		delete window[<span class="reserved">this</span>.movieName];
		
		<span class="reserved">return</span> true;
	} catch (ex1) {
		<span class="reserved">return</span> false;
	}
};

<span class="comment">// Public: displayDebugInfo prints out settings and configuration</span>
<span class="comment">// information about this SWFUpload instance.</span>
<span class="comment">// This function (and any references to it) can be deleted when placing</span>
<span class="comment">// SWFUpload in production.</span>
SWFUpload.<span class="reserved">prototype</span>.displayDebugInfo = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.debug(
		[
			<span class="literal">"---SWFUpload Instance Info---\n"</span>,
			<span class="literal">"Version: "</span>, SWFUpload.version, <span class="literal">"\n"</span>,
			<span class="literal">"Movie Name: "</span>, <span class="reserved">this</span>.movieName, <span class="literal">"\n"</span>,
			<span class="literal">"Settings:\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_url:               "</span>, <span class="reserved">this</span>.settings.upload_url, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"flash_url:                "</span>, <span class="reserved">this</span>.settings.flash_url, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"use_query_string:         "</span>, <span class="reserved">this</span>.settings.use_query_string.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_post_name:           "</span>, <span class="reserved">this</span>.settings.file_post_name, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"post_params:              "</span>, <span class="reserved">this</span>.settings.post_params.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_types:               "</span>, <span class="reserved">this</span>.settings.file_types, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_types_description:   "</span>, <span class="reserved">this</span>.settings.file_types_description, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_size_limit:          "</span>, <span class="reserved">this</span>.settings.file_size_limit, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_upload_limit:        "</span>, <span class="reserved">this</span>.settings.file_upload_limit, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_queue_limit:         "</span>, <span class="reserved">this</span>.settings.file_queue_limit, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"debug:                    "</span>, <span class="reserved">this</span>.settings.debug.toString(), <span class="literal">"\n"</span>,

			<span class="literal">"\t"</span>, <span class="literal">"prevent_swf_caching:      "</span>, <span class="reserved">this</span>.settings.prevent_swf_caching.toString(), <span class="literal">"\n"</span>,

			<span class="literal">"\t"</span>, <span class="literal">"button_placeholder_id:    "</span>, <span class="reserved">this</span>.settings.button_placeholder_id.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_image_url:         "</span>, <span class="reserved">this</span>.settings.button_image_url.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_width:             "</span>, <span class="reserved">this</span>.settings.button_width.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_height:            "</span>, <span class="reserved">this</span>.settings.button_height.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_text:              "</span>, <span class="reserved">this</span>.settings.button_text.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_text_style:        "</span>, <span class="reserved">this</span>.settings.button_text_style.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_text_top_padding:  "</span>, <span class="reserved">this</span>.settings.button_text_top_padding.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_text_left_padding: "</span>, <span class="reserved">this</span>.settings.button_text_left_padding.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_action:            "</span>, <span class="reserved">this</span>.settings.button_action.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"button_disabled:          "</span>, <span class="reserved">this</span>.settings.button_disabled.toString(), <span class="literal">"\n"</span>,

			<span class="literal">"\t"</span>, <span class="literal">"custom_settings:          "</span>, <span class="reserved">this</span>.settings.custom_settings.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"Event Handlers:\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"swfupload_loaded_handler assigned:  "</span>, (typeof <span class="reserved">this</span>.settings.swfupload_loaded_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_dialog_start_handler assigned: "</span>, (typeof <span class="reserved">this</span>.settings.file_dialog_start_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_queued_handler assigned:       "</span>, (typeof <span class="reserved">this</span>.settings.file_queued_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_queue_error_handler assigned:  "</span>, (typeof <span class="reserved">this</span>.settings.file_queue_error_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_start_handler assigned:      "</span>, (typeof <span class="reserved">this</span>.settings.upload_start_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_progress_handler assigned:   "</span>, (typeof <span class="reserved">this</span>.settings.upload_progress_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_error_handler assigned:      "</span>, (typeof <span class="reserved">this</span>.settings.upload_error_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_success_handler assigned:    "</span>, (typeof <span class="reserved">this</span>.settings.upload_success_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_complete_handler assigned:   "</span>, (typeof <span class="reserved">this</span>.settings.upload_complete_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"debug_handler assigned:             "</span>, (typeof <span class="reserved">this</span>.settings.debug_handler === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>
		].join(<span class="literal">""</span>)
	);
};

<span class="comment">/* Note: addSetting and getSetting are no longer used by SWFUpload but are included
	the maintain v2 API compatibility
*/</span>
<span class="comment">// Public: (Deprecated) addSetting adds a setting value. If the value given is undefined or null then the default_value is used.</span>
SWFUpload.<span class="reserved">prototype</span>.addSetting = <span class="reserved">function</span> (name, value, default_value) {
    <span class="reserved">if</span> (value == undefined) {
        <span class="reserved">return</span> (<span class="reserved">this</span>.settings[name] = default_value);
    } <span class="reserved">else</span> {
        <span class="reserved">return</span> (<span class="reserved">this</span>.settings[name] = value);
	}
};

<span class="comment">// Public: (Deprecated) getSetting gets a setting. Returns an empty string if the setting was not found.</span>
SWFUpload.<span class="reserved">prototype</span>.getSetting = <span class="reserved">function</span> (name) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.settings[name] != undefined) {
        <span class="reserved">return</span> <span class="reserved">this</span>.settings[name];
	}

    <span class="reserved">return</span> <span class="literal">""</span>;
};



<span class="comment">// Private: callFlash handles function calls made to the Flash element.</span>
<span class="comment">// Calls are made with a setTimeout for some functions to work around</span>
<span class="comment">// bugs in the ExternalInterface library.</span>
SWFUpload.<span class="reserved">prototype</span>.callFlash = <span class="reserved">function</span> (functionName, argumentArray) {
	argumentArray = argumentArray || [];
	
	var movieElement = <span class="reserved">this</span>.getMovieElement();
	var returnValue;

	<span class="reserved">if</span> (typeof movieElement[functionName] === <span class="literal">"function"</span>) {
		<span class="comment">// We have to go through all this if/else stuff because the Flash functions don't have apply() and only accept the exact number of arguments.</span>
		<span class="reserved">if</span> (argumentArray.length === 0) {
			returnValue = movieElement[functionName]();
		} <span class="reserved">else</span> <span class="reserved">if</span> (argumentArray.length === 1) {
			returnValue = movieElement[functionName](argumentArray[0]);
		} <span class="reserved">else</span> <span class="reserved">if</span> (argumentArray.length === 2) {
			returnValue = movieElement[functionName](argumentArray[0], argumentArray[1]);
		} <span class="reserved">else</span> <span class="reserved">if</span> (argumentArray.length === 3) {
			returnValue = movieElement[functionName](argumentArray[0], argumentArray[1], argumentArray[2]);
		} <span class="reserved">else</span> {
			throw <span class="literal">"Too many arguments"</span>;
		}
		
		<span class="comment">// Unescape file post param values</span>
		<span class="reserved">if</span> (returnValue != undefined &amp;&amp; typeof returnValue.post === <span class="literal">"object"</span>) {
			returnValue = <span class="reserved">this</span>.unescapeFilePostParams(returnValue);
		}
		
		<span class="reserved">return</span> returnValue;
	} <span class="reserved">else</span> {
		throw <span class="literal">"Invalid function name: "</span> + functionName;
	}
};


<span class="comment">/* *****************************
	-- Flash control methods --
	Your UI should use these
	to operate SWFUpload
   ***************************** */</span>

<span class="comment">// Public: selectFile causes a File Selection Dialog window to appear.  This</span>
<span class="comment">// dialog only allows 1 file to be selected. WARNING: this function does not work in Flash Player 10</span>
SWFUpload.<span class="reserved">prototype</span>.selectFile = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.callFlash(<span class="literal">"SelectFile"</span>);
};

<span class="comment">// Public: selectFiles causes a File Selection Dialog window to appear/ This</span>
<span class="comment">// dialog allows the user to select any number of files</span>
<span class="comment">// Flash Bug Warning: Flash limits the number of selectable files based on the combined length of the file names.</span>
<span class="comment">// If the selection name length is too long the dialog will fail in an unpredictable manner.  There is no work-around</span>
<span class="comment">// for this bug.  WARNING: this function does not work in Flash Player 10</span>
SWFUpload.<span class="reserved">prototype</span>.selectFiles = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.callFlash(<span class="literal">"SelectFiles"</span>);
};


<span class="comment">// Public: startUpload starts uploading the first file in the queue unless</span>
<span class="comment">// the optional parameter 'fileID' specifies the ID </span>
SWFUpload.<span class="reserved">prototype</span>.startUpload = <span class="reserved">function</span> (fileID) {
	<span class="reserved">this</span>.callFlash(<span class="literal">"StartUpload"</span>, [fileID]);
};

<span class="comment">/* Cancels a the file upload.  You must specify a file_id */</span>
<span class="comment">// Public: cancelUpload cancels any queued file.  The fileID parameter</span>
<span class="comment">// must be specified.</span>
SWFUpload.<span class="reserved">prototype</span>.cancelUpload = <span class="reserved">function</span> (fileID) {
	<span class="reserved">this</span>.callFlash(<span class="literal">"CancelUpload"</span>, [fileID]);
};

<span class="comment">// Public: stopUpload stops the current upload and requeues the file at the beginning of the queue.</span>
<span class="comment">// If nothing is currently uploading then nothing happens.</span>
SWFUpload.<span class="reserved">prototype</span>.stopUpload = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.callFlash(<span class="literal">"StopUpload"</span>);
};

<span class="comment">/* ************************
 * Settings methods
 *   These methods change the SWFUpload settings.
 *   SWFUpload settings should not be changed directly on the settings object
 *   since many of the settings need to be passed to Flash in order to take
 *   effect.
 * *********************** */</span>

<span class="comment">// Public: getStats gets the file statistics object.</span>
SWFUpload.<span class="reserved">prototype</span>.getStats = <span class="reserved">function</span> () {
	<span class="reserved">return</span> <span class="reserved">this</span>.callFlash(<span class="literal">"GetStats"</span>);
};

<span class="comment">// Public: setStats changes the SWFUpload statistics.  You shouldn't need to </span>
<span class="comment">// change the statistics but you can.  Changing the statistics does not</span>
<span class="comment">// affect SWFUpload accept for the successful_uploads count which is used</span>
<span class="comment">// by the upload_limit setting to determine how many files the user may upload.</span>
SWFUpload.<span class="reserved">prototype</span>.setStats = <span class="reserved">function</span> (statsObject) {
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetStats"</span>, [statsObject]);
};

<span class="comment">// Public: getFile retrieves a File object by ID or Index.  If the file is</span>
<span class="comment">// not found then 'null' is returned.</span>
SWFUpload.<span class="reserved">prototype</span>.getFile = <span class="reserved">function</span> (fileID) {
	<span class="reserved">if</span> (typeof(fileID) === <span class="literal">"number"</span>) {
		<span class="reserved">return</span> <span class="reserved">this</span>.callFlash(<span class="literal">"GetFileByIndex"</span>, [fileID]);
	} <span class="reserved">else</span> {
		<span class="reserved">return</span> <span class="reserved">this</span>.callFlash(<span class="literal">"GetFile"</span>, [fileID]);
	}
};

<span class="comment">// Public: addFileParam sets a name/value pair that will be posted with the</span>
<span class="comment">// file specified by the Files ID.  If the name already exists then the</span>
<span class="comment">// exiting value will be overwritten.</span>
SWFUpload.<span class="reserved">prototype</span>.addFileParam = <span class="reserved">function</span> (fileID, name, value) {
	<span class="reserved">return</span> <span class="reserved">this</span>.callFlash(<span class="literal">"AddFileParam"</span>, [fileID, name, value]);
};

<span class="comment">// Public: removeFileParam removes a previously set (by addFileParam) name/value</span>
<span class="comment">// pair from the specified file.</span>
SWFUpload.<span class="reserved">prototype</span>.removeFileParam = <span class="reserved">function</span> (fileID, name) {
	<span class="reserved">this</span>.callFlash(<span class="literal">"RemoveFileParam"</span>, [fileID, name]);
};

<span class="comment">// Public: setUploadUrl changes the upload_url setting.</span>
SWFUpload.<span class="reserved">prototype</span>.setUploadURL = <span class="reserved">function</span> (url) {
	<span class="reserved">this</span>.settings.upload_url = url.toString();
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetUploadURL"</span>, [url]);
};

<span class="comment">// Public: setPostParams changes the post_params setting</span>
SWFUpload.<span class="reserved">prototype</span>.setPostParams = <span class="reserved">function</span> (paramsObject) {
	<span class="reserved">this</span>.settings.post_params = paramsObject;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetPostParams"</span>, [paramsObject]);
};

<span class="comment">// Public: addPostParam adds post name/value pair.  Each name can have only one value.</span>
SWFUpload.<span class="reserved">prototype</span>.addPostParam = <span class="reserved">function</span> (name, value) {
	<span class="reserved">this</span>.settings.post_params[name] = value;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetPostParams"</span>, [<span class="reserved">this</span>.settings.post_params]);
};

<span class="comment">// Public: removePostParam deletes post name/value pair.</span>
SWFUpload.<span class="reserved">prototype</span>.removePostParam = <span class="reserved">function</span> (name) {
	delete <span class="reserved">this</span>.settings.post_params[name];
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetPostParams"</span>, [<span class="reserved">this</span>.settings.post_params]);
};

<span class="comment">// Public: setFileTypes changes the file_types setting and the file_types_description setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFileTypes = <span class="reserved">function</span> (types, description) {
	<span class="reserved">this</span>.settings.file_types = types;
	<span class="reserved">this</span>.settings.file_types_description = description;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFileTypes"</span>, [types, description]);
};

<span class="comment">// Public: setFileSizeLimit changes the file_size_limit setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFileSizeLimit = <span class="reserved">function</span> (fileSizeLimit) {
	<span class="reserved">this</span>.settings.file_size_limit = fileSizeLimit;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFileSizeLimit"</span>, [fileSizeLimit]);
};

<span class="comment">// Public: setFileUploadLimit changes the file_upload_limit setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFileUploadLimit = <span class="reserved">function</span> (fileUploadLimit) {
	<span class="reserved">this</span>.settings.file_upload_limit = fileUploadLimit;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFileUploadLimit"</span>, [fileUploadLimit]);
};

<span class="comment">// Public: setFileQueueLimit changes the file_queue_limit setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFileQueueLimit = <span class="reserved">function</span> (fileQueueLimit) {
	<span class="reserved">this</span>.settings.file_queue_limit = fileQueueLimit;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFileQueueLimit"</span>, [fileQueueLimit]);
};

<span class="comment">// Public: setFilePostName changes the file_post_name setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFilePostName = <span class="reserved">function</span> (filePostName) {
	<span class="reserved">this</span>.settings.file_post_name = filePostName;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFilePostName"</span>, [filePostName]);
};

<span class="comment">// Public: setUseQueryString changes the use_query_string setting</span>
SWFUpload.<span class="reserved">prototype</span>.setUseQueryString = <span class="reserved">function</span> (useQueryString) {
	<span class="reserved">this</span>.settings.use_query_string = useQueryString;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetUseQueryString"</span>, [useQueryString]);
};

<span class="comment">// Public: setRequeueOnError changes the requeue_on_error setting</span>
SWFUpload.<span class="reserved">prototype</span>.setRequeueOnError = <span class="reserved">function</span> (requeueOnError) {
	<span class="reserved">this</span>.settings.requeue_on_error = requeueOnError;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetRequeueOnError"</span>, [requeueOnError]);
};

<span class="comment">// Public: setDebugEnabled changes the debug_enabled setting</span>
SWFUpload.<span class="reserved">prototype</span>.setDebugEnabled = <span class="reserved">function</span> (debugEnabled) {
	<span class="reserved">this</span>.settings.debug_enabled = debugEnabled;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetDebugEnabled"</span>, [debugEnabled]);
};

<span class="comment">// Public: setButtonImageURL loads a button image sprite</span>
SWFUpload.<span class="reserved">prototype</span>.setButtonImageURL = <span class="reserved">function</span> (buttonImageURL) {
	<span class="reserved">if</span> (buttonImageURL == undefined) {
		buttonImageURL = <span class="literal">""</span>;
	}
	
	<span class="reserved">this</span>.settings.button_image_url = buttonImageURL;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetButtonImageURL"</span>, [buttonImageURL]);
};

<span class="comment">// Public: setButtonDimensions resizes the Flash Movie and button</span>
SWFUpload.<span class="reserved">prototype</span>.setButtonDimensions = <span class="reserved">function</span> (width, height) {
	<span class="reserved">this</span>.settings.button_width = width;
	<span class="reserved">this</span>.settings.button_height = height;
	
	var movie = <span class="reserved">this</span>.getMovieElement();
	<span class="reserved">if</span> (movie != undefined) {
		movie.style.width = width + <span class="literal">"px"</span>;
		movie.style.height = height + <span class="literal">"px"</span>;
	}
	
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetButtonDimensions"</span>, [width, height]);
};
<span class="comment">// Public: setButtonText Changes the text overlaid on the button</span>
SWFUpload.<span class="reserved">prototype</span>.setButtonText = <span class="reserved">function</span> (html) {
	<span class="reserved">this</span>.settings.button_text = html;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetButtonText"</span>, [html]);
};
<span class="comment">// Public: setButtonTextPadding changes the top and left padding of the text overlay</span>
SWFUpload.<span class="reserved">prototype</span>.setButtonTextPadding = <span class="reserved">function</span> (left, top) {
	<span class="reserved">this</span>.settings.button_text_top_padding = top;
	<span class="reserved">this</span>.settings.button_text_left_padding = left;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetButtonTextPadding"</span>, [left, top]);
};

<span class="comment">// Public: setButtonTextStyle changes the CSS used to style the HTML/Text overlaid on the button</span>
SWFUpload.<span class="reserved">prototype</span>.setButtonTextStyle = <span class="reserved">function</span> (css) {
	<span class="reserved">this</span>.settings.button_text_style = css;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetButtonTextStyle"</span>, [css]);
};
<span class="comment">// Public: setButtonDisabled disables/enables the button</span>
SWFUpload.<span class="reserved">prototype</span>.setButtonDisabled = <span class="reserved">function</span> (isDisabled) {
	<span class="reserved">this</span>.settings.button_disabled = isDisabled;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetButtonDisabled"</span>, [isDisabled]);
};
<span class="comment">// Public: setButtonAction sets the action that occurs when the button is clicked</span>
SWFUpload.<span class="reserved">prototype</span>.setButtonAction = <span class="reserved">function</span> (buttonAction) {
	<span class="reserved">this</span>.settings.button_action = buttonAction;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetButtonAction"</span>, [buttonAction]);
};

<span class="comment">/* *******************************
	Flash Event Interfaces
	These functions are used by Flash to trigger the various
	events.
	
	All these functions a Private.
	
	Because the ExternalInterface library is buggy the event calls
	are added to a queue and the queue then executed by a setTimeout.
	This ensures that events are executed in a determinate order and that
	the ExternalInterface bugs are avoided.
******************************* */</span>

SWFUpload.<span class="reserved">prototype</span>.queueEvent = <span class="reserved">function</span> (handlerName, argumentArray) {
	<span class="comment">// Warning: Don't call this.debug inside here or you'll create an infinite loop</span>
	
	<span class="reserved">if</span> (argumentArray == undefined) {
		argumentArray = [];
	} <span class="reserved">else</span> <span class="reserved">if</span> (!(argumentArray instanceof Array)) {
		argumentArray = [argumentArray];
	}
	
	var self = <span class="reserved">this</span>;
	<span class="reserved">if</span> (typeof <span class="reserved">this</span>.settings[handlerName] === <span class="literal">"function"</span>) {
		<span class="comment">// Queue the event</span>
		<span class="reserved">this</span>.eventQueue.push(<span class="reserved">function</span> () {
			<span class="reserved">this</span>.settings[handlerName].apply(<span class="reserved">this</span>, argumentArray);
		});
		
		<span class="comment">// Execute the next queued event</span>
		setTimeout(<span class="reserved">function</span> () {
			self.executeNextEvent();
		}, 0);
		
	} <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.settings[handlerName] !== null) {
		throw <span class="literal">"Event handler "</span> + handlerName + <span class="literal">" is unknown or is not a function"</span>;
	}
};

<span class="comment">// Private: Causes the next event in the queue to be executed.  Since events are queued using a setTimeout</span>
<span class="comment">// we must queue them in order to garentee that they are executed in order.</span>
SWFUpload.<span class="reserved">prototype</span>.executeNextEvent = <span class="reserved">function</span> () {
	<span class="comment">// Warning: Don't call this.debug inside here or you'll create an infinite loop</span>

	var  f = <span class="reserved">this</span>.eventQueue ? <span class="reserved">this</span>.eventQueue.shift() : null;
	<span class="reserved">if</span> (typeof(f) === <span class="literal">"function"</span>) {
		f.apply(<span class="reserved">this</span>);
	}
};

<span class="comment">// Private: unescapeFileParams is part of a workaround for a flash bug where objects passed through ExternalInterface cannot have</span>
<span class="comment">// properties that contain characters that are not valid for JavaScript identifiers. To work around this</span>
<span class="comment">// the Flash Component escapes the parameter names and we must unescape again before passing them along.</span>
SWFUpload.<span class="reserved">prototype</span>.unescapeFilePostParams = <span class="reserved">function</span> (file) {
	var reg = /[$]([0-9a-f]{4})/i;
	var unescapedPost = {};
	var uk;

	<span class="reserved">if</span> (file != undefined) {
		<span class="reserved">for</span> (var k in file.post) {
			<span class="reserved">if</span> (file.post.hasOwnProperty(k)) {
				uk = k;
				var match;
				<span class="reserved">while</span> ((match = reg.exec(uk)) !== null) {
					uk = uk.replace(match[0], String.fromCharCode(parseInt(<span class="literal">"0x"</span> + match[1], 16)));
				}
				unescapedPost[uk] = file.post[k];
			}
		}

		file.post = unescapedPost;
	}

	<span class="reserved">return</span> file;
};

SWFUpload.<span class="reserved">prototype</span>.flashReady = <span class="reserved">function</span> () {
	<span class="comment">// Check that the movie element is loaded correctly with its ExternalInterface methods defined</span>
	var movieElement = <span class="reserved">this</span>.getMovieElement();
	<span class="reserved">if</span> (typeof movieElement.StartUpload !== <span class="literal">"function"</span>) {
		throw <span class="literal">"ExternalInterface methods failed to initialize."</span>;
	}

	<span class="comment">// Fix IE Flash/Form bug</span>
	<span class="reserved">if</span> (window[<span class="reserved">this</span>.movieName] == undefined) {
		window[<span class="reserved">this</span>.movieName] = movieElement;
	}
	
	<span class="reserved">this</span>.queueEvent(<span class="literal">"swfupload_loaded_handler"</span>);
};


<span class="comment">/* This is a chance to do something before the browse window opens */</span>
SWFUpload.<span class="reserved">prototype</span>.fileDialogStart = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.queueEvent(<span class="literal">"file_dialog_start_handler"</span>);
};


<span class="comment">/* Called when a file is successfully added to the queue. */</span>
SWFUpload.<span class="reserved">prototype</span>.fileQueued = <span class="reserved">function</span> (file) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"file_queued_handler"</span>, file);
};


<span class="comment">/* Handle errors that occur when an attempt to queue a file fails. */</span>
SWFUpload.<span class="reserved">prototype</span>.fileQueueError = <span class="reserved">function</span> (file, errorCode, message) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"file_queue_error_handler"</span>, [file, errorCode, message]);
};

<span class="comment">/* Called after the file dialog has closed and the selected files have been queued.
	You could call startUpload here if you want the queued files to begin uploading immediately. */</span>
SWFUpload.<span class="reserved">prototype</span>.fileDialogComplete = <span class="reserved">function</span> (numFilesSelected, numFilesQueued) {
	<span class="reserved">this</span>.queueEvent(<span class="literal">"file_dialog_complete_handler"</span>, [numFilesSelected, numFilesQueued]);
};

SWFUpload.<span class="reserved">prototype</span>.uploadStart = <span class="reserved">function</span> (file) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"return_upload_start_handler"</span>, file);
};

SWFUpload.<span class="reserved">prototype</span>.returnUploadStart = <span class="reserved">function</span> (file) {
	var returnValue;
	<span class="reserved">if</span> (typeof <span class="reserved">this</span>.settings.upload_start_handler === <span class="literal">"function"</span>) {
		file = <span class="reserved">this</span>.unescapeFilePostParams(file);
		returnValue = <span class="reserved">this</span>.settings.upload_start_handler.call(<span class="reserved">this</span>, file);
	} <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.settings.upload_start_handler != undefined) {
		throw <span class="literal">"upload_start_handler must be a function"</span>;
	}

	<span class="comment">// Convert undefined to true so if nothing is returned from the upload_start_handler it is</span>
	<span class="comment">// interpretted as 'true'.</span>
	<span class="reserved">if</span> (returnValue === undefined) {
		returnValue = true;
	}
	
	returnValue = !!returnValue;
	
	<span class="reserved">this</span>.callFlash(<span class="literal">"ReturnUploadStart"</span>, [returnValue]);
};



SWFUpload.<span class="reserved">prototype</span>.uploadProgress = <span class="reserved">function</span> (file, bytesComplete, bytesTotal) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"upload_progress_handler"</span>, [file, bytesComplete, bytesTotal]);
};

SWFUpload.<span class="reserved">prototype</span>.uploadError = <span class="reserved">function</span> (file, errorCode, message) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"upload_error_handler"</span>, [file, errorCode, message]);
};

SWFUpload.<span class="reserved">prototype</span>.uploadSuccess = <span class="reserved">function</span> (file, serverData) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"upload_success_handler"</span>, [file, serverData]);
};

SWFUpload.<span class="reserved">prototype</span>.uploadComplete = <span class="reserved">function</span> (file) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"upload_complete_handler"</span>, file);
};

<span class="comment">/* Called by SWFUpload JavaScript and Flash functions when debug is enabled. By default it writes messages to the
   internal debug console.  You can override this event and have messages written where you want. */</span>
SWFUpload.<span class="reserved">prototype</span>.debug = <span class="reserved">function</span> (message) {
	n2i.log(message);
};
<span class="comment">/*
 * Copyright (C) 2004 Baron Schwartz &lt;baron at sequent dot org&gt;
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the
 * Free Software Foundation, version 2.1.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more
 * details.
 */</span>

Date.parseFunctions = {count:0};
Date.parseRegexes = [];
Date.formatFunctions = {count:0};

Date.<span class="reserved">prototype</span>.dateFormat = <span class="reserved">function</span>(format) {
    <span class="reserved">if</span> (Date.formatFunctions[format] == null) {
        Date.createNewFormat(format);
    }
    var func = Date.formatFunctions[format];
    <span class="reserved">return</span> <span class="reserved">this</span>[func]();
}

Date.createNewFormat = <span class="reserved">function</span>(format) {
    var funcName = <span class="literal">"format"</span> + Date.formatFunctions.count++;
    Date.formatFunctions[format] = funcName;
    var code = <span class="literal">"Date.prototype."</span> + funcName + <span class="literal">" = function(){return "</span>;
    var special = false;
    var ch = <span class="literal">''</span>;
    <span class="reserved">for</span> (var i = 0; i &lt; format.length; ++i) {
        ch = format.charAt(i);
        <span class="reserved">if</span> (!special &amp;&amp; ch == <span class="literal">"\\"</span>) {
            special = true;
        }
        <span class="reserved">else</span> <span class="reserved">if</span> (special) {
            special = false;
            code += <span class="literal">"'"</span> + String.escape(ch) + <span class="literal">"' + "</span>;
        }
        <span class="reserved">else</span> {
            code += Date.getFormatCode(ch);
        }
    }
    eval(code.substring(0, code.length - 3) + <span class="literal">";}"</span>);
}

Date.getFormatCode = <span class="reserved">function</span>(character) {
    switch (character) {
    case <span class="literal">"d"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getDate(), 2, '0') + "</span>;
    case <span class="literal">"D"</span>:
        <span class="reserved">return</span> <span class="literal">"Date.dayNames[this.getDay()].substring(0, 3) + "</span>;
    case <span class="literal">"j"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getDate() + "</span>;
    case <span class="literal">"l"</span>:
        <span class="reserved">return</span> <span class="literal">"Date.dayNames[this.getDay()] + "</span>;
    case <span class="literal">"S"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getSuffix() + "</span>;
    case <span class="literal">"w"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getDay() + "</span>;
    case <span class="literal">"z"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getDayOfYear() + "</span>;
    case <span class="literal">"W"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getWeekOfYear() + "</span>;
    case <span class="literal">"F"</span>:
        <span class="reserved">return</span> <span class="literal">"Date.monthNames[this.getMonth()] + "</span>;
    case <span class="literal">"m"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getMonth() + 1, 2, '0') + "</span>;
    case <span class="literal">"M"</span>:
        <span class="reserved">return</span> <span class="literal">"Date.monthNames[this.getMonth()].substring(0, 3) + "</span>;
    case <span class="literal">"n"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.getMonth() + 1) + "</span>;
    case <span class="literal">"t"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getDaysInMonth() + "</span>;
    case <span class="literal">"L"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.isLeapYear() ? 1 : 0) + "</span>;
    case <span class="literal">"Y"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getFullYear() + "</span>;
    case <span class="literal">"y"</span>:
        <span class="reserved">return</span> <span class="literal">"('' + this.getFullYear()).substring(2, 4) + "</span>;
    case <span class="literal">"a"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.getHours() &lt; 12 ? 'am' : 'pm') + "</span>;
    case <span class="literal">"A"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.getHours() &lt; 12 ? 'AM' : 'PM') + "</span>;
    case <span class="literal">"g"</span>:
        <span class="reserved">return</span> <span class="literal">"((this.getHours() %12) ? this.getHours() % 12 : 12) + "</span>;
    case <span class="literal">"G"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getHours() + "</span>;
    case <span class="literal">"h"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad((this.getHours() %12) ? this.getHours() % 12 : 12, 2, '0') + "</span>;
    case <span class="literal">"H"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getHours(), 2, '0') + "</span>;
    case <span class="literal">"i"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getMinutes(), 2, '0') + "</span>;
    case <span class="literal">"s"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getSeconds(), 2, '0') + "</span>;
    case <span class="literal">"O"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getGMTOffset() + "</span>;
    case <span class="literal">"T"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getTimezone() + "</span>;
    case <span class="literal">"Z"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.getTimezoneOffset() * -60) + "</span>;
    default:
        <span class="reserved">return</span> <span class="literal">"'"</span> + String.escape(character) + <span class="literal">"' + "</span>;
    }
}

Date.parseDate = <span class="reserved">function</span>(input, format) {
    <span class="reserved">if</span> (Date.parseFunctions[format] == null) {
        Date.createParser(format);
    }
    var func = Date.parseFunctions[format];
    <span class="reserved">return</span> Date[func](input);
}

Date.createParser = <span class="reserved">function</span>(format) {
    var funcName = <span class="literal">"parse"</span> + Date.parseFunctions.count++;
    var regexNum = Date.parseRegexes.length;
    var currentGroup = 1;
    Date.parseFunctions[format] = funcName;

    var code = <span class="literal">"Date."</span> + funcName + <span class="literal">" = function(input){\n"</span>
        + <span class="literal">"var y = -1, m = -1, d = -1, h = -1, i = -1, s = -1;\n"</span>
        + <span class="literal">"var d = new Date();\n"</span>
        + <span class="literal">"y = d.getFullYear();\n"</span>
        + <span class="literal">"m = d.getMonth();\n"</span>
        + <span class="literal">"d = d.getDate();\n"</span>
        + <span class="literal">"var results = input.match(Date.parseRegexes["</span> + regexNum + <span class="literal">"]);\n"</span>
        + <span class="literal">"if (results &amp;&amp; results.length &gt; 0) {"</span>
    var regex = <span class="literal">""</span>;

    var special = false;
    var ch = <span class="literal">''</span>;
    <span class="reserved">for</span> (var i = 0; i &lt; format.length; ++i) {
        ch = format.charAt(i);
        <span class="reserved">if</span> (!special &amp;&amp; ch == <span class="literal">"\\"</span>) {
            special = true;
        }
        <span class="reserved">else</span> <span class="reserved">if</span> (special) {
            special = false;
            regex += String.escape(ch);
        }
        <span class="reserved">else</span> {
            obj = Date.formatCodeToRegex(ch, currentGroup);
            currentGroup += obj.g;
            regex += obj.s;
            <span class="reserved">if</span> (obj.g &amp;&amp; obj.c) {
                code += obj.c;
            }
        }
    }

    code += <span class="literal">"if (y &gt; 0 &amp;&amp; m &gt;= 0 &amp;&amp; d &gt; 0 &amp;&amp; h &gt;= 0 &amp;&amp; i &gt;= 0 &amp;&amp; s &gt;= 0)\n"</span>
        + <span class="literal">"{return new Date(y, m, d, h, i, s);}\n"</span>
        + <span class="literal">"else if (y &gt; 0 &amp;&amp; m &gt;= 0 &amp;&amp; d &gt; 0 &amp;&amp; h &gt;= 0 &amp;&amp; i &gt;= 0)\n"</span>
        + <span class="literal">"{return new Date(y, m, d, h, i);}\n"</span>
        + <span class="literal">"else if (y &gt; 0 &amp;&amp; m &gt;= 0 &amp;&amp; d &gt; 0 &amp;&amp; h &gt;= 0)\n"</span>
        + <span class="literal">"{return new Date(y, m, d, h);}\n"</span>
        + <span class="literal">"else if (y &gt; 0 &amp;&amp; m &gt;= 0 &amp;&amp; d &gt; 0)\n"</span>
        + <span class="literal">"{return new Date(y, m, d);}\n"</span>
        + <span class="literal">"else if (y &gt; 0 &amp;&amp; m &gt;= 0)\n"</span>
        + <span class="literal">"{return new Date(y, m);}\n"</span>
        + <span class="literal">"else if (y &gt; 0)\n"</span>
        + <span class="literal">"{return new Date(y);}\n"</span>
        + <span class="literal">"}return null;}"</span>;

    Date.parseRegexes[regexNum] = new RegExp(<span class="literal">"^"</span> + regex + <span class="literal">"$"</span>);
    eval(code);
}

Date.formatCodeToRegex = <span class="reserved">function</span>(character, currentGroup) {
    switch (character) {
    case <span class="literal">"D"</span>:
        <span class="reserved">return</span> {g:0,
        c:null,
        s:<span class="literal">"(?:Sun|Mon|Tue|Wed|Thu|Fri|Sat)"</span>};
    case <span class="literal">"j"</span>:
    case <span class="literal">"d"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"d = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{1,2})"</span>};
    case <span class="literal">"l"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:"</span> + Date.dayNames.join(<span class="literal">"|"</span>) + <span class="literal">")"</span>};
    case <span class="literal">"S"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:st|nd|rd|th)"</span>};
    case <span class="literal">"w"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"\\d"</span>};
    case <span class="literal">"z"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:\\d{1,3})"</span>};
    case <span class="literal">"W"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:\\d{2})"</span>};
    case <span class="literal">"F"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"m = parseInt(Date.monthNumbers[results["</span> + currentGroup + <span class="literal">"].substring(0, 3)], 10);\n"</span>,
            s:<span class="literal">"("</span> + Date.monthNames.join(<span class="literal">"|"</span>) + <span class="literal">")"</span>};
    case <span class="literal">"M"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"m = parseInt(Date.monthNumbers[results["</span> + currentGroup + <span class="literal">"]], 10);\n"</span>,
            s:<span class="literal">"(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)"</span>};
    case <span class="literal">"n"</span>:
    case <span class="literal">"m"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"m = parseInt(results["</span> + currentGroup + <span class="literal">"], 10) - 1;\n"</span>,
            s:<span class="literal">"(\\d{1,2})"</span>};
    case <span class="literal">"t"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"\\d{1,2}"</span>};
    case <span class="literal">"L"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:1|0)"</span>};
    case <span class="literal">"Y"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"y = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{4})"</span>};
    case <span class="literal">"y"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"var ty = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>
                + <span class="literal">"y = ty &gt; Date.y2kYear ? 1900 + ty : 2000 + ty;\n"</span>,
            s:<span class="literal">"(\\d{1,2})"</span>};
    case <span class="literal">"a"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"if (results["</span> + currentGroup + <span class="literal">"] == 'am') {\n"</span>
                + <span class="literal">"if (h == 12) { h = 0; }\n"</span>
                + <span class="literal">"} else { if (h &lt; 12) { h += 12; }}"</span>,
            s:<span class="literal">"(am|pm)"</span>};
    case <span class="literal">"A"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"if (results["</span> + currentGroup + <span class="literal">"] == 'AM') {\n"</span>
                + <span class="literal">"if (h == 12) { h = 0; }\n"</span>
                + <span class="literal">"} else { if (h &lt; 12) { h += 12; }}"</span>,
            s:<span class="literal">"(AM|PM)"</span>};
    case <span class="literal">"g"</span>:
    case <span class="literal">"G"</span>:
    case <span class="literal">"h"</span>:
    case <span class="literal">"H"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"h = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{1,2})"</span>};
    case <span class="literal">"i"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"i = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{2})"</span>};
    case <span class="literal">"s"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"s = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{2})"</span>};
    case <span class="literal">"O"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"[+-]\\d{4}"</span>};
    case <span class="literal">"T"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"[A-Z]{3}"</span>};
    case <span class="literal">"Z"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"[+-]\\d{1,5}"</span>};
    default:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:String.escape(character)};
    }
}

Date.<span class="reserved">prototype</span>.getTimezone = <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.toString().replace(
        /^.*? ([A-Z]{3}) [0-9]{4}.*$/, <span class="literal">"$1"</span>).replace(
        /^.*?\(([A-Z])[a-z]+ ([A-Z])[a-z]+ ([A-Z])[a-z]+\)$/, <span class="literal">"$1$2$3"</span>);
}

Date.<span class="reserved">prototype</span>.getGMTOffset = <span class="reserved">function</span>() {
    <span class="reserved">return</span> (<span class="reserved">this</span>.getTimezoneOffset() &gt; 0 ? <span class="literal">"-"</span> : <span class="literal">"+"</span>)
        + String.leftPad(Math.floor(<span class="reserved">this</span>.getTimezoneOffset() / 60), 2, <span class="literal">"0"</span>)
        + String.leftPad(<span class="reserved">this</span>.getTimezoneOffset() % 60, 2, <span class="literal">"0"</span>);
}

Date.<span class="reserved">prototype</span>.getDayOfYear = <span class="reserved">function</span>() {
    var num = 0;
    Date.daysInMonth[1] = <span class="reserved">this</span>.isLeapYear() ? 29 : 28;
    <span class="reserved">for</span> (var i = 0; i &lt; <span class="reserved">this</span>.getMonth(); ++i) {
        num += Date.daysInMonth[i];
    }
    <span class="reserved">return</span> num + <span class="reserved">this</span>.getDate() - 1;
}

Date.<span class="reserved">prototype</span>.getWeekOfYear = <span class="reserved">function</span>() {
    <span class="comment">// Skip to Thursday of this week</span>
    var now = <span class="reserved">this</span>.getDayOfYear() + (5 - <span class="reserved">this</span>.getDay());
    <span class="comment">// Find the first Thursday of the year</span>
    var jan1 = new Date(<span class="reserved">this</span>.getFullYear(), 0, 1);
    var then = (5 - jan1.getDay());
    <span class="reserved">return</span> String.leftPad(((now - then) / 7) + 1, 2, <span class="literal">"0"</span>);
}

Date.<span class="reserved">prototype</span>.isLeapYear = <span class="reserved">function</span>() {
    var year = <span class="reserved">this</span>.getFullYear();
    <span class="reserved">return</span> ((year &amp; 3) == 0 &amp;&amp; (year % 100 || (year % 400 == 0 &amp;&amp; year)));
}

Date.<span class="reserved">prototype</span>.getFirstDayOfMonth = <span class="reserved">function</span>() {
    var day = (<span class="reserved">this</span>.getDay() - (<span class="reserved">this</span>.getDate() - 1)) % 7;
    <span class="reserved">return</span> (day &lt; 0) ? (day + 7) : day;
}

Date.<span class="reserved">prototype</span>.getLastDayOfMonth = <span class="reserved">function</span>() {
    var day = (<span class="reserved">this</span>.getDay() + (Date.daysInMonth[<span class="reserved">this</span>.getMonth()] - <span class="reserved">this</span>.getDate())) % 7;
    <span class="reserved">return</span> (day &lt; 0) ? (day + 7) : day;
}

Date.<span class="reserved">prototype</span>.getDaysInMonth = <span class="reserved">function</span>() {
    Date.daysInMonth[1] = <span class="reserved">this</span>.isLeapYear() ? 29 : 28;
    <span class="reserved">return</span> Date.daysInMonth[<span class="reserved">this</span>.getMonth()];
}

Date.<span class="reserved">prototype</span>.getSuffix = <span class="reserved">function</span>() {
    switch (<span class="reserved">this</span>.getDate()) {
        case 1:
        case 21:
        case 31:
            <span class="reserved">return</span> <span class="literal">"st"</span>;
        case 2:
        case 22:
            <span class="reserved">return</span> <span class="literal">"nd"</span>;
        case 3:
        case 23:
            <span class="reserved">return</span> <span class="literal">"rd"</span>;
        default:
            <span class="reserved">return</span> <span class="literal">"th"</span>;
    }
}

String.escape = <span class="reserved">function</span>(string) {
    <span class="reserved">return</span> string.replace(/(<span class="literal">'|\\)/g, "\\$1");
}

String.leftPad = function (val, size, ch) {
    var result = new String(val);
    if (ch == null) {
        ch = " ";
    }
    while (result.length &lt; size) {
        result = ch + result;
    }
    return result;
}

Date.daysInMonth = [31,28,31,30,31,30,31,31,30,31,30,31];
Date.monthNames =
   ["January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December"];
Date.dayNames =
   ["Sunday",
    "Monday",
    "Tuesday",
    "Wednesday",
    "Thursday",
    "Friday",
    "Saturday"];
Date.y2kYear = 50;
Date.monthNumbers = {
    Jan:0,
    Feb:1,
    Mar:2,
    Apr:3,
    May:4,
    Jun:5,
    Jul:6,
    Aug:7,
    Sep:8,
    Oct:9,
    Nov:10,
    Dec:11};
Date.patterns = {
    ISO8601LongPattern:"Y-m-d H:i:s",
    ISO8601ShortPattern:"Y-m-d",
    ShortDatePattern: "n/j/Y",
    LongDatePattern: "l, F d, Y",
    FullDateTimePattern: "l, F d, Y g:i:s A",
    MonthDayPattern: "F d",
    ShortTimePattern: "g:i A",
    LongTimePattern: "g:i:s A",
    SortableDateTimePattern: "Y-m-d\\TH:i:s",
    UniversalSortableDateTimePattern: "Y-m-d H:i:sO",
    YearMonthPattern: "F, Y"};
/*
    json2.js
    2008-01-17

    Public Domain

    No warranty expressed or implied. Use at your own risk.

    See http://www.JSON.org/js.html

    This file creates a global JSON object containing two methods:

        JSON.stringify(value, whitelist)
            value       any JavaScript value, usually an object or array.

            whitelist   an optional array prameter that determines how object
                        values are stringified.

            This method produces a JSON text from a JavaScript value.
            There are three possible ways to stringify an object, depending
            on the optional whitelist parameter.

            If an object has a toJSON method, then the toJSON() method will be
            called. The value returned from the toJSON method will be
            stringified.

            Otherwise, if the optional whitelist parameter is an array, then
            the elements of the array will be used to select members of the
            object for stringification.

            Otherwise, if there is no whitelist parameter, then all of the
            members of the object will be stringified.

            Values that do not have JSON representaions, such as undefined or
            functions, will not be serialized. Such values in objects will be
            dropped; in arrays will be replaced with null.
            JSON.stringify(undefined) returns undefined. Dates will be
            stringified as quoted ISO dates.

            Example:

            var text = JSON.stringify(['</span>e<span class="literal">', {pluribus: '</span>unum<span class="literal">'}]);
            // text is '</span>[<span class="literal">"e"</span>,{<span class="literal">"pluribus"</span>:<span class="literal">"unum"</span>}]<span class="literal">'

        JSON.parse(text, filter)
            This method parses a JSON text to produce an object or
            array. It can throw a SyntaxError exception.

            The optional filter parameter is a function that can filter and
            transform the results. It receives each of the keys and values, and
            its return value is used instead of the original value. If it
            returns what it received, then structure is not modified. If it
            returns undefined then the member is deleted.

            Example:

            // Parse the text. If a key contains the string '</span>date<span class="literal">' then
            // convert the value to a date.

            myData = JSON.parse(text, function (key, value) {
                return key.indexOf('</span>date<span class="literal">') &gt;= 0 ? new Date(value) : value;
            });

    This is a reference implementation. You are free to copy, modify, or
    redistribute.

    Use your own copy. It is extremely unwise to load third party
    code into your pages.
*/

/*jslint evil: true */

/*global JSON */

/*members "\b", "\t", "\n", "\f", "\r", "\"", JSON, "\\", apply,
    charCodeAt, floor, getUTCDate, getUTCFullYear, getUTCHours,
    getUTCMinutes, getUTCMonth, getUTCSeconds, hasOwnProperty, join, length,
    parse, propertyIsEnumerable, prototype, push, replace, stringify, test,
    toJSON, toString
*/

if (!this.JSON) {

    JSON = function () {

        function f(n) {    // Format integers to have at least two digits.
            return n &lt; 10 ? '</span>0<span class="literal">' + n : n;
        }

        Date.prototype.toJSON = function () {

// Eventually, this method will be based on the date.toISOString method.

            return this.getUTCFullYear()   + '</span>-<span class="literal">' +
                 f(this.getUTCMonth() + 1) + '</span>-<span class="literal">' +
                 f(this.getUTCDate())      + '</span>T<span class="literal">' +
                 f(this.getUTCHours())     + '</span>:<span class="literal">' +
                 f(this.getUTCMinutes())   + '</span>:<span class="literal">' +
                 f(this.getUTCSeconds())   + '</span>Z<span class="literal">';
        };


        var m = {    // table of character substitutions
            '</span>\b<span class="literal">': '</span>\\b<span class="literal">',
            '</span>\t<span class="literal">': '</span>\\t<span class="literal">',
            '</span>\n<span class="literal">': '</span>\\n<span class="literal">',
            '</span>\f<span class="literal">': '</span>\\f<span class="literal">',
            '</span>\r<span class="literal">': '</span>\\r<span class="literal">',
            '</span><span class="literal">"' : '\\"</span><span class="literal">',
            '</span>\\<span class="literal">': '</span>\\\\<span class="literal">'
        };

        function stringify(value, whitelist) {
            var a,          // The array holding the partial texts.
                i,          // The loop counter.
                k,          // The member key.
                l,          // Length.
                r = /["\\\x00-\x1f\x7f-\x9f]/g,
                v;          // The member value.

            switch (typeof value) {
            case '</span>string<span class="literal">':

// If the string contains no control characters, no quote characters, and no
// backslash characters, then we can safely slap some quotes around it.
// Otherwise we must also replace the offending characters with safe sequences.

                return r.test(value) ?
                    '</span><span class="literal">"' + value.replace(r, function (a) {
                        var c = m[a];
                        if (c) {
                            return c;
                        }
                        c = a.charCodeAt();
                        return '\\u00' + Math.floor(c / 16).toString(16) +
                                                   (c % 16).toString(16);
                    }) + '"</span><span class="literal">' :
                    '</span><span class="literal">"' + value + '"</span><span class="literal">';

            case '</span>number<span class="literal">':

// JSON numbers must be finite. Encode non-finite numbers as null.

                return isFinite(value) ? String(value) : '</span>null<span class="literal">';

            case '</span>boolean<span class="literal">':
            case '</span>null<span class="literal">':
                return String(value);

            case '</span>object<span class="literal">':

// Due to a specification blunder in ECMAScript,
// typeof null is '</span>object<span class="literal">', so watch out for that case.

                if (!value) {
                    return '</span>null<span class="literal">';
                }

// If the object has a toJSON method, call it, and stringify the result.

                if (typeof value.toJSON === '</span><span class="reserved">function</span><span class="literal">') {
                    return stringify(value.toJSON());
                }
                a = [];
                if (typeof value.length === '</span>number<span class="literal">' &amp;&amp;
                        !(value.propertyIsEnumerable('</span>length<span class="literal">'))) {

// The object is an array. Stringify every element. Use null as a placeholder
// for non-JSON values.

                    l = value.length;
                    for (i = 0; i &lt; l; i += 1) {
                        a.push(stringify(value[i], whitelist) || '</span>null<span class="literal">');
                    }

// Join all of the elements together and wrap them in brackets.

                    return '</span>[<span class="literal">' + a.join('</span>,<span class="literal">') + '</span>]<span class="literal">';
                }
                if (whitelist) {

// If a whitelist (array of keys) is provided, use it to select the components
// of the object.

                    l = whitelist.length;
                    for (i = 0; i &lt; l; i += 1) {
                        k = whitelist[i];
                        if (typeof k === '</span>string<span class="literal">') {
                            v = stringify(value[k], whitelist);
                            if (v) {
                                a.push(stringify(k) + '</span>:<span class="literal">' + v);
                            }
                        }
                    }
                } else {

// Otherwise, iterate through all of the keys in the object.

                    for (k in value) {
                        if (typeof k === '</span>string<span class="literal">') {
                            v = stringify(value[k], whitelist);
                            if (v) {
                                a.push(stringify(k) + '</span>:<span class="literal">' + v);
                            }
                        }
                    }
                }

// Join all of the member texts together and wrap them in braces.

                return '</span>{<span class="literal">' + a.join('</span>,<span class="literal">') + '</span>}<span class="literal">';
            }
        }

        return {
            stringify: stringify,
            parse: function (text, filter) {
                var j;

                function walk(k, v) {
                    var i, n;
                    if (v &amp;&amp; typeof v === '</span>object<span class="literal">') {
                        for (i in v) {
                            if (Object.prototype.hasOwnProperty.apply(v, [i])) {
                                n = walk(i, v[i]);
                                if (n !== undefined) {
                                    v[i] = n;
                                }
                            }
                        }
                    }
                    return filter(k, v);
                }


// Parsing happens in three stages. In the first stage, we run the text against
// regular expressions that look for non-JSON patterns. We are especially
// concerned with '</span>()<span class="literal">' and '</span>new<span class="literal">' because they can cause invocation, and '</span>=<span class="literal">'
// because it can cause mutation. But just to be safe, we want to reject all
// unexpected forms.

// We split the first stage into 4 regexp operations in order to work around
// crippling inefficiencies in IE'</span>s and Safari<span class="literal">'s regexp engines. First we
// replace all backslash pairs with '</span>@<span class="literal">' (a non-JSON character). Second, we
// replace all simple value tokens with '</span>]<span class="literal">' characters. Third, we delete all
// open brackets that follow a colon or comma or that begin the text. Finally,
// we look to see that the remaining characters are only whitespace or '</span>]<span class="literal">' or
// '</span>,<span class="literal">' or '</span>:<span class="literal">' or '</span>{<span class="literal">' or '</span>}<span class="literal">'. If that is so, then the text is safe for eval.

                if (/^[\],:{}\s]*$/.test(text.replace(/\\./g, '</span>@<span class="literal">').
replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, '</span>]<span class="literal">').
replace(/(?:^|:|,)(?:\s*\[)+/g, '</span><span class="literal">'))) {

// In the second stage we use the eval function to compile the text into a
// JavaScript structure. The '</span>{<span class="literal">' operator is subject to a syntactic ambiguity
// in JavaScript: it can begin a block or an object literal. We wrap the text
// in parens to eliminate the ambiguity.

                    j = eval('</span>(<span class="literal">' + text + '</span>)<span class="literal">');

// In the optional third stage, we recursively walk the new structure, passing
// each name/value pair to a filter function for possible transformation.

                    return typeof filter === '</span><span class="reserved">function</span><span class="literal">' ? walk('</span><span class="literal">', j) : j;
                }

// If the text is not JSON parseable, then a SyntaxError is thrown.

                throw new SyntaxError('</span>parseJSON<span class="literal">');
            }
        };
    }();
}


var in2igui = {
	locales : {
		'</span>da/DK<span class="literal">':{decimal:'</span>,<span class="literal">',thousands:'</span>.<span class="literal">'},
		'</span>en/US<span class="literal">':{decimal:'</span>.<span class="literal">',thousands:'</span>,<span class="literal">'}
	},
	locale : {decimal:'</span>,<span class="literal">',thousands:'</span>.<span class="literal">'},
	setLocale : function(code) {
		if (this.locales[code]) {
			this.locale = this.locales[code];
		}
	}
};

/**
  The base class of the In2iGui framework
  @constructor
 */
function In2iGui() {
	/** {boolean} Is true when the DOM is loaded */
	this.domLoaded = false;
	/** @private */
	this.overflows = null;
	/** @private */
	this.delegates = [];
	/** @private */
	this.objects = $H();
	/** @private */
	this.state = '</span>default<span class="literal">';
	this.addBehavior();
}

window.ui = In2iGui;

/** @private */
In2iGui.latestObjectIndex = 0;
/** @private */
In2iGui.latestIndex = 500;
/** @private */
In2iGui.latestPanelIndex = 1000;
/** @private */
In2iGui.latestAlertIndex = 1500;
/** @private */
In2iGui.latestTopIndex = 2000;
/** @private */
In2iGui.toolTips = {};

/** Gets the one instance of In2iGui */
In2iGui.get = function(name) {
	if (!In2iGui.instance) {
		In2iGui.instance = new In2iGui();
	}
	if (name) {
		return In2iGui.instance.objects.get(name);
	} else {
		return In2iGui.instance;
	}
};

document.observe('</span>dom:loaded<span class="literal">', function () {
	In2iGui.get().ignite();
});

In2iGui.prototype = {
	/** @private */
	ignite : function() {
		if (window.dwr) {
			if (dwr &amp;&amp; dwr.engine &amp;&amp; dwr.engine.setErrorHandler) {
				dwr.engine.setErrorHandler(function(msg,e) {
					n2i.log(msg);
					n2i.log(e);
					In2iGui.get().alert({title:'</span>An unexpected error occurred!<span class="literal">',text:msg,emotion:'</span>gasp<span class="literal">'});
				});
			}
		}
		this.domLoaded = true;
		In2iGui.domReady = true;
		this.resize();
		In2iGui.callSuperDelegates(this,'</span>interfaceIsReady<span class="literal">');
	},
	/** @private */
	addBehavior : function() {
		Event.observe(window,'</span>resize<span class="literal">',this.resize.bind(this));
	},
	/** Adds a global delegate
	 * @deprecated
	*/
	addDelegate : function(delegate) {
		this.delegates.push(delegate);
	},
	listen : function(delegate) {
		this.delegates.push(delegate);
	},
	getTopPad : function(element) {
		var all,top;
		all = parseInt(n2i.getStyle(element,'</span>padding<span class="literal">'),10);
		top = parseInt(n2i.getStyle(element,'</span>padding-top<span class="literal">'),10);
		if (all) {return all;}
		if (top) {return top;}
		return 0;
	},
	getBottomPad : function(element) {
		var all,bottom;
		all = parseInt(n2i.getStyle(element,'</span>padding<span class="literal">'),10);
		bottom = parseInt(n2i.getStyle(element,'</span>padding-bottom<span class="literal">'),10);
		if (all) {return all;}
		if (bottom) {return bottom;}
		return 0;
	},
	/** @private */
	resize : function() {
		if (!this.overflows) {return;}
		var height = n2i.getInnerHeight();
		this.overflows.each(function(overflow) {
			if (n2i.browser.webkit || n2i.browser.gecko) {
				overflow.element.style.display='</span>none<span class="literal">';
				overflow.element.style.width = overflow.element.parentNode.clientWidth+'</span>px<span class="literal">';
				overflow.element.style.display='</span><span class="literal">';
			}
			overflow.element.style.height = height+overflow.diff+'</span>px<span class="literal">';
		});
	},
	registerOverflow : function(id,diff) {
		if (!this.overflows) {this.overflows=[];}
		var overflow = $(id);
		this.overflows.push({element:overflow,diff:diff});
	},
	/** @private */
	alert : function(options) {
		if (!this.alertBox) {
			this.alertBox = In2iGui.Alert.create(options);
			this.alertBoxButton = In2iGui.Button.create({name:'</span>in2iGuiAlertBoxButton<span class="literal">',text : '</span>OK<span class="literal">'});
			this.alertBoxButton.addDelegate(this);
			this.alertBox.addButton(this.alertBoxButton);
		} else {
			this.alertBox.update(options);
		}
		this.alertBoxCallBack = options.onOK;
		this.alertBoxButton.setText(options.button ? options.button : '</span>OK<span class="literal">');
		this.alertBox.show();
	},
	/** @private */
	$click$in2iGuiAlertBoxButton : function() {
		In2iGui.get().alertBox.hide();
		if (this.alertBoxCallBack) {
			this.alertBoxCallBack();
			this.alertBoxCallBack = null;
		}
	},
	confirm : function(options) {
		if (!options.name) {
			options.name = '</span>in2iguiConfirm<span class="literal">';
		}
		var alert = In2iGui.get(options.name);
		if (!alert) {
			alert = In2iGui.Alert.create(options);
			var cancel = In2iGui.Button.create({name:name+'</span>_cancel<span class="literal">',text : options.cancel || '</span>Cancel<span class="literal">',highlighted:options.highlighted==='</span>cancel<span class="literal">'});
			cancel.addDelegate({$click:function(){
				alert.hide();
				if (options.onCancel) {
					options.onCancel();
				}
				In2iGui.callDelegates(alert,'</span>cancel<span class="literal">');
			}});
			alert.addButton(cancel);
		
			var ok = In2iGui.Button.create({name:name+'</span>_ok<span class="literal">',text : options.ok || '</span>OK<span class="literal">',highlighted:options.highlighted==='</span>ok<span class="literal">'});
			ok.addDelegate({$click:function(){
				alert.hide();
				if (options.onOK) {
					options.onOK();
				}
				In2iGui.callDelegates(alert,'</span>ok<span class="literal">');
			}});
			alert.addButton(ok);
		} else {
			alert.update(options);
			In2iGui.get(name+'</span>_ok<span class="literal">').setText(options.ok || '</span>ok<span class="literal">');
			In2iGui.get(name+'</span>_ok<span class="literal">').setHighlighted(options.highlighted=='</span>ok<span class="literal">');
			In2iGui.get(name+'</span>_cancel<span class="literal">').setText(options.ok || '</span>cancel<span class="literal">');
			In2iGui.get(name+'</span>_cancel<span class="literal">').setHighlighted(options.highlighted=='</span>cancel<span class="literal">');
			if (options.cancel) {In2iGui.get(name+'</span>_cancel<span class="literal">').setText(options.cancel);}
		}
		alert.show();
	},
	getDescendants : function(widget) {
		var desc = [],e = widget.getElement();
		if (e) {
			var d = e.descendants();
			var o = this.objects.values();
			for (var i=0; i &lt; d.length; i++) {
				for (var j=0; j &lt; o.length; j++) {
					if (d[i]==o[j].element) {
						desc.push(o[j]);
					}
				};
				
			};
		}
		return desc;
	},
	/** Gets all ancestors of a widget
		@param {Widget} A widget
		@returns {Array} An array of all ancestors
	*/
	getAncestors : function(widget) {
		var desc = [];
		var e = widget.element;
		if (e) {
			var a = e.ancestors();
			var o = this.objects.values();
			for (var i=0; i &lt; a.length; i++) {
				for (var j=0; j &lt; o.length; j++) {
					if (o[j].element==a[i]) {
						desc.push(o[j]);
					}
					
				};
			};
		}
		return desc;
	},
	getAncestor : function(widget,cls) {
		var a = this.getAncestors(widget);
		for (var i=0; i &lt; a.length; i++) {
			if (a[i].getElement().hasClassName(cls)) {
				return a[i];
			}
		};
		return null;
	}
};

In2iGui.changeState = function(state) {
	if (In2iGui.get().state===state) {return;}
	var objects = In2iGui.get().objects.values();
	objects.each(function(obj) {
		if (obj.options &amp;&amp; obj.options.state) {
			if (obj.options.state==state) {obj.show();}
			else {obj.hide();}
		}
	});
	In2iGui.get().state==state;
}

///////////////////////////////// Indexes /////////////////////////////

In2iGui.nextIndex = function() {
	In2iGui.latestIndex++;
	return 	In2iGui.latestIndex;
};

In2iGui.nextPanelIndex = function() {
	In2iGui.latestPanelIndex++;
	return 	In2iGui.latestPanelIndex;
};

In2iGui.nextAlertIndex = function() {
	In2iGui.latestAlertIndex++;
	return 	In2iGui.latestAlertIndex;
};

In2iGui.nextTopIndex = function() {
	In2iGui.latestTopIndex++;
	return 	In2iGui.latestTopIndex;
};

///////////////////////////////// Curtain /////////////////////////////

In2iGui.showCurtain = function(widget,zIndex) {
	if (!widget.curtain) {
		widget.curtain = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_curtain<span class="literal">'}).setStyle({'</span>z-index<span class="literal">':'</span>none<span class="literal">'});
		widget.curtain.onclick = function() {
			if (widget.curtainWasClicked) {
				widget.curtainWasClicked();
			}
		};
		var body = $$('</span>.in2igui_body<span class="literal">')[0];
		if (!body) {
			body=document.body;
		}
		body.appendChild(widget.curtain);
	}
	widget.curtain.style.height=n2i.getDocumentHeight()+'</span>px<span class="literal">';
	widget.curtain.style.zIndex=zIndex;
	n2i.setOpacity(widget.curtain,0);
	widget.curtain.style.display='</span>block<span class="literal">';
	n2i.ani(widget.curtain,'</span>opacity<span class="literal">',0.7,1000,{ease:n2i.ease.slowFastSlow});
};

In2iGui.hideCurtain = function(widget) {
	if (widget.curtain) {
		n2i.ani(widget.curtain,'</span>opacity<span class="literal">',0,200,{hideOnComplete:true});
	}
};

//////////////////////////////// Message //////////////////////////////

In2iGui.alert = function(o) {
	In2iGui.get().alert(o);
};

In2iGui.showMessage = function(options) {
	if (typeof(options)=='</span>string<span class="literal">') {
		// TODO: Backwards compatibility
		options={text:options};
	}
	if (!In2iGui.message) {
		In2iGui.message = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_message<span class="literal">'}).update('</span>&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">');
		if (!n2i.browser.msie) {
			In2iGui.message.setStyle({opacity:0});
		}
		document.body.appendChild(In2iGui.message);
	}
	In2iGui.message.select('</span>div<span class="literal">')[1].update(options.text);
	In2iGui.message.setStyle({'</span>display<span class="literal">':'</span>block<span class="literal">',zIndex:In2iGui.nextTopIndex()});
	In2iGui.message.setStyle({marginLeft:(In2iGui.message.getWidth()/-2)+'</span>px<span class="literal">',marginTop:n2i.getScrollTop()+'</span>px<span class="literal">'});
	if (!n2i.browser.msie) {
		n2i.ani(In2iGui.message,'</span>opacity<span class="literal">',1,300);
	}
	window.clearTimeout(In2iGui.messageTimer);
	if (options.duration) {
		In2iGui.messageTimer = window.setTimeout(In2iGui.hideMessage,options.duration);
	}
};

In2iGui.hideMessage = function() {
	if (In2iGui.message) {
		if (!n2i.browser.msie) {
			n2i.ani(In2iGui.message,'</span>opacity<span class="literal">',0,300,{hideOnComplete:true});
		} else {
			In2iGui.message.setStyle({display:'</span>none<span class="literal">'});
		}
	}
};

In2iGui.showToolTip = function(options) {
	var key = options.key || '</span>common<span class="literal">';
	var t = In2iGui.toolTips[key];
	if (!t) {
		t = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_tooltip<span class="literal">'}).update('</span>&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">').setStyle({display:'</span>none<span class="literal">'});
		document.body.appendChild(t);
		In2iGui.toolTips[key] = t;
	}
	t.onclick = function() {In2iGui.hideToolTip(options);};
	var n = $(options.element);
	var pos = n.cumulativeOffset();
	t.select('</span>div<span class="literal">')[1].update(options.text);
	if (t.style.display=='</span>none<span class="literal">' &amp;&amp; !n2i.browser.msie) {t.setStyle({opacity:0});}
	t.setStyle({'</span>display<span class="literal">':'</span>block<span class="literal">',zIndex:In2iGui.nextTopIndex()});
	t.setStyle({left:(pos.left-t.getWidth()+4)+'</span>px<span class="literal">',top:(pos.top+2-(t.getHeight()/2)+(n.getHeight()/2))+'</span>px<span class="literal">'});
	if (!n2i.browser.msie) {
		n2i.ani(t,'</span>opacity<span class="literal">',1,300);
	}
};

In2iGui.hideToolTip = function(options) {
	var key = options ? options.key || '</span>common<span class="literal">' : '</span>common<span class="literal">';
	var t = In2iGui.toolTips[key];
	if (t) {
		if (!n2i.browser.msie) {
			n2i.ani(t,'</span>opacity<span class="literal">',0,300,{hideOnComplete:true});
		} else {
			t.setStyle({display:'</span>none<span class="literal">'});
		}
	}
};

/////////////////////////////// Utilities /////////////////////////////

In2iGui.isWithin = function(e,element) {
	Event.extend(e);
	var offset = element.cumulativeOffset();
	var dims = element.getDimensions();
	return e.pointerX()&gt;offset.left &amp;&amp; e.pointerX()&lt;offset.left+dims.width &amp;&amp; e.pointerY()&gt;offset.top &amp;&amp; e.pointerY()&lt;offset.top+dims.height;
};

In2iGui.getIconUrl = function(icon,size) {
	return In2iGui.context+'</span>/In2iGui/icons/<span class="literal">'+icon+size+'</span>.png<span class="literal">';
};

In2iGui.createIcon = function(icon,size) {
	return new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_icon in2igui_icon_<span class="literal">'+size}).setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl(icon,size)+'</span>)<span class="literal">'});
};

In2iGui.onDomReady = function(func) {
	if (In2iGui.domReady) {return func();}
	if (n2i.browser.gecko &amp;&amp; document.baseURI.endsWith('</span>xml<span class="literal">')) {
		window.setTimeout(func,1000);
		return;
	}
	document.observe('</span>dom:loaded<span class="literal">', func);
};

In2iGui.wrapInField = function(e) {
	var w = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_field<span class="literal">'}).update(
		'</span>&lt;span class=<span class="literal">"in2igui_field_top"</span>&gt;&lt;span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">'+
		'</span>&lt;span class=<span class="literal">"in2igui_field_middle"</span>&gt;&lt;span class=<span class="literal">"in2igui_field_middle"</span>&gt;&lt;span class=<span class="literal">"in2igui_field_content"</span>&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">'+
		'</span>&lt;span class=<span class="literal">"in2igui_field_bottom"</span>&gt;&lt;span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">'
	);
	w.select('</span>span.in2igui_field_content<span class="literal">')[0].insert(e);
	return w;
};

In2iGui.addFocusClass = function(o) {
	var ce = o.classElement || o.element, c = o['</span>class<span class="literal">'];
	o.element.observe('</span>focus<span class="literal">',function() {
		ce.addClassName(c);
	}).observe('</span>blur<span class="literal">',function() {
		ce.removeClassName(c);
	});
};


/////////////////////////////// Validation /////////////////////////////

In2iGui.NumberValidator = function(options) {
	n2i.override({allowNull:false,min:0,max:10},options)
	this.min = options.min;
	this.max = options.max;
	this.allowNull = options.allowNull;
	this.middle = Math.max(Math.min(this.max,0),this.min);
}

In2iGui.NumberValidator.prototype = {
	validate : function(value) {
		if (n2i.isBlank(value) &amp;&amp; this.allowNull) {
			return {valid:true,value:null};
		}
		var number = parseFloat(value);
		if (isNaN(number)) {
			return {valid:false,value:this.middle};
		} else if (number&lt;this.min) {
			return {valid:false,value:this.min};
		} else if (number&gt;this.max) {
			return {valid:false,value:this.max};
		}
		return {valid:true,value:number};
	}
}

/////////////////////////////// Animation /////////////////////////////

In2iGui.fadeIn = function(node,time) {
	if ($(node).getStyle('</span>display<span class="literal">')=='</span>none<span class="literal">') {
		node.setStyle({opacity:0,display:'</span><span class="literal">'});
	}
	n2i.ani(node,'</span>opacity<span class="literal">',1,time);
};

In2iGui.fadeOut = function(node,time) {
	n2i.ani(node,'</span>opacity<span class="literal">',0,time,{hideOnComplete:true});
};

//////////////////////////// Positioning /////////////////////////////

In2iGui.positionAtElement = function(element,target,options) {
	options = options || {};
	element = $(element);
	target = $(target);
	var origDisplay = element.getStyle('</span>display<span class="literal">');
	if (origDisplay=='</span>none<span class="literal">') {
		element.setStyle({'</span>visibility<span class="literal">':'</span>hidden<span class="literal">','</span>display<span class="literal">':'</span>block<span class="literal">'});
	}
	var pos = target.cumulativeOffset(),left = pos.left,top = pos.top;
	var vert=options.vertical || null;
	if (options.horizontal &amp;&amp; options.horizontal=='</span>right<span class="literal">') {
		left = left+target.getWidth()-element.getWidth();
	}
	if (vert=='</span>topOutside<span class="literal">') {
		top = top-element.getHeight();
	} else if (vert=='</span>bottomOutside<span class="literal">') {
		top = top+target.getHeight();
	}
	left+=(options.left || 0);
	top+=(options.top || 0);
	element.setStyle({'</span>left<span class="literal">':left+'</span>px<span class="literal">','</span>top<span class="literal">':top+'</span>px<span class="literal">'});
	if (origDisplay=='</span>none<span class="literal">') {
		element.setStyle({'</span>visibility<span class="literal">':'</span>visible<span class="literal">','</span>display<span class="literal">':'</span>none<span class="literal">'});
	}
};


//////////////////////////////// Drag drop //////////////////////////////

In2iGui.getDragProxy = function() {
	if (!In2iGui.dragProxy) {
		In2iGui.dragProxy = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_dragproxy<span class="literal">'}).setStyle({'</span>display<span class="literal">':'</span>none<span class="literal">'});
		document.body.appendChild(In2iGui.dragProxy);
	}
	return In2iGui.dragProxy;
};

In2iGui.startDrag = function(e,element,options) {
	e = e || window.event;
	var info = element.dragDropInfo;
	In2iGui.dropTypes = In2iGui.findDropTypes(info);
	if (!In2iGui.dropTypes) return;
	var proxy = In2iGui.getDragProxy();
	Event.observe(document.body,'</span>mousemove<span class="literal">',In2iGui.dragListener);
	Event.observe(document.body,'</span>mouseup<span class="literal">',In2iGui.dragEndListener);
	In2iGui.dragInfo = info;
	if (info.icon) {
		proxy.style.backgroundImage = '</span>url(<span class="literal">'+In2iGui.getIconUrl(info.icon,1)+'</span>)<span class="literal">';
	}
	In2iGui.startDragPos = {top:Event.pointerY(e),left:Event.pointerX(e)};
	proxy.innerHTML = '</span>&lt;span&gt;<span class="literal">'+info.title+'</span>&lt;/span&gt;<span class="literal">' || '</span>###<span class="literal">';
	In2iGui.dragging = true;
	document.body.onselectstart = function () { return false; };
};

In2iGui.findDropTypes = function(drag) {
	var gui = In2iGui.get();
	var drops = null;
	for (var i=0; i &lt; gui.delegates.length; i++) {
		if (gui.delegates[i].dragDrop) {
			for (var j=0; j &lt; gui.delegates[i].dragDrop.length; j++) {
				var rule = gui.delegates[i].dragDrop[j];
				if (rule.drag==drag.kind) {
					if (drops==null) drops={};
					drops[rule.drop] = {};
				}
			};
		}
	}
	return drops;
};

In2iGui.dragListener = function(e) {
	In2iGui.dragProxy.style.left = (Event.pointerX(e)+10)+'</span>px<span class="literal">';
	In2iGui.dragProxy.style.top = Event.pointerY(e)+'</span>px<span class="literal">';
	In2iGui.dragProxy.style.display='</span>block<span class="literal">';
	var target = In2iGui.findDropTarget(Event.element(e));
	if (target &amp;&amp; In2iGui.dropTypes[target.dragDropInfo['</span>kind<span class="literal">']]) {
		if (In2iGui.latestDropTarget) {
			In2iGui.latestDropTarget.removeClassName('</span>in2igui_drop<span class="literal">');
		}
		target.addClassName('</span>in2igui_drop<span class="literal">');
		In2iGui.latestDropTarget = target;
	} else if (In2iGui.latestDropTarget) {
		In2iGui.latestDropTarget.removeClassName('</span>in2igui_drop<span class="literal">');
		In2iGui.latestDropTarget = null;
	}
	return false;
};

In2iGui.findDropTarget = function(node) {
	while (node) {
		if (node.dragDropInfo) {
			return node;
		}
		node = node.parentNode;
	}
	return null;
};

In2iGui.dragEndListener = function(event) {
	Event.stopObserving(document.body,'</span>mousemove<span class="literal">',In2iGui.dragListener);
	Event.stopObserving(document.body,'</span>mouseup<span class="literal">',In2iGui.dragEndListener);
	In2iGui.dragging = false;
	if (In2iGui.latestDropTarget) {
		In2iGui.latestDropTarget.removeClassName('</span>in2igui_drop<span class="literal">');
		In2iGui.callDelegatesDrop(In2iGui.dragInfo,In2iGui.latestDropTarget.dragDropInfo);
		In2iGui.dragProxy.style.display='</span>none<span class="literal">';
	} else {
		n2i.ani(In2iGui.dragProxy,'</span>left<span class="literal">',(In2iGui.startDragPos.left+10)+'</span>px<span class="literal">',200,{ease:n2i.ease.fastSlow});
		n2i.ani(In2iGui.dragProxy,'</span>top<span class="literal">',(In2iGui.startDragPos.top-5)+'</span>px<span class="literal">',200,{ease:n2i.ease.fastSlow,hideOnComplete:true});
	}
	In2iGui.latestDropTarget=null;
	document.body.onselectstart=null;
};

In2iGui.dropOverListener = function(event) {
	if (In2iGui.dragging) {
		//this.style.backgroundColor='</span>#3875D7<span class="literal">';
	}
};

In2iGui.dropOutListener = function(event) {
	if (In2iGui.dragging) {
		//this.style.backgroundColor='</span><span class="literal">';
	}
};

//////////////////// Delegating ////////////////////

In2iGui.extend = function(obj,options) {
	if (!obj.name) {
		In2iGui.latestObjectIndex++;
		obj.name = '</span>unnamed<span class="literal">'+In2iGui.latestObjectIndex;
	}
	if (options!==undefined) {
		if (obj.options) {
			obj.options = n2i.override(obj.options,options);
		}
		obj.element = $(options.element);
		obj.name = options.name;
	}
	In2iGui.get().objects.set(obj.name,obj);
	obj.delegates = [];
	obj.addDelegate = obj.listen = function(delegate) {
		n2i.addToArray(this.delegates,delegate);
	}
	obj.removeDelegate = function(delegate) {
		n2i.removeFromArray(this.delegates,delegate);
	}
	obj.fire = function(method,value,event) {
		In2iGui.callDelegates(this,method,value,event);
	}
	obj.fireProperty = function(key,value) {
		In2iGui.firePropertyChange(this,key,value);
	}
	if (!obj.getElement) {
		obj.getElement = function() {
			return this.element;
		}
	}
	if (!obj.valueForProperty) {
		obj.valueForProperty = function(p) {return this[p]};
	}
};

In2iGui.callDelegatesDrop = function(dragged,dropped) {
	var gui = In2iGui.get();
	var result = null;
	for (var i=0; i &lt; gui.delegates.length; i++) {
		if (gui.delegates[i]['</span>$drop$<span class="literal">'+dragged.kind+'</span>$<span class="literal">'+dropped.kind]) {
			gui.delegates[i]['</span>$drop$<span class="literal">'+dragged.kind+'</span>$<span class="literal">'+dropped.kind](dragged,dropped);
		}
	}
};

In2iGui.callAncestors = function(obj,method,value,event) {
	if (typeof(value)=='</span>undefined<span class="literal">') value=obj;
	var d = In2iGui.get().getAncestors(obj);
	for (var i=0; i &lt; d.length; i++) {
		if (d[i][method]) {
			d[i][method](value,event);
		}
	};
};

In2iGui.callDescendants = function(obj,method,value,event) {
	if (typeof(value)=='</span>undefined<span class="literal">') {
		value=obj;
	}
	var d = In2iGui.get().getDescendants(obj);
	d.each(function(child) {
		if (child[method]) {
			thisResult = child[method](value,event);
		}
	});
};

In2iGui.callVisible = function(widget) {
	In2iGui.callDescendants(widget,'</span>$visibilityChanged<span class="literal">');
}

In2iGui.addDelegate = In2iGui.observe = function(d) {
	In2iGui.get().addDelegate(d);
}

In2iGui.callDelegates = function(obj,method,value,event) {
	if (typeof(value)=='</span>undefined<span class="literal">') {
		value=obj;
	}
	var result = null;
	if (obj.delegates) {
		for (var i=0; i &lt; obj.delegates.length; i++) {
			var delegate = obj.delegates[i];
			var thisResult = null;
			if (obj.name &amp;&amp; delegate['</span>$<span class="literal">'+method+'</span>$<span class="literal">'+obj.name]) {
				thisResult = delegate['</span>$<span class="literal">'+method+'</span>$<span class="literal">'+obj.name](value,event);
			}/* else if (obj.name &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.name]) {
				thisResult = delegate[method+'</span>$<span class="literal">'+obj.name](value,event);
			} else if ('</span>$<span class="literal">'+obj.name &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.name]) {
				thisResult = delegate['</span>$<span class="literal">'+method+'</span>$<span class="literal">'+obj.name](value,event);
			} else if (obj.kind &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.kind]) {
				thisResult = delegate[method+'</span>$<span class="literal">'+obj.kind](value,event);
			} else if (delegate[method]) {
				thisResult = delegate[method](value,event);
			}*/ else if (delegate['</span>$<span class="literal">'+method]) {
				thisResult = delegate['</span>$<span class="literal">'+method](value,event);
			}
			if (result==null &amp;&amp; thisResult!=null &amp;&amp; typeof(thisResult)!='</span>undefined<span class="literal">') {
				result = thisResult;
			}
		};
	}
	var superResult = In2iGui.callSuperDelegates(obj,method,value,event);
	if (result==null &amp;&amp; superResult!=null) {
		result = superResult;
	}
	return result;
};

In2iGui.callSuperDelegates = function(obj,method,value,event) {
	if (typeof(value)=='</span>undefined<span class="literal">') value=obj;
	var gui = In2iGui.get();
	var result = null;
	for (var i=0; i &lt; gui.delegates.length; i++) {
		var delegate = gui.delegates[i];
		var thisResult = null;
		if (obj.name &amp;&amp; delegate['</span>$<span class="literal">'+method+'</span>$<span class="literal">'+obj.name]) {
			thisResult = delegate['</span>$<span class="literal">'+method+'</span>$<span class="literal">'+obj.name](value,event);
		}/* else if (obj.name &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.name]) {
			thisResult = delegate[method+'</span>$<span class="literal">'+obj.name](value,event);
		} else if (obj.kind &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.kind]) {
			thisResult = delegate[method+'</span>$<span class="literal">'+obj.kind](value,event);
		} else if (delegate[method]) {
			thisResult = delegate[method](value,event);
		}*/ else if (delegate['</span>$<span class="literal">'+method]) {
			thisResult = delegate['</span>$<span class="literal">'+method](value,event);
		}
		if (result==null &amp;&amp; thisResult!=null &amp;&amp; typeof(thisResult)!='</span>undefined<span class="literal">') {
			result = thisResult;
		}
	};
	return result;
};

In2iGui.resolveImageUrl = function(widget,img,width,height) {
	for (var i=0; i &lt; widget.delegates.length; i++) {
		if (widget.delegates[i].$resolveImageUrl) {
			return widget.delegates[i].$resolveImageUrl(img,width,height);
		}
	};
	var gui = In2iGui.get();
	for (var i=0; i &lt; gui.delegates.length; i++) {
		var delegate = gui.delegates[i];
		if (delegate.$resolveImageUrl) {
			return delegate.$resolveImageUrl(img,width,height);
		}
	}
	return null;
};

////////////////////////////// Bindings ///////////////////////////

In2iGui.firePropertyChange = function(obj,name,value) {
	In2iGui.callDelegates(obj,'</span>propertyChanged<span class="literal">',{property:name,value:value});
};

In2iGui.bind = function(expression,delegate) {
	if (expression.charAt(0)=='</span>@<span class="literal">') {
		var pair = expression.substring(1).split('</span>.<span class="literal">');
		var obj = In2iGui.get(pair[0]);
		if (!obj) {
			n2i.log('</span>Unable to bind to <span class="literal">'+expression);
			return;
		}
		var p = pair.slice(1).join('</span>.<span class="literal">');
		obj.addDelegate({
			$propertyChanged : function(prop) {
				if (prop.property==p) {
					delegate(prop.value);
				}
			}
		});
		return obj.valueForProperty(p);
	}
	return expression;
};

//////////////////////////////// Data /////////////////////////////

In2iGui.dwrUpdate = function() {
	var func = arguments[0];
	var delegate = {
  		callback:function(data) { In2iGui.handleDwrUpdate(data) }
	}
	var num = arguments.length;
	if (num==1) {
		func(delegate);
	} else if (num==2) {
		func(arguments[1],delegate);
	} else {
		alert('</span>Too many parameters<span class="literal">');
	}
};

In2iGui.handleDwrUpdate = function(data) {
	var gui = In2iGui.get();
	for (var i=0; i &lt; data.length; i++) {
		if (gui.objects.get(data[i].name)) {
			gui.objects.get(data[i].name).updateFromObject(data[i]);
		}
	};
};

In2iGui.update = function(url,delegate) {
	var dlgt = {
		onSuccess:function(t) {In2iGui.handleUpdate(t,delegate)}
	}
	$get(url,dlgt);
};

In2iGui.handleUpdate = function(t,delegate) {
	var gui = In2iGui.get();
	var doc = t.responseXML.firstChild;
	var children = doc.childNodes;
	for (var i=0; i &lt; children.length; i++) {
		if (children[i].nodeType==1) {
			var name = children[i].getAttribute('</span>name<span class="literal">');
			if (name &amp;&amp; name!='</span><span class="literal">' &amp;&amp; gui.objects.get(name)) {
				gui.objects.get(name).updateFromNode(children[i]);
			}
		}
	};
	delegate.onSuccess();
};

/** @private */
In2iGui.jsonResponse = function(t,key) {
	if (!t.responseXML || !t.responseXML.documentElement) {
		var str = t.responseText.replace(/^\s+|\s+$/g, '</span><span class="literal">');
		if (str.length&gt;0) {
			var json = t.responseText.evalJSON(true);
		} else {
			json = '</span><span class="literal">';
		}
		In2iGui.callDelegates(json,'</span>success$<span class="literal">'+key)
	} else {
		In2iGui.callDelegates(t,'</span>success$<span class="literal">'+key)
	}
};

/** @deprecated */
In2iGui.json = function(data,url,delegateOrKey) {
	var options = {method:'</span>post<span class="literal">',parameters:{},onException:function(e) {throw e}};
	if (typeof(delegateOrKey)=='</span>string<span class="literal">') {
		options.onSuccess=function(t) {In2iGui.jsonResponse(t,delegateOrKey)};
	} else {
		delegate = delegateOrKey;
	}
	for (key in data) {
		options.parameters[key]=Object.toJSON(data[key])
	}
	new Ajax.Request(url,options);
};

In2iGui.jsonRequest = function(o) {
	var options = {method:'</span>post<span class="literal">',parameters:{},onException:function(e) {throw e}};
	if (typeof(o.event)=='</span>string<span class="literal">') {
		options.onSuccess=function(t) {In2iGui.jsonResponse(t,o.event)};
	} else {
		delegate = delegateOrKey;
	}
	for (key in o.parameters) {
		options.parameters[key]=Object.toJSON(o.parameters[key])
	}
	new Ajax.Request(o.url,options)
};

In2iGui.request = function(options) {
	options = n2i.override({method:'</span>post<span class="literal">',parameters:{}},options);
	if (options.json) {
		for (key in options.json) {
			options.parameters[key]=Object.toJSON(options.json[key])
		}
	}
	var onSuccess = options.onSuccess;
	options.onSuccess=function(t) {
		if (typeof(onSuccess)=='</span>string<span class="literal">') {
			In2iGui.jsonResponse(t,onSuccess);
		} else if (t.responseXML &amp;&amp; t.responseXML.documentElement.nodeName!='</span>parsererror<span class="literal">' &amp;&amp; options.onXML) {
			options.onXML(t.responseXML);
		} else if (options.onJSON) {
			var str = t.responseText.replace(/^\s+|\s+$/g, '</span><span class="literal">');
			if (str.length&gt;0) {
				var json = t.responseText.evalJSON(true);
			} else {
				var json = null;
			}
			options.onJSON(json);
		} else if (typeof(onSuccess)=='</span><span class="reserved">function</span><span class="literal">') {
			onSuccess(t);
		}
	};
	var onFailure = options.onFailure;
	options.onFailure = function(t) {
		if (typeof(onFailure)=='</span>string<span class="literal">') {
			In2iGui.callDelegates(t,'</span>failure$<span class="literal">'+onFailure)
		}
	}
	options.onException = function(t,e) {n2i.log(e)};
	new Ajax.Request(options.url,options);
};

In2iGui.parseItems = function(doc) {
	var root = doc.documentElement;
	var out = [];
	In2iGui.parseSubItems(root,out);
	return out;
};

In2iGui.parseSubItems = function(parent,array) {
	var children = parent.childNodes;
	for (var i=0; i &lt; children.length; i++) {
		var node = children[i];
		if (node.nodeType==1 &amp;&amp; node.nodeName=='</span>item<span class="literal">') {
			var sub = [];
			In2iGui.parseSubItems(node,sub);
			array.push({
				title:node.getAttribute('</span>title<span class="literal">'),
				value:node.getAttribute('</span>value<span class="literal">'),
				icon:node.getAttribute('</span>icon<span class="literal">'),
				kind:node.getAttribute('</span>kind<span class="literal">'),
				badge:node.getAttribute('</span>badge<span class="literal">'),
				children:sub
			});
		}
	};
}

////////////////////////////////// Source ///////////////////////////

/** @constructor */
In2iGui.Source = function(o) {
	this.options = n2i.override({url:null,dwr:null,parameters:[]},o);
	this.name = o.name;
	this.data = null;
	this.parameters = this.options.parameters;
	In2iGui.extend(this);
	if (o.delegate) {
		this.addDelegate(o.delegate);
	}
	this.busy=false;
	In2iGui.onDomReady(this.init.bind(this));
};

In2iGui.Source.prototype = {
	init : function() {
		var self = this;
		this.parameters.each(function(parm) {
			parm.value = In2iGui.bind(parm.value,function(value) {
				self.changeParameter(parm.key,value);
			});
		})
		this.refresh();
	},
	refresh : function() {
		if (this.delegates.length==0) return;
		if (this.busy) {
			this.pendingRefresh = true;
			return;
		}
		this.pendingRefresh = false;
		var self = this;
		if (this.options.url) {
			var url = new n2i.URL(this.options.url);
			this.parameters.each(function(p) {
				url.addParameter(p.key,p.value);
			});
			this.busy=true;
			In2iGui.callDelegates(this,'</span>sourceIsBusy<span class="literal">');
			new Ajax.Request(url.toString(), {onSuccess: function(t) {self.parse(t)},onException:function(t,e) {n2i.log(e)}});
		} else if (this.options.dwr) {
			var pair = this.options.dwr.split('</span>.<span class="literal">');
			var facade = eval(pair[0]);
			var method = pair[1];
			var args = facade[method].argumentNames();
			for (var i=0; i &lt; args.length; i++) {
				if (this.parameters[i]) {
					args[i]=this.parameters[i].value===undefined ? null : this.parameters[i].value;
				}
			};
			args[args.length-1]=function(r) {self.parseDWR(r)};
			this.busy=true;
			In2iGui.callDelegates(this,'</span>sourceIsBusy<span class="literal">');
			facade[method].apply(facade,args);
		}
	},
	end : function() {
		In2iGui.callDelegates(this,'</span>sourceIsNotBusy<span class="literal">');
		this.busy=false;
		if (this.pendingRefresh) {
			this.refresh();
		}
	},
	parse : function(t) {
		if (t.responseXML) {
			this.parseXML(t.responseXML);
		}
		this.end();
	},
	parseXML : function(doc) {
		if (doc.documentElement.tagName=='</span>items<span class="literal">') {
			this.data = In2iGui.parseItems(doc);
			this.fire('</span>itemsLoaded<span class="literal">',this.data);
		} else if (doc.documentElement.tagName=='</span>list<span class="literal">') {
			this.fire('</span>listLoaded<span class="literal">',doc);
		} else if (doc.documentElement.tagName=='</span>articles<span class="literal">') {
			this.fire('</span>articlesLoaded<span class="literal">',doc);
		}
	},
	parseDWR : function(data) {
		this.data = data;
		this.fire('</span>objectsLoaded<span class="literal">',data);
		this.end();
	},
	addParameter : function(parm) {
		this.parameters.push(parm);
	},
	changeParameter : function(key,value) {
		this.parameters.each(function(p) {
			if (p.key==key) p.value=value;
		})
		var self = this;
		window.clearTimeout(this.paramDelay);
		this.paramDelay = window.setTimeout(function() {
			this.refresh();
		}.bind(this),100)
	}
}


//////////////////////////// Prototype extensions ////////////////////////////////

Element.addMethods({
	setClassName : function(element,name,set) {
		if (set) {
			element.addClassName(name);
		} else {
			element.removeClassName(name);
		}
		return element;
	}
});

/* EOF */
/**
 * @constructor
 */
In2iGui.Window = function(options) {
	this.element = $(options.element);
	this.name = options.name;
	this.close = this.element.select('</span>.in2igui_window_close<span class="literal">')[0];
	this.titlebar = this.element.select('</span>.in2igui_window_titlebar<span class="literal">')[0];
	this.title = this.titlebar.select('</span>.in2igui_window_title<span class="literal">')[0];
	this.content = this.element.select('</span>.in2igui_window_body<span class="literal">')[0];
	this.visible = false;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Window.create = function(options) {
	options = n2i.override({title:'</span>Window<span class="literal">',close:true},options);
	var element = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_window<span class="literal">'+(options.variant ? '</span> in2igui_window_<span class="literal">'+options.variant : '</span><span class="literal">')});
	var html = (options.close ? '</span>&lt;div class=<span class="literal">"in2igui_window_close"</span>&gt;&lt;/div&gt;<span class="literal">' : '</span><span class="literal">')+
		'</span>&lt;div class=<span class="literal">"in2igui_window_titlebar"</span>&gt;&lt;div&gt;&lt;div&gt;<span class="literal">';
		if (options.icon) {
			html+='</span>&lt;span class=<span class="literal">"in2igui_window_icon"</span> style=<span class="literal">"background-image: url('+In2iGui.getIconUrl(options.icon,1)+')"</span>&gt;&lt;/span&gt;<span class="literal">';
		}
	html+='</span>&lt;span class=<span class="literal">"in2igui_window_title"</span>&gt;<span class="literal">'+options.title+'</span>&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"in2igui_window_content"</span>&gt;&lt;div class=<span class="literal">"in2igui_window_content"</span>&gt;&lt;div class=<span class="literal">"in2igui_window_body"</span> style=<span class="literal">"'+
		(options.width ? 'width:'+options.width+'px;':'')+
		(options.padding ? 'padding:'+options.padding+'px;':'')+
		'"</span>&gt;<span class="literal">'+
		'</span>&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"in2igui_window_bottom"</span>&gt;&lt;div class=<span class="literal">"in2igui_window_bottom"</span>&gt;&lt;div class=<span class="literal">"in2igui_window_bottom"</span>&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">';
	element.update(html);
	document.body.appendChild(element);
	return new In2iGui.Window(options);
}

In2iGui.Window.prototype = {
	addBehavior : function() {
		var self = this;
		if (this.close) {
			this.close.observe('</span>click<span class="literal">',function(e) {
				this.hide();
				this.fire('</span>userClosedWindow<span class="literal">');
			}.bind(this)
			).observe('</span>mousedown<span class="literal">',function(e) {e.stop();});
		}
		this.titlebar.onmousedown = function(e) {self.startDrag(e);return false;};
		this.element.observe('</span>mousedown<span class="literal">',function() {
			self.element.style.zIndex=In2iGui.nextPanelIndex();
		})
	},
	setTitle : function(title) {
		this.title.update(title);
	},
	show : function() {
		if (this.visible) return;
		this.element.setStyle({
			zIndex : In2iGui.nextPanelIndex(), visibility : '</span>hidden<span class="literal">', display : '</span>block<span class="literal">', top: (n2i.getScrollTop()+40)+'</span>px<span class="literal">'
		})
		var width = this.element.clientWidth;
		this.element.setStyle({
			width : width+'</span>px<span class="literal">' , visibility : '</span>visible<span class="literal">'
		});
		if (!n2i.browser.msie) {
			n2i.ani(this.element,'</span>opacity<span class="literal">',1,0);
		}
		this.visible = true;
		In2iGui.callDescendants(this,'</span>parentShown<span class="literal">');
		In2iGui.callVisible(this);
	},
	toggle : function() {
		(this.visible ? this.hide() : this.show() );
	},
	hide : function() {
		if (!this.visible) return;
		if (!n2i.browser.msie) {
			n2i.ani(this.element,'</span>opacity<span class="literal">',0,200,{hideOnComplete:true});
		} else {
			this.element.setStyle({display:'</span>none<span class="literal">'});
		}
		this.visible = false;
	},
	add : function(widgetOrNode) {
		if (widgetOrNode.getElement) {
			this.content.insert(widgetOrNode.getElement());
		} else {
			this.content.insert(widgetOrNode);
		}
	},
	setVariant : function(variant) {
		this.element.removeClassName('</span>in2igui_window_dark<span class="literal">');
		this.element.removeClassName('</span>in2igui_window_light<span class="literal">');
		if (variant=='</span>dark<span class="literal">' || variant=='</span>light<span class="literal">') {
			this.element.addClassName('</span>in2igui_window_<span class="literal">'+variant);
		}
	},

////////////////////////////// Dragging ////////////////////////////////

	startDrag : function(e) {
		var event = Event.extend(e || window.event);
		this.element.style.zIndex=In2iGui.nextPanelIndex();
		var pos = this.element.cumulativeOffset();
		this.dragState = {left:event.pointerX()-pos.left,top:event.pointerY()-pos.top};
		this.latestPosition = {left: this.dragState.left, top:this.dragState.top};
		this.latestTime = new Date().getMilliseconds();
		var self = this;
		this.moveListener = function(e) {self.drag(e)};
		this.upListener = function(e) {self.endDrag(e)};
		Event.observe(document,'</span>mousemove<span class="literal">',this.moveListener);
		Event.observe(document,'</span>mouseup<span class="literal">',this.upListener);
		Event.observe(document,'</span>mousedown<span class="literal">',this.upListener);
		event.stop();
		document.body.onselectstart = function () { return false; };
		return false;
	},
	calc : function(top,left) {
		// TODO: No need to do this all the time
		this.a = this.latestPosition.left-left;
		this.b = this.latestPosition.top-top;
		this.dist = Math.sqrt(Math.pow((this.a),2),Math.pow((this.b),2));
		this.latestTime = new Date().getMilliseconds();
		this.latestPosition = {'</span>top<span class="literal">':top,'</span>left<span class="literal">':left};
	},
	drag : function(e) {
		var event = Event.extend(e);
		this.element.style.right = '</span>auto<span class="literal">';
		var top = (event.pointerY()-this.dragState.top);
		var left = (event.pointerX()-this.dragState.left);
		this.element.style.top = Math.max(top,0)+'</span>px<span class="literal">';
		this.element.style.left = Math.max(left,0)+'</span>px<span class="literal">';
		//this.calc(top,left);
		return false;
	},
	endDrag : function(e) {
		Event.stopObserving(document,'</span>mousemove<span class="literal">',this.moveListener);
		Event.stopObserving(document,'</span>mouseup<span class="literal">',this.upListener);
		Event.stopObserving(document,'</span>mousedown<span class="literal">',this.upListener);
		document.body.onselectstart = null;
	}
}

/* EOF *//**
 * @class
 * This is a formula
 */
In2iGui.Formula = function(options) {
	this.options = options;
	In2iGui.extend(this,options);
	this.addBehavior();
}

/** @static Creates a new formula */
In2iGui.Formula.create = function(o) {
	o = o || {};
	var atts = {'</span>class<span class="literal">':'</span>in2igui_formula<span class="literal">'};
	if (o.action) {
		atts.action=o.action;
	}
	if (o.method) {
		atts.method=o.method;
	}
	o.element = new Element('</span>form<span class="literal">',atts);
	return new In2iGui.Formula(o);
}

In2iGui.Formula.prototype = {
	/** @private */
	addBehavior : function() {
		this.element.onsubmit=function() {return false;};
	},
	submit : function() {
		this.fire('</span>submit<span class="literal">');
	},
	/** Returns a map of all values of descendants */
	getValues : function() {
		var data = {};
		var d = In2iGui.get().getDescendants(this);
		for (var i=0; i &lt; d.length; i++) {
			if (d[i].options &amp;&amp; d[i].options.key &amp;&amp; d[i].getValue) {
				data[d[i].options.key] = d[i].getValue();
			} else if (d[i].name &amp;&amp; d[i].getValue) {
				data[d[i].name] = d[i].getValue();
			}
		};
		return data;
	},
	/** Sets the values of the descendants */
	setValues : function(values) {
		var d = In2iGui.get().getDescendants(this);
		for (var i=0; i &lt; d.length; i++) {
			if (d[i].options &amp;&amp; d[i].options.key) {
				var key = d[i].options.key;
				if (key &amp;&amp; values[key]!=undefined) {
					d[i].setValue(values[key]);
				}
			}
		}
	},
	/** Sets focus in the first found child */
	focus : function() {
		var d = In2iGui.get().getDescendants(this);
		for (var i=0; i &lt; d.length; i++) {
			if (d[i].focus) {
				d[i].focus();
				return;
			}
		}
	},
	/** Resets all descendants */
	reset : function() {
		var d = In2iGui.get().getDescendants(this);
		for (var i=0; i &lt; d.length; i++) {
			if (d[i].reset) d[i].reset();
		}
	},
	/** Adds a widget to the form */
	add : function(widget) {
		this.element.insert(widget.getElement());
	},
	/** Creates a new form group and adds it to the form
	 * @returns {'</span>In2iGui.Formula.Group<span class="literal">'} group
	 */
	createGroup : function(options) {
		var g = In2iGui.Formula.Group.create(options);
		this.add(g);
		return g;
	},
	/** Builds and adds a new group according to a recipe
	 * @returns {'</span>In2iGui.Formula.Group<span class="literal">'} group
	 */
	buildGroup : function(options,recipe) {
		var g = this.createGroup(options);
		recipe.each(function(item) {
			if (In2iGui.Formula[item.type]) {
				var w = In2iGui.Formula[item.type].create(item.options);
				g.add(w);
			}
		});
		return g;
	},
	/** @private */
	childValueChanged : function(value) {
		this.fire('</span>valuesChanged<span class="literal">',this.getValues());
	}
}

///////////////////////// Group //////////////////////////


/**
 * A form group
 * @constructor
 */
In2iGui.Formula.Group = function(options) {
	this.name = options.name;
	this.element = $(options.element);
	this.body = this.element.select('</span>tbody<span class="literal">')[0];
	this.options = n2i.override({above:true},options);
	In2iGui.extend(this);
}

/** Creates a new form group */
In2iGui.Formula.Group.create = function(options) {
	options = n2i.override({above:true},options);
	var element = options.element = new Element('</span>table<span class="literal">',
		{'</span>class<span class="literal">':'</span>in2igui_formula_group<span class="literal">'}
	);
	if (options.above) {
		element.addClassName('</span>in2igui_formula_group_above<span class="literal">');
	}
	element.insert(new Element('</span>tbody<span class="literal">'));
	return new In2iGui.Formula.Group(options);
}

In2iGui.Formula.Group.prototype = {
	add : function(widget) {
		var tr = new Element('</span>tr<span class="literal">');
		this.body.insert(tr);
		if (widget.getLabel) {
			var label = widget.getLabel();
			if (label) {
				var th = new Element('</span>th<span class="literal">');
				th.insert(new Element('</span>label<span class="literal">').insert(label));
				tr.insert(th);
			}
		}
		var td = new Element('</span>td<span class="literal">');
		td.insert(new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_formula_item<span class="literal">'}).insert(widget.getElement()));
		if (this.options.above) {
			tr = new Element('</span>tr<span class="literal">');
			this.body.insert(tr);
		}
		tr.insert(td);
	},
	createButtons : function(options) {
		var tr = new Element('</span>tr<span class="literal">');
		this.body.insert(tr);
		var td = new Element('</span>td<span class="literal">',{colspan:this.options.above?1:2});
		tr.insert(td);
		var b = In2iGui.Buttons.create(options);
		td.insert(b.getElement());
		return b;
	}
}

///////////////////////// Text /////////////////////////

/**
 * A text fields
 * @constructor
 */
In2iGui.Formula.Text = function(options) {
	this.options = n2i.override({label:null,key:null,lines:1,live:false},options);
	this.element = $(options.element);
	this.name = options.name;
	In2iGui.extend(this);
	this.input = this.element.select('</span>.in2igui_formula_text<span class="literal">')[0];
	this.placeholder = this.element.select('</span>.in2igui_field_placeholder<span class="literal">')[0];
	this.value = this.input.value;
	if (this.placeholder) {
		var self = this;
		In2iGui.onDomReady(function() {
			window.setTimeout(function() {
				self.value = self.input.value;
				self.updateClass();
			},500);
		});
	}
	this.addBehavior();
}

In2iGui.Formula.Text.create = function(options) {
	options = n2i.override({lines:1},options);
	var node,input;
	if (options.lines&gt;1) {
		input = new Element('</span>textarea<span class="literal">',
			{'</span>class<span class="literal">':'</span>in2igui_formula_text<span class="literal">','</span>rows<span class="literal">':options.lines}
		);
		node = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_formula_text_multiline<span class="literal">'}).insert(input);
	} else {
		input = new Element('</span>input<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_formula_text<span class="literal">'});
		node = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_formula_text_singleline<span class="literal">'}).insert(input);
	}
	if (options.value!==undefined) {
		input.value=options.value;
	}
	options.element = In2iGui.wrapInField(node);
	return new In2iGui.Formula.Text(options);
}

In2iGui.Formula.Text.prototype = {
	/** @private */
	addBehavior : function() {
		In2iGui.addFocusClass({element:this.input,classElement:this.element,'</span>class<span class="literal">':'</span>in2igui_field_focused<span class="literal">'});
		this.input.observe('</span>keyup<span class="literal">',this.onKeyUp.bind(this));
		var p = this.element.select('</span>em<span class="literal">')[0];
		if (p) {
			this.updateClass();
			p.observe('</span>mousedown<span class="literal">',function(){window.setTimeout(function() {this.input.focus();this.input.select();}.bind(this))}.bind(this));
			p.observe('</span>mouseup<span class="literal">',function(){this.input.focus();this.input.select();}.bind(this));
		}
	},
	updateClass : function() {
		this.element.setClassName('</span>in2igui_field_dirty<span class="literal">',this.value.length&gt;0);
	},
	/** @private */
	onKeyUp : function(e) {
		if (this.options.lines&lt;2 &amp;&amp; e.keyCode===Event.KEY_RETURN) {
			this.fire('</span>submit<span class="literal">');
			var form = In2iGui.get().getAncestor(this,'</span>in2igui_formula<span class="literal">');
			if (form) {form.submit();}
			return;
		}
		if (this.input.value==this.value) {return;}
		this.value=this.input.value;
		this.updateClass();
		In2iGui.callAncestors(this,'</span>childValueChanged<span class="literal">',this.input.value);
		this.fire('</span>valueChanged<span class="literal">',this.input.value);
	},
	updateFromNode : function(node) {
		if (node.firstChild) {
			this.setValue(node.firstChild.nodeValue);
		} else {
			this.setValue(null);
		}
	},
	updateFromObject : function(data) {
		this.setValue(data.value);
	},
	focus : function() {
		try {
			this.input.focus();
		} catch (e) {}
	},
	select : function() {
		try {
			this.input.focus();
			this.input.select();
		} catch (e) {}
	},
	reset : function() {
		this.setValue('</span><span class="literal">');
	},
	setValue : function(value) {
		if (value===undefined || value===null) {
			value='</span><span class="literal">';
		}
		this.value = value;
		this.input.value = value;
	},
	getValue : function() {
		return this.input.value;
	},
	getLabel : function() {
		return this.options.label;
	},
	isEmpty : function() {
		return this.input.value=='</span><span class="literal">';
	},
	isBlank : function() {
		return this.input.value.strip()=='</span><span class="literal">';
	},
	setError : function(error) {
		var isError = error ? true : false;
		this.element.setClassName('</span>in2igui_field_error<span class="literal">',isError);
		if (typeof(error) == '</span>string<span class="literal">') {
			In2iGui.showToolTip({text:error,element:this.element,key:this.name});
		}
		if (!isError) {
			In2iGui.hideToolTip({key:this.name});
		}
	}
}

/////////////////////////// Date time /////////////////////////

/**
 * A date and time field
 * @constructor
 */
In2iGui.Formula.DateTime = function(o) {
	this.inputFormats = ['</span>d-m-Y<span class="literal">','</span>d/m-Y<span class="literal">','</span>d/m/Y<span class="literal">','</span>d-m-Y H:i:s<span class="literal">','</span>d/m-Y H:i:s<span class="literal">','</span>d/m/Y H:i:s<span class="literal">','</span>d-m-Y H:i<span class="literal">','</span>d/m-Y H:i<span class="literal">','</span>d/m/Y H:i<span class="literal">','</span>d-m-Y H<span class="literal">','</span>d/m-Y H<span class="literal">','</span>d/m/Y H<span class="literal">','</span>d-m<span class="literal">','</span>d/m<span class="literal">','</span>d<span class="literal">','</span>Y<span class="literal">','</span>m-d-Y<span class="literal">','</span>m-d<span class="literal">','</span>m/d<span class="literal">'];
	this.outputFormat = '</span>d-m-Y H:i:s<span class="literal">';
	this.name = o.name;
	this.element = $(o.element);
	this.input = this.element.select('</span>input<span class="literal">')[0];
	this.options = n2i.override({returnType:null,label:null,allowNull:true,value:null},o);
	this.value = this.options.value;
	In2iGui.extend(this);
	this.addBehavior();
	this.updateUI();
}

In2iGui.Formula.DateTime.create = function(options) {
	var input = new Element('</span>input<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_formula_text<span class="literal">'});
	var node = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_formula_text_singleline<span class="literal">'}).insert(input);
	options.element = In2iGui.wrapInField(node);
	return new In2iGui.Formula.DateTime(options);
}

In2iGui.Formula.DateTime.prototype = {
	addBehavior : function() {
		In2iGui.addFocusClass({element:this.input,classElement:this.element,'</span>class<span class="literal">':'</span>in2igui_field_focused<span class="literal">'});
		this.input.observe('</span>blur<span class="literal">',this.check.bind(this));
	},
	updateFromNode : function(node) {
		if (node.firstChild) {
			this.setValue(node.firstChild.nodeValue);
		} else {
			this.setValue(null);
		}
	},
	updateFromObject : function(data) {
		this.setValue(data.value);
	},
	focus : function() {
		try {this.input.focus();} catch (ignore) {}
	},
	reset : function() {
		this.setValue('</span><span class="literal">');
	},
	setValue : function(value) {
		if (!value) {
			this.value = null;
		} else if (value.constructor==Date) {
			this.value = value;
		} else {
			this.value = new Date();
			this.value.setTime(parseInt(value)*1000);
		}
		this.updateUI();
	},
	check : function() {
		var str = this.input.value;
		var parsed = null;
		for (var i=0; i &lt; this.inputFormats.length &amp;&amp; parsed==null; i++) {
			parsed = Date.parseDate(str,this.inputFormats[i]);
		};
		if (this.options.allowNull || parsed!=null) {
			this.value = parsed;
		}
		this.updateUI();
	},
	getValue : function() {
		if (this.value!=null &amp;&amp; this.options.returnType=='</span>seconds<span class="literal">') {
			return Math.round(this.value.getTime()/1000);
		}
		return this.value;
	},
	getElement : function() {
		return this.element;
	},
	getLabel : function() {
		return this.options.label;
	},
	updateUI : function() {
		if (this.value) {
			this.input.value = this.value.dateFormat(this.outputFormat);
		} else {
			this.input.value = '</span><span class="literal">'
		}
	}
}

/////////////////////////// Number /////////////////////////

/**
 * A date and time field
 * @constructor
 */
In2iGui.Formula.Number = function(o) {
	this.options = n2i.override({min:0,max:10000,value:null,decimals:0,allowNull:false},o);	
	this.name = o.name;
	var e = this.element = $(o.element);
	this.input = e.select('</span>input<span class="literal">')[0];
	this.up = e.select('</span>.in2igui_number_up<span class="literal">')[0];
	this.down = e.select('</span>.in2igui_number_down<span class="literal">')[0];
	this.value = this.options.value;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Formula.Number.create = function(o) {
	var e = o.element = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_number<span class="literal">'});
	e.update('</span>&lt;span&gt;&lt;span&gt;&lt;input type=<span class="literal">"text"</span> value=<span class="literal">"'+(o.value!==undefined ? o.value : '0')+'"</span>/&gt;&lt;a class=<span class="literal">"in2igui_number_up"</span>&gt;&lt;/a&gt;&lt;a class=<span class="literal">"in2igui_number_down"</span>&gt;&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">');
	return new In2iGui.Formula.Number(o);
}

In2iGui.Formula.Number.prototype = {
	addBehavior : function() {
		var e = this.element;
		this.input.observe('</span>focus<span class="literal">',function() {e.addClassName('</span>in2igui_number_focused<span class="literal">')});
		this.input.observe('</span>blur<span class="literal">',this.blurEvent.bind(this));
		this.input.observe('</span>keyup<span class="literal">',this.keyEvent.bind(this));
		//this.input.observe('</span>keypress<span class="literal">',this.keyEvent.bind(this));
		this.up.observe('</span>mousedown<span class="literal">',this.upEvent.bind(this));
		this.down.observe('</span>mousedown<span class="literal">',this.downEvent.bind(this));
	},
	blurEvent : function() {
		this.element.removeClassName('</span>in2igui_number_focused<span class="literal">');
		this.input.value = this.value;
	},
	keyEvent : function(e) {
		if (e.keyCode==Event.KEY_UP) {
			e.stop();
			this.upEvent();
		} else if (e.keyCode==Event.KEY_DOWN) {
			this.downEvent();
		} else {
			var parsed = parseInt(this.input.value,10);
			if (!isNaN(parsed)) {
				this.setLocalValue(parsed);
			}
		}
	},
	downEvent : function() {
		if (this.value===null) {
			this.setValue(this.options.min);
		} else {
			this.setValue(this.value-1);
		}
	},
	upEvent : function() {
		this.setValue(this.value+1);
	},
	getValue : function() {
		return this.value;
	},
	getLabel : function() {
		return this.options.label;
	},
	setValue : function(value) {
		this.setLocalValue(value);
		this.input.value = this.value;
	},
	setLocalValue : function(value) {
		this.value = Math.min(Math.max(value,this.options.min),this.options.max);
		In2iGui.callAncestors(this,'</span>childValueChanged<span class="literal">',this.value);
		this.fire('</span>valueChanged<span class="literal">',this.value);
	}
}

////////////////////////// DropDown ///////////////////////////

/**
 * A drop down selector
 * @constructor
 */
In2iGui.Formula.DropDown = function(o) {
	this.options = n2i.override({label:null,placeholder:null,url:null,source:null},o);
	this.name = o.name;
	var e = this.element = $(o.element);
	this.inner = e.select('</span>strong<span class="literal">')[0];
	this.items = o.items || [];
	this.index = -1;
	this.value = this.options.value || null;
	this.dirty = true;
	In2iGui.extend(this);
	this.addBehavior();
	this.updateIndex();
	this.updateUI();
	if (this.options.url) {
		this.options.source = new In2iGui.Source({url:this.options.url,delegate:this});
	} else if (this.options.source) {
		this.options.source.addDelegate(this);	
	}
}

In2iGui.Formula.DropDown.create = function(o) {
	o = o || {};
	o.element = new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_dropdown<span class="literal">',href:'</span>#<span class="literal">'}).update(
		'</span>&lt;span&gt;&lt;span&gt;&lt;strong&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">'
	);
	return new In2iGui.Formula.DropDown(o);
}

In2iGui.Formula.DropDown.prototype = {
	addBehavior : function() {
		In2iGui.addFocusClass({element:this.element,'</span>class<span class="literal">':'</span>in2igui_dropdown_focused<span class="literal">'});
		this.element.observe('</span>click<span class="literal">',this.clicked.bind(this));
		this.element.observe('</span>blur<span class="literal">',this.hideSelector.bind(this));
	},
	updateIndex : function() {
		this.index=-1;
		this.items.each(function(item,i) {
			if (item.value==this.value) this.index=i;
		}.bind(this));
	},
	updateUI : function() {
		var selected = this.items[this.index];
		if (selected) {
			this.inner.update(selected.label || selected.title);
		} else if (this.options.placeholder) {
			this.inner.update(new Element('</span>em<span class="literal">').update(this.options.placeholder.escapeHTML()));
		} else {
			this.inner.update();
		}
		if (!this.selector) return;
		this.selector.select('</span>a<span class="literal">').each(function(a,i) {
			if (this.index==i) {
				a.addClassName('</span>in2igui_selected<span class="literal">');
			}
			else a.className='</span><span class="literal">';
		}.bind(this));
	},
	clicked : function(e) {
		e.stop();
		this.buildSelector();
		var el = this.element,s=this.selector;
		el.focus();
		if (!this.items) return;
		In2iGui.positionAtElement(s,el,{vertical:'</span>bottomOutside<span class="literal">',top:-2,left:2});
		s.setStyle({visibility:'</span>hidden<span class="literal">',display:'</span>block<span class="literal">',width:'</span><span class="literal">'});
		var width = Math.max(el.getWidth()-5,100,s.getWidth());
		var space = n2i.getDocumentWidth()-el.cumulativeOffset().left-20;
		width = Math.min(width,space);
		s.setStyle({visibility:'</span>visible<span class="literal">',width:width+'</span>px<span class="literal">',zIndex:In2iGui.nextTopIndex(),maxHeight:'</span>200px<span class="literal">'});
	},
	getValue : function(value) {
		return this.value;
	},
	setValue : function(value) {
		this.value = value;
		this.updateIndex();
		this.updateUI();
	},
	reset : function() {
		this.setValue(null);
	},
	getLabel : function() {
		return this.options.label;
	},
	refresh : function() {
		if (this.options.source) {
			this.options.source.refresh();
		}
	},
	addItem : function(item) {
		this.items.push(item);
		this.dirty = true;
		this.updateIndex();
		this.updateUI();
	},
	setItems : function(items) {
		this.items = items;
		this.dirty = true;
		this.index = -1;
		this.updateIndex();
		this.updateUI();
	},
	$itemsLoaded : function(items) {
		this.setItems(items);
	},
	hideSelector : function() {
		if (!this.selector) return;
		this.selector.hide();
	},
	buildSelector : function() {
		if (!this.dirty || !this.items) return;
		if (!this.selector) {
			this.selector = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_dropdown_selector<span class="literal">'});
			document.body.appendChild(this.selector);
		} else {
			this.selector.update();
		}
		var self = this;
		this.items.each(function(item,i) {
			var e = new Element('</span>a<span class="literal">',{href:'</span>#<span class="literal">'}).update(item.label || item.title).observe('</span>mousedown<span class="literal">',function(e) {
				e.stop();
				self.itemClicked(item,i);
			})
			if (i==self.index) e.addClassName('</span>in2igui_selected<span class="literal">');
			self.selector.insert(e);
		});
		this.dirty = false;
	},
	itemClicked : function(item,index) {
		this.index = index;
		var changed = this.value!=this.items[index].value;
		this.value = this.items[index].value;
		this.updateUI();
		this.hideSelector();
		if (changed) {
			In2iGui.callAncestors(this,'</span>childValueChanged<span class="literal">',this.value);
			this.fire('</span>valueChanged<span class="literal">',this.value);
		}
	}
}


//////////////////////////// Radio buttons ////////////////////////////

/**
 * @constructor
 */
In2iGui.Formula.Radiobuttons = function(options) {
	this.options = options;
	this.element = $(options.element);
	this.name = options.name;
	this.radios = [];
	this.value = options.value;
	this.defaultValue = this.value;
	In2iGui.extend(this);
}

In2iGui.Formula.Radiobuttons.prototype = {
	click : function() {
		this.value = !this.value;
		this.updateUI();
	},
	/** @private */
	updateUI : function() {
		for (var i=0; i &lt; this.radios.length; i++) {
			var radio = this.radios[i];
			$(radio.id).setClassName('</span>in2igui_selected<span class="literal">',radio.value==this.value);
		};
	},
	setValue : function(value) {
		this.value = value;
		this.updateUI();
	},
	getValue : function() {
		return this.value;
	},
	reset : function() {
		this.setValue(this.defaultValue);
	},
	registerRadiobutton : function(radio) {
		this.radios.push(radio);
		var element = $(radio.id);
		var self = this;
		element.onclick = function() {
			self.setValue(radio.value);
		}
	}
}


///////////////////////////// Checkbox /////////////////////////////////

/**
 * A check box
 * @constructor
 */
In2iGui.Formula.Checkbox = function(o) {
	this.element = $(o.element);
	this.control = this.element.select('</span>span<span class="literal">')[0];
	this.options = o;
	this.name = o.name;
	this.value = o.value==='</span>true<span class="literal">' || o.value===true;
	In2iGui.extend(this);
	this.addBehavior();
}

/**
 * Creates a new checkbox
 */
In2iGui.Formula.Checkbox.create = function(o) {
	var e = o.element = new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_checkbox<span class="literal">',href:'</span>#<span class="literal">'});
	if (o.value) {
		e.addClassName('</span>in2igui_checkbox_selected<span class="literal">');
	}
	e.update('</span>&lt;span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">');
	return new In2iGui.Formula.Checkbox(o);
}

In2iGui.Formula.Checkbox.prototype = {
	/** @private */
	addBehavior : function() {
		In2iGui.addFocusClass({element:this.element,'</span>class<span class="literal">':'</span>in2igui_checkbox_focused<span class="literal">'});
		this.element.observe('</span>click<span class="literal">',this.click.bind(this));
	},
	/** @private */
	click : function(e) {
		e.stop();
		this.element.focus();
		this.value = !this.value;
		this.updateUI();
		In2iGui.callAncestors(this,'</span>childValueChanged<span class="literal">',this.value);
		this.fire('</span>valueChanged<span class="literal">',this.value);
	},
	/** @private */
	updateUI : function() {
		this.element.setClassName('</span>in2igui_checkbox_selected<span class="literal">',this.value);
	},
	/** Sets the value
	 * @param {Boolean} value Whether the checkbox is checked
	 */
	setValue : function(value) {
		this.value = value;
		this.updateUI();
	},
	/** Gets the value
	 * @return {Boolean} Whether the checkbox is checked
	 */
	getValue : function() {
		return this.value;
	},
	/** Resets the checkbox */
	reset : function() {
		this.setValue(false);
	},
	/** Gets the label
	 * @return {String} The checkbox label
	 */
	getLabel : function() {
		return this.options.label;
	}
}

/////////////////////////// Checkboxes ////////////////////////////////

/**
 * Multiple checkboxes
 * @constructor
 */
In2iGui.Formula.Checkboxes = function(o) {
	this.options = o;
	this.element = $(o.element);
	this.name = o.name;
	this.items = o.items || [];
	this.sources = [];
	this.subItems = [];
	this.values = o.values || o.value || []; // values is deprecated
	n2i.log(this.values);
	In2iGui.extend(this);
	this.addBehavior();
	this.updateUI();
	if (o.url) {
		new In2iGui.Source({url:o.url,delegate:this});
	}
}

In2iGui.Formula.Checkboxes.create = function(o) {
	o.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':o.vertical ? '</span>in2igui_checkboxes in2igui_checkboxes_vertical<span class="literal">' : '</span>in2igui_checkboxes<span class="literal">'});
	if (o.items) {
		o.items.each(function(item) {
			var node = new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_checkbox<span class="literal">',href:'</span>javascript:void(0);<span class="literal">'}).update(
				'</span>&lt;span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">'+item.title
			);
			In2iGui.addFocusClass({element:node,'</span>class<span class="literal">':'</span>in2igui_checkbox_focused<span class="literal">'});
			o.element.insert(node);
		});
	}
	return new In2iGui.Formula.Checkboxes(o);
}

In2iGui.Formula.Checkboxes.prototype = {
	addBehavior : function() {
		this.element.select('</span>a.in2igui_checkbox<span class="literal">').each(function(check,i) {
			check.observe('</span>click<span class="literal">',function(e) {
				e.stop();
				this.flipValue(this.items[i].value);
			}.bind(this))
		}.bind(this));
	},
	getValue : function() {
		return this.values;
	},
	/** @deprecated */
	getValues : function() {
		return this.values;
	},
	checkValues : function() {
		var newValues = [];
		for (var i=0; i &lt; this.values.length; i++) {
			var value = this.values[i];
			var found = false;
			for (var j=0; j &lt; this.items.length; j++) {
				found = found || this.items[j].value===value;
			}
			for (var j=0; j &lt; this.subItems.length; j++) {
				found = found || this.subItems[j].hasValue(value);
			};
			if (found) {
				newValues.push(value);
			}
		};
		this.values=newValues;
	},
	setValue : function(values) {
		this.values=values;
		this.checkValues();
		this.updateUI();
	},
	/** @deprecated */
	setValues : function(values) {
		this.setValue(values);
	},
	flipValue : function(value) {
		n2i.flipInArray(this.values,value);
		this.checkValues();
		this.updateUI();
		this.fire('</span>valueChanged<span class="literal">',this.values);
		In2iGui.callAncestors(this,'</span>childValueChanged<span class="literal">',this.values);
	},
	updateUI : function() {
		for (var i=0; i &lt; this.subItems.length; i++) {
			this.subItems[i].updateUI();
		};
		var nodes = this.element.select('</span>a.in2igui_checkbox<span class="literal">');
		this.items.each(function(item,i) {
			nodes[i].setClassName('</span>in2igui_checkbox_selected<span class="literal">',this.values.indexOf(item.value)!==-1);
		}.bind(this));
	},
	refresh : function() {
		for (var i=0; i &lt; this.subItems.length; i++) {
			this.subItems[i].refresh();
		};
	},
	reset : function() {
		this.setValues([]);
	},
	registerSource : function(source) {
		source.parent = this;
		this.sources.push(source);
	},
	registerItems : function(items) {
		items.parent = this;
		this.subItems.push(items);
	},
	getLabel : function() {
		return this.options.label;
	},
	$itemsLoaded : function(items) {
		items.each(function(item) {
			var node = new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_checkbox<span class="literal">',href:'</span>javascript:void(0);<span class="literal">'}).update(
				'</span>&lt;span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">'+item.title
			);
			node.observe('</span>click<span class="literal">',function(e) {
				e.stop();
				this.flipValue(item.value);
			}.bind(this))
			In2iGui.addFocusClass({element:node,'</span>class<span class="literal">':'</span>in2igui_checkbox_focused<span class="literal">'});
			this.element.insert(node);
			this.items.push(item);
		}.bind(this));
		this.checkValues();
		this.updateUI();
	}
}

/////////////////////// Checkbox items ///////////////////

/**
 * Check box items
 * @constructor
 */
In2iGui.Formula.Checkboxes.Items = function(options) {
	this.element = $(options.element);
	this.name = options.name;
	this.parent = null;
	this.options = options;
	this.checkboxes = [];
	In2iGui.extend(this);
	if (this.options.source) {
		this.options.source.addDelegate(this);
	}
}

In2iGui.Formula.Checkboxes.Items.prototype = {
	refresh : function() {
		if (this.options.source) {
			this.options.source.refresh();
		}
	},
	$itemsLoaded : function(items) {
		this.checkboxes = [];
		this.element.update();
		var self = this;
		items.each(function(item) {
			var node = new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_checkbox<span class="literal">',href:'</span>#<span class="literal">'}).update(
				'</span>&lt;span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;<span class="literal">'+item.title
			).observe('</span>click<span class="literal">',function(e) {e.stop();node.focus();self.itemWasClicked(item)});
			In2iGui.addFocusClass({element:node,'</span>class<span class="literal">':'</span>in2igui_checkbox_focused<span class="literal">'});
			self.element.insert(node);
			self.checkboxes.push({title:item.title,element:node,value:item.value});
		})
		this.parent.checkValues();
		this.updateUI();
	},
	itemWasClicked : function(item) {
		this.parent.flipValue(item.value);
	},
	updateUI : function() {
		for (var i=0; i &lt; this.checkboxes.length; i++) {
			var item = this.checkboxes[i];
			item.element.setClassName('</span>in2igui_checkbox_selected<span class="literal">',this.parent.values.indexOf(item.value)!=-1);
		};
	},
	hasValue : function(value) {
		for (var i=0; i &lt; this.checkboxes.length; i++) {
			if (this.checkboxes[i].value==value) {
				return true;
			}
		};
		return false;
	}
}

///////////////////////// Tokens //////////////////////////////

/**
 * A tokens component
 * @constructor
 */
In2iGui.Formula.Tokens = function(o) {
	this.options = n2i.override({label:null,key:null},o);
	this.element = $(o.element);
	this.name = o.name;
	this.value = ['</span><span class="literal">'];
	In2iGui.extend(this);
	this.updateUI();
}

In2iGui.Formula.Tokens.create = function(o) {
	o = o || {};
	o.element = new Element('</span>div<span class="literal">').addClassName('</span>in2igui_tokens<span class="literal">');
	return new In2iGui.Formula.Tokens(o);
}

In2iGui.Formula.Tokens.prototype = {
	setValue : function(objects) {
		this.value = objects;
		this.value.push('</span><span class="literal">');
		this.updateUI();
	},
	reset : function() {
		this.value = ['</span><span class="literal">'];
		this.updateUI();
	},
	getValue : function() {
		var out = [];
		this.value.each(function(value) {
			value = value.strip();
			if (value.length&gt;0) out.push(value);
		})
		return out;
	},
	getLabel : function() {
		return this.options.label;
	},
	updateUI : function() {
		this.element.update();
		this.value.each(function(value,i) {
			var input = new Element('</span>input<span class="literal">').addClassName('</span>in2igui_tokens_token<span class="literal">');
			if (this.options.width) {
				input.setStyle({width:this.options.width+'</span>px<span class="literal">'});
			}
			input.value = value;
			input.in2iguiIndex = i;
			this.element.insert(input);
			input.observe('</span>keyup<span class="literal">',function() {this.inputChanged(input,i)}.bind(this));
		}.bind(this));
	},
	/** @private */
	inputChanged : function(input,index) {
		if (index==this.value.length-1 &amp;&amp; input.value!=this.value[index]) {
			this.addField();
		}
		this.value[index] = input.value;
	},
	/** @private */
	addField : function() {
		var input = new Element('</span>input<span class="literal">').addClassName('</span>in2igui_tokens_token<span class="literal">');
		if (this.options.width) {
			input.setStyle({width:this.options.width+'</span>px<span class="literal">'});
		}
		var i = this.value.length;
		this.value.push('</span><span class="literal">');
		this.element.insert(input);
		var self = this;
		input.observe('</span>keyup<span class="literal">',function() {self.inputChanged(input,i)});
	}
}

/////////////////////////// Style length /////////////////////////

/**
 * A date and time field
 * @constructor
 */
In2iGui.Formula.StyleLength = function(o) {
	this.options = n2i.override({value:null,min:0,max:1000,units:['</span>px<span class="literal">','</span>pt<span class="literal">','</span>em<span class="literal">','</span>%<span class="literal">'],allowNull:false},o);	
	this.name = o.name;
	var e = this.element = $(o.element);
	this.input = e.select('</span>input<span class="literal">')[0];
	this.up = e.select('</span>.in2igui_style_length_up<span class="literal">')[0];
	this.down = e.select('</span>.in2igui_style_length_down<span class="literal">')[0];
	this.value = this.options.value;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Formula.StyleLength.prototype = {
	addBehavior : function() {
		var e = this.element;
		this.input.observe('</span>focus<span class="literal">',function() {e.addClassName('</span>in2igui_number_focused<span class="literal">')});
		this.input.observe('</span>blur<span class="literal">',this.blurEvent.bind(this));
		this.input.observe('</span>keyup<span class="literal">',this.keyEvent.bind(this));
		this.up.observe('</span>mousedown<span class="literal">',this.upEvent.bind(this));
		this.down.observe('</span>mousedown<span class="literal">',this.downEvent.bind(this));
	},
	blurEvent : function() {
		this.element.removeClassName('</span>in2igui_number_focused<span class="literal">');
		this.input.value = this.value;
	},
	keyEvent : function(e) {
		if (e.keyCode==Event.KEY_UP) {
			e.stop();
			this.upEvent();
		} else if (e.keyCode==Event.KEY_DOWN) {
			this.downEvent();
		} else {
			var parsed = parseInt(this.input.value,10);
			n2i.log(this.input.value);
			n2i.log(parsed);
			if (!isNaN(parsed)) {
				this.setLocalValue(parsed);
			}
		}
	},
	downEvent : function() {
		if (this.value===null) {
			this.setValue(this.options.min);
		} else {
			this.setValue(this.value-1);
		}
	},
	upEvent : function() {
		this.setValue(this.value+1);
	},
	getValue : function() {
		return this.value;
	},
	setValue : function(value) {
		this.setLocalValue(value);
		this.input.value = this.value;
	},
	setLocalValue : function(value) {
		this.value = Math.min(Math.max(value,this.options.min),this.options.max);
	}
}

/////////////////////////// Style length /////////////////////////

/**
 * A component for geo-location
 * @constructor
 */
In2iGui.Formula.Location = function(options) {
	this.options = n2i.override({value:null},options);
	this.name = options.name;
	this.element = $(options.element);
	this.chooser = this.element.select('</span>a<span class="literal">')[0];
	this.latField = new In2iGui.TextField({element:this.element.select('</span>input<span class="literal">')[0],validator:new In2iGui.NumberValidator({min:-90,max:90,allowNull:true})});
	this.latField.listen(this);
	this.lngField = new In2iGui.TextField({element:this.element.select('</span>input<span class="literal">')[1],validator:new In2iGui.NumberValidator({min:-180,max:180,allowNull:true})});
	this.lngField.listen(this);
	this.value = this.options.value;
	In2iGui.extend(this);
	this.setValue(this.value);
	this.addBehavior();
}

In2iGui.Formula.Location.create = function(options) {
	options = options || {};
	var e = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_location<span class="literal">'});
	var b = new Element('</span>span<span class="literal">');
	b.update('</span>&lt;span class=<span class="literal">"in2igui_location_latitude"</span>&gt;&lt;input/&gt;&lt;/span&gt;&lt;span class=<span class="literal">"in2igui_location_longitude"</span>&gt;&lt;input/&gt;&lt;/span&gt;<span class="literal">');
	e.insert(In2iGui.wrapInField(b));
	e.insert('</span>&lt;a class=<span class="literal">"in2igui_location_picker"</span> href=<span class="literal">"javascript:void(0);"</span>&gt;&lt;/a&gt;<span class="literal">');
	return new In2iGui.Formula.Location(options);
}

In2iGui.Formula.Location.prototype = {
	/** @private */
	addBehavior : function() {
		this.chooser.observe('</span>click<span class="literal">',this.showPicker.bind(this));
		In2iGui.addFocusClass({element:this.latField.element,classElement:this.element,'</span>class<span class="literal">':'</span>in2igui_field_focused<span class="literal">'});
		In2iGui.addFocusClass({element:this.lngField.element,classElement:this.element,'</span>class<span class="literal">':'</span>in2igui_field_focused<span class="literal">'});
	},
	getLabel : function() {
		return this.options.label;
	},
	reset : function() {
		this.setValue();
	},
	getValue : function() {
		return this.value;
	},
	setValue : function(loc) {
		if (loc) {
			this.latField.setValue(loc.latitude);
			this.lngField.setValue(loc.longitude);
			this.value = loc;
		} else {
			this.latField.setValue();
			this.lngField.setValue();
			this.value = null;
		}
		this.updatePicker();
		n2i.log(this.value);
	},
	updatePicker : function() {
		if (this.picker) {
			this.picker.setLocation(this.value);
		}
	},
	/** @private */
	showPicker : function() {
		if (!this.picker) {
			this.picker = new In2iGui.LocationPicker();
			this.picker.listen(this);
		}
		this.picker.show({node:this.chooser,location:this.value});
	},
	$locationChanged : function(loc) {
		this.setValue(loc);
	},
	$valueChanged : function() {
		var lat = this.latField.getValue();
		var lng = this.lngField.getValue();
		if (lat===null || lng===null) {
			this.value = null;
		} else {
			this.value = {latitude:lat,longitude:lng};
		}
		this.updatePicker();
	}
}

/* EOF */In2iGui.List = function(options) {
	this.options = n2i.override({url:null,source:null},options);
	this.element = $(options.element);
	this.name = options.name;
	if (this.options.source) {
		this.options.source.addDelegate(this);
	}
	this.url = options.url;
	this.table = this.element.select('</span>table<span class="literal">')[0];
	this.head = this.element.select('</span>thead<span class="literal">')[0];
	this.body = this.element.select('</span>tbody<span class="literal">')[0];
	this.columns = [];
	this.rows = [];
	this.selected = [];
	this.navigation = this.element.select('</span>.in2igui_list_navigation<span class="literal">')[0];
	this.count = this.navigation.select('</span>.in2igui_list_count<span class="literal">')[0];
	this.windowPage = this.navigation.select('</span>.window_page<span class="literal">')[0];
	this.windowPageBody = this.navigation.select('</span>.window_page_body<span class="literal">')[0];
	this.parameters = {};
	this.sortKey = null;
	this.sortDirection = null;
	
	this.window = {size:null,page:0,total:0};
	if (options.windowSize!='</span><span class="literal">') {
		this.window.size = parseInt(options.windowSize);
	}
	In2iGui.extend(this);
	if (this.url) this.refresh();
}

In2iGui.List.create = function(options) {
	options = n2i.override({},options);
	var e = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_list<span class="literal">'});
	e.update('</span>&lt;div class=<span class="literal">"in2igui_list_navigation"</span>&gt;&lt;div class=<span class="literal">"in2igui_list_selection window_page"</span>&gt;&lt;div&gt;&lt;div class=<span class="literal">"window_page_body"</span>&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;span class=<span class="literal">"in2igui_list_count"</span>&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=<span class="literal">"in2igui_list_body"</span><span class="literal">'+(options.maxHeight&gt;0 ? '</span> style=<span class="literal">"max-height: '+options.maxHeight+'px;"</span><span class="literal">' : '</span><span class="literal">')+'</span>&gt;&lt;table cellspacing=<span class="literal">"0"</span> cellpadding=<span class="literal">"0"</span>&gt;&lt;thead&gt;&lt;tr&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;<span class="literal">');
	return new In2iGui.List(options);
}

In2iGui.List.prototype = {
	hide : function() {
		this.element.hide();
	},
	show : function() {
		this.element.show();
	},
	registerColumn : function(column) {
		this.columns.push(column);
	},
	getSelection : function() {
		var items = [];
		for (var i=0; i &lt; this.selected.length; i++) {
			items.push(this.rows[this.selected[i]]);
		};
		return items;
	},
	getFirstSelection : function() {
		var items = this.getSelection();
		if (items.length&gt;0) return items[0];
		else return null;
	},
	setParameter : function(key,value) {
		this.parameters[key]=value;
	},
	loadData : function(url) {
		this.setUrl(url);
	},
	setSource : function(source) {
		if (this.options.source!=source) {
			if (this.options.source) {
				this.options.source.removeDelegate(this);
			}
			source.addDelegate(this);
			this.options.source = source;
			source.refresh();
		}
	},
	setUrl : function(url) {
		if (this.options.source) {
			this.options.source.removeDelegate(this);
			this.options.source=null;
		}
		this.url = url;
		this.selected = [];
		this.sortKey = null;
		this.sortDirection = null;
		this.resetState();
		this.refresh();
	},
	resetState : function() {
		this.window = {size:null,page:0,total:0};
		In2iGui.firePropertyChange(this,'</span>window<span class="literal">',this.window);
		In2iGui.firePropertyChange(this,'</span>window.page<span class="literal">',this.window.page);
	},
	valueForProperty : function(p) {
		if (p=='</span>window.page<span class="literal">') return this.window.page;
		if (p=='</span>window.page<span class="literal">') return this.window.page;
		else if (p=='</span>sort.key<span class="literal">') return this.sortKey;
		else if (p=='</span>sort.direction<span class="literal">') return (this.sortDirection || '</span>ascending<span class="literal">');
		else return this[p];
	},
	/**
	 * @private
	 */
	refresh : function() {
		if (this.options.source) {
			this.options.source.refresh();
			return;
		}
		if (!this.url) return;
		var url = this.url;
		if (typeof(this.window.page)=='</span>number<span class="literal">') {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+='</span>windowPage=<span class="literal">'+this.window.page;
		}
		if (this.window.size) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+='</span>windowSize=<span class="literal">'+this.window.size;
		}
		if (this.sortKey) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+='</span>sort=<span class="literal">'+this.sortKey;
		}
		if (this.sortDirection) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+='</span>direction=<span class="literal">'+this.sortDirection;
		}
		for (key in this.parameters) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+=key+'</span>=<span class="literal">'+this.parameters[key];
		}
		In2iGui.request({
			url:url,
			onJSON : this.$objectsLoaded.bind(this),
			onXML : this.$listLoaded.bind(this)
		});
	},
	sort : function(index) {
		var key = this.columns[index].key;
		if (key==this.sortKey) {
			this.sortDirection = this.sortDirection=='</span>ascending<span class="literal">' ? '</span>descending<span class="literal">' : '</span>ascending<span class="literal">';
			In2iGui.firePropertyChange(this,'</span>sort.direction<span class="literal">',this.sortDirection);
		} else {
			In2iGui.firePropertyChange(this,'</span>sort.key<span class="literal">',key);
		}
		this.sortKey = key;
	},

	/**
	 * @private
	 */
	$listLoaded : function(doc) {
		this.selected = [];
		this.parseWindow(doc);
		this.buildNavigation();
		this.body.update();
		this.head.update();
		this.rows = [];
		this.columns = [];
		var headTr = new Element('</span>tr<span class="literal">');
		var sort = doc.getElementsByTagName('</span>sort<span class="literal">');
		this.sortKey=null;
		this.sortDirection=null;
		if (sort.length&gt;0) {
			this.sortKey=sort[0].getAttribute('</span>key<span class="literal">');
			this.sortDirection=sort[0].getAttribute('</span>direction<span class="literal">');
		}
		var headers = doc.getElementsByTagName('</span>header<span class="literal">');
		for (var i=0; i &lt; headers.length; i++) {
			var className = '</span><span class="literal">';
			var th = new Element('</span>th<span class="literal">');
			var width = headers[i].getAttribute('</span>width<span class="literal">');
			var key = headers[i].getAttribute('</span>key<span class="literal">');
			var sortable = headers[i].getAttribute('</span>sortable<span class="literal">')=='</span>true<span class="literal">';
			if (width &amp;&amp; width!='</span><span class="literal">') {
				th.style.width=width+'</span>%<span class="literal">';
			}
			if (sortable) {
				var self = this;
				th.in2iguiIndex = i;
				th.onclick=function() {self.sort(this.in2iguiIndex)};
				className+='</span>sortable<span class="literal">';
			}
			if (key==this.sortKey) {
				className+='</span> sort_<span class="literal">'+this.sortDirection;
			}
			th.className=className;
			var span = new Element('</span>span<span class="literal">');
			th.appendChild(span);
			span.appendChild(document.createTextNode(headers[i].getAttribute('</span>title<span class="literal">')));
			headTr.appendChild(th);
			this.columns.push({'</span>key<span class="literal">':key,'</span>sortable<span class="literal">':sortable,'</span>width<span class="literal">':width});
		};
		this.head.appendChild(headTr);
		var frag = document.createDocumentFragment();
		var rows = doc.getElementsByTagName('</span>row<span class="literal">');
		for (var i=0; i &lt; rows.length; i++) {
			var cells = rows[i].getElementsByTagName('</span>cell<span class="literal">');
			var row = new Element('</span>tr<span class="literal">');
			var icon = rows[i].getAttribute('</span>icon<span class="literal">');
			var title = rows[i].getAttribute('</span>title<span class="literal">');
			for (var j=0; j &lt; cells.length; j++) {
				var td = new Element('</span>td<span class="literal">');
				this.parseCell(cells[j],td);
				row.insert(td);
				if (!title) title = cells[j].innerText;
				if (!icon &amp;&amp; cells[j].getAttribute('</span>icon<span class="literal">')) icon = cells[j].getAttribute('</span>icon<span class="literal">');
			};
			var info = {id:rows[i].getAttribute('</span>id<span class="literal">'),kind:rows[i].getAttribute('</span>kind<span class="literal">'),icon:icon,title:title,index:i};
			row.dragDropInfo = info;
			this.addRowBehavior(row,i);
			frag.appendChild(row);
			//this.body.insert(row);
			this.rows.push(info);
		};
		this.body.appendChild(frag);
		this.fire('</span>selectionReset<span class="literal">');
	},
	
	$objectsLoaded : function(data) {
		if (data.constructor == Array) {
			this.setObjects(data);
		} else {
			this.setData(data);
		}
		this.fire('</span>selectionReset<span class="literal">');
	},
	$sourceIsBusy : function() {
		//this.element.addClassName('</span>in2igui_list_busy<span class="literal">');
	},
	$sourceIsNotBusy : function() {
		//this.element.removeClassName('</span>in2igui_list_busy<span class="literal">');
	},
	
	filter : function(str) {
		var len = 20;
		var regex = new RegExp("[\\w]{"+len+",}","g");
		var match = regex.exec(str);
		if (match) {
			for (var i=0; i &lt; match.length; i++) {
				var rep = '</span><span class="literal">';
				for (var j=0; j &lt; match[i].length; j++) {
					rep+=match[i][j];
					if ((j+1)%len==0) rep+='</span>\u200B<span class="literal">';
				};
				str = str.replace(match[i],rep);
			};
		}
		return str;
	},
	
	/** @private */
	parseCell = function(node,cell) {
		var icon = node.getAttribute('</span>icon<span class="literal">');
		if (icon!=null &amp;&amp; !icon.blank()) {
			cell.insert(In2iGui.createIcon(icon,1));
		}
		for (var i=0; i &lt; node.childNodes.length; i++) {
			var child = node.childNodes[i];
			if (n2i.dom.isDefinedText(child)) {
				n2i.dom.addText(cell,child.nodeValue);
			} else if (n2i.dom.isElement(child,'</span>break<span class="literal">')) {
				cell.insert(new Element('</span>br<span class="literal">'));
			} else if (n2i.dom.isElement(child,'</span>line<span class="literal">')) {
				var line = new Element('</span>p<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_list_line<span class="literal">'}).insert(n2i.dom.getNodeText(child));
				if (child.getAttribute('</span>dimmed<span class="literal">')=='</span>true<span class="literal">') {
					line.addClassName('</span>in2igui_list_dimmed<span class="literal">')
				}
				cell.insert(line);
			} else if (n2i.dom.isElement(child,'</span>object<span class="literal">')) {
				var obj = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>object<span class="literal">'});
				if (child.getAttribute('</span>icon<span class="literal">')) {
					obj.insert(In2iGui.createIcon(child.getAttribute('</span>icon<span class="literal">'),1));
				}
				if (child.firstChild &amp;&amp; child.firstChild.nodeType==n2i.TEXT_NODE &amp;&amp; child.firstChild.nodeValue.length&gt;0) {
					obj.appendChild(document.createTextNode(child.firstChild.nodeValue));
				}
				cell.insert(obj);
			}
		};
	},
	/** @private */
	parseWindow = function(doc) {
		var wins = doc.getElementsByTagName('</span>window<span class="literal">');
		if (wins.length&gt;0) {
			var win = wins[0];
			this.window.total = parseInt(win.getAttribute('</span>total<span class="literal">'));
			this.window.size = parseInt(win.getAttribute('</span>size<span class="literal">'));
			this.window.page = parseInt(win.getAttribute('</span>page<span class="literal">'));
		} else {
			this.window.total = 0;
			this.window.size = 0;
			this.window.page = 0;
		}
	},
	/** @private */
	buildNavigation = function() {
		var self = this;
		var pages = this.window.size&gt;0 ? Math.ceil(this.window.total/this.window.size) : 0;
		if (pages&lt;2) {
			this.navigation.style.display='</span>none<span class="literal">';
			return;
		}
		this.navigation.style.display='</span>block<span class="literal">';
		var from = ((this.window.page)*this.window.size+1);
		this.count.update(from+'</span>-<span class="literal">'+Math.min((this.window.page+1)*this.window.size,this.window.total)+'</span> / <span class="literal">'+this.window.total);
		var pageBody = this.windowPageBody;
		pageBody.update();
		if (pages&lt;2) {
			this.windowPage.style.display='</span>none<span class="literal">';	
		} else {
			$R(0, pages-1).each(function(i){
				var a = document.createElement('</span>a<span class="literal">');
				a.appendChild(document.createTextNode(i+1));
				a.onclick = function() {
					self.windowPageWasClicked(this,i);
					return false;
				}
				if (i==self.window.page) {
					a.className='</span>selected<span class="literal">';
				}
				pageBody.appendChild(a);
			
			});
			this.windowPage.style.display='</span>block<span class="literal">';
		}
	},
	setData = function(data) {
		this.selected = [];
		var win = data.window || {};
		this.window.total = win.total || 0;
		this.window.size = win.size || 0;
		this.window.page = win.page || 0;
		this.buildNavigation();
		this.buildHeaders(data.headers);
		this.buildRows(data.rows);
	},
	/** @private */
	buildHeaders = function(headers) {
		this.head.update();
		this.columns = [];
		var tr = new Element('</span>tr<span class="literal">');
		this.head.insert(tr);
		headers.each(function(h,i) {
			var th = new Element('</span>th<span class="literal">');
			if (h.width) {
				th.setStyle({width:h.width+'</span>%<span class="literal">'});
			}
			if (h.sortable) {
				th.observe('</span>click<span class="literal">',function() {this.sort(i)}.bind(this));
				th.addClassName('</span>sortable<span class="literal">');
			}
			th.insert(new Element('</span>span<span class="literal">').update(h.title));
			tr.insert(th);
			this.columns.push(h);
		}.bind(this));
	},
	buildRows = function(rows) {
		var self = this;
		this.body.update();
		this.rows = [];
		if (!rows) return;
		rows.each(function(r,i) {
			var tr = new Element('</span>tr<span class="literal">');
			var icon = r.icon;
			var title = r.title;
			r.cells.each(function(c) {
				var td = new Element('</span>td<span class="literal">');
				if (c.icon) {
					td.insert(In2iGui.createIcon(c.icon,1));
					icon = icon || c.icon;
				}
				if (c.text) {
					td.appendChild(document.createTextNode(c.text))
					title = title || c.text;
				}
				tr.insert(td);
			})
			self.body.insert(tr);
			// TODO: Memory leak!
			var info = {id:r.id,kind:r.kind,icon:icon,title:title,index:i};
			tr.dragDropInfo = info;
			self.rows.push(info);
			this.addRowBehavior(tr,i);
		}.bind(this));
	},
	setObjects = function(objects) {
		this.selected = [];
		this.body.update();
		this.rows = [];
		for (var i=0; i &lt; objects.length; i++) {
			var row = new Element('</span>tr<span class="literal">');
			var obj = objects[i];
			var title = null;
			for (var j=0; j &lt; this.columns.length; j++) {
				var cell = new Element('</span>td<span class="literal">');
				if (this.builder) {
					cell.update(this.builder.buildColumn(this.columns[j],obj));
				} else {
					var value = obj[this.columns[j].key] || '</span><span class="literal">';
					if (value.constructor == Array) {
						for (var k=0; k &lt; value.length; k++) {
							if (value[k].constructor == Object) {
								cell.insert(this.createObject(value[k]));
							} else {
								cell.insert(new Element('</span>div<span class="literal">').update(value));
							}
						};
					} else if (value.constructor == Object) {
						cell.insert(this.createObject(value[j]));
					} else {
						cell.insert(value);
						title = title==null ? value : title;
					}
				}
				row.insert(cell);
			};
			var info = {id:obj.id,kind:obj.kind,title:title};
			row.dragDropInfo = info;
			this.body.insert(row);
			this.addRowBehavior(row,i);
			this.rows.push(obj);
		};
	},
	createObject = function(object) {
		var node = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>object<span class="literal">'});
		if (object.icon) {
			node.insert(new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>icon<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">"'+In2iGui.getIconUrl(object.icon,1)+'"</span>)<span class="literal">'}));
		}
		return node.insert(object.text || object.name || '</span><span class="literal">');
	},
	addRowBehavior = function(row,index) {
		var self = this;
		row.onmousedown = function(e) {
			self.rowDown(index);
			In2iGui.startDrag(e,row);
			return false;
		}
		row.ondblclick = function() {
			self.rowDoubleClick(index);
			return false;
		}
	},
	changeSelection = function(indexes) {
		var rows = this.body.getElementsByTagName('</span>tr<span class="literal">');
		for (var i=0;i&lt;this.selected.length;i++) {
			rows[this.selected[i]].removeClassName('</span>selected<span class="literal">');
		}
		for (var i=0;i&lt;indexes.length;i++) {
			rows[indexes[i]].addClassName('</span>selected<span class="literal">');
		}
		this.selected = indexes;
		this.fire('</span>selectionChanged<span class="literal">',this.rows[indexes[0]]);
	},
	rowDown = function(index) {
		this.changeSelection([index]);
	},
	rowDoubleClick = function(index) {
		In2iGui.callDelegates(this,'</span>listRowsWasOpened<span class="literal">');
		In2iGui.callDelegates(this,'</span>listRowWasOpened<span class="literal">',this.getFirstSelection());
		In2iGui.callDelegates(this,'</span>onRowOpen<span class="literal">',this.getFirstSelection());
	},
	windowPageWasClicked = function(tag,index) {
		this.window.page = index;
		In2iGui.firePropertyChange(this,'</span>window<span class="literal">',this.window);
		In2iGui.firePropertyChange(this,'</span>window.page<span class="literal">',this.window.page);
	}
};

/* EOF *//**
 * @constructor
 */
In2iGui.Tabs = function(o) {
	o = o || {};
	this.name = o.name;
	this.element = $(o.element);
	this.activeTab = -1;
	this.bar = this.element.select('</span>.in2igui_tabs_bar ul<span class="literal">')[0];
	this.tabs = this.bar.select('</span>li<span class="literal">');
	this.contents = this.element.select('</span>.in2igui_tabs_tab<span class="literal">');
	this.addBehavior();
	In2iGui.extend(this);
}

In2iGui.Tabs.create = function(options) {
	options = options || {};
	var e = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_tabs<span class="literal">'});
	var bar = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">' : options.small ? '</span>in2igui_tabs_bar in2igui_tabs_bar_small<span class="literal">' : '</span>in2igui_tabs_bar<span class="literal">'});
	e.insert(bar);
	var ul = new Element('</span>ul<span class="literal">');
	bar.insert(ul);
	return new In2iGui.Tabs(options);
}

In2iGui.Tabs.prototype = {
	addBehavior : function() {
		this.tabs.each(this.addTabBehavior.bind(this));
	},
	addTabBehavior : function(tab,index) {	
		tab.observe('</span>click<span class="literal">',function() {
			this.tabWasClicked(index);
		}.bind(this))
	},
	registerTab : function(obj) {
		obj.parent = this;
		this.tabs.push(obj);
	},
	tabWasClicked : function(index) {
		this.activeTab = index;
		this.updateGUI();
	},
	updateGUI : function() {
		for (var i=0; i &lt; this.tabs.length; i++) {
			this.tabs[i].setClassName('</span>in2igui_tabs_selected<span class="literal">',i==this.activeTab);
			this.contents[i].setStyle({display : (i==this.activeTab ? '</span>block<span class="literal">' : '</span>none<span class="literal">')});
		};
	},
	createTab : function(options) {
		options = options || {};
		var tab = new Element('</span>li<span class="literal">').update('</span>&lt;a&gt;&lt;span&gt;&lt;span&gt;<span class="literal">'+options.title+'</span>&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;<span class="literal">');
		this.bar.insert(tab);
		this.addTabBehavior(tab,this.tabs.length);
		this.tabs.push(tab);
		var e = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_tabs_tab<span class="literal">'});
		if (options.padding&gt;0) {
			e.setStyle({'</span>padding<span class="literal">':options.padding+'</span>px<span class="literal">'});
		}
		this.contents.push(e);
		this.element.insert(e);
		if (this.activeTab==-1) {
			this.activeTab=0;
			tab.addClassName('</span>in2igui_tabs_selected<span class="literal">');
		} else {
			e.setStyle({display:'</span>none<span class="literal">'});			
		}
		return new In2iGui.Tab(options);
	}
};

/**
 * @constructor
 */
In2iGui.Tab = function(o) {
	this.name = o.name;
	this.element = $(o.element);
}

In2iGui.Tab.prototype = {
	add : function(widget) {
		this.element.insert(widget.element);
	}
}

/* EOF *//**
 * @constructor
 */
In2iGui.ObjectList = function(o) {
	this.options = n2i.override({key:null},o);
	this.name = o.name;
	this.element = $(o.element);
	this.body = this.element.select('</span>tbody<span class="literal">')[0];
	this.template = [];
	this.objects = [];
	In2iGui.extend(this);
}

In2iGui.ObjectList.create = function(o) {
	o=o || {};
	var e = o.element = new Element('</span>table<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_objectlist<span class="literal">',cellpadding:'</span>0<span class="literal">',cellspacing:'</span>0<span class="literal">'});
	if (o.template) {
		var head = '</span>&lt;thead&gt;&lt;tr&gt;<span class="literal">';
		o.template.each(function(item) {
			head+='</span>&lt;th&gt;<span class="literal">'+(item.label || '</span><span class="literal">')+'</span>&lt;/th&gt;<span class="literal">';
		});
		head+='</span>&lt;/tr&gt;&lt;/thead&gt;<span class="literal">';
		e.insert(head);
	}
	e.insert(new Element('</span>tbody<span class="literal">'));
	var list = new In2iGui.ObjectList(o);
	if (o.template) {
		o.template.each(function(item) {
			list.registerTemplateItem(new In2iGui.ObjectList.Text(item.key));
		});
	}
	return list;
}

In2iGui.ObjectList.prototype = {
	ignite : function() {
		this.addObject({});
	},
	addObject : function(data,addToEnd) {
		if (this.objects.length==0 || addToEnd) {
			var obj = new In2iGui.ObjectList.Object(this.objects.length,data,this);
			this.objects.push(obj);
			this.body.appendChild(obj.getElement());
		} else {
			var last = this.objects.pop();
			var obj = new In2iGui.ObjectList.Object(last.index,data,this);
			last.index++;
			this.objects.push(obj);
			this.objects.push(last);
			this.body.insertBefore(obj.getElement(),last.getElement())
		}
	},
	reset : function() {
		for (var i=0; i &lt; this.objects.length; i++) {
			var element = this.objects[i].getElement();
			element.parentNode.removeChild(element);
		};
		this.objects = [];
		this.addObject({});
	},
	addObjects : function(data) {
		for (var i=0; i &lt; data.length; i++) {
			this.addObject(data[i]);
		};
	},
	setObjects : function(data) {
		this.reset();
		this.addObjects(data);
	},
	getObjects : function(data) {
		var list = [];
		for (var i=0; i &lt; this.objects.length-1; i++) {
			list.push(this.objects[i].getData());
		};
		return list;
	},
	getValue : function() {
		return this.getObjects();
	},
	setValue : function(data) {
		this.setObjects(data);
	},
	registerTemplateItem : function(item) {
		this.template.push(item);
	},
	objectDidChange : function(obj) {
		if (obj.index&gt;=this.objects.length-1) {
			this.addObject({},true);
		}
	},
	getLabel : function() {
		return this.options.label;
	}
}

/********************** Object ********************/

/** @constructor */
In2iGui.ObjectList.Object = function(index,data,list) {
	this.data = data;
	this.index = index;
	this.list = list;
	this.fields = [];
}

In2iGui.ObjectList.Object.prototype = {
	getElement : function() {
		if (!this.element) {
			var self = this;
			this.element = document.createElement('</span>tr<span class="literal">');
			for (var i=0; i &lt; this.list.template.length; i++) {
				var template = this.list.template[i];
				var field = template.clone();
				field.object = this;
				this.fields.push(field);
				var cell = document.createElement('</span>td<span class="literal">');
				if (i==0) cell.className='</span>first<span class="literal">';
				cell.appendChild(field.getElement());
				field.setValue(this.data[template.key]);
				this.element.appendChild(cell);
			};
		}
		return this.element;
	},
	valueDidChange : function() {
		this.list.objectDidChange(this);
	},
	getData : function() {
		var data = this.data;
		for (var i=0; i &lt; this.fields.length; i++) {
			data[this.fields[i].key] = this.fields[i].getValue();
		};
		return data;
	}
}

/*************************** Text **************************/

In2iGui.ObjectList.Text = function(key) {
	this.key = key;
	this.value = null;
}

In2iGui.ObjectList.Text.prototype = {
	clone : function() {
		return new In2iGui.ObjectList.Text(this.key);
	},
	getElement : function() {
		var input = new Element('</span>input<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_formula_text<span class="literal">'});
		var field = In2iGui.wrapInField(input);
		this.wrapper = new In2iGui.TextField({element:input});
		this.wrapper.addDelegate(this);
		return field;
	},
	$valueChanged : function(value) {
		this.value = value;
		this.object.valueDidChange();
	},
	getValue : function() {
		return this.value;
	},
	setValue : function(value) {
		this.value = value;
		this.wrapper.setValue(value);
	}
}

/*************************** Select **************************/

In2iGui.ObjectList.Select = function(key) {
	this.key = key;
	this.value = null;
	this.options = [];
}

In2iGui.ObjectList.Select.prototype = {
	clone : function() {
		var copy = new In2iGui.ObjectList.Select(this.key);
		copy.options = this.options;
		return copy;
	},
	getElement : function() {
		this.select = new Element('</span>select<span class="literal">');
		for (var i=0; i &lt; this.options.length; i++) {
			this.select.options[this.select.options.length] = new Option(this.options[i].label,this.options[i].value);
		};
		var self = this;
		this.select.onchange = function() {
			self.object.valueDidChange();
		}
		return this.select;
	},
	getValue : function() {
		return this.select.value;
	},
	setValue : function(value) {
		this.select.value = value;
	},
	addOption : function(value,label) {
		this.options.push({value:value,label:label});
	}
}

/* EOF *//**
 * An alert
 * @constructor
 */
In2iGui.Alert = function(options) {
	this.options = n2i.override({modal:false},options);
	this.element = $(options.element);
	this.name = options.name;
	this.body = this.element.select('</span>.in2igui_alert_body<span class="literal">')[0];
	this.content = this.element.select('</span>.in2igui_alert_content<span class="literal">')[0];
	this.emotion = this.options.emotion;
	this.title = this.element.select('</span>h1<span class="literal">').first();
	In2iGui.extend(this);
}

/**
 * Creates a new instance of an alert
 * &lt;br/&gt;&lt;strong&gt;options:&lt;/strong&gt; { name: String, title: String, text: String, emotion: '</span>smile<span class="literal">' | '</span>gasp<span class="literal">', modal: Boolean}
 * @static
 */
In2iGui.Alert.create = function(options) {
	options = n2i.override({title:'</span><span class="literal">',text:'</span><span class="literal">',emotion:null,title:null},options);
	
	var element = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_alert<span class="literal">'});
	var body = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_alert_body<span class="literal">'});
	element.insert(body);
	var content = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_alert_content<span class="literal">'});
	body.insert(content);
	document.body.appendChild(element);
	var obj = new In2iGui.Alert(options);
	if (options.emotion) {
		obj.setEmotion(options.emotion);
	}
	if (options.title) {
		obj.setTitle(options.title);
	}
	if (options.text) {
		obj.setText(options.text);
	}
	
	return obj;
}

In2iGui.Alert.prototype = {
	/** Shows the alert */
	show : function() {
		var zIndex = In2iGui.nextAlertIndex();
		if (this.options.modal) {
			In2iGui.showCurtain(this,zIndex);
			zIndex++;
		}
		this.element.style.zIndex=zIndex;
		this.element.style.display='</span>block<span class="literal">';
		this.element.style.top=(n2i.getScrollTop()+100)+'</span>px<span class="literal">';
		n2i.ani(this.element,'</span>opacity<span class="literal">',1,200);
		n2i.ani(this.element,'</span>margin-top<span class="literal">','</span>40px<span class="literal">',600,{ease:n2i.ease.elastic});
	},
	/** Hides the alert */
	hide : function() {
		n2i.ani(this.element,'</span>opacity<span class="literal">',0,200,{hideOnComplete:true});
		n2i.ani(this.element,'</span>margin-top<span class="literal">','</span>0px<span class="literal">',200);
		In2iGui.hideCurtain(this);
	},
	/** Sets the alert title */
	setTitle : function(/**String*/ text) {
		if (!this.title) {
			this.title = new Element('</span>h1<span class="literal">');
			this.content.appendChild(this.title);
		}
		this.title.innerHTML = text;
	},
	/** Sets the alert text */
	setText : function(/**String*/ text) {
		if (!this.text) {
			this.text = new Element('</span>p<span class="literal">');
			this.content.appendChild(this.text);
		}
		this.text.innerHTML = text || '</span><span class="literal">';
	},
	/** Sets the alert emotion */
	setEmotion : function(/**String*/ emotion) {
		if (this.emotion) {
			this.body.removeClassName(this.emotion);
		}
		this.emotion = emotion;
		this.body.addClassName(emotion);
	},
	/** Updates multiple properties
	 * @param {Object} options {title: String, text: String, emotion: '</span>smile<span class="literal">' | '</span>gasp<span class="literal">'}
	 */
	update : function(options) {
		options = options || {};
		this.setTitle(options.title || null);
		this.setText(options.text || null);
		this.setEmotion(options.emotion || null);
	},
	/** Adds an In2iGui.Button to the alert */
	addButton : function(button) {
		if (!this.buttons) {
			this.buttons = In2iGui.Buttons.create({align:'</span>right<span class="literal">'});
			this.body.appendChild(this.buttons.element);
		}
		this.buttons.add(button);
	}
}

/* EOF *//**
 * @constructor
 * A button
 */
In2iGui.Button = function(options) {
	this.options = options;
	this.name = options.name;
	this.element = $(options.element);
	this.inner = this.element.getElementsByTagName('</span>span<span class="literal">')[1];
	this.enabled = !this.element.hasClassName('</span>in2igui_button_disabled<span class="literal">');
	In2iGui.extend(this);
	this.addBehavior();
}

/**
 * Creates a new button
 */
In2iGui.Button.create = function(o) {
	var o = n2i.override({text:'</span><span class="literal">',highlighted:false,enabled:true},o);
	var className = '</span>in2igui_button<span class="literal">'+(o.highlighted ? '</span> in2igui_button_highlighted<span class="literal">' : '</span><span class="literal">');
	if (o.small &amp;&amp; o.rounded) {
		className+='</span> in2igui_button_small_rounded<span class="literal">';
	}
	if (!o.enabled) {
		className+='</span> in2igui_button_disabled<span class="literal">';
	}
	var element = o.element = new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':className,href:'</span>#<span class="literal">'});
	var element2 = new Element('</span>span<span class="literal">');
	element.appendChild(element2);
	var element3 = new Element('</span>span<span class="literal">');
	element2.appendChild(element3);
	if (o.icon) {
		var icon = new Element('</span>em<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_button_icon<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl(o.icon,1)+'</span>)<span class="literal">'});
		if (!o.text || o.text.length==0) {
			icon.addClassName('</span>in2igui_button_icon_notext<span class="literal">');
		}
		element3.insert(icon);
	}
	if (o.text &amp;&amp; o.text.length&gt;0) {
		element3.insert(o.text);
	}
	if (o.title &amp;&amp; o.title.length&gt;0) {
		element3.insert(o.title);
	}
	return new In2iGui.Button(o);
}

In2iGui.Button.prototype = {
	/** @private */
	addBehavior : function() {
		var self = this;
		this.element.onclick = function() {
			self.clicked();
			return false;
		}
	},
	/** @private */
	clicked : function() {
		if (this.enabled) {
			this.fire('</span>click<span class="literal">');
			if (this.options.submit) {
				var form = In2iGui.get().getAncestor(this,'</span>in2igui_formula<span class="literal">');
				if (form) {form.submit();}
			}
		} else {
			this.element.blur();
		}
	},
	/** Enables or disables the button */
	setEnabled : function(enabled) {
		this.enabled = enabled;
		this.updateUI();
	},
	/** Sets whether the button is highlighted */
	setHighlighted : function(highlighted) {
		this.element.setClassName('</span>in2igui_button_highlighted<span class="literal">',highlighted);
	},
	/** @private */
	updateUI : function() {
		this.element.setClassName('</span>in2igui_button_disabled<span class="literal">',!this.enabled);
	},
	/** Sets the button text */
	setText : function(text) {
		this.inner.innerHTML = text;
	}
}

////////////////////////////////// Buttons /////////////////////////////

/** @constructor */
In2iGui.Buttons = function(o) {
	this.name = o.name;
	this.element = $(o.element);
	this.body = this.element.select('</span>.in2igui_buttons_body<span class="literal">')[0];
	In2iGui.extend(this);
}

In2iGui.Buttons.create = function(o) {
	o = n2i.override({top:0},o);
	var e = o.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_buttons<span class="literal">'});
	if (o.align=='</span>right<span class="literal">') {
		e.addClassName('</span>in2igui_buttons_right<span class="literal">');
	}
	if (o.top&gt;0) e.setStyle({paddingTop:o.top+'</span>px<span class="literal">'});
	e.insert(new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_buttons_body<span class="literal">'}));
	return new In2iGui.Buttons(o);
}

In2iGui.Buttons.prototype = {
	add : function(widget) {
		this.body.insert(widget.element);
		return this;
	}
}

/* EOF *//**
 * @constructor
 * @param {Object} options The options : {value:null}
 */
In2iGui.Selection = function(options) {
	this.options = n2i.override({value:null},options);
	this.element = $(options.element);
	this.name = options.name;
	this.items = [];
	this.subItems = [];
	this.selection=null;
	if (this.options.value!=null) {
		this.selection = {value:this.options.value};
	}
	In2iGui.extend(this);
}

/**
 * Creates a new selection widget
 * @param {Object} options The options : {width:0}
 */
In2iGui.Selection.create = function(options) {
	options = n2i.override({width:0},options);
	var e = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_selection<span class="literal">'});
	if (options.width&gt;0) e.setStyle({width:options.width+'</span>px<span class="literal">'});
	return new In2iGui.Selection(options);
}

In2iGui.Selection.prototype = {
	/** Get the selected item
	 * @returns {Object} The selected item, null if no selection */
	getValue : function() {
		return this.selection;
	},
	/** Set the selected item
	 * @param {Object} value The selected item */
	setValue : function(value) {
		var item = this.getSelectionWithValue(value);
		if (item===null) {
			this.selection = null;
		} else {
			this.selection = item;
			this.kind=item.kind;
		}
		this.updateUI();
		this.fireChange();
	},
	/** @private */
	getSelectionWithValue : function(value) {
		for (var i=0; i &lt; this.items.length; i++) {
			if (this.items[i].value==value) {
				return this.items[i];
			}
		};
		for (var i=0; i &lt; this.subItems.length; i++) {
			var items = this.subItems[i].items;
			for (var j=0; j &lt; items.length; j++) {
				if (items[j].value==value) {
					return items[j];
				}
			};
		};
		return null;
	},
	/** Set the value to null */
	reset : function() {
		this.setValue(null);
	},
	/** @private */
	updateUI : function() {
		this.items.each(function(item) {
			item.element.setClassName('</span>in2igui_selected<span class="literal">',this.isSelection(item));
		}.bind(this));
		this.subItems.each(function(sub) {
			sub.updateUI();
		});
	},
	/** @private */
	changeSelection : function(item) {
		this.subItems.each(function(sub) {
			sub.selectionChanged(this.selection,item);
		});
		this.selection = item;
		this.updateUI();
		this.fireChange();
	},
	/** @private */
	fireChange : function() {
		this.fire('</span>selectionChanged<span class="literal">',this.selection);
		this.fireProperty('</span>value<span class="literal">',this.selection ? this.selection.value : null);
		this.fireProperty('</span>kind<span class="literal">',this.selection ? this.selection.kind : null);
	},
	/** @private */
	registerItems : function(items) {
		items.parent = this;
		this.subItems.push(items);
	},
	/** @private */
	registerItem : function(id,title,icon,badge,value,kind) {
		var element = $(id);
		var item = {id:id,title:title,icon:icon,badge:badge,element:element,value:value,kind:kind};
		this.items.push(item);
		this.addItemBehavior(element,item);
		this.selection = this.getSelectionWithValue(this.options.value);
	},
	/** @private */
	addItemBehavior : function(node,item) {
		node.observe('</span>click<span class="literal">',function() {
			this.itemWasClicked(item);
		}.bind(this));
		node.observe('</span>dblclick<span class="literal">',function() {
			this.itemWasDoubleClicked(item);
		}.bind(this));
		node.dragDropInfo = item;
	},
	/** Untested!! */
	setObjects : function(items) {
		this.items = [];
		items.each(function(item) {
			this.items.push(item);
			var node = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_selection_item<span class="literal">'});
			item.element = node;
			this.element.insert(node);
			var inner = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_selection_label<span class="literal">'}).update(item.title);
			if (item.icon) {
				node.insert(In2iGui.createIcon(item.icon,1));
			}
			node.insert(inner);
			node.observe('</span>click<span class="literal">',function() {
				this.itemWasClicked(item);
			}.bind(this));
			node.observe('</span>dblclick<span class="literal">',function(e) {
				this.itemWasDoubleClicked(item);
				e.stop();
			}.bind(this));
		}.bind(this));
	},
	/** @private */
	isSelection : function(item) {
		if (this.selection===null) {
			return false;
		}
		var selected = item.value==this.selection.value;
		if (this.selection.kind) {
			selected = selected &amp;&amp; item.kind==this.selection.kind;
		}
		return selected;
	},
	
	/** @private */
	itemWasClicked : function(item) {
		this.changeSelection(item);
	},
	/** @private */
	itemWasDoubleClicked : function(item) {
		this.fire('</span>selectionWasOpened<span class="literal">',item);
	}
}

/////////////////////////// Items ///////////////////////////

/**
 * @constructor
 * A group of items loaded from a source
 * @param {Object} options The options : {element,name,source}
 */
In2iGui.Selection.Items = function(options) {
	this.options = n2i.override({source:null},options);
	this.element = $(options.element);
	this.name = options.name;
	this.parent = null;
	this.items = [];
	In2iGui.extend(this);
	if (this.options.source) {
		this.options.source.addDelegate(this);
	}
}

In2iGui.Selection.Items.prototype = {
	/**
	 * Refresh the underlying source
	 */
	refresh : function() {
		if (this.options.source) {
			this.options.source.refresh();
		}
	},
	/** @private */
	$objectsLoaded : function(objects) {
		this.$itemsLoaded(objects);
	},
	/** @private */
	$itemsLoaded : function(items) {
		this.items = [];
		this.element.update();
		this.buildLevel(this.element,items,0);
		this.parent.updateUI();
	},
	/** @private */
	buildLevel : function(parent,items,inc) {
		if (!items) return;
		var hierarchical = this.isHierarchy(items);
		var open = inc==0;
		var level = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_selection_level<span class="literal">'}).setStyle({display:open ? '</span>block<span class="literal">' : '</span>none<span class="literal">'});
		parent.insert(level);
		items.each(function(item) {
			var hasChildren = item.children &amp;&amp; item.children.length&gt;0;
			var left = inc*16+6;
			if (!hierarchical &amp;&amp; inc&gt;0 || hierarchical &amp;&amp; !hasChildren) left+=13;
			var node = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_selection_item<span class="literal">'}).setStyle({paddingLeft:left+'</span>px<span class="literal">'})
			if (item.badge) {
				node.insert(new Element('</span>strong<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_selection_badge<span class="literal">'}).update(item.badge));
			}
			if (hierarchical &amp;&amp; hasChildren) {
				var self = this;
				node.insert(new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_disclosure<span class="literal">'}).observe('</span>click<span class="literal">',function(e) {
					e.stop();
					self.toggle(this);
				}));
			}
			var inner = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_selection_label<span class="literal">'});
			if (item.icon) {
				node.insert(new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_icon_1<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">' : '</span>url(<span class="literal">'+In2iGui.getIconUrl(item.icon,1)+'</span>)<span class="literal">'}));
			}
			node.insert(inner.insert(item.title));
			node.observe('</span>click<span class="literal">',function(e) {
				this.parent.itemWasClicked(item);
			}.bind(this));
			node.observe('</span>dblclick<span class="literal">',function(e) {
				this.parent.itemWasDoubleClicked(item);
			}.bind(this));
			level.insert(node);
			var info = {title:item.title,icon:item.icon,badge:item.badge,kind:item.kind,element:node,value:item.value};
			node.dragDropInfo = info;
			this.items.push(info);
			this.buildLevel(level,item.children,inc+1);
		}.bind(this));
	},
	/** @private */
	toggle : function(node) {
		if (node.hasClassName('</span>in2igui_disclosure_open<span class="literal">')) {
			node.parentNode.next().hide();
			node.removeClassName('</span>in2igui_disclosure_open<span class="literal">');
		} else {
			node.parentNode.next().show();
			node.addClassName('</span>in2igui_disclosure_open<span class="literal">');
		}
	},
	/** @private */
	isHierarchy : function(items) {
		for (var i=0; i &lt; items.length; i++) {
			if (items[i].children &amp;&amp; items[i].children.length&gt;0) {
				return true;
			}
		};
		return false;
	},
	/** Get the selection of this items group
	 * @returns {Object} The selected item or null */
	getValue : function() {
		if (this.parent.selection==null) {
			return null;
		}
		for (var i=0; i &lt; this.items.length; i++) {
			if (this.items[i].value == this.parent.selection.value) {
				return this.items[i];
			}
		};
		return null;
	},
	/** @private */
	updateUI : function() {
		this.items.each(function(item) {
			item.element.setClassName('</span>in2igui_selected<span class="literal">',this.parent.isSelection(item));
		}.bind(this));
	},
	/** @private */
	selectionChanged : function(oldSelection,newSelection) {
		for (var i=0; i &lt; this.items.length; i++) {
			var value = this.items[i].value;
			if (value == newSelection.value) {
				this.fireProperty('</span>value<span class="literal">',newSelection.value);
				return;
			}
		};
		this.fireProperty('</span>value<span class="literal">',null);
	}
}
/* EOF */
/** @constructor */
In2iGui.Toolbar = function(options) {
	this.element = $(options.element);
	this.name = options.name;
	In2iGui.extend(this);
}

In2iGui.Toolbar.create = function(options) {
	options = options || {};
	options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_toolbar<span class="literal">'});
	if (options.labels==false) {
		options.element.addClassName('</span>in2igui_toolbar_nolabels<span class="literal">');
	}
	return new In2iGui.Toolbar(options);
}

In2iGui.Toolbar.prototype = {
	add : function(widget) {
		this.element.appendChild(widget.getElement());
	},
	addDivider : function() {
		this.element.appendChild(new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_divider<span class="literal">'}));
	}
}



/////////////////////// Revealing toolbar ////////////////////////

/** @constructor */
In2iGui.RevealingToolbar = function(options) {
	this.element = $(options.element);
	this.name = options.name;
	In2iGui.extend(this);
}

In2iGui.RevealingToolbar.create = function(options) {
	options = options || {};
	options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_revealing_toolbar<span class="literal">'}).setStyle({'</span>display<span class="literal">':'</span>none<span class="literal">'});
	document.body.appendChild(options.element);
	var rev = new In2iGui.RevealingToolbar(options);
	var toolbar = In2iGui.Toolbar.create();
	rev.setToolbar(toolbar);
	return rev;
}

In2iGui.RevealingToolbar.prototype = {
	setToolbar : function(widget) {
		this.toolbar = widget;
		this.element.appendChild(widget.getElement());
	},
	getToolbar : function() {
		return this.toolbar;
	},
	show : function(instantly) {
		this.element.style.display='</span><span class="literal">';
		n2i.ani(this.element,'</span>height<span class="literal">','</span>58px<span class="literal">',instantly ? 0 : 600,{ease:n2i.ease.slowFastSlow});
	},
	hide : function() {
		n2i.ani(this.element,'</span>height<span class="literal">','</span>0px<span class="literal">',500,{ease:n2i.ease.slowFastSlow,hideOnComplete:true});
	}
}



/////////////////////// Icon ///////////////////

/** @constructor */
In2iGui.Toolbar.Icon = function(options) {
	this.element = $(options.element);
	this.name = options.name;
	this.enabled = !this.element.hasClassName('</span>in2igui_toolbar_icon_disabled<span class="literal">');
	this.icon = this.element.select('</span>.in2igui_icon<span class="literal">')[0];
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Toolbar.Icon.create = function(options) {
	var element = options.element = new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_toolbar_icon<span class="literal">'});
	var icon = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_icon<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl(options.icon,2)+'</span>)<span class="literal">'});
	var inner = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_toolbar_inner_icon<span class="literal">'});
	var innerest = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_toolbar_inner_icon<span class="literal">'});
	element.insert(inner);
	inner.insert(innerest);
	var title = new Element('</span>strong<span class="literal">');
	title.innerHTML=options.title;
	if (options.overlay) {
		var overlay = new Element('</span>span<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_icon_overlay<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl('</span>overlay/<span class="literal">'+options.overlay,2)+'</span>)<span class="literal">'});
		icon.insert(overlay);
	}
	innerest.insert(icon);
	innerest.insert(title);
	return new In2iGui.Toolbar.Icon(options);
}

In2iGui.Toolbar.Icon.prototype = {
	/** @private */
	addBehavior : function() {
		var self = this;
		this.element.onclick = function() {
			self.wasClicked();
		}
	},
	/** Sets wether the icon should be enabled */
	setEnabled : function(enabled) {
		this.enabled = enabled;
		this.element.setClassName('</span>in2igui_toolbar_icon_disabled<span class="literal">',!this.enabled);
	},
	/** Sets wether the icon should be selected */
	setSelected : function(selected) {
		this.element.setClassName('</span>in2igui_toolbar_icon_selected<span class="literal">',selected);
	},
	/** @private */
	wasClicked : function() {
		if (this.enabled) {
			In2iGui.callDelegates(this,'</span>toolbarIconWasClicked<span class="literal">');
			In2iGui.callDelegates(this,'</span>click<span class="literal">');
		}
	}
}


/////////////////////// Search field ///////////////////////

/** @constructor */
In2iGui.Toolbar.SearchField = function(options) {
	this.options = options;
	this.element = $(options.element);
	this.name = options.name;
	this.field = this.element.select('</span>input<span class="literal">')[0];
	this.value = this.field.value;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Toolbar.SearchField.create = function(options) {
	options = options || {};
	var e = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">': options.adaptive ? '</span>in2igui_toolbar_search in2igui_toolbar_search_adaptive<span class="literal">' : '</span>in2igui_toolbar_search<span class="literal">'});
	e.update('</span>&lt;div class=<span class="literal">"in2igui_searchfield"</span>&gt;&lt;strong class=<span class="literal">"in2igui_searchfield_button"</span>&gt;&lt;/strong&gt;&lt;div&gt;&lt;div&gt;&lt;input type=<span class="literal">"text"</span>/&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;span&gt;<span class="literal">'+options.title+'</span>&lt;/span&gt;<span class="literal">');
	return new In2iGui.Toolbar.SearchField(options);
}

In2iGui.Toolbar.SearchField.prototype = {
	getValue : function() {
		return this.field.value;
	},
	addBehavior : function() {
		var self = this;
		this.field.onkeyup = function() {
			self.fieldChanged();
		}
		if (!this.options.adaptive) {
			this.field.onfocus = function() {
				n2i.ani(this,'</span>width<span class="literal">','</span>120px<span class="literal">',500,{ease:n2i.ease.slowFastSlow});
			}
			this.field.onblur = function() {
				n2i.ani(this,'</span>width<span class="literal">','</span>80px<span class="literal">',500,{ease:n2i.ease.slowFastSlow});
			}
		}
	},
	fieldChanged : function() {
		if (this.field.value!=this.value) {
			this.value=this.field.value;
			In2iGui.callDelegates(this,'</span>valueChanged<span class="literal">');
			In2iGui.firePropertyChange(this,'</span>value<span class="literal">',this.value);
		}
	}
}


//////////////////////// Badge ///////////////////////

/** @constructor */
In2iGui.Toolbar.Badge = function(options) {
	this.element = $(options.element);
	this.name = options.name;
	this.label = this.element.select('</span>strong<span class="literal">')[0];
	this.text = this.element.select('</span>span<span class="literal">')[0];
	In2iGui.extend(this);
}

In2iGui.Toolbar.Badge.prototype = {
	setLabel : function(str) {
		this.label.update(str);
	},
	setText : function(str) {
		this.text.update(str);
	}
}

/* EOF *//**
	Used to choose an image
	@constructor
*/
In2iGui.ImagePicker = function(o) {
	this.name = o.name;
	this.options = o || {};
	this.element = $(o.element);
	this.images = [];
	this.object = null;
	this.thumbnailsLoaded = false;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.ImagePicker.prototype = {
	/** @private */
	addBehavior : function() {
		this.element.onclick = this.showPicker.bind(this);
	},
	setObject : function(obj) {
		this.object = obj;
		this.updateUI();
	},
	getObject : function() {
		return this.object;
	},
	reset : function() {
		this.object = null;
		this.updateUI();
	},
	/** @private */
	updateUI : function() {
		if (this.object==null) {
			this.element.style.backgroundImage='</span><span class="literal">';
		} else {
			var url = In2iGui.resolveImageUrl(this,this.object,48,48);
			this.element.style.backgroundImage='</span>url(<span class="literal">'+url+'</span>)<span class="literal">';
		}
	},
	/** @private */
	showPicker : function() {
		if (!this.picker) {
			var self = this;
			this.picker = In2iGui.BoundPanel.create();
			this.content = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_imagepicker_thumbs<span class="literal">'});
			var buttons = In2iGui.Buttons.create({align:'</span>right<span class="literal">'});
			var close = In2iGui.Button.create({text:'</span>Luk<span class="literal">',highlighted:true});
			close.listen({
				$click:function() {self.hidePicker()}
			});
			var remove = In2iGui.Button.create({text:'</span>Fjern<span class="literal">'});
			remove.listen({
				$click:function() {self.setObject(null);self.hidePicker()}
			});
			buttons.add(remove).add(close);
			this.picker.add(this.content);
			this.picker.add(buttons);
		}
		this.picker.position(this.element);
		this.picker.show();
		if (!this.thumbnailsLoaded) {
			this.updateImages();
			this.thumbnailsLoaded = true;
		}
	},
	/** @private */
	hidePicker : function() {
		this.picker.hide();
	},
	/** @private */
	updateImages : function() {
		var self = this;
		var delegate = {
			onSuccess:function(t) {
				self.parse(t.responseXML);
			}
		};
		new Ajax.Request(this.options.source,delegate);
	},
	/** @private */
	parse : function(doc) {
		this.content.update();
		var images = doc.getElementsByTagName('</span>image<span class="literal">');
		var self = this;
		for (var i=0; i &lt; images.length; i++) {
			var id = images[i].getAttribute('</span>id<span class="literal">');
			var img = {id:images[i].getAttribute('</span>id<span class="literal">')};
			var url = In2iGui.resolveImageUrl(this,img,48,48);
			var thumb = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_imagepicker_thumbnail<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+url+'</span>)<span class="literal">'});
			thumb.in2iguiObject = {'</span>id<span class="literal">':id};
			thumb.onclick = function() {
				self.setObject(this.in2iguiObject);
				self.hidePicker();
			}
			this.content.appendChild(thumb);
		};
	}
}

/* EOF *//**
 * A bound panel is a panel that is shown at a certain place
 * @constructor
 * @param {Object} options { element: Node | id, name: String }
 */
In2iGui.BoundPanel = function(options) {
	this.element = $(options.element);
	this.name = options.name;
	this.visible = false;
	this.content=this.element.select('</span>.content<span class="literal">')[0];
	this.arrow=this.element.select('</span>.arrow<span class="literal">')[0];
	In2iGui.extend(this);
}

/**
 * Creates a new bound panel
 * &lt;br/&gt;&lt;strong&gt;options:&lt;/strong&gt; { name: String, top: pixels, left: pixels, padding: pixels, width: pixels }
 * @param {Object} options The options
 */
In2iGui.BoundPanel.create = function(options) {
	var options = n2i.override({name:null, top:0, left:0, width:null, padding: null}, options);
	var element = options.element = new Element('</span>div<span class="literal">',
		{'</span>class<span class="literal">':'</span>in2igui_boundpanel<span class="literal">'}).setStyle({'</span>display<span class="literal">':'</span>none<span class="literal">','</span>zIndex<span class="literal">':In2iGui.nextPanelIndex(),'</span>top<span class="literal">':options.top+'</span>px<span class="literal">','</span>left<span class="literal">':options.left+'</span>px<span class="literal">'});
	
	var html = 
		'</span>&lt;div class=<span class="literal">"arrow"</span>&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"top"</span>&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"content"</span> style=<span class="literal">"';
	if (options.width) {
		html+='width:'+options.width+'px;';
	}
	if (options.padding) {
		html+='padding:'+options.padding+'px;';
	}
	html+='"</span>&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"bottom"</span>&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">';
	element.innerHTML=html;
	document.body.appendChild(element);
	return new In2iGui.BoundPanel(options);
}

/********************************* Public methods ***********************************/

In2iGui.BoundPanel.prototype = {
	/** Shows the panel */
	show : function() {
		if (!this.visible) {
			if (!n2i.browser.msie) {
				n2i.setOpacity(this.element,0);
			}
			if (this.relativePosition=='</span>left<span class="literal">') {
				this.element.style.marginLeft='</span>30px<span class="literal">';
			} else {
				this.element.style.marginLeft='</span>-30px<span class="literal">';
			}
			this.element.setStyle({
				visibility : '</span>hidden<span class="literal">', display : '</span>block<span class="literal">'
			})
			var width = this.element.clientWidth;
			this.element.setStyle({
				width : width+'</span>px<span class="literal">' , visibility : '</span>visible<span class="literal">'
			});
			this.element.style.marginTop='</span>0px<span class="literal">';
			this.element.style.display='</span>block<span class="literal">';
			if (!n2i.browser.msie) {
				n2i.ani(this.element,'</span>opacity<span class="literal">',1,400,{ease:n2i.ease.fastSlow});
			}
			n2i.ani(this.element,'</span>margin-left<span class="literal">','</span>0px<span class="literal">',800,{ease:n2i.ease.bounce});
		}
		this.element.style.zIndex = In2iGui.nextPanelIndex();
		this.visible=true;
	},
	/** Hides the panel */
	hide : function() {
		if (n2i.browser.msie) {
			this.element.style.display='</span>none<span class="literal">';
		} else {
			n2i.ani(this.element,'</span>opacity<span class="literal">',0,300,{ease:n2i.ease.slowFast,hideOnComplete:true});
		}
		this.visible=false;
	},
	/**
	 * Adds a widget or element to the panel
	 * @param {Node | Widget} child The object to add
	 */
	add : function(child) {
		if (child.getElement) {
			this.content.insert(child.getElement());
		} else {
			this.content.insert(child);
		}
	},
	/**
	 * Adds som vertical space to the panel
	 * @param {pixels} height The height of the space in pixels
	 */
	addSpace : function(height) {
		this.add(new Element('</span>div<span class="literal">').setStyle({fontSize:'</span>0px<span class="literal">',height:height+'</span>px<span class="literal">'}));
	},
	/** @private */
	getDimensions : function() {
		if (this.element.style.display=='</span>none<span class="literal">') {
			this.element.style.visibility='</span>hidden<span class="literal">';
			this.element.style.display='</span>block<span class="literal">';
			var width = this.element.getWidth();
			var height = this.element.getHeight();
			this.element.style.display='</span>none<span class="literal">';
			this.element.style.visibility='</span><span class="literal">';
		} else {
			var width = this.element.getWidth();
			var height = this.element.getHeight();
		}
		return {width:width,height:height};
	},
	/** Position the panel at a node
	 * @param {Node} node The node the panel should be positioned at 
	 */
	position : function(node) {
		node = $(node);
		var offset = node.cumulativeOffset();
		var scrollOffset = node.cumulativeScrollOffset();
		var dims = this.getDimensions();
		var winWidth = n2i.getInnerWidth();
		var nodeLeft = offset.left-scrollOffset.left+n2i.getScrollLeft();
		var nodeWidth = node.getWidth();
		var nodeHeight = node.getHeight();
		var nodeTop = offset.top-scrollOffset.top+n2i.getScrollTop();
		if ((nodeLeft+nodeWidth/2)/winWidth&lt;.5) {
			this.relativePosition='</span>left<span class="literal">';
			var left = nodeLeft+nodeWidth+10;
			this.arrow.className='</span>arrow arrow_left<span class="literal">';
			var arrowLeft=-14;
		} else {
			this.relativePosition='</span>right<span class="literal">';
			var left = nodeLeft-dims.width-10;
			this.arrow.className='</span>arrow arrow_right<span class="literal">';
			var arrowLeft=dims.width-4;
		}
		var top = Math.max(0,nodeTop+(nodeHeight-dims.height)/2);
		this.arrow.style.marginTop = (dims.height-32)/2+Math.min(0,nodeTop+(nodeHeight-dims.height)/2)+'</span>px<span class="literal">';
		this.arrow.style.marginLeft = arrowLeft+'</span>px<span class="literal">';
		if (this.visible) {
			n2i.ani(this.element,'</span>top<span class="literal">',top+'</span>px<span class="literal">',500,{ease:n2i.ease.fastSlow});
			n2i.ani(this.element,'</span>left<span class="literal">',left+'</span>px<span class="literal">',500,{ease:n2i.ease.fastSlow});
		} else {
			this.element.style.top=top+'</span>px<span class="literal">';
			this.element.style.left=left+'</span>px<span class="literal">';
		}
	}
}

/* EOF *//**
 * @constructor
 */
In2iGui.RichText = function(options) {
	this.name = options.name;
	var e = this.element = $(options.element);
	this.options = n2i.override({debug:false,value:'</span><span class="literal">',autoHideToolbar:true,style:'</span>font-family: sans-serif;<span class="literal">'},options);
	this.textarea = new Element('</span>textarea<span class="literal">');
	e.insert(this.textarea);
	this.editor = WysiHat.Editor.attach(this.textarea);
	this.editor.setAttribute('</span>frameborder<span class="literal">','</span>0<span class="literal">');
	/* @private */
	this.toolbar = e.select('</span>.in2igui_richtext_toolbar<span class="literal">')[0];
	this.toolbarContent = e.select('</span>.in2igui_richtext_toolbar_content<span class="literal">')[0];
	this.value = this.options.value;
	this.document = null;
	this.ignited = false;
	this.buildToolbar();
	this.ignite();
	In2iGui.extend(this);
}

In2iGui.RichText.actions = [
	{key:'</span>bold<span class="literal">',				cmd:'</span>bold<span class="literal">',				value:null,		icon:'</span>edit/text_bold<span class="literal">'},
	{key:'</span>italic<span class="literal">',				cmd:'</span>italic<span class="literal">',			value:null,		icon:'</span>edit/text_italic<span class="literal">'},
	{key:'</span>underline<span class="literal">',			cmd:'</span>underline<span class="literal">',		value:null,		icon:'</span>edit/text_underline<span class="literal">'},
	null,
	{key:'</span>justifyleft<span class="literal">',			cmd:'</span>justifyleft<span class="literal">',		value:null,		icon:'</span>edit/text_align_left<span class="literal">'},
	{key:'</span>justifycenter<span class="literal">',		cmd:'</span>justifycenter<span class="literal">',	value:null,		icon:'</span>edit/text_align_center<span class="literal">'},
	{key:'</span>justifyright<span class="literal">',		cmd:'</span>justifyright<span class="literal">',		value:null,		icon:'</span>edit/text_align_right<span class="literal">'},
	null,
	{key:'</span>increasefontsize<span class="literal">',	cmd:'</span>increasefontsize<span class="literal">',	value:null,		icon:'</span>edit/increase_font_size<span class="literal">'},
	{key:'</span>decreasefontsize<span class="literal">',	cmd:'</span>decreasefontsize<span class="literal">',	value:null,		icon:'</span>edit/decrease_font_size<span class="literal">'},
	{key:'</span>color<span class="literal">',				cmd:null,				value:null,		icon:'</span>common/color<span class="literal">'}
	/*,
	null,
	{key:'</span>p<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>p<span class="literal">'},
	{key:'</span>h1<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h1<span class="literal">'},
	{key:'</span>h2<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h2<span class="literal">'},
	{key:'</span>h3<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h3<span class="literal">'},
	{key:'</span>h4<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h4<span class="literal">'},
	{key:'</span>h5<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h5<span class="literal">'},
	{key:'</span>h6<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h6<span class="literal">'},
	{key:'</span>removeformat<span class="literal">', 	cmd:'</span>removeformat<span class="literal">', 	'</span>value<span class="literal">':null}*/
];

In2iGui.RichText.replaceInput = function(options) {
	options = options || {};
	var input = $(options.input);
	input.style.display='</span>none<span class="literal">';
	options.value = input.value;
	var obj = In2iGui.RichText.create(options);
	input.parentNode.insertBefore(obj.element,input);
	obj.ignite();
}

In2iGui.RichText.create = function(options) {
	options = options || {};
	options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_richtext<span class="literal">'}).update(
		'</span>&lt;div class=<span class="literal">"in2igui_richtext_toolbar"</span>&gt;&lt;div class=<span class="literal">"in2igui_richtext_inner_toolbar"</span>&gt;&lt;div class=<span class="literal">"in2igui_richtext_toolbar_content"</span>&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'
	);
	return new In2iGui.RichText(options);
}

In2iGui.RichText.prototype = {
	isCompatible : function() {
	    var agt=navigator.userAgent.toLowerCase();
		return true;
		return (agt.indexOf('</span>msie 6<span class="literal">')&gt;-1 || agt.indexOf('</span>msie 7<span class="literal">')&gt;-1 || (agt.indexOf('</span>gecko<span class="literal">')&gt;-1 &amp;&amp; agt.indexOf('</span>safari<span class="literal">')&lt;0));
	},
	ignite : function() {
		var self = this;
		this.editor.observe("wysihat:loaded", function(event) {
			if (this.ignited) {
				return;
			}
			this.editor.setStyle(this.options.style);
			this.editor.setRawContent(this.value);
			this.document = this.editor.getDocument();
			if (this.document.body) {
				this.document.body.style.minHeight='</span>100%<span class="literal">';
				this.document.body.style.margin='</span>0<span class="literal">';
				this.document.documentElement.style.cursor='</span>text<span class="literal">';
				this.document.documentElement.style.minHeight='</span>100%<span class="literal">';
				Element.setStyle(this.document.body,this.options.style);
			}
			this.window = this.editor.getWindow();
			Event.observe(this.window,'</span>focus<span class="literal">',function() {self.documentFocused()});
			Event.observe(this.window,'</span>blur<span class="literal">',function() {self.documentBlurred()});
			this.document.body.focus();
			this.ignited = true;
     	}.bind(this));
		this.editor.observe("wysihat:change", function(event) {
        	this.documentChanged();
     	}.bind(this));
	},
	setHeight : function(height) {
		this.editor.style.height=height+'</span>px<span class="literal">';
	},
	focus : function() {
		try { // TODO : May only work in gecko
			var r = this.document.createRange();
			r.selectNodeContents(this.document.body);
			this.window.getSelection().addRange(r);
		} catch (ignore) {}
		if (this.window)this.window.focus();
	},
	setValue : function(value) {
		this.value = value;
		this.editor.setRawContent(this.value);
	},
	getValue : function() {
		return this.value;
	},
	deactivate : function() {
		if (this.colorPicker) this.colorPicker.hide();
		if (this.toolbar) this.toolbar.style.display='</span>none<span class="literal">';
	},
	
	buildToolbar : function() {
		this.toolbar.onmousedown = function() {this.toolbarMouseDown=true}.bind(this);
		this.toolbar.onmouseup = function() {this.toolbarMouseDown=false}.bind(this);
		var self = this;
		var actions = In2iGui.RichText.actions;
		for (var i=0; i &lt; actions.length; i++) {
			if (actions[i]==null) {
				this.toolbarContent.insert(new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_richtext_divider<span class="literal">'}));
			} else {
				var div = new Element('</span>div<span class="literal">').addClassName('</span>action action_<span class="literal">'+actions[i].key);
				div.title=actions[i].key;
				div.in2iguiRichTextAction = actions[i]
				div.onclick = div.ondblclick = function(e) {return self.actionWasClicked(this.in2iguiRichTextAction,e);}
				var img = new Element('</span>img<span class="literal">');
				img.src=In2iGui.context+'</span>/In2iGui/gfx/trans.png<span class="literal">';
				if (actions[i].icon) {
					div.setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl(actions[i].icon,1)+'</span>)<span class="literal">'});
				}
				div.insert(img);
				this.toolbarContent.appendChild(div);
				div.onmousedown = In2iGui.RichText.stopEvent;
			}
		};
	},
	documentFocused : function() {
		if (n2i.browser.msie) {
			this.toolbar.style.display='</span>block<span class="literal">';
			return;
		}
		if (this.toolbar.style.display!='</span>block<span class="literal">') {
			this.toolbar.style.marginTop='</span>-40px<span class="literal">';
			n2i.setOpacity(this.toolbar,0);
			this.toolbar.style.display='</span>block<span class="literal">';
			n2i.ani(this.toolbar,'</span>opacity<span class="literal">',1,300);
			n2i.ani(this.toolbar,'</span>margin-top<span class="literal">','</span>-32px<span class="literal">',300);
		}
	},
	
	documentBlurred : function() {
		if (this.toolbarMouseDown) return;
		if (this.options.autoHideToolbar) {
			if (n2i.browser.msie) {
				var self = this;
				window.setTimeout(function() {
					self.toolbar.style.display='</span>none<span class="literal">';
				},100);
				return;
			}
			n2i.ani(this.toolbar,'</span>opacity<span class="literal">',0,300,{hideOnComplete:true});
			n2i.ani(this.toolbar,'</span>margin-top<span class="literal">','</span>-40px<span class="literal">',300);
		}
		this.documentChanged();
		In2iGui.callDelegates(this,'</span>richTextDidChange<span class="literal">');
	},
	
	documentChanged : function() {
		this.value = this.editor.content();
		if (this.options.input) {
			$(this.options.input).value=this.value;
		}
	},
	
	disabler : function(e) {
		var evt = e ? e : window.event; 
		if (evt.returnValue) {
			evt.returnValue = false;
		} else if (evt.preventDefault) {
			evt.preventDefault( );
		}
		return false;
	},
	actionWasClicked : function(action,e) {
		In2iGui.RichText.stopEvent(e);
		if (action.key=='</span>color<span class="literal">') {
			this.showColorPicker();
		} else {
			this.execCommand(action);
		}
		this.document.body.focus();
		return false;
	},
	execCommand : function(action) {
		this.editor.execCommand(action.cmd,false,action.value);
		this.documentChanged();
	},
	showColorPicker : function() {
		if (!this.colorPicker) {
			var panel = In2iGui.Window.create({variant:'</span>dark<span class="literal">'});
			var picker = In2iGui.ColorPicker.create();
			picker.addDelegate(this);
			panel.add(picker);
			panel.show();
			this.colorPicker = panel;
		}
		this.colorPicker.show();
	},
	colorWasHovered : function(color) {
		//this.document.execCommand('</span>forecolor<span class="literal">',false,color);
	},
	colorWasSelected : function(color) {
		this.document.execCommand('</span>forecolor<span class="literal">',false,color);
		this.documentChanged();
	}
}



In2iGui.RichText.stopEvent = function(e) {
  var evt = e ? e : window.event; 
  if (evt.returnValue) {
    evt.returnValue = false;
  } else if (evt.preventDefault) {
    evt.preventDefault( );
  } else {
    return false;
  }
}

/* EOF *//**
 @constructor
 */
In2iGui.ImageViewer = function(options) {
	this.options = n2i.override({
		maxWidth:800,maxHeight:600,perimeter:100,sizeSnap:100,
		margin:0,
		ease:n2i.ease.slowFastSlow,
		easeEnd:n2i.ease.bounce,
		easeAuto:n2i.ease.slowFastSlow,
		easeReturn:n2i.ease.cubicInOut,transition:400,transitionEnd:1000,transitionReturn:300
		},options);
	this.element = $(options.element);
	this.box = this.options.box;
	this.viewer = this.element.select('</span>.in2igui_imageviewer_viewer<span class="literal">')[0];
	this.innerViewer = this.element.select('</span>.in2igui_imageviewer_inner_viewer<span class="literal">')[0];
	this.status = this.element.select('</span>.in2igui_imageviewer_status<span class="literal">')[0];
	this.previousControl = this.element.select('</span>.in2igui_imageviewer_previous<span class="literal">')[0];
	this.controller = this.element.select('</span>.in2igui_imageviewer_controller<span class="literal">')[0];
	this.nextControl = this.element.select('</span>.in2igui_imageviewer_next<span class="literal">')[0];
	this.playControl = this.element.select('</span>.in2igui_imageviewer_play<span class="literal">')[0];
	this.closeControl = this.element.select('</span>.in2igui_imageviewer_close<span class="literal">')[0];
	this.text = this.element.select('</span>.in2igui_imageviewer_text<span class="literal">')[0];
	this.dirty = false;
	this.width = 600;
	this.height = 460;
	this.index = 0;
	this.playing=false;
	this.name = options.name;
	this.images = [];
	this.box.addDelegate(this);
	this.addBehavior();
	In2iGui.extend(this);
}

In2iGui.ImageViewer.create = function(options) {
	options = options || {};
	var element = options.element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_imageviewer<span class="literal">'});
	element.update('</span>&lt;div class=<span class="literal">"in2igui_imageviewer_viewer"</span>&gt;&lt;div class=<span class="literal">"in2igui_imageviewer_inner_viewer"</span>&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
	'</span>&lt;div class=<span class="literal">"in2igui_imageviewer_text"</span>&gt;&lt;/div&gt;<span class="literal">'+
	'</span>&lt;div class=<span class="literal">"in2igui_imageviewer_status"</span>&gt;&lt;/div&gt;<span class="literal">'+
	'</span>&lt;div class=<span class="literal">"in2igui_imageviewer_controller"</span>&gt;&lt;div&gt;&lt;div&gt;<span class="literal">'+
	'</span>&lt;a class=<span class="literal">"in2igui_imageviewer_previous"</span>&gt;&lt;/a&gt;<span class="literal">'+
	'</span>&lt;a class=<span class="literal">"in2igui_imageviewer_play"</span>&gt;&lt;/a&gt;<span class="literal">'+
	'</span>&lt;a class=<span class="literal">"in2igui_imageviewer_next"</span>&gt;&lt;/a&gt;<span class="literal">'+
	'</span>&lt;a class=<span class="literal">"in2igui_imageviewer_close"</span>&gt;&lt;/a&gt;<span class="literal">'+
	'</span>&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">');
	var box = In2iGui.Box.create({absolute:true,modal:true,closable:true});
	box.add(element);
	box.addToDocument();
	options.box=box;
	return new In2iGui.ImageViewer(options);
}

In2iGui.ImageViewer.prototype = {
	/** @private */
	addBehavior : function() {
		var self = this;
		this.nextControl.onclick = function() {
			self.next(true);
		}
		this.previousControl.onclick = function() {
			self.previous(true);
		}
		this.playControl.onclick = function() {
			self.playOrPause();
		}
		this.closeControl.onclick = this.hide.bind(this);
		this.viewer.observe('</span>click<span class="literal">',this.zoom.bind(this));
		this.timer = function() {
			self.next(false);
		}
		this.keyListener = function(e) {
			if (n2i.isRightKey(e)) {
				self.next(true);
			} else if (n2i.isLeftKey(e)) {
				self.previous(true);
			} else if (n2i.isEscapeKey(e)) {
				self.hide();
			} else if (n2i.isReturnKey(e)) {
				self.playOrPause();
			}
		},
		this.viewer.observe('</span>mousemove<span class="literal">',this.mouseMoveEvent.bind(this));
		this.controller.observe('</span>mouseenter<span class="literal">',function() {
			self.overController = true;
		});
		this.controller.observe('</span>mouseleave<span class="literal">',function() {
			self.overController = false;
		});
		this.viewer.observe('</span>mouseout<span class="literal">',function(e) {
			if (!In2iGui.isWithin(e,this.viewer)) {
				self.hideController();
			}
		}.bind(this));
	},
	/** @private */
	mouseMoveEvent : function() {
		window.clearTimeout(this.ctrlHider);
		if (this.shouldShowController()) {
			this.ctrlHider = window.setTimeout(this.hideController.bind(this),2000);
			if (n2i.browser.msie) {
				this.controller.show();
			} else {
				In2iGui.fadeIn(this.controller,200);
			}
		}
	},
	/** @private */
	hideController : function() {
		if (!this.overController) {
			if (n2i.browser.msie) {
				this.controller.hide();
			} else {
				In2iGui.fadeOut(this.controller,500);
			}
		}
	},
	/** @private */
	zoom : function(e) {
		var img = this.images[this.index];
		if (img.width&lt;=this.width &amp;&amp; img.height&lt;=this.height) {
			return; // Don'</span>t zoom <span class="reserved">if</span> small
		}
		<span class="reserved">if</span> (!<span class="reserved">this</span>.zoomer) {
			<span class="reserved">this</span>.zoomer = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_imageviewer_zoomer'</span>}).setStyle({width:<span class="reserved">this</span>.viewer.clientWidth+<span class="literal">'px'</span>,height:<span class="reserved">this</span>.viewer.clientHeight+<span class="literal">'px'</span>});
			<span class="reserved">this</span>.element.insert({top:<span class="reserved">this</span>.zoomer});
			<span class="reserved">this</span>.zoomer.observe(<span class="literal">'mousemove'</span>,<span class="reserved">this</span>.zoomMove.bind(<span class="reserved">this</span>));
			<span class="reserved">this</span>.zoomer.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>() {
				<span class="reserved">this</span>.hide();
			});
		}
		<span class="reserved">this</span>.pause();
		var size = <span class="reserved">this</span>.getLargestSize({width:2000,height:2000},img);
		var url = In2iGui.resolveImageUrl(<span class="reserved">this</span>,img,size.width,size.height);
		<span class="reserved">this</span>.zoomer.update(<span class="literal">'&lt;div style="width:'</span>+size.width+<span class="literal">'px;height:'</span>+size.height+<span class="literal">'px;"&gt;&lt;img src="'</span>+url+<span class="literal">'"/&gt;&lt;/div&gt;'</span>).show();
		<span class="reserved">this</span>.zoomInfo = {width:size.width,height:size.height};
		<span class="reserved">this</span>.zoomMove(e);
	},
	zoomMove : <span class="reserved">function</span>(e) {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.zoomInfo) {
			<span class="reserved">return</span>;
		}
		var offset = <span class="reserved">this</span>.zoomer.cumulativeOffset();
		var x = (e.pointerX()-offset.left)/<span class="reserved">this</span>.zoomer.clientWidth*(<span class="reserved">this</span>.zoomInfo.width-<span class="reserved">this</span>.zoomer.clientWidth);
		var y = (e.pointerY()-offset.top)/<span class="reserved">this</span>.zoomer.clientHeight*(<span class="reserved">this</span>.zoomInfo.height-<span class="reserved">this</span>.zoomer.clientHeight);
		<span class="reserved">this</span>.zoomer.scrollLeft = x;
		<span class="reserved">this</span>.zoomer.scrollTop = y;
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	getLargestSize : <span class="reserved">function</span>(canvas,image) {
		<span class="reserved">if</span> (image.width&lt;=canvas.width &amp;&amp; image.height&lt;=canvas.height) {
			<span class="reserved">return</span> {width:image.width,height:image.height};
		} <span class="reserved">else</span> <span class="reserved">if</span> (canvas.width/canvas.height&gt;image.width/image.height) {
			<span class="reserved">return</span> {width:Math.round(canvas.height/image.height*image.width),height:canvas.height};
		} <span class="reserved">else</span> <span class="reserved">if</span> (canvas.width/canvas.height&lt;image.width/image.height) {
			<span class="reserved">return</span> {width:canvas.width,height:Math.round(canvas.width/image.width*image.height)};
		} <span class="reserved">else</span> {
			<span class="reserved">return</span> {width:canvas.width,height:canvas.height};
		}
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	calculateSize : <span class="reserved">function</span>() {
		var snap = <span class="reserved">this</span>.options.sizeSnap;
		var newWidth = n2i.getInnerWidth()-<span class="reserved">this</span>.options.perimeter;
		newWidth = Math.floor(newWidth/snap)*snap;
		newWidth = Math.min(newWidth,<span class="reserved">this</span>.options.maxWidth);
		var newHeight = n2i.getInnerHeight()-<span class="reserved">this</span>.options.perimeter;
		newHeight = Math.floor(newHeight/snap)*snap;
		newHeight = Math.min(newHeight,<span class="reserved">this</span>.options.maxHeight);
		var maxWidth = 0;
		var maxHeight = 0;
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.images.length; i++) {
			var dims = <span class="reserved">this</span>.getLargestSize({width:newWidth,height:newHeight},<span class="reserved">this</span>.images[i]);
			maxWidth = Math.max(maxWidth,dims.width);
			maxHeight = Math.max(maxHeight,dims.height);
		};
		newHeight = Math.floor(Math.min(newHeight,maxHeight));
		newWidth = Math.floor(Math.min(newWidth,maxWidth));
		
		<span class="reserved">if</span> (newWidth!=<span class="reserved">this</span>.width || newHeight!=<span class="reserved">this</span>.height) {
			<span class="reserved">this</span>.width = newWidth;
			<span class="reserved">this</span>.height = newHeight;
			<span class="reserved">this</span>.dirty = true;
		}
	},
	adjustSize : <span class="reserved">function</span>() {
		
	},
	showById: <span class="reserved">function</span>(id) {
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.images.length; i++) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.images[i].id==id) {
				<span class="reserved">this</span>.show(i);
				break;
			}
		};
	},
	show: <span class="reserved">function</span>(index) {
		<span class="reserved">this</span>.index = index || 0;
		<span class="reserved">this</span>.calculateSize();
		<span class="reserved">this</span>.updateUI();
		var margin = <span class="reserved">this</span>.options.margin;
		<span class="reserved">this</span>.element.setStyle({width:(<span class="reserved">this</span>.width+margin)+<span class="literal">'px'</span>,height:(<span class="reserved">this</span>.height+margin*2-1)+<span class="literal">'px'</span>});
		<span class="reserved">this</span>.viewer.setStyle({width:(<span class="reserved">this</span>.width+margin)+<span class="literal">'px'</span>,height:(<span class="reserved">this</span>.height-1)+<span class="literal">'px'</span>});
		<span class="reserved">this</span>.innerViewer.setStyle({width:((<span class="reserved">this</span>.width+margin)*<span class="reserved">this</span>.images.length)+<span class="literal">'px'</span>,height:(<span class="reserved">this</span>.height-1)+<span class="literal">'px'</span>});
		<span class="reserved">this</span>.controller.setStyle({marginLeft:((<span class="reserved">this</span>.width-180)/2+margin*0.5)+<span class="literal">'px'</span>,display:<span class="literal">'none'</span>});
		<span class="reserved">this</span>.box.show();
		<span class="reserved">this</span>.goToImage(false,0,false);
		Event.observe(document,<span class="literal">'keydown'</span>,<span class="reserved">this</span>.keyListener);
	},
	hide: <span class="reserved">function</span>(index) {
		<span class="reserved">this</span>.pause();
		<span class="reserved">this</span>.box.hide();
		Event.stopObserving(document,<span class="literal">'keydown'</span>,<span class="reserved">this</span>.keyListener);
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	$boxCurtainWasClicked : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.hide();
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	$boxWasClosed : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.hide();
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	updateUI : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.dirty) {
			<span class="reserved">this</span>.innerViewer.innerHTML=<span class="literal">''</span>;
			<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.images.length; i++) {
				var element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_imageviewer_image'</span>}).setStyle({<span class="literal">'width'</span>:(<span class="reserved">this</span>.width+<span class="reserved">this</span>.options.margin)+<span class="literal">'px'</span>,<span class="literal">'height'</span>:(<span class="reserved">this</span>.height-1)+<span class="literal">'px'</span>});
				<span class="reserved">this</span>.innerViewer.appendChild(element);
			};
			<span class="reserved">if</span> (<span class="reserved">this</span>.shouldShowController()) {
				<span class="reserved">this</span>.controller.show();
			} <span class="reserved">else</span> {
				<span class="reserved">this</span>.controller.hide();
			}
			<span class="reserved">this</span>.dirty = false;
			<span class="reserved">this</span>.preload();
		}
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	shouldShowController : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.images.length&gt;1;
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	goToImage : <span class="reserved">function</span>(animate,num,user) {	
		<span class="reserved">if</span> (animate) {
			<span class="reserved">if</span> (num&gt;1) {
				n2i.ani(<span class="reserved">this</span>.viewer,<span class="literal">'scrollLeft'</span>,<span class="reserved">this</span>.index*(<span class="reserved">this</span>.width+<span class="reserved">this</span>.options.margin),Math.min(num*<span class="reserved">this</span>.options.transitionReturn,2000),{ease:<span class="reserved">this</span>.options.easeReturn});				
			} <span class="reserved">else</span> {
				var end = <span class="reserved">this</span>.index==0 || <span class="reserved">this</span>.index==<span class="reserved">this</span>.images.length-1;
				var ease = (end ? <span class="reserved">this</span>.options.easeEnd : <span class="reserved">this</span>.options.ease);
				<span class="reserved">if</span> (!user) {
					ease = <span class="reserved">this</span>.options.easeAuto;
				}
				n2i.ani(<span class="reserved">this</span>.viewer,<span class="literal">'scrollLeft'</span>,<span class="reserved">this</span>.index*(<span class="reserved">this</span>.width+<span class="reserved">this</span>.options.margin),(end ? <span class="reserved">this</span>.options.transitionEnd : <span class="reserved">this</span>.options.transition),{ease:ease});
			}
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.viewer.scrollLeft=<span class="reserved">this</span>.index*(<span class="reserved">this</span>.width+<span class="reserved">this</span>.options.margin);
		}
		var text = <span class="reserved">this</span>.images[<span class="reserved">this</span>.index].text;
		<span class="reserved">if</span> (text) {
			<span class="reserved">this</span>.text.update(text).show();			
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.text.update().hide();
		}
	},
	clearImages : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.images = [];
		<span class="reserved">this</span>.dirty = true;
	},
	addImages : <span class="reserved">function</span>(images) {
		<span class="reserved">for</span> (var i=0; i &lt; images.length; i++) {
			<span class="reserved">this</span>.addImage(images[i]);
		};
	},
	addImage : <span class="reserved">function</span>(img) {
		<span class="reserved">this</span>.images.push(img);
		<span class="reserved">this</span>.dirty = true;
	},
	play : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.interval) {
			<span class="reserved">this</span>.interval = window.setInterval(<span class="reserved">this</span>.timer,6000);
		}
		<span class="reserved">this</span>.next(false);
		<span class="reserved">this</span>.playing=true;
		<span class="reserved">this</span>.playControl.className=<span class="literal">'in2igui_imageviewer_pause'</span>;
	},
	pause : <span class="reserved">function</span>() {
		window.clearInterval(<span class="reserved">this</span>.interval);
		<span class="reserved">this</span>.interval = null;
		<span class="reserved">this</span>.playControl.className=<span class="literal">'in2igui_imageviewer_play'</span>;
		<span class="reserved">this</span>.playing = false;
	},
	playOrPause : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.playing) {
			<span class="reserved">this</span>.pause();
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.play();
		}
	},
	resetPlay : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.playing) {
			window.clearInterval(<span class="reserved">this</span>.interval);
			<span class="reserved">this</span>.interval = window.setInterval(<span class="reserved">this</span>.timer,6000);
		}
	},
	previous : <span class="reserved">function</span>(user) {
		var num = 1;
		<span class="reserved">this</span>.index--;
		<span class="reserved">if</span> (<span class="reserved">this</span>.index&lt;0) {
			<span class="reserved">this</span>.index=<span class="reserved">this</span>.images.length-1;
			num = <span class="reserved">this</span>.images.length-1;
		}
		<span class="reserved">this</span>.goToImage(true,num,user);
		<span class="reserved">this</span>.resetPlay();
	},
	next : <span class="reserved">function</span>(user) {
		var num = 1;
		<span class="reserved">this</span>.index++;
		<span class="reserved">if</span> (<span class="reserved">this</span>.index==<span class="reserved">this</span>.images.length) {
			<span class="reserved">this</span>.index=0;
			num = <span class="reserved">this</span>.images.length-1;
		}
		<span class="reserved">this</span>.goToImage(true,num,user);
		<span class="reserved">this</span>.resetPlay();
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	preload : <span class="reserved">function</span>() {
		var guiLoader = new n2i.Preloader();
		guiLoader.addImages(In2iGui.context+<span class="literal">'In2iGui/gfx/imageviewer_controls.png'</span>);
		var self = <span class="reserved">this</span>;
		guiLoader.setDelegate({allImagesDidLoad:<span class="reserved">function</span>() {self.preloadImages()}});
		guiLoader.load();
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	preloadImages : <span class="reserved">function</span>() {
		var loader = new n2i.Preloader();
		loader.setDelegate(<span class="reserved">this</span>);
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.images.length; i++) {
			var url = In2iGui.resolveImageUrl(<span class="reserved">this</span>,<span class="reserved">this</span>.images[i],<span class="reserved">this</span>.width,<span class="reserved">this</span>.height);
			<span class="reserved">if</span> (url!==null) {
				loader.addImages(url);
			}
		};
		<span class="reserved">this</span>.status.innerHTML = <span class="literal">'0%'</span>;
		<span class="reserved">this</span>.status.style.display=<span class="literal">''</span>;
		loader.load(<span class="reserved">this</span>.index);
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	allImagesDidLoad : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.status.style.display=<span class="literal">'none'</span>;
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	imageDidLoad : <span class="reserved">function</span>(loaded,total,index) {
		<span class="reserved">this</span>.status.innerHTML = Math.round(loaded/total*100)+<span class="literal">'%'</span>;
		var url = In2iGui.resolveImageUrl(<span class="reserved">this</span>,<span class="reserved">this</span>.images[index],<span class="reserved">this</span>.width,<span class="reserved">this</span>.height);
		url = url.replace(/&amp;amp;/g,<span class="literal">'&amp;'</span>);
		<span class="reserved">this</span>.innerViewer.childNodes[index].style.backgroundImage=<span class="literal">"url('"</span>+url+<span class="literal">"')"</span>;
		Element.setClassName(<span class="reserved">this</span>.innerViewer.childNodes[index],<span class="literal">'in2igui_imageviewer_image_abort'</span>,false);
		Element.setClassName(<span class="reserved">this</span>.innerViewer.childNodes[index],<span class="literal">'in2igui_imageviewer_image_error'</span>,false);
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	imageDidGiveError : <span class="reserved">function</span>(loaded,total,index) {
		Element.setClassName(<span class="reserved">this</span>.innerViewer.childNodes[index],<span class="literal">'in2igui_imageviewer_image_error'</span>,true);
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	imageDidAbort : <span class="reserved">function</span>(loaded,total,index) {
		Element.setClassName(<span class="reserved">this</span>.innerViewer.childNodes[index],<span class="literal">'in2igui_imageviewer_image_abort'</span>,true);
	}
}

<span class="comment">/* EOF */</span><span class="comment">/** <span class="attrib">@constructor</span> */</span>
In2iGui.Picker = <span class="reserved">function</span>(o) {
	o = <span class="reserved">this</span>.options = n2i.override({itemWidth:100,itemHeight:150,itemsVisible:null,shadow:true,valueProperty:<span class="literal">'value'</span>},o);
	<span class="reserved">this</span>.element = $(o.element);
	<span class="reserved">this</span>.name = o.name;
	<span class="reserved">this</span>.container = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_picker_container'</span>)[0];
	<span class="reserved">this</span>.content = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_picker_content'</span>)[0];
	<span class="reserved">this</span>.title = <span class="reserved">this</span>.element.select(<span class="literal">'in2igui_picker_title'</span>)[0];
	<span class="reserved">this</span>.objects = [];
	<span class="reserved">this</span>.selected = null;
	<span class="reserved">this</span>.value = null;
	<span class="reserved">this</span>.addBehavior();
	In2iGui.extend(<span class="reserved">this</span>);
}

In2iGui.Picker.create = <span class="reserved">function</span>(o) {
	o = n2i.override({shadow:true},o);
	var element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_picker'</span>});
	element.update(<span class="literal">'&lt;div class="in2igui_picker_top"&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;'</span>+
	<span class="literal">'&lt;div class="in2igui_picker_middle"&gt;&lt;div class="in2igui_picker_middle"&gt;'</span>+
	(o.title ? <span class="literal">'&lt;div class="in2igui_picker_title"&gt;'</span>+o.title+<span class="literal">'&lt;/div&gt;'</span> : <span class="literal">''</span>)+
	<span class="literal">'&lt;div class="in2igui_picker_container"&gt;&lt;div class="in2igui_picker_content"&gt;&lt;/div&gt;&lt;/div&gt;'</span>+
	<span class="literal">'&lt;/div&gt;&lt;/div&gt;'</span>+
	<span class="literal">'&lt;div class="in2igui_picker_bottom"&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;'</span>);
	<span class="reserved">if</span> (o.shadow==true) {
		element.addClassName(<span class="literal">'in2igui_picker_shadow'</span>)
	}
	o.element = element;
	<span class="reserved">return</span> new In2iGui.Picker(o);
}

In2iGui.Picker.<span class="reserved">prototype</span> = {
	addBehavior : <span class="reserved">function</span>() {
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.content.observe(<span class="literal">'mousedown'</span>,<span class="reserved">function</span>(e) {
			self.startDrag(e);
			<span class="reserved">return</span> false;
		});
	},
	setObjects : <span class="reserved">function</span>(objects) {
		<span class="reserved">this</span>.selected = null;
		<span class="reserved">this</span>.objects = objects || [];
		<span class="reserved">this</span>.updateUI();
	},
	setValue : <span class="reserved">function</span>(value) {
		<span class="reserved">this</span>.value = value;
		<span class="reserved">this</span>.updateSelection();
	},
	getValue : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value;
	},
	reset : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.value = null;
		<span class="reserved">this</span>.updateSelection();
	},
	updateUI : <span class="reserved">function</span>() {
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.content.update();
		<span class="reserved">this</span>.container.scrollLeft=0;
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.itemsVisible) {
			var width = <span class="reserved">this</span>.options.itemsVisible*(<span class="reserved">this</span>.options.itemWidth+14);
		} <span class="reserved">else</span> {
			var width = <span class="reserved">this</span>.container.clientWidth;
		}
		<span class="reserved">this</span>.container.setStyle({width:width+<span class="literal">'px'</span>,height:(<span class="reserved">this</span>.options.itemHeight+10)+<span class="literal">'px'</span>});
		<span class="reserved">this</span>.content.style.width=(<span class="reserved">this</span>.objects.length*(<span class="reserved">this</span>.options.itemWidth+14))+<span class="literal">'px'</span>;
		<span class="reserved">this</span>.content.style.height=(<span class="reserved">this</span>.options.itemHeight+10)+<span class="literal">'px'</span>;
		<span class="reserved">this</span>.objects.each(<span class="reserved">function</span>(object,i) {
			var item = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_picker_item'</span>,title:object.title});
			<span class="reserved">if</span> (self.value!=null &amp;&amp; object[self.options.valueProperty]==self.value) item.addClassName(<span class="literal">'in2igui_picker_item_selected'</span>);
			item.update(
				<span class="literal">'&lt;div class="in2igui_picker_item_middle"&gt;&lt;div class="in2igui_picker_item_middle"&gt;'</span>+
				<span class="literal">'&lt;div style="width:'</span>+self.options.itemWidth+<span class="literal">'px;height:'</span>+self.options.itemHeight+<span class="literal">'px;background-image:url(\'</span><span class="literal">'+object.image+'</span>\<span class="literal">')"&gt;&lt;/div&gt;'</span>+
				<span class="literal">'&lt;/div&gt;&lt;/div&gt;'</span>+
				<span class="literal">'&lt;div class="in2igui_picker_item_bottom"&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;'</span>
			);
			item.observe(<span class="literal">'mouseup'</span>,<span class="reserved">function</span>() {self.selectionChanged(object[self.options.valueProperty])});
			self.content.insert(item);			
		});
	},
	updateSelection : <span class="reserved">function</span>() {
		var children = <span class="reserved">this</span>.content.childNodes;
		<span class="reserved">for</span> (var i=0; i &lt; children.length; i++) {
			Element.setClassName(children[i],<span class="literal">'in2igui_picker_item_selected'</span>,<span class="reserved">this</span>.value!=null &amp;&amp; <span class="reserved">this</span>.objects[i][<span class="reserved">this</span>.options.valueProperty]==<span class="reserved">this</span>.value);
		};
	},
	selectionChanged : <span class="reserved">function</span>(value) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.dragging) <span class="reserved">return</span>;
		<span class="reserved">if</span> (<span class="reserved">this</span>.value==value) <span class="reserved">return</span>;
		<span class="reserved">this</span>.value = value;
		<span class="reserved">this</span>.updateSelection();
		<span class="reserved">this</span>.fire(<span class="literal">'selectionChanged'</span>,value);
	},
	
	<span class="comment">// Dragging</span>
	startDrag : <span class="reserved">function</span>(e) {
		e.stop();
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.dragX = Event.pointerX(e);
		<span class="reserved">this</span>.dragScroll = <span class="reserved">this</span>.container.scrollLeft;
		In2iGui.Picker.mousemove = <span class="reserved">function</span>(e) {self.drag(e);<span class="reserved">return</span> false;}
		In2iGui.Picker.mouseup = In2iGui.Picker.mousedown = <span class="reserved">function</span>(e) {self.endDrag(e);<span class="reserved">return</span> false;}
		window.document.observe(<span class="literal">'mousemove'</span>,In2iGui.Picker.mousemove);
		window.document.observe(<span class="literal">'mouseup'</span>,In2iGui.Picker.mouseup);
		window.document.observe(<span class="literal">'mousedown'</span>,In2iGui.Picker.mouseup);
	},
	drag : <span class="reserved">function</span>(e) {
		<span class="reserved">this</span>.dragging = true;
		Event.stop(e);
		<span class="reserved">this</span>.container.scrollLeft=<span class="reserved">this</span>.dragX-e.pointerX()+<span class="reserved">this</span>.dragScroll;
	},
	endDrag : <span class="reserved">function</span>(e) {
		<span class="reserved">this</span>.dragging = false;
		Event.stop(e);
		window.document.stopObserving(<span class="literal">'mousemove'</span>,In2iGui.Picker.mousemove);
		window.document.stopObserving(<span class="literal">'mouseup'</span>,In2iGui.Picker.mouseup);
		window.document.stopObserving(<span class="literal">'mousedown'</span>,In2iGui.Picker.mouseup);
		var size = (<span class="reserved">this</span>.options.itemWidth+14);
		n2i.ani(<span class="reserved">this</span>.container,<span class="literal">'scrollLeft'</span>,Math.round(<span class="reserved">this</span>.container.scrollLeft/size)*size,500,{ease:n2i.ease.bounceOut});
	},
	$visibilityChanged : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.container.setStyle({display:<span class="literal">'none'</span>});
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.itemsVisible) {
			var width = <span class="reserved">this</span>.options.itemsVisible*(<span class="reserved">this</span>.options.itemWidth+14);
		} <span class="reserved">else</span> {
			var width = <span class="reserved">this</span>.container.parentNode.clientWidth-12;
		}
		width = Math.max(width,0);
		<span class="reserved">this</span>.container.setStyle({width:width+<span class="literal">'px'</span>,display:<span class="literal">'block'</span>});
	}
}

<span class="comment">/* EOF */</span><span class="comment">/**
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Editor = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.name = <span class="literal">'In2iGuiEditor'</span>;
	<span class="reserved">this</span>.parts = [];
	<span class="reserved">this</span>.rows = [];
	<span class="reserved">this</span>.partControllers = [];
	<span class="reserved">this</span>.activePart = null;
	<span class="reserved">this</span>.active = false;
	<span class="reserved">this</span>.dragProxy = null;
	In2iGui.extend(<span class="reserved">this</span>);
}

In2iGui.Editor.get = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (!In2iGui.Editor.instance) {
		In2iGui.Editor.instance = new In2iGui.Editor();
	}
	<span class="reserved">return</span> In2iGui.Editor.instance;
}

In2iGui.Editor.<span class="reserved">prototype</span> = {
	ignite : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.reload();
	},
	addPartController : <span class="reserved">function</span>(key,title,controller) {
		<span class="reserved">this</span>.partControllers.push({key:key,<span class="literal">'title'</span>:title,<span class="literal">'controller'</span>:controller});
	},
	getPartController : <span class="reserved">function</span>(key) {
		var ctrl = null;
		<span class="reserved">this</span>.partControllers.each(<span class="reserved">function</span>(item) {
			<span class="reserved">if</span> (item.key==key) ctrl=item;
		});
		<span class="reserved">return</span> ctrl;
	},
	reload : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.partControls) {
			<span class="reserved">this</span>.partControls.hide();
		}
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.parts = [];
		var rows = $$(<span class="literal">'.row'</span>);
		rows.each(<span class="reserved">function</span>(row,i) {
			var columns = row.select(<span class="literal">'.column'</span>);
			self.reloadColumns(columns,i);
			columns.each(<span class="reserved">function</span>(column,j) {
				var parts = column.select(<span class="literal">'.part'</span>);
				self.reloadParts(parts,i,j);
			});
		});
		var parts = $$(<span class="literal">'.part'</span>);
		
		<span class="reserved">this</span>.parts.each(<span class="reserved">function</span>(part) {
			var i = parts.indexOf(part.element);
			<span class="reserved">if</span> (i!=-1) delete(parts[i]);
		});
		<span class="reserved">this</span>.reloadParts(parts,-1,-1);
	},
	partExists : <span class="reserved">function</span>(element) {
		
	},
	reloadColumns : <span class="reserved">function</span>(columns,rowIndex) {
		var self = <span class="reserved">this</span>;
		columns.each(<span class="reserved">function</span>(column,columnIndex) {
			column.observe(<span class="literal">'mouseover'</span>,<span class="reserved">function</span>() {
				self.hoverColumn(column);
			});
			column.observe(<span class="literal">'mouseout'</span>,<span class="reserved">function</span>() {
				self.blurColumn();
			});
			column.observe(<span class="literal">'contextmenu'</span>,<span class="reserved">function</span>(e) {
				self.contextColumn(column,rowIndex,columnIndex,e);
			});
		});
	},
	reloadParts : <span class="reserved">function</span>(parts,row,column) {
		var self = <span class="reserved">this</span>;
		parts.each(<span class="reserved">function</span>(element,partIndex) {
			<span class="reserved">if</span> (!element) <span class="reserved">return</span>;
			var match = element.className.match(/part_([\w]+)/i);
			<span class="reserved">if</span> (match &amp;&amp; match[1]) {
				var handler = self.getPartController(match[1]);
				<span class="reserved">if</span> (handler) {
					var part = new handler.controller(element,row,column,partIndex);
					part.type=match[1];
					element.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>() {
						self.editPart(part);
					});
					element.observe(<span class="literal">'mouseover'</span>,<span class="reserved">function</span>(e) {
						self.hoverPart(part);
					});
					element.observe(<span class="literal">'mouseout'</span>,<span class="reserved">function</span>(e) {
						self.blurPart(e);
					});
					element.observe(<span class="literal">'mousedown'</span>,<span class="reserved">function</span>(e) {
						self.startPartDrag(e);
					});
					self.parts.push(part);
				}
			}
		});
	},
	activate : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.active = true;
	},
	deactivate : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.active = false;
		<span class="reserved">if</span> (<span class="reserved">this</span>.activePart) {
			<span class="reserved">this</span>.activePart.deactivate();
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.partControls) <span class="reserved">this</span>.partControls.hide();
	},
	
	
	<span class="comment">///////////////////////// Columns ////////////////////////</span>
	
	hoverColumn : <span class="reserved">function</span>(column) {
		<span class="reserved">this</span>.hoveredColumn = column;
		<span class="reserved">if</span> (!<span class="reserved">this</span>.active || <span class="reserved">this</span>.activePart) <span class="reserved">return</span>;
		column.addClassName(<span class="literal">'in2igui_editor_column_hover'</span>);
	},
	
	blurColumn : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.active || !<span class="reserved">this</span>.hoveredColumn) <span class="reserved">return</span>;
		<span class="reserved">this</span>.hoveredColumn.removeClassName(<span class="literal">'in2igui_editor_column_hover'</span>);
	},
	
	contextColumn : <span class="reserved">function</span>(column,rowIndex,columnIndex,e) {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.active || <span class="reserved">this</span>.activePart) <span class="reserved">return</span>;
		<span class="reserved">if</span> (!<span class="reserved">this</span>.columnMenu) {
			var menu = In2iGui.Menu.create({name:<span class="literal">'In2iGuiEditorColumnMenu'</span>});
			menu.addItem({title:<span class="literal">'Rediger kolonne'</span>,value:<span class="literal">'editColumn'</span>});
			menu.addItem({title:<span class="literal">'Slet kolonne'</span>,value:<span class="literal">'removeColumn'</span>});
			menu.addItem({title:<span class="literal">'Tilfj kolonne'</span>,value:<span class="literal">'addColumn'</span>});
			menu.addDivider();
			<span class="reserved">this</span>.partControllers.each(<span class="reserved">function</span>(item) {
				menu.addItem({title:item.title,value:item.key});
			});
			<span class="reserved">this</span>.columnMenu = menu;
			menu.addDelegate(<span class="reserved">this</span>);
		}
		<span class="reserved">this</span>.hoveredRow=rowIndex;
		<span class="reserved">this</span>.hoveredColumnIndex=columnIndex;
		<span class="reserved">this</span>.columnMenu.showAtPointer(e);
	},
	$itemWasClicked$In2iGuiEditorColumnMenu : <span class="reserved">function</span>(value) {
		<span class="reserved">if</span> (value==<span class="literal">'removeColumn'</span>) {
			<span class="reserved">this</span>.fire(<span class="literal">'removeColumn'</span>,{<span class="literal">'row'</span>:<span class="reserved">this</span>.hoveredRow,<span class="literal">'column'</span>:<span class="reserved">this</span>.hoveredColumnIndex});
		} <span class="reserved">else</span> <span class="reserved">if</span> (value==<span class="literal">'editColumn'</span>) {
			<span class="reserved">this</span>.editColumn(<span class="reserved">this</span>.hoveredRow,<span class="reserved">this</span>.hoveredColumnIndex);
		} <span class="reserved">else</span> <span class="reserved">if</span> (value==<span class="literal">'addColumn'</span>) {
			<span class="reserved">this</span>.fire(<span class="literal">'addColumn'</span>,{<span class="literal">'row'</span>:<span class="reserved">this</span>.hoveredRow,<span class="literal">'position'</span>:<span class="reserved">this</span>.hoveredColumnIndex+1});
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.fire(<span class="literal">'addPart'</span>,{<span class="literal">'row'</span>:<span class="reserved">this</span>.hoveredRow,<span class="literal">'column'</span>:<span class="reserved">this</span>.hoveredColumnIndex,<span class="literal">'position'</span>:0,type:value});
		}
	},
	
	<span class="comment">///////////////////// Column editor //////////////////////</span>
	
	editColumn : <span class="reserved">function</span>(rowIndex,columnIndex) {
		<span class="reserved">this</span>.closeColumn();
		var c = <span class="reserved">this</span>.activeColumn = $$(<span class="literal">'.row'</span>)[rowIndex].select(<span class="literal">'.column'</span>)[columnIndex];
		c.addClassName(<span class="literal">'in2igui_editor_column_edit'</span>);
		<span class="reserved">this</span>.showColumnWindow();
		<span class="reserved">this</span>.columnEditorForm.setValues({width:c.getStyle(<span class="literal">'width'</span>),paddingLeft:c.getStyle(<span class="literal">'padding-left'</span>)});
	},
	closeColumn : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.activeColumn) {
			<span class="reserved">this</span>.activeColumn.removeClassName(<span class="literal">'in2igui_editor_column_edit'</span>);
		}
	},
	showColumnWindow : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.columnEditor) {
			var w = <span class="reserved">this</span>.columnEditor = In2iGui.Window.create({name:<span class="literal">'columnEditor'</span>,title:<span class="literal">'Rediger kolonne'</span>,width:200});
			var f = <span class="reserved">this</span>.columnEditorForm = In2iGui.Formula.create();
			var g = f.createGroup();
			var width = In2iGui.Formula.Text.create({label:<span class="literal">'Bredde'</span>,key:<span class="literal">'width'</span>});
			width.addDelegate({$valueChanged:<span class="reserved">function</span>(v) {<span class="reserved">this</span>.changeColumnWidth(v)}.bind(<span class="reserved">this</span>)})
			g.add(width);
			var marginLeft = In2iGui.Formula.Text.create({label:<span class="literal">'Venstremargen'</span>,key:<span class="literal">'left'</span>});
			marginLeft.addDelegate({$valueChanged:<span class="reserved">function</span>(v) {<span class="reserved">this</span>.changeColumnLeftMargin(v)}.bind(<span class="reserved">this</span>)})
			g.add(marginLeft);
			var marginRight = In2iGui.Formula.Text.create({label:<span class="literal">'Hjremargen'</span>,key:<span class="literal">'right'</span>});
			marginRight.addDelegate({$valueChanged:<span class="reserved">this</span>.changeColumnRightMargin.bind(<span class="reserved">this</span>)})
			g.add(marginRight);
			w.add(f);
			w.addDelegate(<span class="reserved">this</span>);
		}
		<span class="reserved">this</span>.columnEditor.show();
	},
	$userClosedWindow$columnEditor : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.closeColumn();
		var values = <span class="reserved">this</span>.columnEditorForm.getValues();
		values.row=<span class="reserved">this</span>.hoveredRow;
		values.column=<span class="reserved">this</span>.hoveredColumnIndex;
		<span class="reserved">this</span>.fire(<span class="literal">'updateColumn'</span>,values);
	},
	changeColumnWidth : <span class="reserved">function</span>(width) {
		<span class="reserved">this</span>.activeColumn.setStyle({<span class="literal">'width'</span>:width});
	},
	changeColumnLeftMargin : <span class="reserved">function</span>(margin) {
		<span class="reserved">this</span>.activeColumn.setStyle({<span class="literal">'paddingLeft'</span>:margin});
	},
	changeColumnRightMargin : <span class="reserved">function</span>(margin) {
		<span class="reserved">this</span>.activeColumn.setStyle({<span class="literal">'paddingRight'</span>:margin});
	},
	<span class="comment">///////////////////////// Parts //////////////////////////</span>
	
	hoverPart : <span class="reserved">function</span>(part,event) {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.active || <span class="reserved">this</span>.activePart) <span class="reserved">return</span>;
		<span class="reserved">this</span>.hoveredPart = part;
		part.element.addClassName(<span class="literal">'in2igui_editor_part_hover'</span>);
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.partControlTimer = window.setTimeout(<span class="reserved">function</span>() {self.showPartControls()},200);
	},
	blurPart : <span class="reserved">function</span>(e) {
		window.clearTimeout(<span class="reserved">this</span>.partControlTimer);
		<span class="reserved">if</span> (!<span class="reserved">this</span>.active) <span class="reserved">return</span>;
		<span class="reserved">if</span> (<span class="reserved">this</span>.partControls &amp;&amp; !In2iGui.isWithin(e,<span class="reserved">this</span>.partControls.element)) {
			<span class="reserved">this</span>.hidePartControls();
			<span class="reserved">this</span>.hoveredPart.element.removeClassName(<span class="literal">'in2igui_editor_part_hover'</span>);
		}
		<span class="reserved">if</span> (!<span class="reserved">this</span>.partControls &amp;&amp; <span class="reserved">this</span>.hoveredPart) {
			<span class="reserved">this</span>.hoveredPart.element.removeClassName(<span class="literal">'in2igui_editor_part_hover'</span>);			
		}
	},
	showPartEditControls : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.partEditControls) {
			<span class="reserved">this</span>.partEditControls = In2iGui.Overlay.create({name:<span class="literal">'In2iGuiEditorPartEditActions'</span>});
			<span class="reserved">this</span>.partEditControls.addIcon(<span class="literal">'save'</span>,<span class="literal">'common/save'</span>);
			<span class="reserved">this</span>.partEditControls.addIcon(<span class="literal">'cancel'</span>,<span class="literal">'common/close'</span>);
			<span class="reserved">this</span>.partEditControls.addDelegate(<span class="reserved">this</span>);
		}
		<span class="reserved">this</span>.partEditControls.showAtElement(<span class="reserved">this</span>.activePart.element,{<span class="literal">'horizontal'</span>:<span class="literal">'right'</span>,<span class="literal">'vertical'</span>:<span class="literal">'topOutside'</span>});
	},
	showPartControls : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.partControls) {
			<span class="reserved">this</span>.partControls = In2iGui.Overlay.create({name:<span class="literal">'In2iGuiEditorPartActions'</span>});
			<span class="reserved">this</span>.partControls.addIcon(<span class="literal">'edit'</span>,<span class="literal">'common/edit'</span>);
			<span class="reserved">this</span>.partControls.addIcon(<span class="literal">'new'</span>,<span class="literal">'common/new'</span>);
			<span class="reserved">this</span>.partControls.addIcon(<span class="literal">'delete'</span>,<span class="literal">'common/delete'</span>);
			var self = <span class="reserved">this</span>;
			<span class="reserved">this</span>.partControls.getElement().observe(<span class="literal">'mouseout'</span>,<span class="reserved">function</span>(e) {
				self.blurControls(e);
			});
			<span class="reserved">this</span>.partControls.getElement().observe(<span class="literal">'mouseover'</span>,<span class="reserved">function</span>(e) {
				self.hoverControls(e);
			});
			<span class="reserved">this</span>.partControls.addDelegate(<span class="reserved">this</span>);
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.hoveredPart.column==-1) {
			<span class="reserved">this</span>.partControls.hideIcons([<span class="literal">'new'</span>,<span class="literal">'delete'</span>]);
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.partControls.showIcons([<span class="literal">'new'</span>,<span class="literal">'delete'</span>]);
		}
		<span class="reserved">this</span>.partControls.showAtElement(<span class="reserved">this</span>.hoveredPart.element,{<span class="literal">'horizontal'</span>:<span class="literal">'right'</span>});
	},
	hoverControls : <span class="reserved">function</span>(e) {
		<span class="reserved">this</span>.hoveredPart.element.addClassName(<span class="literal">'in2igui_editor_part_hover'</span>);
	},
	blurControls : <span class="reserved">function</span>(e) {
		<span class="reserved">this</span>.hoveredPart.element.removeClassName(<span class="literal">'in2igui_editor_part_hover'</span>);
		<span class="reserved">if</span> (!In2iGui.isWithin(e,<span class="reserved">this</span>.hoveredPart.element)) {
			<span class="reserved">this</span>.hidePartControls();
		}
	},
	$iconWasClicked$In2iGuiEditorPartActions : <span class="reserved">function</span>(key,event) {
		<span class="reserved">if</span> (key==<span class="literal">'delete'</span>) {
			<span class="reserved">this</span>.deletePart(<span class="reserved">this</span>.hoveredPart);
		} <span class="reserved">else</span> <span class="reserved">if</span> (key==<span class="literal">'new'</span>) {
			<span class="reserved">this</span>.newPart(event);
		} <span class="reserved">else</span> <span class="reserved">if</span> (key==<span class="literal">'edit'</span>) {
			<span class="reserved">this</span>.editPart(<span class="reserved">this</span>.hoveredPart);
		}
	},
	$iconWasClicked$In2iGuiEditorPartEditActions : <span class="reserved">function</span>(key,event) {
		<span class="reserved">if</span> (key==<span class="literal">'cancel'</span>) {
			<span class="reserved">this</span>.cancelPart(<span class="reserved">this</span>.activePart);
		} <span class="reserved">else</span> <span class="reserved">if</span> (key==<span class="literal">'save'</span>) {
			<span class="reserved">this</span>.savePart(<span class="reserved">this</span>.activePart);
		}
	},
	hidePartControls : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.partControls) {
			<span class="reserved">this</span>.partControls.hide();
		}
	},
	hidePartEditControls : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.partEditControls) {
			<span class="reserved">this</span>.partEditControls.hide();
		}
	},
	editPart : <span class="reserved">function</span>(part) {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.active || <span class="reserved">this</span>.activePart) <span class="reserved">return</span>;
		<span class="reserved">if</span> (<span class="reserved">this</span>.activePart) <span class="reserved">this</span>.activePart.deactivate();
		<span class="reserved">if</span> (<span class="reserved">this</span>.hoveredPart) {
			<span class="reserved">this</span>.hoveredPart.element.removeClassName(<span class="literal">'in2igui_editor_part_hover'</span>);
		}
		<span class="reserved">this</span>.activePart = part;
		<span class="reserved">this</span>.showPartEditControls();
		part.element.addClassName(<span class="literal">'in2igui_editor_part_active'</span>);
		part.activate();
		window.clearTimeout(<span class="reserved">this</span>.partControlTimer);
		<span class="reserved">this</span>.hidePartControls();
		<span class="reserved">this</span>.blurColumn();
		<span class="reserved">this</span>.showPartEditor();
	},
	showPartEditor : <span class="reserved">function</span>() {
		 <span class="comment">// TODO: Disabled!</span>
		<span class="comment">/*if (!this.partEditor) {
			var w = this.partEditor = In2iGui.Window.create({padding:5,title:'Afstande',close:false,variant:'dark',width: 200});
			var f = this.partEditorForm = In2iGui.Formula.create();
			f.buildGroup({above:false},[
				{type:'Text',options:{label:'Top',key:'top'}},
				{type:'Text',options:{label:'Bottom',key:'bottom'}},
				{type:'Text',options:{label:'Left',key:'left'}},
				{type:'Text',options:{label:'Right',key:'right'}}
			]);
			w.add(f);
			f.addDelegate({valuesChanged:this.updatePartProperties.bind(this)});
		}
		var e = this.activePart.element;
		this.partEditorForm.setValues({
			top: e.getStyle('marginTop'),
			bottom: e.getStyle('marginBottom'),
			left: e.getStyle('marginLeft'),
			right: e.getStyle('marginRight')
		});
		this.partEditor.show();*/</span>
	},
	updatePartProperties : <span class="reserved">function</span>(values) {
		<span class="reserved">this</span>.activePart.element.setStyle({
			marginTop:values.top,
			marginBottom:values.bottom,
			marginLeft:values.left,
			marginRight:values.right
		});
		<span class="reserved">this</span>.activePart.properties = values;
		n2i.log(values);
	},
	hidePartEditor : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.partEditor) <span class="reserved">this</span>.partEditor.hide();
	},
	cancelPart : <span class="reserved">function</span>(part) {
		part.cancel();
		<span class="reserved">this</span>.hidePartEditor();
	},
	savePart : <span class="reserved">function</span>(part) {
		part.save();
		<span class="reserved">this</span>.hidePartEditor();
	},
	getEditorForElement : <span class="reserved">function</span>(element) {
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.parts.length; i++) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.parts[i].element==element) {
				<span class="reserved">return</span> <span class="reserved">this</span>.parts[i];
			}
		};
		<span class="reserved">return</span> null;
	},
	partDidDeacivate : <span class="reserved">function</span>(part) {
		part.element.removeClassName(<span class="literal">'in2igui_editor_part_active'</span>);
		<span class="reserved">this</span>.activePart = null;
		<span class="reserved">this</span>.hidePartEditControls();
	},
	partChanged : <span class="reserved">function</span>(part) {
		In2iGui.callDelegates(part,<span class="literal">'partChanged'</span>);
	},
	deletePart : <span class="reserved">function</span>(part) {
		In2iGui.callDelegates(part,<span class="literal">'deletePart'</span>);
		<span class="reserved">this</span>.partControls.hide();
	},
	newPart : <span class="reserved">function</span>(e) {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.newPartMenu) {
			var menu = In2iGui.Menu.create({name:<span class="literal">'In2iGuiEditorNewPartMenu'</span>});
			<span class="reserved">this</span>.partControllers.each(<span class="reserved">function</span>(item) {
				menu.addItem({title:item.title,value:item.key});
			});
			menu.addDelegate(<span class="reserved">this</span>);
			<span class="reserved">this</span>.newPartMenu=menu;
		}
		<span class="reserved">this</span>.newPartMenu.showAtPointer(e);
	},
	itemWasClicked$In2iGuiEditorNewPartMenu : <span class="reserved">function</span>(value) {
		var info = {row:<span class="reserved">this</span>.hoveredPart.row,column:<span class="reserved">this</span>.hoveredPart.column,position:<span class="reserved">this</span>.hoveredPart.position+1,type:value};
		In2iGui.callDelegates(<span class="reserved">this</span>,<span class="literal">'addPart'</span>,info);
	},
	<span class="comment">/**** Dragging ****/</span>
	startPartDrag : <span class="reserved">function</span>(e) {
		<span class="reserved">return</span> true;
		<span class="reserved">if</span> (!<span class="reserved">this</span>.active || <span class="reserved">this</span>.activePart) <span class="reserved">return</span> true;
		<span class="reserved">if</span> (!<span class="reserved">this</span>.dragProxy) {
			<span class="reserved">this</span>.dragProxy = new Element(<span class="literal">'div'</span>).addClassName(<span class="literal">'in2igui_editor_dragproxy part part_header'</span>);
			document.body.appendChild(<span class="reserved">this</span>.dragProxy);
		}
		var element = <span class="reserved">this</span>.hoveredPart.element;
		<span class="reserved">this</span>.dragProxy.setStyle({<span class="literal">'width'</span>:element.getWidth()+<span class="literal">'px'</span>});
		<span class="reserved">this</span>.dragProxy.innerHTML = element.innerHTML;
		In2iGui.Editor.startDrag(e,<span class="reserved">this</span>.dragProxy);
		<span class="reserved">return</span>;
		Element.observe(document.body,<span class="literal">'mouseup'</span>,<span class="reserved">function</span>() {
			self.endPartDrag();
		})
	},
	dragPart : <span class="reserved">function</span>() {
		
	},
	endPartDrag : <span class="reserved">function</span>() {
		In2iGui.get();
	}
}



In2iGui.Editor.startDrag = <span class="reserved">function</span>(e,element) {
	In2iGui.Editor.dragElement = element;
	Element.observe(document.body,<span class="literal">'mousemove'</span>,In2iGui.Editor.dragListener);
	Element.observe(document.body,<span class="literal">'mouseup'</span>,In2iGui.Editor.dragEndListener);
	In2iGui.Editor.startDragPos = {top:e.pointerY(),left:e.pointerX()};
	e.stop();
	<span class="reserved">return</span> false;
}

In2iGui.Editor.dragListener = <span class="reserved">function</span>(e) {
	var element = In2iGui.Editor.dragElement;
	element.style.left = e.pointerX()+<span class="literal">'px'</span>;
	element.style.top = e.pointerY()+<span class="literal">'px'</span>;
	element.style.display=<span class="literal">'block'</span>;
	<span class="reserved">return</span> false;
}

In2iGui.Editor.dragEndListener = <span class="reserved">function</span>(event) {
	Event.stopObserving(document.body,<span class="literal">'mousemove'</span>,In2iGui.Editor.dragListener);
	Event.stopObserving(document.body,<span class="literal">'mouseup'</span>,In2iGui.Editor.dragEndListener);
	In2iGui.Editor.dragElement.style.display=<span class="literal">'none'</span>;
	In2iGui.Editor.dragElement=null;
}

In2iGui.Editor.getPartId = <span class="reserved">function</span>(element) {
	var m = element.id.match(/part\-([\d]+)/i);
	<span class="reserved">if</span> (m &amp;&amp; m.length&gt;0) <span class="reserved">return</span> m[1];
}

<span class="comment">////////////////////////////////// Header editor ////////////////////////////////</span>

<span class="comment">/**
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Editor.Header = <span class="reserved">function</span>(element,row,column,position) {
	<span class="reserved">this</span>.element = $(element);
	<span class="reserved">this</span>.row = row;
	<span class="reserved">this</span>.column = column;
	<span class="reserved">this</span>.position = position;
	<span class="reserved">this</span>.id = In2iGui.Editor.getPartId(<span class="reserved">this</span>.element);
	<span class="reserved">this</span>.header = <span class="reserved">this</span>.element.firstDescendant();
	<span class="reserved">this</span>.field = null;
}

In2iGui.Editor.Header.<span class="reserved">prototype</span> = {
	activate : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.value = <span class="reserved">this</span>.header.innerHTML;
		<span class="reserved">this</span>.field = new Element(<span class="literal">'textarea'</span>).addClassName(<span class="literal">'in2igui_editor_header'</span>);
		<span class="reserved">this</span>.field.value = <span class="reserved">this</span>.value;
		<span class="reserved">this</span>.header.style.visibility=<span class="literal">'hidden'</span>;
		<span class="reserved">this</span>.updateFieldStyle();
		<span class="reserved">this</span>.element.insertBefore(<span class="reserved">this</span>.field,<span class="reserved">this</span>.header);
		<span class="reserved">this</span>.field.focus();
		<span class="reserved">this</span>.field.select();
		<span class="reserved">this</span>.field.observe(<span class="literal">'keydown'</span>,<span class="reserved">function</span>(e) {
			<span class="reserved">if</span> (e.keyCode==Event.KEY_RETURN) {
				<span class="reserved">this</span>.save();
			}
		}.bind(<span class="reserved">this</span>));
	},
	save : <span class="reserved">function</span>() {
		var value = <span class="reserved">this</span>.field.value;
		<span class="reserved">this</span>.header.innerHTML = value;
		<span class="reserved">this</span>.deactivate();
		<span class="reserved">if</span> (value!=<span class="reserved">this</span>.value) {
			<span class="reserved">this</span>.value = value;
			In2iGui.Editor.get().partChanged(<span class="reserved">this</span>);
		}
	},
	cancel : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.deactivate();
	},
	deactivate : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.header.style.visibility=<span class="literal">''</span>;
		<span class="reserved">this</span>.element.removeChild(<span class="reserved">this</span>.field);
		In2iGui.Editor.get().partDidDeacivate(<span class="reserved">this</span>);
	},
	updateFieldStyle : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.field.setStyle({width:<span class="reserved">this</span>.header.getWidth()+<span class="literal">'px'</span>,height:<span class="reserved">this</span>.header.getHeight()+<span class="literal">'px'</span>});
		n2i.copyStyle(<span class="reserved">this</span>.header,<span class="reserved">this</span>.field,[<span class="literal">'fontSize'</span>,<span class="literal">'marginTop'</span>,<span class="literal">'fontWeight'</span>,<span class="literal">'fontFamily'</span>,<span class="literal">'textAlign'</span>,<span class="literal">'color'</span>,<span class="literal">'fontStyle'</span>]);
	},
	getValue : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value;
	}
}

<span class="comment">////////////////////////////////// Html editor ////////////////////////////////</span>

<span class="comment">/**
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Editor.Html = <span class="reserved">function</span>(element,row,column,position) {
	<span class="reserved">this</span>.element = $(element);
	<span class="reserved">this</span>.row = row;
	<span class="reserved">this</span>.column = column;
	<span class="reserved">this</span>.position = position;
	<span class="reserved">this</span>.id = In2iGui.Editor.getPartId(<span class="reserved">this</span>.element);
	<span class="reserved">this</span>.field = null;
}

In2iGui.Editor.Html.<span class="reserved">prototype</span> = {
	activate : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.value = <span class="reserved">this</span>.element.innerHTML;
		<span class="comment">//if (Prototype.Browser.IE) return;</span>
		var height = <span class="reserved">this</span>.element.getHeight();
		<span class="reserved">this</span>.element.update(<span class="literal">''</span>);
		var style = <span class="reserved">this</span>.buildStyle();
		<span class="reserved">this</span>.editor = In2iGui.RichText.create({autoHideToolbar:false,style:style});
		<span class="reserved">this</span>.editor.setHeight(height);
		<span class="reserved">this</span>.element.appendChild(<span class="reserved">this</span>.editor.getElement());
		<span class="reserved">this</span>.editor.addDelegate(<span class="reserved">this</span>);
		<span class="reserved">this</span>.editor.ignite();
		<span class="reserved">this</span>.editor.setValue(<span class="reserved">this</span>.value);
		<span class="reserved">this</span>.editor.focus();
	},
	buildStyle : <span class="reserved">function</span>() {
		<span class="reserved">return</span> {
			<span class="literal">'textAlign'</span>:n2i.getStyle(<span class="reserved">this</span>.element,<span class="literal">'text-align'</span>)
			,<span class="literal">'fontFamily'</span>:n2i.getStyle(<span class="reserved">this</span>.element,<span class="literal">'font-family'</span>)
			,<span class="literal">'fontSize'</span>:n2i.getStyle(<span class="reserved">this</span>.element,<span class="literal">'font-size'</span>)
			,<span class="literal">'fontWeight'</span>:n2i.getStyle(<span class="reserved">this</span>.element,<span class="literal">'font-weight'</span>)
			,<span class="literal">'color'</span>:n2i.getStyle(<span class="reserved">this</span>.element,<span class="literal">'color'</span>)
		}
	},
	cancel : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.deactivate();
		<span class="reserved">this</span>.element.innerHTML = <span class="reserved">this</span>.value;
	},
	save : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.deactivate();
		var value = <span class="reserved">this</span>.editor.value;
		<span class="reserved">if</span> (value!=<span class="reserved">this</span>.value) {
			<span class="reserved">this</span>.value = value;
			In2iGui.Editor.get().partChanged(<span class="reserved">this</span>);
		}
		<span class="reserved">this</span>.element.innerHTML = <span class="reserved">this</span>.value;
	},
	deactivate : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.editor) {
			<span class="reserved">this</span>.editor.deactivate();
			<span class="reserved">this</span>.element.innerHTML = <span class="reserved">this</span>.value;
		}
		In2iGui.Editor.get().partDidDeacivate(<span class="reserved">this</span>);
	},
	richTextDidChange : <span class="reserved">function</span>() {
		<span class="comment">//this.deactivate();</span>
	},
	getValue : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value;
	}
}

<span class="comment">/* EOF */</span><span class="comment">/**
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Menu = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = n2i.override({autoHide:false,parentElement:null},options);
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.value = null;
	<span class="reserved">this</span>.subMenus = [];
	<span class="reserved">this</span>.visible = false;
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.addBehavior();
}

In2iGui.Menu.create = <span class="reserved">function</span>(options) {
	options = options || {};
	options.element = new Element(<span class="literal">'div'</span>).addClassName(<span class="literal">'in2igui_menu'</span>);
	var obj = new In2iGui.Menu(options);
	document.body.appendChild(options.element);
	<span class="reserved">return</span> obj;
}

In2iGui.Menu.<span class="reserved">prototype</span> = {
	addBehavior : <span class="reserved">function</span>() {
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.hider = <span class="reserved">function</span>() {
			self.hide();
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.autoHide) {
			var x = <span class="reserved">function</span>(e) {
				<span class="reserved">if</span> (!In2iGui.isWithin(e,self.element) &amp;&amp; (!self.options.parentElement || !In2iGui.isWithin(e,self.options.parentElement))) {
					<span class="reserved">if</span> (!self.isSubMenuVisible()) {
						self.hide();
					}
				}
			};
			<span class="reserved">this</span>.element.observe(<span class="literal">'mouseout'</span>,x);
			<span class="reserved">if</span> (<span class="reserved">this</span>.options.parentElement) {
				<span class="reserved">this</span>.options.parentElement.observe(<span class="literal">'mouseout'</span>,x);
			}
		}
	},
	addDivider : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.insert(new Element(<span class="literal">'div'</span>).addClassName(<span class="literal">'in2igui_menu_divider'</span>));
	},
	addItem : <span class="reserved">function</span>(item) {
		var self = <span class="reserved">this</span>;
		var element = new Element(<span class="literal">'div'</span>).addClassName(<span class="literal">'in2igui_menu_item'</span>).update(item.title);
		element.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>(e) {
			self.itemWasClicked(item.value);
			Event.stop(e);
		});
		<span class="reserved">if</span> (item.children) {
			var sub = In2iGui.Menu.create(null,{autoHide:true,parentElement:element});
			sub.addItems(item.children);
			element.observe(<span class="literal">'mouseover'</span>,<span class="reserved">function</span>(e) {
				sub.showAtElement(element,e,<span class="literal">'horizontal'</span>);
			});
			<span class="comment">//sub.addDelegate({itemWasClicked:function(value) {self.itemWasClicked(value)}});</span>
			self.subMenus.push(sub);
			element.addClassName(<span class="literal">'in2igui_menu_item_children'</span>);
		}
		<span class="reserved">this</span>.element.insert(element);
	},
	addItems : <span class="reserved">function</span>(items) {
		<span class="reserved">for</span> (var i=0; i &lt; items.length; i++) {
			<span class="reserved">if</span> (items[i]==null) {
				<span class="reserved">this</span>.addDivider();
			} <span class="reserved">else</span> {
				<span class="reserved">this</span>.addItem(items[i]);
			}
		};
	},
	getValue : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value;
	},
	itemWasClicked : <span class="reserved">function</span>(value) {
		<span class="reserved">this</span>.value = value;
		In2iGui.callDelegates(<span class="reserved">this</span>,<span class="literal">'itemWasClicked'</span>,value);
		In2iGui.callDelegates(<span class="reserved">this</span>,<span class="literal">'select'</span>,value);
		<span class="reserved">this</span>.hide();
	},
	showAtPointer : <span class="reserved">function</span>(event) {
		<span class="reserved">if</span> (event) {
			Event.stop(event);
			<span class="comment">//if (event.type!='click') this.ignoreNextClick=true;</span>
		}
		<span class="reserved">this</span>.showAtPoint({<span class="literal">'top'</span>:event.pointerY(),<span class="literal">'left'</span>:event.pointerX()});
	},
	showAtElement : <span class="reserved">function</span>(element,event,position) {
		<span class="reserved">if</span> (event) {
			Event.stop(event);
		}
		element = $(element);
		var point = element.cumulativeOffset();
		<span class="reserved">if</span> (position==<span class="literal">'horizontal'</span>) {
			point.left += element.getWidth();
		} <span class="reserved">else</span> <span class="reserved">if</span> (position==<span class="literal">'vertical'</span>) {
			point.top += element.getHeight();
		}
		<span class="reserved">this</span>.showAtPoint(point);
	},
	showAtPoint : <span class="reserved">function</span>(pos) {
		var innerWidth = n2i.getInnerWidth();
		var innerHeight = n2i.getInnerHeight();
		var scrollTop = n2i.getScrollTop();
		var scrollLeft = n2i.getScrollLeft();
		<span class="reserved">if</span> (!<span class="reserved">this</span>.visible) {
			<span class="reserved">this</span>.element.setStyle({<span class="literal">'display'</span>:<span class="literal">'block'</span>,<span class="literal">'visibility'</span>:<span class="literal">'hidden'</span>,opacity:0});
		}
		var width = <span class="reserved">this</span>.element.getWidth();
		var height = <span class="reserved">this</span>.element.getHeight();
		var left = Math.min(pos.left,innerWidth-width-20+scrollLeft);
		var top = Math.max(0,Math.min(pos.top,innerHeight-height-20+scrollTop));
		<span class="reserved">this</span>.element.setStyle({<span class="literal">'top'</span>:top+<span class="literal">'px'</span>,<span class="literal">'left'</span>:left+<span class="literal">'px'</span>,<span class="literal">'visibility'</span>:<span class="literal">'visible'</span>,zIndex:In2iGui.nextTopIndex(),<span class="literal">'width'</span>:(width-2)+<span class="literal">'px'</span>});
		<span class="reserved">if</span> (!<span class="reserved">this</span>.visible) {
			n2i.ani(<span class="reserved">this</span>.element,<span class="literal">'opacity'</span>,1,200);
			<span class="reserved">this</span>.addHider();
			<span class="reserved">this</span>.visible = true;
		}
	},
	hide : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.visible) <span class="reserved">return</span>;
		var self = <span class="reserved">this</span>;
		n2i.ani(<span class="reserved">this</span>.element,<span class="literal">'opacity'</span>,0,200,{onComplete:<span class="reserved">function</span>() {
			self.element.setStyle({<span class="literal">'display'</span>:<span class="literal">'none'</span>});
		}})
		<span class="reserved">this</span>.removeHider();
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.subMenus.length; i++) {
			<span class="reserved">this</span>.subMenus[i].hide();
		};
		<span class="reserved">this</span>.visible = false;
	},
	isSubMenuVisible : <span class="reserved">function</span>() {
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.subMenus.length; i++) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.subMenus[i].visible) <span class="reserved">return</span> true;
		};
		<span class="reserved">return</span> false;
	},
	addHider : <span class="reserved">function</span>() {
		Element.observe(document.body,<span class="literal">'click'</span>,<span class="reserved">this</span>.hider);
	},
	removeHider : <span class="reserved">function</span>() {
		Event.stopObserving(document.body,<span class="literal">'click'</span>,<span class="reserved">this</span>.hider);
	}
}



<span class="comment">/* EOF */</span><span class="comment">/**
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Overlay = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.content = <span class="reserved">this</span>.element.select(<span class="literal">'div.in2igui_inner_overlay'</span>)[1];
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.icons = new Hash();
	<span class="reserved">this</span>.visible = false;
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.addBehavior();
}

In2iGui.Overlay.create = <span class="reserved">function</span>(options) {
	var e = options.element = new Element(<span class="literal">'div'</span>).addClassName(<span class="literal">'in2igui_overlay'</span>).setStyle({<span class="literal">'display'</span>:<span class="literal">'none'</span>});
	e.update(<span class="literal">'&lt;div class="in2igui_inner_overlay"&gt;&lt;div class="in2igui_inner_overlay"&gt;&lt;/div&gt;&lt;/div&gt;'</span>);
	document.body.appendChild(e);
	<span class="reserved">return</span> new In2iGui.Overlay(options);
}

In2iGui.Overlay.<span class="reserved">prototype</span> = {
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	addBehavior : <span class="reserved">function</span>() {
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.hider = <span class="reserved">function</span>(e) {
			<span class="reserved">if</span> (self.boundElement) {
				<span class="reserved">if</span> (In2iGui.isWithin(e,self.boundElement) || In2iGui.isWithin(e,self.element)) <span class="reserved">return</span>;
				<span class="comment">// TODO: should be unreg'ed but it fails</span>
				<span class="comment">//self.boundElement.stopObserving(self.hider);</span>
				self.boundElement.removeClassName(<span class="literal">'in2igui_overlay_bound'</span>);
				self.boundElement = null;
				self.hide();
			}
		}
		<span class="reserved">this</span>.element.observe(<span class="literal">'mouseout'</span>,<span class="reserved">this</span>.hider);
	},
	addIcon : <span class="reserved">function</span>(key,icon) {
		var self = <span class="reserved">this</span>;
		var element = new Element(<span class="literal">'div'</span>).addClassName(<span class="literal">'in2igui_overlay_icon'</span>);
		element.setStyle({<span class="literal">'backgroundImage'</span>:<span class="literal">'url('</span>+In2iGui.getIconUrl(icon,2)+<span class="literal">')'</span>});
		element.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>(e) {
			self.iconWasClicked(key,e);
		});
		<span class="reserved">this</span>.icons.set(key,element);
		<span class="reserved">this</span>.content.insert(element);
	},
	hideIcons : <span class="reserved">function</span>(keys) {
		var self = <span class="reserved">this</span>;
		keys.each(<span class="reserved">function</span>(key) {
			self.icons.get(key).hide();
		});
	},
	showIcons : <span class="reserved">function</span>(keys) {
		var self = <span class="reserved">this</span>;
		keys.each(<span class="reserved">function</span>(key) {
			self.icons.get(key).show();
		});
	},
	iconWasClicked : <span class="reserved">function</span>(key,e) {
		In2iGui.callDelegates(<span class="reserved">this</span>,<span class="literal">'iconWasClicked'</span>,key,e);
	},
	showAtElement : <span class="reserved">function</span>(element,options) {
		In2iGui.positionAtElement(<span class="reserved">this</span>.element,element,options);
		<span class="reserved">if</span> (<span class="reserved">this</span>.visible) <span class="reserved">return</span>;
		<span class="reserved">if</span> (n2i.browser.msie) {
			<span class="reserved">this</span>.element.setStyle({<span class="literal">'display'</span>:<span class="literal">'block'</span>});
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.element.setStyle({<span class="literal">'display'</span>:<span class="literal">'block'</span>,<span class="literal">'opacity'</span>:0});
			n2i.ani(<span class="reserved">this</span>.element,<span class="literal">'opacity'</span>,1,150);
		}
		<span class="reserved">this</span>.visible = true;
		<span class="reserved">if</span> (options.autoHide) {
			<span class="reserved">this</span>.boundElement = element;
			element.observe(<span class="literal">'mouseout'</span>,<span class="reserved">this</span>.hider);
			element.addClassName(<span class="literal">'in2igui_overlay_bound'</span>);
		}
		<span class="reserved">return</span>;
	},
	hide : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.setStyle({<span class="literal">'display'</span>:<span class="literal">'none'</span>});
		<span class="reserved">this</span>.visible = false;
	}
}

<span class="comment">/* EOF */</span>
<span class="comment">/**
 * <span class="attrib">@class</span>
 * <span class="attrib">@constructor</span>
 *
 * Options
 * {url:'',parameters:{}}
 *
 * Events:
 * uploadDidCompleteQueue
 * uploadDidStartQueue
 * uploadDidComplete(file)
 */</span>
In2iGui.Upload = <span class="reserved">function</span>(o) {
	o = <span class="reserved">this</span>.options = n2i.override({url:<span class="literal">''</span>,parameters:{},maxItems:50,maxSize:<span class="literal">"20480"</span>,types:<span class="literal">"*.*"</span>,useFlash:true,fieldName:<span class="literal">'file'</span>,chooseButton:<span class="literal">'Choose files...'</span>},o);
	<span class="reserved">this</span>.element = $(o.element);
	<span class="reserved">this</span>.itemContainer = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_upload_items'</span>)[0];
	<span class="reserved">this</span>.status = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_upload_status'</span>)[0];
	<span class="reserved">this</span>.placeholder = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_upload_placeholder'</span>)[0];
	<span class="reserved">this</span>.name = o.name;
	<span class="reserved">this</span>.items = [];
	<span class="reserved">this</span>.busy = false;
	<span class="reserved">this</span>.loaded = false;
	<span class="reserved">this</span>.useFlash = <span class="reserved">this</span>.options.useFlash;
	<span class="reserved">if</span> (<span class="reserved">this</span>.options.useFlash) {
		<span class="reserved">this</span>.useFlash = swfobject.hasFlashPlayerVersion(<span class="literal">"8"</span>);
	}
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.addBehavior();
}

In2iGui.Upload.nameIndex = 0;

In2iGui.Upload.create = <span class="reserved">function</span>(o) {
	o = o || {};
	o.element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_upload'</span>});
	o.element.update(
		<span class="literal">'&lt;div class="in2igui_upload_items"&gt;&lt;/div&gt;'</span>+
		<span class="literal">'&lt;div class="in2igui_upload_status"&gt;&lt;/div&gt;'</span>
	);
	<span class="reserved">return</span> new In2iGui.Upload(o);
}

In2iGui.Upload.<span class="reserved">prototype</span> = {
	addBehavior : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.useFlash) {
			<span class="reserved">this</span>.createIframeVersion();
			<span class="reserved">return</span>;
		}
		<span class="reserved">if</span> (In2iGui.get().domLoaded) {
			<span class="reserved">this</span>.createFlashVersion();			
		} <span class="reserved">else</span> {
			In2iGui.onDomReady(<span class="reserved">this</span>.createFlashVersion.bind(<span class="reserved">this</span>));
		}
	},
	
	<span class="comment">/////////////////////////// Iframe //////////////////////////</span>
	
	createIframeVersion : <span class="reserved">function</span>() {
		In2iGui.Upload.nameIndex++;
		var frameName = <span class="literal">'in2igui_upload_'</span>+In2iGui.Upload.nameIndex;
		
		var atts = {<span class="literal">'action'</span>:<span class="reserved">this</span>.options.url || <span class="literal">''</span>, <span class="literal">'method'</span>:<span class="literal">'post'</span>, <span class="literal">'enctype'</span>:<span class="literal">'multipart/form-data'</span>,<span class="literal">'encoding'</span>:<span class="literal">'multipart/form-data'</span>,<span class="literal">'target'</span>:frameName};
		var form = <span class="reserved">this</span>.form = new Element(<span class="literal">'form'</span>,atts);
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.parameters) {
			$H(<span class="reserved">this</span>.options.parameters).each(<span class="reserved">function</span>(pair) {
				var hidden = new Element(<span class="literal">'input'</span>,{<span class="literal">'type'</span>:<span class="literal">'hidden'</span>,<span class="literal">'name'</span>:pair.key});
				hidden.setValue(pair.value);
				form.insert(hidden);
			});
		}
		var iframe = <span class="reserved">this</span>.iframe = new Element(<span class="literal">'iframe'</span>,{name:frameName,id:frameName,src:In2iGui.context+<span class="literal">'/In2iGui/html/blank.html'</span>,style:<span class="literal">'display:none'</span>});
		<span class="reserved">this</span>.element.insert(iframe);
		<span class="reserved">this</span>.fileInput = new Element(<span class="literal">'input'</span>,{<span class="literal">'type'</span>:<span class="literal">'file'</span>,<span class="literal">'class'</span>:<span class="literal">'file'</span>,<span class="literal">'name'</span>:<span class="reserved">this</span>.options.fieldName});
		<span class="reserved">this</span>.fileInput.observe(<span class="literal">'change'</span>,<span class="reserved">this</span>.iframeSubmit.bind(<span class="reserved">this</span>));
		form.insert(<span class="reserved">this</span>.fileInput);
		var buttonContainer = new Element(<span class="literal">'span'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_upload_button'</span>});
		var span = new Element(<span class="literal">'span'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_upload_button_input'</span>});
		span.insert(form);
		buttonContainer.insert(span);
		buttonContainer.insert(<span class="literal">'&lt;a href="javascript:void(0);" class="in2igui_button"&gt;&lt;span&gt;&lt;span&gt;'</span>+<span class="reserved">this</span>.options.chooseButton+<span class="literal">'&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;'</span>);
		<span class="reserved">this</span>.element.insert(buttonContainer);
		iframe.observe(<span class="literal">'load'</span>,<span class="reserved">function</span>() {<span class="reserved">this</span>.iframeUploadComplete()}.bind(<span class="reserved">this</span>));
	},
	iframeUploadComplete : <span class="reserved">function</span>() {
		n2i.log(<span class="literal">'iframeUploadComplete uploading: '</span>+<span class="reserved">this</span>.uploading+<span class="literal">' ('</span>+<span class="reserved">this</span>.name+<span class="literal">')'</span>);
		<span class="reserved">if</span> (!<span class="reserved">this</span>.uploading) <span class="reserved">return</span>;
		<span class="reserved">this</span>.uploading = false;
		<span class="reserved">this</span>.form.reset();
		var doc = n2i.getFrameDocument(<span class="reserved">this</span>.iframe);
		<span class="reserved">if</span> (doc.body.innerHTML.indexOf(<span class="literal">'SUCCESS'</span>)!=-1) {
			<span class="reserved">this</span>.fire(<span class="literal">'uploadDidCompleteQueue'</span>);
			<span class="reserved">this</span>.items.last().update({progress:1,filestatus:<span class="literal">'Frdig'</span>});
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.items.last().setError(<span class="literal">'Upload af filen fejlede!'</span>);
			<span class="reserved">this</span>.fire(<span class="literal">'uploadDidCompleteQueue'</span>);		
		}
		<span class="reserved">this</span>.iframe.src=In2iGui.context+<span class="literal">'/In2iGui/html/blank.html'</span>;
		<span class="reserved">this</span>.endIframeProgress();
	},
	iframeSubmit : <span class="reserved">function</span>() {
		n2i.log(<span class="literal">'iframeSubmit'</span>);
		<span class="reserved">this</span>.startIframeProgress();
		<span class="reserved">this</span>.uploading = true;
		<span class="comment">// IE: set value of parms again since they disappear</span>
		<span class="reserved">if</span> (n2i.browser.msie) {
			var p = <span class="reserved">this</span>.options.parameters;
			$H(<span class="reserved">this</span>.options.parameters).each(<span class="reserved">function</span>(pair) {
				<span class="reserved">this</span>.form[pair.key].value=pair.value;
			}.bind(<span class="reserved">this</span>));
		}
		<span class="reserved">this</span>.form.submit();
		<span class="reserved">this</span>.fire(<span class="literal">'uploadDidSubmit'</span>);
		var fileName = <span class="reserved">this</span>.fileInput.value.split(<span class="literal">'\\'</span>).pop();
		<span class="reserved">this</span>.addItem({name:fileName,filestatus:<span class="literal">'I gang'</span>}).setWaiting();
	},
	startIframeProgress : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.form.style.display=<span class="literal">'none'</span>;
	},
	endIframeProgress : <span class="reserved">function</span>() {
		n2i.log(<span class="literal">'endIframeProgress'</span>);
		<span class="reserved">this</span>.form.style.display=<span class="literal">'block'</span>;
		<span class="reserved">this</span>.form.reset();
	},
	clear : <span class="reserved">function</span>() {
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.items.length; i++) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.items[i]) {
				<span class="reserved">this</span>.items[i].destroy();
			}
		};
		<span class="reserved">this</span>.items = [];
		<span class="reserved">this</span>.itemContainer.hide();
		<span class="reserved">this</span>.status.update();
	},
	
	<span class="comment">/////////////////////////// Flash //////////////////////////</span>
	
	createFlashVersion : <span class="reserved">function</span>() {
		var loc = new String(document.location);
		var url = loc.slice(0,loc.lastIndexOf(<span class="literal">'/'</span>)+1);
		url += <span class="reserved">this</span>.options.url;
		var javaSession = n2i.cookie.get(<span class="literal">'JSESSIONID'</span>);
		<span class="reserved">if</span> (javaSession) {
			url+=<span class="literal">';jsessionid='</span>+javaSession;
		}
		var phpSession = n2i.cookie.get(<span class="literal">'PHPSESSID'</span>);
		<span class="reserved">if</span> (phpSession) {
			url+=<span class="literal">'?PHPSESSID='</span>+phpSession;
		}
		var buttonContainer = new Element(<span class="literal">'span'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_upload_button'</span>});
		var placeholder = new Element(<span class="literal">'span'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_upload_button_object'</span>});
		buttonContainer.insert(placeholder);
		buttonContainer.insert(<span class="literal">'&lt;a href="javascript:void(0);" class="in2igui_button"&gt;&lt;span&gt;&lt;span&gt;'</span>+<span class="reserved">this</span>.options.chooseButton+<span class="literal">'&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;'</span>);
		<span class="reserved">this</span>.element.insert(buttonContainer);
		
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.loader = new SWFUpload({
			upload_url : url,
			flash_url : In2iGui.context+<span class="literal">"/In2iGui/lib/swfupload/swfupload.swf"</span>,
			file_size_limit : <span class="reserved">this</span>.options.maxSize,
			file_post_name : <span class="reserved">this</span>.options.fieldName,
			file_upload_limit : <span class="reserved">this</span>.options.maxItems,
			file_types : <span class="reserved">this</span>.options.types,
			debug : true,
			post_params : <span class="reserved">this</span>.options.parameters,
			button_placeholder_id : <span class="literal">'x'</span>,
			button_placeholder : placeholder,
			button_width : <span class="literal">'100%'</span>,
			button_height : 30,

			swfupload_loaded_handler : <span class="reserved">function</span>() {self.flashLoaded()},
			file_queued_handler : self.fileQueued.bind(self),
			file_queue_error_handler : <span class="reserved">function</span>(file, error, message) {self.fileQueueError(file, error, message)},
			file_dialog_complete_handler : <span class="reserved">function</span>() {self.fileDialogComplete()},
			upload_start_handler : <span class="reserved">function</span>() {self.uploadStart()},
			upload_progress_handler : <span class="reserved">function</span>(file,complete,total) {self.uploadProgress(file,complete,total)},
			upload_error_handler : <span class="reserved">function</span>(file, error, message) {self.uploadError(file, error, message)},
			upload_success_handler : <span class="reserved">function</span>(file,data) {self.uploadSuccess(file,data)},
			upload_complete_handler : <span class="reserved">function</span>(file) {self.uploadComplete(file)},
		
			<span class="comment">// SWFObject settings</span>
			swfupload_pre_load_handler : <span class="reserved">function</span>() {alert(<span class="literal">'swfupload_pre_load_handler!'</span>)},
			swfupload_load_failed_handler : <span class="reserved">function</span>() {alert(<span class="literal">'swfupload_load_failed_handler!'</span>)}
		});
		
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.button) {
			<span class="comment">//this.setButton(In2iGui.get(this.options.button));</span>
		}
	},
	startNextUpload : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.loader.startUpload();
	},
	
	<span class="comment">//////////////////// Events //////////////</span>
	
	flashLoaded : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.loaded = true;
	},
	addError : <span class="reserved">function</span>(file,error) {
		var item = <span class="reserved">this</span>.addItem(file);
		item.setError(error);
	},
	fileQueued : <span class="reserved">function</span>(file) {
		<span class="reserved">this</span>.addItem(file);
	},
	fileQueueError : <span class="reserved">function</span>(file, error, message) {
		<span class="reserved">this</span>.addError(file,error);
	},
	fileDialogComplete : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.startNextUpload();
	},
	uploadStart : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.status.setStyle({display:<span class="literal">'block'</span>});
		n2i.log(<span class="literal">'uploadStart'</span>);
		<span class="reserved">if</span> (!<span class="reserved">this</span>.busy) {
			<span class="reserved">this</span>.fire(<span class="literal">'uploadDidStartQueue'</span>);
		}
		<span class="reserved">this</span>.busy = true;
	},
	uploadProgress : <span class="reserved">function</span>(file,complete,total) {
		<span class="reserved">this</span>.updateStatus();
		<span class="reserved">this</span>.items[file.index].updateProgress(complete,total);
	},
	uploadError : <span class="reserved">function</span>(file, error, message) {
		n2i.log(<span class="literal">'uploadError file:'</span>+file+<span class="literal">', error:'</span>+error+<span class="literal">', message:'</span>+message);
		<span class="reserved">if</span> (file) {
			<span class="reserved">this</span>.items[file.index].update(file);
		}
	},
	uploadSuccess : <span class="reserved">function</span>(file,data) {
		n2i.log(<span class="literal">'uploadSuccess file:'</span>+file+<span class="literal">', data:'</span>+data);
		<span class="reserved">this</span>.items[file.index].updateProgress(file.size,file.size);
	},
	uploadComplete : <span class="reserved">function</span>(file) {
		<span class="reserved">this</span>.items[file.index].update(file);
		<span class="reserved">this</span>.startNextUpload();
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.fire(<span class="literal">'uploadDidComplete'</span>,file);
		<span class="reserved">if</span> (<span class="reserved">this</span>.loader.getStats().files_queued==0) {
			<span class="reserved">this</span>.fire(<span class="literal">'uploadDidCompleteQueue'</span>);
		}
		<span class="reserved">this</span>.updateStatus();
		<span class="reserved">this</span>.busy = false;
	},
	
	<span class="comment">//////////// Items ////////////</span>
	
	addItem : <span class="reserved">function</span>(file) {
		var index = file.index;
		<span class="reserved">if</span> (index===undefined) {
			index = <span class="reserved">this</span>.items.length;
			file.index = index;
		}
		var item = new In2iGui.Upload.Item(file);
		<span class="reserved">this</span>.items[index] = item;
		<span class="reserved">this</span>.itemContainer.insert(item.element);
		<span class="reserved">this</span>.itemContainer.setStyle({display:<span class="literal">'block'</span>});
		<span class="reserved">if</span> (<span class="reserved">this</span>.placeholder) {
			<span class="reserved">this</span>.placeholder.hide();
		}
		<span class="reserved">return</span> item;
	},
	
	updateStatus : <span class="reserved">function</span>() {
		var s = <span class="reserved">this</span>.loader.getStats();
		<span class="reserved">this</span>.status.update(<span class="literal">'Status: '</span>+Math.round(s.successful_uploads/<span class="reserved">this</span>.items.length*100)+<span class="literal">'%'</span>);
		n2i.log(s);
	}
}

In2iGui.Upload.Item = <span class="reserved">function</span>(file) {
	<span class="reserved">this</span>.element = new Element(<span class="literal">'div'</span>).addClassName(<span class="literal">'in2igui_upload_item'</span>);
	<span class="reserved">if</span> (file.index % 2 == 1) {
		<span class="reserved">this</span>.element.addClassName(<span class="literal">'in2igui_upload_item_alt'</span>)
	}
	<span class="reserved">this</span>.content = new Element(<span class="literal">'div'</span>).addClassName(<span class="literal">'in2igui_upload_item_content'</span>);
	<span class="reserved">this</span>.icon = In2iGui.createIcon(<span class="literal">'file/generic'</span>,2);
	<span class="reserved">this</span>.element.insert(<span class="reserved">this</span>.icon);
	<span class="reserved">this</span>.element.insert(<span class="reserved">this</span>.content);
	<span class="reserved">this</span>.info = new Element(<span class="literal">'strong'</span>);
	<span class="reserved">this</span>.status = new Element(<span class="literal">'em'</span>);
	<span class="reserved">this</span>.progress = In2iGui.ProgressBar.create({small:true});
	<span class="reserved">this</span>.content.insert(<span class="reserved">this</span>.progress.getElement());
	<span class="reserved">this</span>.content.insert(<span class="reserved">this</span>.info);
	<span class="reserved">this</span>.content.insert(<span class="reserved">this</span>.status);
	<span class="reserved">this</span>.update(file);
}

In2iGui.Upload.Item.<span class="reserved">prototype</span> = {
	update : <span class="reserved">function</span>(file) {
		<span class="reserved">this</span>.status.update(In2iGui.Upload.status[file.filestatus] || file.filestatus);
		<span class="reserved">if</span> (file.name) {
			<span class="reserved">this</span>.info.update(file.name);
		}
		<span class="reserved">if</span> (file.progress!==undefined) {
			<span class="reserved">this</span>.setProgress(file.progress);
		}
		<span class="reserved">if</span> (file.filestatus==SWFUpload.FILE_STATUS.ERROR) {
			<span class="reserved">this</span>.element.addClassName(<span class="literal">'in2igui_upload_item_error'</span>);
			<span class="reserved">this</span>.progress.hide();
		}
	},
	setError : <span class="reserved">function</span>(error) {
		<span class="reserved">this</span>.status.update(In2iGui.Upload.errors[error] || error);
		<span class="reserved">this</span>.element.addClassName(<span class="literal">'in2igui_upload_item_error'</span>);
		<span class="reserved">this</span>.progress.hide();
	},
	updateProgress : <span class="reserved">function</span>(complete,total) {
		<span class="reserved">this</span>.progress.setValue(complete/total);
		<span class="reserved">return</span> <span class="reserved">this</span>;
	},
	setProgress : <span class="reserved">function</span>(value) {
		<span class="reserved">this</span>.progress.setValue(value);
		<span class="reserved">return</span> <span class="reserved">this</span>;
	},
	setWaiting : <span class="reserved">function</span>(value) {
		<span class="reserved">this</span>.progress.setWaiting();
		<span class="reserved">return</span> <span class="reserved">this</span>;
	},
	hide : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.hide();
	},
	destroy : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.remove();
	}
}

<span class="reserved">if</span> (window.SWFUpload) {
(<span class="reserved">function</span>(){
	var e = In2iGui.Upload.errors = {};
	e[SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED]			= <span class="literal">'Der er for mange filer i ken'</span>;
	e[SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT]		= <span class="literal">'Filen er for stor'</span>;
	e[SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE]					= <span class="literal">'Filen er tom'</span>;
	e[SWFUpload.QUEUE_ERROR.INVALID_FILETYPE]				= <span class="literal">'Filens type er ikke understttet'</span>;
	e[SWFUpload.UPLOAD_ERROR.HTTP_ERROR]					= <span class="literal">'Der skete en netvrksfejl'</span>;
	e[SWFUpload.UPLOAD_ERROR.MISSING_UPLOAD_URL]			= <span class="literal">'Upload-adressen findes ikke'</span>;
	e[SWFUpload.UPLOAD_ERROR.IO_ERROR]						= <span class="literal">'Der skete en IO-fejl'</span>;
	e[SWFUpload.UPLOAD_ERROR.SECURITY_ERROR]				= <span class="literal">'Der skete en sikkerhedsfejl'</span>;
	e[SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED]			= <span class="literal">'Upload-strrelsen er overskredet'</span>;
	e[SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED]					= <span class="literal">'Upload af filen fejlede'</span>;
	e[SWFUpload.UPLOAD_ERROR.SPECIFIED_FILE_ID_NOT_FOUND]	= <span class="literal">'Filens id kunne ikke findes'</span>;
	e[SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED]		= <span class="literal">'Validering af filen fejlede'</span>;
	e[SWFUpload.UPLOAD_ERROR.FILE_CANCELLED]				= <span class="literal">'Filen blev afbrudt'</span>;
	e[SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED]				= <span class="literal">'Upload af filen blev stoppet'</span>;
	var s = In2iGui.Upload.status = {};
	s[SWFUpload.FILE_STATUS.QUEUED] 		= <span class="literal">'I k'</span>;
	s[SWFUpload.FILE_STATUS.IN_PROGRESS] 	= <span class="literal">'I gang'</span>;
	s[SWFUpload.FILE_STATUS.ERROR] 			= <span class="literal">'Filen gav fejl'</span>;
	s[SWFUpload.FILE_STATUS.COMPLETE] 		= <span class="literal">'Frdig'</span>;
	s[SWFUpload.FILE_STATUS.CANCELLED] 		= <span class="literal">'Afbrudt'</span>;
}())
}
<span class="comment">/* EOF */</span><span class="comment">/** A progress bar is a widget that shows progress from 0% to 100%
	<span class="attrib">@constructor</span>
*/</span>
In2iGui.ProgressBar = <span class="reserved">function</span>(o) {
	<span class="reserved">this</span>.element = $(o.element);
	<span class="reserved">this</span>.name = o.name;
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.WAITING = <span class="literal">'in2igui_progressbar_small_waiting'</span>;
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.COMPLETE = <span class="literal">'in2igui_progressbar_small_complete'</span>;
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.options = o || {};
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.indicator = <span class="reserved">this</span>.element.firstDescendant();
	In2iGui.extend(<span class="reserved">this</span>);
}

<span class="comment">/** Creates a new progress bar:
	<span class="attrib">@param</span> o {Object} Options : {small:false}
*/</span>
In2iGui.ProgressBar.create = <span class="reserved">function</span>(o) {
	o = o || {};
	var e = o.element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_progressbar'</span>}).insert(new Element(<span class="literal">'div'</span>));
	<span class="reserved">if</span> (o.small) e.addClassName(<span class="literal">'in2igui_progressbar_small'</span>);
	<span class="reserved">return</span> new In2iGui.ProgressBar(o);
}
	
In2iGui.ProgressBar.<span class="reserved">prototype</span> = {
	<span class="comment">/** Set the progress value
	<span class="attrib">@param</span> value {Number} A number between 0 and 1
	*/</span>
	setValue : <span class="reserved">function</span>(value) {
		var el = <span class="reserved">this</span>.element;
		<span class="reserved">if</span> (<span class="reserved">this</span>.waiting) el.removeClassName(<span class="reserved">this</span>.WAITING);
		el.setClassName(<span class="reserved">this</span>.COMPLETE,value==1);
		n2i.ani(<span class="reserved">this</span>.indicator,<span class="literal">'width'</span>,(value*100)+<span class="literal">'%'</span>,200);
	},
	<span class="comment">/** Mark progress as waiting */</span>
	setWaiting : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.waiting = true;
		<span class="reserved">this</span>.indicator.setStyle({width:0});
		<span class="reserved">this</span>.element.addClassName(<span class="reserved">this</span>.WAITING);
	},
	<span class="comment">/** Reset the progress bar */</span>
	reset : <span class="reserved">function</span>() {
		var el = <span class="reserved">this</span>.element;
		<span class="reserved">if</span> (<span class="reserved">this</span>.waiting) el.removeClassName(<span class="reserved">this</span>.WAITING);
		el.removeClassName(<span class="reserved">this</span>.COMPLETE);
		<span class="reserved">this</span>.indicator.style.width=<span class="literal">'0%'</span>;
	},
	<span class="comment">/** Hide the progress bar */</span>
	hide : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.style.display = <span class="literal">'none'</span>;
	},
	<span class="comment">/** Show the progress bar */</span>
	show : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.style.display = <span class="literal">'block'</span>;
	}
}

<span class="comment">/* EOF */</span><span class="comment">/** <span class="attrib">@constructor</span> */</span>
In2iGui.Gallery = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = options || {};
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.objects = [];
	<span class="reserved">this</span>.nodes = [];
	<span class="reserved">this</span>.selected = [];
	<span class="reserved">this</span>.width = 100;
	<span class="reserved">this</span>.height = 100;
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">if</span> (<span class="reserved">this</span>.options.source) {
		<span class="reserved">this</span>.options.source.addDelegate(<span class="reserved">this</span>);
	}
}

In2iGui.Gallery.create = <span class="reserved">function</span>(options) {
	options = options || {};
	options.element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_gallery'</span>});
	<span class="reserved">return</span> new In2iGui.Gallery(options);
}

In2iGui.Gallery.<span class="reserved">prototype</span> = {
	setObjects : <span class="reserved">function</span>(objects) {
		<span class="reserved">this</span>.objects = objects;
		<span class="reserved">this</span>.render();
	},
	getObjects : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.objects;
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	$objectsLoaded : <span class="reserved">function</span>(objects) {
		<span class="reserved">this</span>.setObjects(objects);
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	render : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.nodes = [];
		<span class="reserved">this</span>.element.update();
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.objects.each(<span class="reserved">function</span>(object,i) {
			var url = self.resolveImageUrl(object);
			url = url.replace(/&amp;amp;/,<span class="literal">'&amp;'</span>);
			<span class="reserved">if</span> (object.height&lt;object.width) {
				var top = (self.height-(self.height*object.height/object.width))/2;
			} <span class="reserved">else</span> {
				var top = 0;
			}
			var img = new Element(<span class="literal">'img'</span>,{src:url}).setStyle({margin:top+<span class="literal">'px auto 0px'</span>});
			var item = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_gallery_item'</span>}).setStyle({<span class="literal">'width'</span>:self.width+<span class="literal">'px'</span>,<span class="literal">'height'</span>:self.height+<span class="literal">'px'</span>}).insert(img);
			item.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>() {
				self.itemClicked(i);
			});
			item.dragDropInfo = {kind:<span class="literal">'image'</span>,icon:<span class="literal">'common/image'</span>,id:object.id,title:object.name};
			item.onmousedown=<span class="reserved">function</span>(e) {
				In2iGui.startDrag(e,item);
				<span class="reserved">return</span> false;
			};
			item.observe(<span class="literal">'dblclick'</span>,<span class="reserved">function</span>() {
				self.itemDoubleClicked(i);
			});
			self.element.insert(item);
			self.nodes.push(item);
		});
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	updateUI : <span class="reserved">function</span>() {
		var s = <span class="reserved">this</span>.selected;
		<span class="reserved">this</span>.nodes.each(<span class="reserved">function</span>(node,i) {
			node.setClassName(<span class="literal">'in2igui_gallery_item_selected'</span>,n2i.inArray(s,i));
		});
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	resolveImageUrl : <span class="reserved">function</span>(img) {
		<span class="reserved">return</span> In2iGui.resolveImageUrl(<span class="reserved">this</span>,img,<span class="reserved">this</span>.width,<span class="reserved">this</span>.height);
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.delegates.length; i++) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.delegates[i][<span class="literal">'$resolveImageUrl'</span>]) {
				<span class="reserved">return</span> <span class="reserved">this</span>.delegates[i][<span class="literal">'$resolveImageUrl'</span>](img,<span class="reserved">this</span>.width,<span class="reserved">this</span>.height);
			}
		};
		<span class="reserved">return</span> <span class="literal">''</span>;
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	itemClicked : <span class="reserved">function</span>(index) {
		<span class="reserved">this</span>.selected = [index];
		<span class="reserved">this</span>.fire(<span class="literal">'selectionChanged'</span>);
		<span class="reserved">this</span>.updateUI();
	},
	getFirstSelection : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.selected.length&gt;0) {
			<span class="reserved">return</span> <span class="reserved">this</span>.objects[<span class="reserved">this</span>.selected[0]];
		}
		<span class="reserved">return</span> null;
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	itemDoubleClicked : <span class="reserved">function</span>(index) {
		<span class="reserved">this</span>.fire(<span class="literal">'itemOpened'</span>,<span class="reserved">this</span>.objects[index]);
	}
}

<span class="comment">/* EOF */</span><span class="comment">/**
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Calendar = <span class="reserved">function</span>(o) {
	<span class="reserved">this</span>.name = o.name;
	<span class="reserved">this</span>.options = n2i.override({startHour:7,endHour:24},o);
	<span class="reserved">this</span>.element = $(o.element);
	<span class="reserved">this</span>.head = $(<span class="reserved">this</span>.element.getElementsByTagName(<span class="literal">'thead'</span>)[0]);
	<span class="reserved">this</span>.body = $(<span class="reserved">this</span>.element.getElementsByTagName(<span class="literal">'tbody'</span>)[0]);
	<span class="reserved">this</span>.date = new Date();
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.buildUI();
	<span class="reserved">this</span>.updateUI();
}

In2iGui.Calendar.<span class="reserved">prototype</span> = {
	getFirstDay : <span class="reserved">function</span>() {
		var date = new Date(<span class="reserved">this</span>.date.getTime());
		date.setDate(date.getDate()-date.getDay()+1);
		date.setHours(0);
		date.setMinutes(0);
		date.setSeconds(0);
		<span class="reserved">return</span> date;
	},
	getLastDay : <span class="reserved">function</span>() {
		var date = new Date(<span class="reserved">this</span>.date.getTime());
		date.setDate(date.getDate()-date.getDay()+7);
		date.setHours(23);
		date.setMinutes(59);
		date.setSeconds(59);
		<span class="reserved">return</span> date;
	},
	clearEvents : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.events = [];
		var nodes = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_calendar_event'</span>);
		nodes.each(<span class="reserved">function</span>(node) {
			node.remove();
		});
		<span class="reserved">this</span>.hideEventViewer();
	},
	setEvents : <span class="reserved">function</span>(events) {
		<span class="reserved">this</span>.setBusy(false);
		<span class="reserved">this</span>.clearEvents();
		<span class="reserved">this</span>.events = events;
		var self = <span class="reserved">this</span>;
		var pixels = (<span class="reserved">this</span>.options.endHour-<span class="reserved">this</span>.options.startHour)*40;
		<span class="reserved">this</span>.events.each(<span class="reserved">function</span>(event) {
			var day = self.body.select(<span class="literal">'.day'</span>)[event.startTime.getDay()-1];
			var node = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_calendar_event'</span>});
			var top = ((event.startTime.getHours()*60+event.startTime.getMinutes())/60-self.options.startHour)*40-1;
			var height = (event.endTime.getTime()-event.startTime.getTime())/1000/60/60*40+1;
			var height = Math.min(pixels-top,height);
			node.setStyle({<span class="literal">'marginTop'</span>:top+<span class="literal">'px'</span>,<span class="literal">'height'</span>:height+<span class="literal">'px'</span>});
			var content = new Element(<span class="literal">'div'</span>);
			content.insert(new Element(<span class="literal">'p'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_calendar_event_time'</span>}).update(event.startTime.dateFormat(<span class="literal">'H:i'</span>)));
			content.insert(new Element(<span class="literal">'p'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_calendar_event_text'</span>}).update(event.text));
			<span class="reserved">if</span> (event.location) {
				content.insert(new Element(<span class="literal">'p'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_calendar_event_location'</span>}).update(event.location));
			}
			day.insert(node.insert(content));
			node.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>() {
				self.eventWasClicked(event,<span class="reserved">this</span>);
			});
		});
	},
	eventWasClicked : <span class="reserved">function</span>(event,node) {
		<span class="reserved">this</span>.showEvent(event,node);
	},
	setBusy : <span class="reserved">function</span>(busy) {
		<span class="reserved">if</span> (busy) {
			<span class="reserved">this</span>.element.addClassName(<span class="literal">'in2igui_calendar_busy'</span>);
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.element.removeClassName(<span class="literal">'in2igui_calendar_busy'</span>);
		}
	},
	updateUI : <span class="reserved">function</span>() {
		var first = <span class="reserved">this</span>.getFirstDay();
		var x = <span class="reserved">this</span>.head.select(<span class="literal">'.time'</span>)[0];
		x.update(<span class="literal">'&lt;div&gt;Uge '</span>+<span class="reserved">this</span>.date.getWeekOfYear()+<span class="literal">' '</span>+<span class="reserved">this</span>.date.getFullYear()+<span class="literal">'&lt;/div&gt;'</span>);
		
		var days = <span class="reserved">this</span>.head.select(<span class="literal">'.day'</span>);
		<span class="reserved">for</span> (var i=0; i &lt; days.length; i++) {
			var date = new Date(first.getTime());
			date.setDate(date.getDate()+i);
			days[i].update(date.dateFormat(<span class="literal">'l \\d. d M'</span>))
		};
	},
	buildUI : <span class="reserved">function</span>() {
		var bar = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_calendar_bar'</span>)[0];
		<span class="reserved">this</span>.toolbar = In2iGui.Toolbar.create({labels:false});
		bar.insert(<span class="reserved">this</span>.toolbar.getElement());
		var previous = In2iGui.Button.create({name:<span class="literal">'in2iguiCalendarPrevious'</span>,text:<span class="literal">''</span>,icon:<span class="literal">'monochrome/previous'</span>});
		previous.addDelegate(<span class="reserved">this</span>);
		<span class="reserved">this</span>.toolbar.add(previous);
		var today = In2iGui.Button.create({name:<span class="literal">'in2iguiCalendarToday'</span>,text:<span class="literal">'Idag'</span>});
		today.addDelegate(<span class="reserved">this</span>);
		<span class="reserved">this</span>.toolbar.add(today);
		var next = In2iGui.Button.create({name:<span class="literal">'in2iguiCalendarNext'</span>,text:<span class="literal">''</span>,icon:<span class="literal">'monochrome/next'</span>});
		next.addDelegate(<span class="reserved">this</span>);
		<span class="reserved">this</span>.toolbar.add(next);
		<span class="reserved">this</span>.datePickerButton = In2iGui.Button.create({name:<span class="literal">'in2iguiCalendarDatePicker'</span>,text:<span class="literal">'Vlg dato...'</span>});
		<span class="reserved">this</span>.datePickerButton.addDelegate(<span class="reserved">this</span>);
		<span class="reserved">this</span>.toolbar.add(<span class="reserved">this</span>.datePickerButton);
		
		var time = <span class="reserved">this</span>.body.select(<span class="literal">'.time'</span>)[0];
		<span class="reserved">for</span> (var i=<span class="reserved">this</span>.options.startHour; i &lt;= <span class="reserved">this</span>.options.endHour; i++) {
			var node = new Element(<span class="literal">'div'</span>).update(<span class="literal">'&lt;span&gt;&lt;em&gt;'</span>+i+<span class="literal">':00&lt;/em&gt;&lt;/span&gt;'</span>);
			<span class="reserved">if</span> (i==<span class="reserved">this</span>.options.startHour) {
				node.addClassName(<span class="literal">'first'</span>);
			}
			<span class="reserved">if</span> (i==<span class="reserved">this</span>.options.endHour) {
				node.addClassName(<span class="literal">'last'</span>);
			}
			time.insert(node);
		};
	},
	$click$in2iguiCalendarPrevious : <span class="reserved">function</span>() {
		var date = new Date(<span class="reserved">this</span>.date.getTime());
		date.setDate(<span class="reserved">this</span>.date.getDate()-7);
		<span class="reserved">this</span>.setDate(date);
	},
	$click$in2iguiCalendarNext : <span class="reserved">function</span>() {
		var date = new Date(<span class="reserved">this</span>.date.getTime());
		date.setDate(<span class="reserved">this</span>.date.getDate()+7);
		<span class="reserved">this</span>.setDate(date);
	},
	$click$in2iguiCalendarToday : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.setDate(new Date());
	},
	setDate: <span class="reserved">function</span>(date) {
		<span class="reserved">this</span>.date = new Date(date.getTime());
		<span class="reserved">this</span>.updateUI();
		<span class="reserved">this</span>.refresh();
		<span class="reserved">if</span> (<span class="reserved">this</span>.datePicker) {
			<span class="reserved">this</span>.datePicker.setValue(<span class="reserved">this</span>.date);
		}
	},
	$click$in2iguiCalendarDatePicker : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.showDatePicker();
	},
	refresh : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.clearEvents();
		<span class="reserved">this</span>.setBusy(true);
		var info = {<span class="literal">'startTime'</span>:<span class="reserved">this</span>.getFirstDay(),<span class="literal">'endTime'</span>:<span class="reserved">this</span>.getLastDay()};
		In2iGui.callDelegates(<span class="reserved">this</span>,<span class="literal">'calendarSpanChanged'</span>,info);
	},
	
	<span class="comment">////////////////////////////////// Date picker ///////////////////////////</span>
	showDatePicker : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.datePickerPanel) {
			<span class="reserved">this</span>.datePickerPanel = In2iGui.BoundPanel.create();
			<span class="reserved">this</span>.datePicker = In2iGui.DatePicker.create({name:<span class="literal">'in2iguiCalendarDatePicker'</span>,value:<span class="reserved">this</span>.date});
			<span class="reserved">this</span>.datePicker.addDelegate(<span class="reserved">this</span>);
			<span class="reserved">this</span>.datePickerPanel.add(<span class="reserved">this</span>.datePicker);
			<span class="reserved">this</span>.datePickerPanel.addSpace(5);
			var button = In2iGui.Button.create({name:<span class="literal">'in2iguiCalendarDatePickerClose'</span>,text:<span class="literal">'Luk'</span>});
			button.addDelegate(<span class="reserved">this</span>);
			<span class="reserved">this</span>.datePickerPanel.add(button);
		}
		<span class="reserved">this</span>.datePickerPanel.position(<span class="reserved">this</span>.datePickerButton.getElement());
		<span class="reserved">this</span>.datePickerPanel.show();
	},
	$click$in2iguiCalendarDatePickerClose : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.datePickerPanel.hide();
	},
	$dateChanged$in2iguiCalendarDatePicker : <span class="reserved">function</span>(date) {
		<span class="reserved">this</span>.setDate(date);
	},
	
	<span class="comment">//////////////////////////////// Event viewer //////////////////////////////</span>
	
	showEvent : <span class="reserved">function</span>(event,node) {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.eventViewerPanel) {
			<span class="reserved">this</span>.eventViewerPanel = In2iGui.BoundPanel.create({width:270,padding: 3});
			<span class="reserved">this</span>.eventInfo = In2iGui.InfoView.create(null,{height:240,clickObjects:true});
			<span class="reserved">this</span>.eventViewerPanel.add(<span class="reserved">this</span>.eventInfo);
			<span class="reserved">this</span>.eventViewerPanel.addSpace(5);
			var button = In2iGui.Button.create({name:<span class="literal">'in2iguiCalendarEventClose'</span>,text:<span class="literal">'Luk'</span>});
			button.addDelegate(<span class="reserved">this</span>);
			<span class="reserved">this</span>.eventViewerPanel.add(button);
		}
		<span class="reserved">this</span>.eventInfo.clear();
		<span class="reserved">this</span>.eventInfo.setBusy(true);
		<span class="reserved">this</span>.eventViewerPanel.position(node);
		<span class="reserved">this</span>.eventViewerPanel.show();
		In2iGui.callDelegates(<span class="reserved">this</span>,<span class="literal">'requestEventInfo'</span>,event);
		<span class="reserved">return</span>;
	},
	updateEventInfo : <span class="reserved">function</span>(event,data) {
		<span class="reserved">this</span>.eventInfo.setBusy(false);
		<span class="reserved">this</span>.eventInfo.update(data);
	},
	click$in2iguiCalendarEventClose : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.hideEventViewer();
	},
	hideEventViewer : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.eventViewerPanel) {
			<span class="reserved">this</span>.eventViewerPanel.hide();
		}
	}
}


<span class="comment">////////////////////////// Date picker ////////////////////////</span>

<span class="comment">/** <span class="attrib">@constructor</span> */</span>
In2iGui.DatePicker = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.options = {};
	n2i.override(<span class="reserved">this</span>.options,options);
	<span class="reserved">this</span>.cells = [];
	<span class="reserved">this</span>.title = <span class="reserved">this</span>.element.select(<span class="literal">'strong'</span>)[0];
	<span class="reserved">this</span>.today = new Date();
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.options.value ? new Date(<span class="reserved">this</span>.options.value.getTime()) : new Date();
	<span class="reserved">this</span>.viewDate = new Date(<span class="reserved">this</span>.value.getTime());
	<span class="reserved">this</span>.viewDate.setDate(1);
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.addBehavior();
	<span class="reserved">this</span>.updateUI();
}

In2iGui.DatePicker.create = <span class="reserved">function</span>(options) {
	var element = options.element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_datepicker'</span>});
	element.insert(<span class="literal">'&lt;div class="in2igui_datepicker_header"&gt;&lt;a class="in2igui_datepicker_next"&gt;&lt;/a&gt;&lt;a class="in2igui_datepicker_previous"&gt;&lt;/a&gt;&lt;strong&gt;&lt;/strong&gt;&lt;/div&gt;'</span>);
	var table = new Element(<span class="literal">'table'</span>);
	var head = new Element(<span class="literal">'tr'</span>);
	table.insert(new Element(<span class="literal">'thead'</span>).insert(head));
	<span class="reserved">for</span> (var i=0;i&lt;7;i++) {
		head.insert(new Element(<span class="literal">'th'</span>).update(Date.dayNames[i].substring(0,3)));
	}
	var body = new Element(<span class="literal">'tbody'</span>);
	table.insert(body);
	<span class="reserved">for</span> (var i=0;i&lt;6;i++) {
		var row = new Element(<span class="literal">'tr'</span>);
		<span class="reserved">for</span> (var j=0;j&lt;7;j++) {
			var cell = new Element(<span class="literal">'td'</span>);
			row.insert(cell);
		}
		body.insert(row);
	}
	element.insert(table);
	<span class="reserved">return</span> new In2iGui.DatePicker(options);
}

In2iGui.DatePicker.<span class="reserved">prototype</span> = {
	addBehavior : <span class="reserved">function</span>() {
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.cells = <span class="reserved">this</span>.element.select(<span class="literal">'td'</span>);
		<span class="reserved">this</span>.cells.each(<span class="reserved">function</span>(cell,index) {
			cell.observe(<span class="literal">'mousedown'</span>,<span class="reserved">function</span>() {self.selectCell(index)});
		})
		<span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_datepicker_next'</span>)[0].observe(<span class="literal">'mousedown'</span>,<span class="reserved">function</span>() {self.next()});
		<span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_datepicker_previous'</span>)[0].observe(<span class="literal">'mousedown'</span>,<span class="reserved">function</span>() {self.previous()});
	},
	setValue : <span class="reserved">function</span>(date) {
		<span class="reserved">this</span>.value = new Date(date.getTime());
		<span class="reserved">this</span>.viewDate = new Date(date.getTime());
		<span class="reserved">this</span>.viewDate.setDate(1);
		<span class="reserved">this</span>.updateUI();
	},
	updateUI : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.title.update(<span class="reserved">this</span>.viewDate.dateFormat(<span class="literal">'F Y'</span>));
		var isSelectedYear =  <span class="reserved">this</span>.value.getFullYear()==<span class="reserved">this</span>.viewDate.getFullYear();
		var month = <span class="reserved">this</span>.viewDate.getMonth();
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.cells.length; i++) {
			var date = <span class="reserved">this</span>.indexToDate(i);
			var cell = <span class="reserved">this</span>.cells[i];
			<span class="reserved">if</span> (date.getMonth()&lt;month) {
				cell.className = <span class="literal">'in2igui_datepicker_dimmed'</span>;
			} <span class="reserved">else</span> <span class="reserved">if</span> (date.getMonth()&gt;month) {
				cell.className = <span class="literal">'in2igui_datepicker_dimmed'</span>;
			} <span class="reserved">else</span> {
				cell.className = <span class="literal">''</span>;
			}
			<span class="reserved">if</span> (date.getDate()==<span class="reserved">this</span>.value.getDate() &amp;&amp; date.getMonth()==<span class="reserved">this</span>.value.getMonth() &amp;&amp; isSelectedYear) {
				cell.addClassName(<span class="literal">'in2igui_datepicker_selected'</span>);
			}
			<span class="reserved">if</span> (date.getDate()==<span class="reserved">this</span>.today.getDate() &amp;&amp; date.getMonth()==<span class="reserved">this</span>.today.getMonth() &amp;&amp; date.getFullYear()==<span class="reserved">this</span>.today.getFullYear()) {
				cell.addClassName(<span class="literal">'in2igui_datepicker_today'</span>);
			}
			cell.update(date.getDate());
		};
	},
	getPreviousMonth : <span class="reserved">function</span>() {
		var previous = new Date(<span class="reserved">this</span>.viewDate.getTime());
		previous.setMonth(previous.getMonth()-1);
		<span class="reserved">return</span> previous;
	},
	getNextMonth : <span class="reserved">function</span>() {
		var previous = new Date(<span class="reserved">this</span>.viewDate.getTime());
		previous.setMonth(previous.getMonth()+1);
		<span class="reserved">return</span> previous;
	},

	<span class="comment">////////////////// Events ///////////////</span>

	previous : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.viewDate = <span class="reserved">this</span>.getPreviousMonth();
		<span class="reserved">this</span>.updateUI();
	},
	next : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.viewDate = <span class="reserved">this</span>.getNextMonth();
		<span class="reserved">this</span>.updateUI();
	},
	selectCell : <span class="reserved">function</span>(index) {
		<span class="reserved">this</span>.value = <span class="reserved">this</span>.indexToDate(index);
		<span class="reserved">this</span>.viewDate = new Date(<span class="reserved">this</span>.value.getTime());
		<span class="reserved">this</span>.viewDate.setDate(1);
		<span class="reserved">this</span>.updateUI();
		In2iGui.callDelegates(<span class="reserved">this</span>,<span class="literal">'dateChanged'</span>,<span class="reserved">this</span>.value);
	},
	indexToDate : <span class="reserved">function</span>(index) {
		var first = <span class="reserved">this</span>.viewDate.getDay();
		var days = <span class="reserved">this</span>.viewDate.getDaysInMonth();
		var previousDays = <span class="reserved">this</span>.getPreviousMonth().getDaysInMonth();
		<span class="reserved">if</span> (index&lt;first) {
			var date = <span class="reserved">this</span>.getPreviousMonth();
			date.setDate(previousDays-first+index+1);
			<span class="reserved">return</span> date;
		} <span class="reserved">else</span> <span class="reserved">if</span> (index&gt;first+days-1) {
			var date = <span class="reserved">this</span>.getPreviousMonth();
			date.setDate(index-first-days+1);
			<span class="reserved">return</span> date;
			cell.update(i-first-days+1);
		} <span class="reserved">else</span> {
			var date = new Date(<span class="reserved">this</span>.viewDate.getTime());
			date.setDate(index+1-first);
			<span class="reserved">return</span> date;
		}
	}
}

Date.monthNames =
   [<span class="literal">"Januar"</span>,
    <span class="literal">"Februar"</span>,
    <span class="literal">"Marts"</span>,
    <span class="literal">"April"</span>,
    <span class="literal">"Maj"</span>,
    <span class="literal">"Juni"</span>,
    <span class="literal">"Juli"</span>,
    <span class="literal">"August"</span>,
    <span class="literal">"September"</span>,
    <span class="literal">"Oktober"</span>,
    <span class="literal">"November"</span>,
    <span class="literal">"December"</span>];
Date.dayNames =
   [<span class="literal">"Sndag"</span>,
    <span class="literal">"Mandag"</span>,
    <span class="literal">"Tirsdag"</span>,
    <span class="literal">"Onsdag"</span>,
    <span class="literal">"Torsdag"</span>,
    <span class="literal">"Fredag"</span>,
    <span class="literal">"Lrdag"</span>];

<span class="comment">/* EOF */</span><span class="comment">/**
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {Object} options { element Node | id, name: String }
 */</span>
In2iGui.Layout = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.options = options || {};
	<span class="reserved">this</span>.element = $(options.element);
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">if</span> (n2i.browser.msie7 || n2i.browser.msie8) {
		In2iGui.onDomReady(<span class="reserved">this</span>.resize.bind(<span class="reserved">this</span>));
		Event.observe(window,<span class="literal">'resize'</span>,<span class="reserved">this</span>.resize.bind(<span class="reserved">this</span>));
	}
}

In2iGui.Layout.<span class="reserved">prototype</span> = {
	resize : <span class="reserved">function</span>() {
		var height = <span class="reserved">this</span>.element.parentNode.clientHeight;
		var diff = n2i.browser.msie7 ? 40 : 20;
		var top = <span class="reserved">this</span>.element.select(<span class="literal">'thead td'</span>)[0].firstDescendant().clientHeight;
		var bottom = <span class="reserved">this</span>.element.select(<span class="literal">'tfoot td'</span>)[0].firstDescendant().clientHeight;
		<span class="reserved">if</span> ((height-top-bottom-diff)&gt;0) {
			<span class="reserved">this</span>.element.select(<span class="literal">'tbody tr td'</span>)[0].style.height=(height-top-bottom-diff)+<span class="literal">'px'</span>;
		}
	}
};


<span class="comment">/**
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {Object} options { element Node | id, name: String }
 */</span>
In2iGui.Columns = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.options = options || {};
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.body = <span class="reserved">this</span>.element.select(<span class="literal">'tr'</span>)[0];
	In2iGui.extend(<span class="reserved">this</span>);
}

<span class="comment">/**
 * Creates a new Columns opject
 */</span>
In2iGui.Columns.create = <span class="reserved">function</span>(options) {
	options = options || {};
	options.element = new Element(<span class="literal">'table'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_columns'</span>}).insert(new Element(<span class="literal">'tbody'</span>).insert(new Element(<span class="literal">'tr'</span>)));
	<span class="reserved">return</span> new In2iGui.Columns(options);
}

In2iGui.Columns.<span class="reserved">prototype</span> = {
	addToColumn : <span class="reserved">function</span>(index,widget) {
		var c = <span class="reserved">this</span>.ensureColumn(index);
		c.insert(widget.getElement());
	},
	setColumnStyle : <span class="reserved">function</span>(index,style) {
		var c = <span class="reserved">this</span>.ensureColumn(index);
		c.setStyle(style);
	},
	setColumnWidth : <span class="reserved">function</span>(index,width) {
		var c = <span class="reserved">this</span>.ensureColumn(index);
		c.setStyle({width:width+<span class="literal">'px'</span>});
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	ensureColumn : <span class="reserved">function</span>(index) {
		var children = <span class="reserved">this</span>.body.childElements();
		<span class="reserved">for</span> (var i=children.length-1;i&lt;index;i++) {
			<span class="reserved">this</span>.body.insert(new Element(<span class="literal">'td'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_columns_column'</span>}));
		}
		<span class="reserved">return</span> <span class="reserved">this</span>.body.childElements()[index];
	}
}

<span class="comment">/* EOF */</span><span class="comment">/**
 * A dock
 * <span class="attrib">@param</span> {Object} The options
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Dock = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = options;
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.iframe = <span class="reserved">this</span>.element.select(<span class="literal">'iframe'</span>)[0];
	<span class="reserved">this</span>.name = options.name;
	In2iGui.extend(<span class="reserved">this</span>);
	var height = -69;
	<span class="reserved">if</span> (<span class="reserved">this</span>.options.tabs) {
		height-=15;
	}
	<span class="comment">//In2iGui.get().registerOverflow(this.iframe,height);</span>
}

In2iGui.Dock.<span class="reserved">prototype</span> = {
	<span class="comment">/** Change the url of the iframe
	 * <span class="attrib">@param</span> {String} url The url to change the iframe to
	 */</span>
	setUrl : <span class="reserved">function</span>(url) {
		n2i.getFrameDocument(<span class="reserved">this</span>.iframe).location.href=url;
	}
}

<span class="comment">/* EOF */</span><span class="comment">/**
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {Object} options The options : {modal:false}
 */</span>
In2iGui.Box = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = n2i.override({},options);
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.body = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_box_body'</span>)[0];
	<span class="reserved">this</span>.close = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_box_close'</span>)[0];
	<span class="reserved">if</span> (<span class="reserved">this</span>.close) {
		<span class="reserved">this</span>.close.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>(e) {
			e.stop();
			<span class="reserved">this</span>.hide();
			<span class="reserved">this</span>.fire(<span class="literal">'boxWasClosed'</span>);
		}.bind(<span class="reserved">this</span>));
	}
	In2iGui.extend(<span class="reserved">this</span>);
};

<span class="comment">/**
 * Creates a new box widget
 * <span class="attrib">@param</span> {Object} options The options : {width:0,padding:0,absolute:false,closable:false}
 */</span>
In2iGui.Box.create = <span class="reserved">function</span>(options) {
	options = n2i.override({},options);
	var e = options.element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_box'</span>});
	<span class="reserved">if</span> (options.width) {
		e.setStyle({width:options.width+<span class="literal">'px'</span>});
	}
	<span class="reserved">if</span> (options.absolute) {
		e.addClassName(<span class="literal">'in2igui_box_absolute'</span>);
	}
	e.update(
		(options.closable ? <span class="literal">'&lt;a class="in2igui_box_close" href="#"&gt;&lt;/a&gt;'</span> : <span class="literal">''</span>)+
		<span class="literal">'&lt;div class="in2igui_box_top"&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;'</span>+
		<span class="literal">'&lt;div class="in2igui_box_middle"&gt;&lt;div class="in2igui_box_middle"&gt;'</span>+
		(options.title ? <span class="literal">'&lt;div class="in2igui_box_header"&gt;&lt;strong class="in2igui_box_title"&gt;'</span>+options.title+<span class="literal">'&lt;/strong&gt;&lt;/div&gt;'</span> : <span class="literal">''</span>)+
		<span class="literal">'&lt;div class="in2igui_box_body"'</span>+(options.padding ? <span class="literal">' style="padding: '</span>+options.padding+<span class="literal">'px;"'</span> : <span class="literal">''</span>)+<span class="literal">'&gt;&lt;/div&gt;'</span>+
		<span class="literal">'&lt;/div&gt;&lt;/div&gt;'</span>+
		<span class="literal">'&lt;div class="in2igui_box_bottom"&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;'</span>);
	<span class="reserved">return</span> new In2iGui.Box(options);
};

In2iGui.Box.<span class="reserved">prototype</span> = {
	<span class="comment">/**
	 * Adds the box to the end of the body
	 */</span>
	addToDocument : <span class="reserved">function</span>() {
		document.body.appendChild(<span class="reserved">this</span>.element);
	},
	<span class="comment">/**
	 * Adds a child widget or node
	 */</span>
	add : <span class="reserved">function</span>(widget) {
		<span class="reserved">if</span> (widget.getElement) {
			<span class="reserved">this</span>.body.insert(widget.getElement());
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.body.insert(widget);
		}
	},
	<span class="comment">/**
	 * Shows the box
	 */</span>
	show : <span class="reserved">function</span>() {
		var e = <span class="reserved">this</span>.element;
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.modal) {
			var index = In2iGui.nextPanelIndex();
			e.style.zIndex=index+1;
			In2iGui.showCurtain(<span class="reserved">this</span>,index);
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.absolute) {
			e.setStyle({display:<span class="literal">'block'</span>,visibility:<span class="literal">'hidden'</span>});
			var w = e.getWidth();
			var top = (n2i.getInnerHeight()-e.getHeight())/2+n2i.getScrollTop();
			e.setStyle({<span class="literal">'marginLeft'</span>:(w/-2)+<span class="literal">'px'</span>,top:top+<span class="literal">'px'</span>});
			e.setStyle({display:<span class="literal">'block'</span>,visibility:<span class="literal">'visible'</span>});
		} <span class="reserved">else</span> {
			e.setStyle({display:<span class="literal">'block'</span>});
		}
		In2iGui.callVisible(<span class="reserved">this</span>);
	},
	<span class="comment">/**
	 * Hides the box
	 */</span>
	hide : <span class="reserved">function</span>() {
		In2iGui.hideCurtain(<span class="reserved">this</span>);
		<span class="reserved">this</span>.element.setStyle({display:<span class="literal">'none'</span>});
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	curtainWasClicked : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.fire(<span class="literal">'boxCurtainWasClicked'</span>);
	}
};<span class="comment">/**
 * <span class="attrib">@constructor</span>
 * A wizard with a number of steps
 */</span>
In2iGui.Wizard = <span class="reserved">function</span>(o) {
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.options = o || {};
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.element = $(o.element);
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.name = o.name;
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.container = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_wizard_steps'</span>)[0];
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.steps = <span class="reserved">this</span>.element.select(<span class="literal">'.in2igui_wizard_step'</span>);
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.anchors = <span class="reserved">this</span>.element.select(<span class="literal">'ul.in2igui_wizard a'</span>);
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	<span class="reserved">this</span>.selected = 0;
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.addBehavior();
}
	
In2iGui.Wizard.<span class="reserved">prototype</span> = {
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	addBehavior : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.anchors.each(<span class="reserved">function</span>(node,i) {
			node.observe(<span class="literal">'mousedown'</span>,<span class="reserved">function</span>(e) {e.stop();<span class="reserved">this</span>.goToStep(i)}.bind(<span class="reserved">this</span>));
			node.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>(e) {e.stop();});
		}.bind(<span class="reserved">this</span>));
	},
	<span class="comment">/** Goes to the step with the index */</span>
	goToStep : <span class="reserved">function</span>(index) {
		var c = <span class="reserved">this</span>.container;
		c.setStyle({height:c.getHeight()+<span class="literal">'px'</span>})
		<span class="reserved">this</span>.anchors[<span class="reserved">this</span>.selected].removeClassName(<span class="literal">'in2igui_selected'</span>);
		<span class="reserved">this</span>.steps[<span class="reserved">this</span>.selected].hide();
		<span class="reserved">this</span>.anchors[index].addClassName(<span class="literal">'in2igui_selected'</span>);
		<span class="reserved">this</span>.steps[index].show();
		<span class="reserved">this</span>.selected=index;
		n2i.ani(c,<span class="literal">'height'</span>,<span class="reserved">this</span>.steps[index].getHeight()+<span class="literal">'px'</span>,500,{ease:n2i.ease.slowFastSlow,onComplete:<span class="reserved">function</span>() {
			c.setStyle({height:<span class="literal">''</span>});
		}});
		In2iGui.callVisible(<span class="reserved">this</span>);
	},
	<span class="comment">/** Goes to the next step */</span>
	next : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.selected&lt;<span class="reserved">this</span>.steps.length-1) {
			<span class="reserved">this</span>.goToStep(<span class="reserved">this</span>.selected+1);
		}
	},
	<span class="comment">/** Goes to the previous step */</span>
	previous : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.selected&gt;0) {
			<span class="reserved">this</span>.goToStep(<span class="reserved">this</span>.selected-1);
		}
	}
}

<span class="comment">/* EOF */</span><span class="comment">/**
 * A list of articles
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@param</span> {Object} options { element: Node | id, name: String, source: In2iGui.Source }
 */</span>
In2iGui.Articles = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = options;
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">if</span> (options.source) {
		options.source.addDelegate(<span class="reserved">this</span>);
	}
}

In2iGui.Articles.<span class="reserved">prototype</span> = {
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	$articlesLoaded : <span class="reserved">function</span>(doc) {
		<span class="reserved">this</span>.element.update();
		var a = doc.getElementsByTagName(<span class="literal">'article'</span>);
		<span class="reserved">for</span> (var i=0; i &lt; a.length; i++) {
			var e = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_article'</span>});
			var c = a[i].childNodes;
			<span class="reserved">for</span> (var j=0; j &lt; c.length; j++) {
				<span class="reserved">if</span> (n2i.dom.isElement(c[j],<span class="literal">'title'</span>)) {
					e.insert(new Element(<span class="literal">'h2'</span>).update(n2i.dom.getNodeText(c[j])));
				} <span class="reserved">else</span> <span class="reserved">if</span> (n2i.dom.isElement(c[j],<span class="literal">'paragraph'</span>)) {
					var p = new Element(<span class="literal">'p'</span>).update(n2i.dom.getNodeText(c[j]));
					<span class="reserved">if</span> (c[j].getAttribute(<span class="literal">'dimmed'</span>)===<span class="literal">'true'</span>) {
						p.addClassName(<span class="literal">'in2igui_dimmed'</span>);
					}
					e.insert(p);
				}
			};
			<span class="reserved">this</span>.element.insert(e);
		};
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	$sourceIsBusy : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.update(<span class="literal">'&lt;div class="in2igui_articles_loading"&gt;Loading...&lt;/div&gt;'</span>);
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	$sourceIsNotBusy : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.removeClassName(<span class="literal">'in2igui_list_busy'</span>);
	}
}

<span class="comment">/* EOF */</span><span class="comment">/** <span class="attrib">@constructor</span> */</span>
In2iGui.TextField = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = n2i.override({placeholderElement:null,validator:null},options);
	var e = <span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.element.setAttribute(<span class="literal">'autocomplete'</span>,<span class="literal">'off'</span>);
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.validate(<span class="reserved">this</span>.element.value);
	<span class="reserved">this</span>.isPassword = <span class="reserved">this</span>.element.type==<span class="literal">'password'</span>;
	<span class="reserved">this</span>.name = options.name;
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.addBehavior();
	<span class="reserved">if</span> (<span class="reserved">this</span>.options.placeholderElement &amp;&amp; <span class="reserved">this</span>.value!=<span class="literal">''</span>) {
		In2iGui.fadeOut(<span class="reserved">this</span>.options.placeholderElement,0);
	}
	<span class="reserved">this</span>.checkPlaceholder();
	try { <span class="comment">// IE hack</span>
		<span class="reserved">if</span> (e==document.activeElement) {
			<span class="reserved">this</span>.focused();
		}
	} catch (e) {}
}

In2iGui.TextField.<span class="reserved">prototype</span> = {
	addBehavior : <span class="reserved">function</span>() {
		var e = <span class="reserved">this</span>.element;
		e.observe(<span class="literal">'keyup'</span>,<span class="reserved">this</span>.keyDidStrike.bind(<span class="reserved">this</span>));
		var p = <span class="reserved">this</span>.options.placeholderElement;
		e.observe(<span class="literal">'blur'</span>,<span class="reserved">this</span>.onBlur.bind(<span class="reserved">this</span>));
		<span class="reserved">if</span> (p) {
			e.observe(<span class="literal">'focus'</span>,<span class="reserved">this</span>.focused.bind(<span class="reserved">this</span>));
			e.observe(<span class="literal">'blur'</span>,<span class="reserved">this</span>.checkPlaceholder.bind(<span class="reserved">this</span>));
			<span class="reserved">if</span> (p) {
				p.setStyle({cursor:<span class="literal">'text'</span>});
				p.observe(<span class="literal">'mousedown'</span>,<span class="reserved">this</span>.focus.bind(<span class="reserved">this</span>)).observe(<span class="literal">'click'</span>,<span class="reserved">this</span>.focus.bind(<span class="reserved">this</span>));
			}
		}
	},
	focused : <span class="reserved">function</span>() {
		var e = <span class="reserved">this</span>.element,p = <span class="reserved">this</span>.options.placeholderElement;
		<span class="reserved">if</span> (p &amp;&amp; e.value==<span class="literal">''</span>) {
			In2iGui.fadeOut(p,0);
		}
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	validate : <span class="reserved">function</span>(value) {
		var validator = <span class="reserved">this</span>.options.validator, result;
		<span class="reserved">if</span> (validator) {
			result = validator.validate(value);
			<span class="reserved">this</span>.element.setClassName(<span class="literal">'in2igui_invalid'</span>,!result.valid);
			<span class="reserved">return</span> result.value;
		}
		<span class="reserved">return</span> value;
	},
	checkPlaceholder : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.placeholderElement &amp;&amp; <span class="reserved">this</span>.value==<span class="literal">''</span>) {
			In2iGui.fadeIn(<span class="reserved">this</span>.options.placeholderElement,200);
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.isPassword &amp;&amp; !n2i.browser.msie) {
			<span class="reserved">this</span>.element.type=<span class="literal">'password'</span>;
		}
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	keyDidStrike : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.value!==<span class="reserved">this</span>.element.value) {
			var newValue = <span class="reserved">this</span>.validate(<span class="reserved">this</span>.element.value);
			var changed = newValue!==<span class="reserved">this</span>.value;
			<span class="reserved">this</span>.value = newValue;
			<span class="reserved">if</span> (changed) {
				<span class="reserved">this</span>.fire(<span class="literal">'valueChanged'</span>,<span class="reserved">this</span>.value);
			}
		}
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	onBlur : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.removeClassName(<span class="literal">'in2igui_invalid'</span>);
		<span class="reserved">this</span>.element.value = <span class="reserved">this</span>.value;
	},
	getValue : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value;
	},
	setValue : <span class="reserved">function</span>(value) {
		<span class="reserved">if</span> (value===undefined || value===null) value=<span class="literal">''</span>;
		<span class="reserved">this</span>.element.value = value;
		<span class="reserved">this</span>.value = <span class="reserved">this</span>.validate(value);
	},
	isEmpty : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value==<span class="literal">''</span>;
	},
	isBlank : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value.strip()==<span class="literal">''</span>;
	},
	focus : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.focus();
	},
	setError : <span class="reserved">function</span>(error) {
		var isError = error ? true : false;
		<span class="reserved">this</span>.element.setClassName(<span class="literal">'in2igui_field_error'</span>,isError);
		<span class="reserved">if</span> (typeof(error) == <span class="literal">'string'</span>) {
			In2iGui.showToolTip({text:error,element:<span class="reserved">this</span>.element,key:<span class="reserved">this</span>.name});
		}
		<span class="reserved">if</span> (!isError) {
			In2iGui.hideToolTip({key:<span class="reserved">this</span>.name});
		}
	}
};

<span class="comment">/* EOF */</span><span class="comment">/** <span class="attrib">@constructor</span> */</span>
In2iGui.InfoView = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = n2i.override({clickObjects:false},options);
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.body = <span class="reserved">this</span>.element.select(<span class="literal">'tbody'</span>)[0];
	<span class="reserved">this</span>.name = options.name;
	In2iGui.extend(<span class="reserved">this</span>);
}

In2iGui.InfoView.create = <span class="reserved">function</span>(options) {
	options = options || {};
	var element = options.element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_infoview'</span>});
	<span class="reserved">if</span> (options.height) {
		element.setStyle({height:options.height+<span class="literal">'px'</span>,<span class="literal">'overflow'</span>:<span class="literal">'auto'</span>,<span class="literal">'overflowX'</span>:<span class="literal">'hidden'</span>});
	}
	<span class="reserved">if</span> (options.margin) {
		element.setStyle({margin:options.margin+<span class="literal">'px'</span>});
	}
	element.update(<span class="literal">'&lt;table&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;/table&gt;'</span>);
	<span class="reserved">return</span> new In2iGui.InfoView(options);
}

In2iGui.InfoView.<span class="reserved">prototype</span> = {
	addHeader : <span class="reserved">function</span>(text) {
		var row = new Element(<span class="literal">'tr'</span>);
		row.insert(new Element(<span class="literal">'th'</span>,{<span class="literal">'class'</span> : <span class="literal">'in2igui_infoview_header'</span>,<span class="literal">'colspan'</span>:<span class="literal">'2'</span>}).insert(text));
		<span class="reserved">this</span>.body.insert(row);
	},
	addProperty : <span class="reserved">function</span>(label,text) {
		var row = new Element(<span class="literal">'tr'</span>);
		row.insert(new Element(<span class="literal">'th'</span>).insert(label));
		row.insert(new Element(<span class="literal">'td'</span>).insert(text));
		<span class="reserved">this</span>.body.insert(row);
	},
	addObjects : <span class="reserved">function</span>(label,objects) {
		<span class="reserved">if</span> (!objects || objects.length==0) <span class="reserved">return</span>;
		var row = new Element(<span class="literal">'tr'</span>);
		row.insert(new Element(<span class="literal">'th'</span>).insert(label));
		var cell = new Element(<span class="literal">'td'</span>);
		var click = <span class="reserved">this</span>.options.clickObjects;
		objects.each(<span class="reserved">function</span>(obj) {
			var node = new Element(<span class="literal">'div'</span>).insert(obj.title);
			<span class="reserved">if</span> (click) {
				node.addClassName(<span class="literal">'in2igui_infoview_click'</span>)
				node.observe(<span class="literal">'click'</span>,<span class="reserved">function</span>() {
					In2iGui.callDelegates(<span class="reserved">this</span>,<span class="literal">'objectWasClicked'</span>,obj);
				});
			}
			cell.insert(node);
		});
		row.insert(cell);
		<span class="reserved">this</span>.body.insert(row);
	},
	setBusy : <span class="reserved">function</span>(busy) {
		<span class="reserved">if</span> (busy) {
			<span class="reserved">this</span>.element.addClassName(<span class="literal">'in2igui_infoview_busy'</span>);
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.element.removeClassName(<span class="literal">'in2igui_infoview_busy'</span>);
		}
	},
	clear : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.body.update();
	},
	update : <span class="reserved">function</span>(data) {
		<span class="reserved">this</span>.clear();
		<span class="reserved">for</span> (var i=0; i &lt; data.length; i++) {
			switch (data[i].type) {
				case <span class="literal">'header'</span>: <span class="reserved">this</span>.addHeader(data[i].value); break;
				case <span class="literal">'property'</span>: <span class="reserved">this</span>.addProperty(data[i].label,data[i].value); break;
				case <span class="literal">'objects'</span>: <span class="reserved">this</span>.addObjects(data[i].label,data[i].value); break;
			}
		};
	}
}

<span class="comment">/* EOF */</span><span class="comment">/**
 * Overflow with scroll bars
 * <span class="attrib">@param</span> {Object} The options
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Overflow = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = options;
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.name = options.name;
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.diff=0;
	<span class="reserved">if</span> (options.dynamic) {
		<span class="reserved">if</span> (n2i.browser.msie7 || n2i.browser.msie8) {
			window.setTimeout(<span class="reserved">this</span>.calculate.bind(<span class="reserved">this</span>),1000);
		} <span class="reserved">else</span> {
			In2iGui.onDomReady(<span class="reserved">this</span>.calculate.bind(<span class="reserved">this</span>));
		}
	} <span class="reserved">else</span> <span class="reserved">if</span> (options.vertical) {
		In2iGui.get().registerOverflow(<span class="reserved">this</span>.element,options.vertical*-1);
	}
}

In2iGui.Overflow.create = <span class="reserved">function</span>(options) {
	options = options || {};
	var e = options.element = new Element(<span class="literal">'div'</span>,{<span class="literal">'class'</span>:<span class="literal">'in2igui_overflow'</span>});
	<span class="reserved">if</span> (options.height) {
		e.setStyle({height:options.height+<span class="literal">'px'</span>});
	}
	<span class="reserved">return</span> new In2iGui.Overflow(options);
}

In2iGui.Overflow.<span class="reserved">prototype</span> = {
	calculate : <span class="reserved">function</span>() {
		var top,bottom,parent,viewport;
		viewport = n2i.getInnerHeight();
		parent = $(<span class="reserved">this</span>.element.parentNode);
		top = <span class="reserved">this</span>.element.cumulativeOffset().top;
		bottom = parent.cumulativeOffset().top+parent.getDimensions().height;
		<span class="reserved">this</span>.element.nextSiblings().each(<span class="reserved">function</span>(node) {
			bottom-=node.clientHeight;
		})
		<span class="reserved">this</span>.diff=-1*(top+(viewport-bottom));
		<span class="reserved">this</span>.resize();
		Event.observe(window,<span class="literal">'resize'</span>,<span class="reserved">this</span>.resize.bind(<span class="reserved">this</span>));
	},
	resize : <span class="reserved">function</span>() {
		var height = n2i.getInnerHeight();
		<span class="reserved">this</span>.element.style.height = Math.max(0,height+<span class="reserved">this</span>.diff)+<span class="literal">'px'</span>;
	},
	add : <span class="reserved">function</span>(widgetOrNode) {
		<span class="reserved">if</span> (widgetOrNode.getElement) {
			<span class="reserved">this</span>.element.insert(widgetOrNode.getElement());
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.element.insert(widgetOrNode);
		}
		<span class="reserved">return</span> <span class="reserved">this</span>;
	}
}

<span class="comment">/* EOF */</span><span class="comment">/** <span class="attrib">@constructor</span> */</span>
In2iGui.SearchField = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = n2i.override({expandedWidth:null},options);
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.name = options.name;
	<span class="reserved">this</span>.field = <span class="reserved">this</span>.element.select(<span class="literal">'input'</span>)[0];
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
	<span class="reserved">this</span>.adaptive = <span class="reserved">this</span>.element.hasClassName(<span class="literal">'in2igui_searchfield_adaptive'</span>);
	In2iGui.onDomReady(<span class="reserved">function</span>() {<span class="reserved">this</span>.initialWidth=parseInt(<span class="reserved">this</span>.element.getStyle(<span class="literal">'width'</span>))}.bind(<span class="reserved">this</span>));
	In2iGui.extend(<span class="reserved">this</span>);
	<span class="reserved">this</span>.addBehavior();
	<span class="reserved">this</span>.updateClass()
}

In2iGui.SearchField.create = <span class="reserved">function</span>(options) {
	options = options || {};
	
	var e = options.element = new Element(<span class="literal">'span'</span>,{<span class="literal">'class'</span>: options.adaptive ? <span class="literal">'in2igui_searchfield in2igui_searchfield_adaptive'</span> : <span class="literal">'in2igui_searchfield'</span>});
	e.update(<span class="literal">'&lt;em class="in2igui_searchfield_placeholder"&gt;&lt;/em&gt;&lt;a href="javascript:void(0);" class="in2igui_searchfield_reset"&gt;&lt;/a&gt;&lt;span&gt;&lt;span&gt;&lt;input type="text"/&gt;&lt;/span&gt;&lt;/span&gt;'</span>);
	<span class="reserved">return</span> new In2iGui.SearchField(options);
}

In2iGui.SearchField.<span class="reserved">prototype</span> = {
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	addBehavior : <span class="reserved">function</span>() {
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.field.observe(<span class="literal">'keyup'</span>,<span class="reserved">this</span>.onKeyUp.bind(<span class="reserved">this</span>));
		var reset = <span class="reserved">this</span>.element.select(<span class="literal">'a'</span>)[0];
		reset.tabIndex=-1;
		var focus = <span class="reserved">function</span>() {self.field.focus();self.field.select()};
		<span class="reserved">this</span>.element.observe(<span class="literal">'mousedown'</span>,focus).observe(<span class="literal">'mouseup'</span>,focus);
		reset.observe(<span class="literal">'mousedown'</span>,<span class="reserved">function</span>(e) {e.stop();self.reset();focus()});
		<span class="reserved">this</span>.element.select(<span class="literal">'em'</span>)[0].observe(<span class="literal">'mousedown'</span>,focus);
		<span class="reserved">this</span>.field.observe(<span class="literal">'focus'</span>,<span class="reserved">function</span>() {
			self.focused=true;
			self.updateClass();
		});
		<span class="reserved">this</span>.field.observe(<span class="literal">'blur'</span>,<span class="reserved">function</span>() {
			self.focused=false;
			self.updateClass();
		});
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.expandedWidth&gt;0) {
			<span class="reserved">this</span>.field.onfocus = <span class="reserved">function</span>() {
				n2i.ani(self.element,<span class="literal">'width'</span>,self.options.expandedWidth+<span class="literal">'px'</span>,500,{ease:n2i.ease.slowFastSlow});
			}
			<span class="reserved">this</span>.field.onblur = <span class="reserved">function</span>() {
				n2i.ani(self.element,<span class="literal">'width'</span>,self.initialWidth+<span class="literal">'px'</span>,500,{ease:n2i.ease.slowFastSlow,delay:100});
			}
		}
	},
	onKeyUp : <span class="reserved">function</span>(e) {
		<span class="reserved">this</span>.fieldChanged();
		<span class="reserved">if</span> (e.keyCode===Event.KEY_RETURN) {
			<span class="reserved">this</span>.fire(<span class="literal">'submit'</span>);
		}
	},
	setValue : <span class="reserved">function</span>(value) {
		<span class="reserved">this</span>.field.value=value===undefined || value===null ? <span class="literal">''</span> : value;
		<span class="reserved">this</span>.fieldChanged();
	},
	getValue : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.field.value;
	},
	isEmpty : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.field.value==<span class="literal">''</span>;
	},
	isBlank : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.field.value.strip()==<span class="literal">''</span>;
	},
	reset : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.field.value=<span class="literal">''</span>;
		<span class="reserved">this</span>.fieldChanged();
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	updateClass : <span class="reserved">function</span>() {
		var className = <span class="literal">'in2igui_searchfield'</span>;
		<span class="reserved">if</span> (<span class="reserved">this</span>.adaptive) {
			className+=<span class="literal">' in2igui_searchfield_adaptive'</span>;
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.focused &amp;&amp; <span class="reserved">this</span>.value!=<span class="literal">''</span>) {
			className+=<span class="literal">' in2igui_searchfield_focus_dirty'</span>;
		} <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.focused) {
			className+=<span class="literal">' in2igui_searchfield_focus'</span>;
		} <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.value!=<span class="literal">''</span>) {
			className+=<span class="literal">' in2igui_searchfield_dirty'</span>;
		}
		<span class="reserved">this</span>.element.className=className;
	},
	<span class="comment">/** <span class="attrib">@private</span> */</span>
	fieldChanged : <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.field.value!=<span class="reserved">this</span>.value) {
			<span class="reserved">this</span>.value=<span class="reserved">this</span>.field.value;
			<span class="reserved">this</span>.updateClass();
			<span class="reserved">this</span>.fire(<span class="literal">'valueChanged'</span>,<span class="reserved">this</span>.value);
			In2iGui.firePropertyChange(<span class="reserved">this</span>,<span class="literal">'value'</span>,<span class="reserved">this</span>.value);
		}
	}
}

<span class="comment">/* EOF */</span><span class="comment">/**
 * Simple container
 * <span class="attrib">@param</span> {Object} The options
 * <span class="attrib">@constructor</span>
 */</span>
In2iGui.Fragment = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = options;
	<span class="reserved">this</span>.element = $(options.element);
	<span class="reserved">this</span>.name = options.name;
	In2iGui.extend(<span class="reserved">this</span>);
}

In2iGui.Fragment.<span class="reserved">prototype</span> = {
	show : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.style.display=<span class="literal">'block'</span>;
	},
	hide : <span class="reserved">function</span>() {
		<span class="reserved">this</span>.element.style.display=<span class="literal">'none'</span>;
	}
}

<span class="comment">/* EOF */</span></pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b></b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Sun Nov 15 22:30:48 2009</div>
</body>
</html>
